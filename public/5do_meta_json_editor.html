<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>5DO meta.json Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#050910;
      color:#e5f1ff;
      margin:0;
      padding:20px;
    }
    h1{
      font-size:20px;
      margin-bottom:4px;
    }
    small{color:#7f9ab8;}
    .top-bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:16px;
    }
    button{
      background:#0f2237;
      color:#e5f1ff;
      border:1px solid #254466;
      border-radius:8px;
      padding:6px 12px;
      cursor:pointer;
    }
    button:hover{background:#17314c;}
    button.danger{border-color:#773b3b;color:#ffd0d0;background:#3b1414;}
    button.danger:hover{background:#5a2020;}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      border:1px solid #16263a;
      padding:4px;
      vertical-align:top;
    }
    th{
      background:#0b1724;
      position:sticky;
      top:0;
      z-index:2;
    }
    input[type="text"], textarea{
      width:100%;
      box-sizing:border-box;
      background:#0a141f;
      border:1px solid #20354d;
      color:#e5f1ff;
      border-radius:6px;
      padding:4px 6px;
      font-size:12px;
    }
    textarea{resize:vertical; min-height:60px;}
    .col-folder{width:120px;}
    .col-file{width:140px;}
    .col-actions{width:60px;text-align:center;}
    .pill{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:#0e2238;
      color:#98c4ff;
      margin-bottom:4px;
    }
    .flex-row{display:flex;gap:6px;align-items:center;}
    .file-input-label{
      border:1px dashed #37547a;
      padding:4px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      color:#9fb9da;
    }
    #loadFile{display:none;}
    .footer-info{
      margin-top:14px;
      font-size:11px;
      color:#7f9ab8;
      line-height:1.6;
    }
    .badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:6px;
      background:#12253a;
      border:1px solid #254466;
      margin-left:4px;
    }
  </style>
</head>
<body>
  <h1>5DO meta.json Editor</h1>
  <small>Supabase <code>media/meta.json</code> 생성·편집용 툴</small>

  <div class="top-bar">
    <button id="addRowBtn">+ 트랙 추가</button>
    <button id="downloadBtn">meta.json 생성 &amp; 다운로드</button>

    <label class="file-input-label">
      기존 meta.json 로드
      <input type="file" id="loadFile" accept="application/json" />
    </label>

    <span class="badge">Key 형식: <code>Folder/FileName.mp3</code></span>
  </div>

  <table>
    <thead>
      <tr>
        <th class="col-folder">폴더<br><small>예: Brainwave_States</small></th>
        <th class="col-file">파일명<br><small>예: Deep_Focus.mp3</small></th>
        <th>
          <span class="pill">KO</span><br/>
          제목 / 설명 / 작곡가
        </th>
        <th>
          <span class="pill">EN</span><br/>
          Title / Description / Composer
        </th>
        <th class="col-actions">삭제</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="footer-info">
    • 폴더 = Supabase <code>media</code> 버킷 기준 상위 폴더 이름 (예: <code>Brainwave_States</code>)<br/>
    • 파일명 = 확장자 포함 (예: <code>Deep_Focus.mp3</code>) – 만약 <code>.mp3</code>를 안 쓰면 자동으로 붙여줍니다.<br/>
    • 결과 JSON 구조 예시:<br/>
    <code>{
      "Folder/File.mp3": {
        "title_ko": "...",
        "title_en": "...",
        "desc_ko": "...",
        "desc_en": "...",
        "composer": "...",
        "composer_ko": "...",
        "composer_en": "..."
      }
    }</code>
  </div>

  <script>
    const rowsTbody    = document.getElementById('rows');
    const addRowBtn    = document.getElementById('addRowBtn');
    const downloadBtn  = document.getElementById('downloadBtn');
    const loadFileInput= document.getElementById('loadFile');

    // 한 줄 생성 (기존 nested 구조, flat 구조 모두 지원)
    function createRow(data = {}) {
      const ko = data.ko || {};
      const en = data.en || {};

      const folder = data.folder || '';
      const file   = data.file   || '';

      const koTitle = data.title_ko      || ko.title      || '';
      const koDesc  = data.desc_ko       || ko.desc       || '';
      const koComp  = data.composer_ko   || ko.composer   || data.composer || '';

      const enTitle = data.title_en      || en.title      || '';
      const enDesc  = data.desc_en       || en.desc       || '';
      const enComp  = data.composer_en   || en.composer   || data.composer || '';

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>
          <input type="text" class="fld-folder" placeholder="폴더명" value="${folder}">
        </td>
        <td>
          <input type="text" class="fld-file" placeholder="파일명.mp3" value="${file}">
        </td>
        <td>
          <input type="text" class="fld-ko-title" placeholder="제목" value="${koTitle}">
          <textarea class="fld-ko-desc" placeholder="설명...">${koDesc}</textarea>
          <input type="text" class="fld-ko-composer" placeholder="작곡가" value="${koComp}">
        </td>
        <td>
          <input type="text" class="fld-en-title" placeholder="Title" value="${enTitle}">
          <textarea class="fld-en-desc" placeholder="Description...">${enDesc}</textarea>
          <input type="text" class="fld-en-composer" placeholder="Composer" value="${enComp}">
        </td>
        <td class="col-actions">
          <button class="danger btn-del">X</button>
        </td>
      `;

      tr.querySelector('.btn-del').addEventListener('click', () => {
        rowsTbody.removeChild(tr);
      });

      rowsTbody.appendChild(tr);
    }

    addRowBtn.addEventListener('click', () => createRow());

    // meta.json 생성 & 다운로드 (flat 구조)
    downloadBtn.addEventListener('click', () => {
      const meta = {};
      const rows = rowsTbody.querySelectorAll('tr');

      rows.forEach(tr => {
        const folderInput = tr.querySelector('.fld-folder');
        const fileInput   = tr.querySelector('.fld-file');
        if(!folderInput || !fileInput) return;

        const folder = folderInput.value.trim();
        let   file   = fileInput.value.trim();
        if (!folder && !file) return; // 완전 빈 행은 스킵

        if (file && !file.toLowerCase().endsWith('.mp3')) {
          file += '.mp3';
        }

        const key = (folder ? folder + '/' : '') + file;

        const koTitle    = tr.querySelector('.fld-ko-title').value.trim();
        const koDesc     = tr.querySelector('.fld-ko-desc').value.trim();
        const koComposer = tr.querySelector('.fld-ko-composer').value.trim();

        const enTitle    = tr.querySelector('.fld-en-title').value.trim();
        const enDesc     = tr.querySelector('.fld-en-desc').value.trim();
        const enComposer = tr.querySelector('.fld-en-composer').value.trim();

        // 공통 composer 문자열 조합 (원하면 규칙 변경 가능)
        let composerCombined = '';
        if (koComposer && enComposer && koComposer !== enComposer) {
          composerCombined = `${koComposer} / ${enComposer}`;
        } else {
          composerCombined = koComposer || enComposer || '';
        }

        meta[key] = {
          title_ko: koTitle,
          title_en: enTitle,
          desc_ko : koDesc,
          desc_en : enDesc,
          composer: composerCombined,
          composer_ko: koComposer,
          composer_en: enComposer
        };
      });

      const json = JSON.stringify(meta, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'meta.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // 기존 meta.json 로드해서 편집 (flat + old nested 둘 다 지원)
    loadFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = evt.target.result;
          const obj  = JSON.parse(text);

          // 기존 행 지우기
          rowsTbody.innerHTML = '';

          Object.entries(obj).forEach(([key, value]) => {
            const parts  = key.split('/');
            const fName  = parts.pop();
            const folder = parts.join('/');

            const v = value || {};
            const ko = v.ko || {};
            const en = v.en || {};

            const rowData = {
              folder,
              file: fName,
              title_ko: v.title_ko || ko.title || '',
              desc_ko : v.desc_ko  || ko.desc  || '',
              composer_ko: v.composer_ko || ko.composer || '',
              title_en: v.title_en || en.title || '',
              desc_en : v.desc_en  || en.desc  || '',
              composer_en: v.composer_en || en.composer || '',
              composer: v.composer || ''
            };

            createRow(rowData);
          });
        } catch (err) {
          alert('meta.json 파싱 에러: ' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
      // 같은 파일 다시 선택 가능하도록 리셋
      e.target.value = '';
    });

    // 처음에 기본 행 하나 만들어 두기
    createRow();
  </script>
</body>
</html>