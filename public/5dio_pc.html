<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>5DIO Desktop</title>

<!-- ✅ Supabase SDK (로드 보장) -->
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>

<!-- ✅ 공개 설정 (필요시 수정) -->
<script>
window.USE_SUPABASE = true;
window.SUPABASE_URL   = window.SUPABASE_URL  || "https://xdjgumqdwedgzwqturcx.supabase.co";
window.SUPABASE_KEY   = window.SUPABASE_KEY  || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
window.SUPABASE_BUCKET = window.SUPABASE_BUCKET || "media";
window.SUPABASE_PUBLIC_BASE =
  (window.SUPABASE_PUBLIC_BASE ||
   (window.SUPABASE_URL.replace(/\/+$/,'') + "/storage/v1/object/public/" + window.SUPABASE_BUCKET));
window.CACHE_BUST = (window.CACHE_BUST ?? true);
</script>

<!-- (선택) 기본 스타일 유지용 – 당신의 기존 CSS가 있다면 그대로 두세요 -->
<style>
  body{background:#111;color:#ddd;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .library-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;margin:12px 0}
  .tcard{background:#1b1f26;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.25);padding:8px;cursor:pointer}
  .tcard .thumb{width:100%;aspect-ratio:1;border-radius:8px;background:#222}
  .tcard .t{margin-top:8px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .nav-btn{margin:0 4px;padding:6px 10px;border-radius:8px;border:0;background:#2a2f3a;color:#ddd}
  .t.small{opacity:.75}
</style>
</head>
<body>

<!-- ✅ 당신의 기존 UI를 여기에 그대로 두세요.
     (이 샘플은 라이브러리 부분만 최소로 포함합니다) -->
<section class="card" style="padding:12px;margin:12px;border-radius:10px;background:#141922;box-shadow:0 1px 6px rgba(0,0,0,.2)">
  <h3 style="margin:4px 0 10px;font-weight:600">Library</h3>
  <div class="library-controls">
    <button id="libPrev" class="nav-btn">◀</button>
    <button id="libNext" class="nav-btn">▶</button>
  </div>
  <div id="libRail" class="library-grid"></div>
</section>

<!-- ✅ 플레이어(당신의 기존 플레이어가 있다면 그 태그에 id="audio"만 부여) -->
<div style="padding:12px;margin:12px;border-radius:10px;background:#141922;box-shadow:0 1px 6px rgba(0,0,0,.2)">
  <audio id="audio" controls preload="none" style="width:100%"></audio>
</div>

<!-- ✅ 드롭-인 라이브러리 모듈 (UI 변경 없음) -->
<script>
(async () => {
  // 1) Supabase SDK 보장
  async function ensureSupabase() {
    if (window.supabase && typeof window.supabase.createClient === 'function') return;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js";
      s.defer = true;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Supabase SDK load failed'));
      document.head.appendChild(s);
    });
  }
  try { await ensureSupabase(); } catch(e){ console.warn('[5DIO] SDK load error:', e); return; }

  // 2) 필수 id 체크 (이미 샘플에 포함되어 있음 – 기존 UI라면 자동 부여 로직 추가 가능)
  function ensureIds() {
    let audio = document.getElementById('audio') || document.getElementById('player') || document.querySelector('audio');
    if (audio && !audio.id) audio.id = 'audio';
    if (!document.getElementById('libRail')) {
      const rail = document.createElement('div');
      rail.id = 'libRail';
      rail.className = 'library-grid';
      (document.querySelector('.card')||document.body).appendChild(rail);
    }
    if (!document.getElementById('libPrev')) {
      const b=document.createElement('button'); b.id='libPrev'; b.textContent='◀'; b.className='nav-btn';
      (document.querySelector('.library-controls')||document.body).appendChild(b);
    }
    if (!document.getElementById('libNext')) {
      const b=document.createElement('button'); b.id='libNext'; b.textContent='▶'; b.className='nav-btn';
      (document.querySelector('.library-controls')||document.body).appendChild(b);
    }
    return {
      audio: document.getElementById('audio'),
      rail : document.getElementById('libRail'),
      prev : document.getElementById('libPrev'),
      next : document.getElementById('libNext'),
    };
  }

  const need = ensureIds();
  if (!need.audio || !need.rail || !need.prev || !need.next) {
    console.warn('[5DIO] Missing required UI elements (libRail/libPrev/libNext/audio).');
    return;
  }

  // 3) 라이브러리 모듈
  const BUCKET      = window.SUPABASE_BUCKET || 'media';
  const PUBLIC_BASE = (window.SUPABASE_PUBLIC_BASE ||
    (window.SUPABASE_URL.replace(/\/+$/,'') + '/storage/v1/object/public/' + BUCKET)
  ).replace(/\/+$/,'');
  const CACHE_BUST  = !!window.CACHE_BUST;
  const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);

  const PAGE = 3;
  let cwd = ''; // root
  let folders = [];
  let files   = [];
  let page    = 0;

  const enc = p => p.split('/').filter(Boolean).map(encodeURIComponent).join('/');
  const isAudio = name => /\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(name);
  function ciPicker(names){
    const map = new Map(names.map(n=>[n.toLowerCase(), n]));
    return (base, exts) => { for (const ext of exts){
      const hit = map.get((base + '.' + ext).toLowerCase());
      if (hit) return hit;
    } return null; };
  }

  async function list(prefix=''){
    const { data, error } = await sb.storage.from(BUCKET).list(prefix, {
      limit: 1000, sortBy: { column:'name', order:'asc' }
    });
    if (error) throw error;
    return data || [];
  }

  async function readFolder(prefix=''){
    const entries = await list(prefix);
    const names   = entries.map(e=>e.name);
    const pick    = ciPicker(names);
    const folderThumb = pick('folder', ['png','jpg','jpeg','webp','gif']);

    const outFolders = [];
    const outFiles   = [];

    for (const e of entries){
      const name = e.name;
      const isFolder = !/\./.test(name);
      const full = (prefix ? prefix + '/' : '') + name;

      if (isFolder){
        const thumb = folderThumb
          ? `${PUBLIC_BASE}/${enc(prefix + '/' + folderThumb)}${CACHE_BUST?('?t='+Date.now()):''}`
          : '';
        outFolders.push({ name, path: full, thumb });
      } else if (isAudio(name)){
        const base  = name.replace(/\.[^.]+$/,'');
        const tThumb= pick(base, ['png','jpg','jpeg','webp','gif']);
        const url   = `${PUBLIC_BASE}/${enc(full)}${CACHE_BUST?('?t='+Date.now()):''}`;
        const thumb = tThumb
          ? `${PUBLIC_BASE}/${enc(prefix + '/' + tThumb)}${CACHE_BUST?('?t='+Date.now()):''}`
          : (folderThumb ? `${PUBLIC_BASE}/${enc(prefix + '/' + folderThumb)}${CACHE_BUST?('?t='+Date.now()):''}` : '');
        outFiles.push({ name, base, url, thumb });
      }
    }
    outFolders.sort((a,b)=>a.name.localeCompare(b.name));
    outFiles.sort((a,b)=>a.name.localeCompare(b.name));
    return { folders: outFolders, files: outFiles };
  }

  function renderPage(folders, files){
    const rail = document.getElementById('libRail');
    rail.innerHTML = '';

    const all = [...folders.map(f=>({type:'folder', ...f})),
                 ...files.map(f=>({type:'file',   ...f}))];
    const totalPages = Math.max(1, Math.ceil(all.length / PAGE));
    if (page > totalPages-1) page = totalPages-1;
    const start = page * PAGE;
    const slice = all.slice(start, start + PAGE);

    slice.forEach(item => {
      const card  = document.createElement('div'); card.className='tcard';
      const img   = document.createElement('div'); img.className='thumb';
      if (item.thumb) {
        img.style.backgroundImage  = `url(${item.thumb})`;
        img.style.backgroundSize   = 'cover';
        img.style.backgroundPosition = 'center';
      }
      const title = document.createElement('div'); title.className='t';
      title.textContent = item.type === 'file' ? item.base : item.name;

      card.appendChild(img);
      card.appendChild(title);

      card.addEventListener('click', async () => {
        if (item.type === 'folder'){
          cwd = item.path; page = 0; await render();
        } else {
          const audio = document.getElementById('audio');
          if (audio.src !== item.url) audio.src = item.url;
          audio.load();
          try { await audio.play(); } catch(e) {}
        }
      });

      rail.appendChild(card);
    });

    const prev = document.getElementById('libPrev');
    const next = document.getElementById('libNext');
    if (prev) prev.disabled = page <= 0;
    if (next) next.disabled = page >= (Math.ceil((folders.length + files.length)/PAGE) - 1);
  }

  async function render(){
    try{
      const {folders, files} = await readFolder(cwd);
      renderPage(folders, files);
      // 내비게이션 핸들러(한 번만 연결)
      if (!render._bound){
        document.getElementById('libPrev').addEventListener('click', ()=>{ if (page>0){ page--; render(); }});
        document.getElementById('libNext').addEventListener('click', ()=>{ page++; render(); });
        render._bound = true;
      }
    }catch(err){
      const rail = document.getElementById('libRail');
      rail.innerHTML = '<div class="t small">Failed to load library</div>';
      console.warn('[5DIO] Library error:', err);
    }
  }

  // 시작
  render();
})();
</script>

</body>
</html>