<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>5DIO Desktop (Patched)</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <script>
  (function(){
    window.SUPABASE_URL  = "https://xdjgumqdwedgzwqturcx.supabase.co";
    window.SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
    window.SUPABASE_BUCKET = "media";
    window.SUPABASE_PUBLIC_BASE =
      window.SUPABASE_URL.replace(/\/+$/,'') + "/storage/v1/object/public/" + window.SUPABASE_BUCKET;
    window.USE_SUPABASE = true;
  })();
  </script>
</head>
<body>
  <canvas id="scope" width="800" height="160"></canvas>
  <audio id="player" controls preload="none"></audio>
  <div id="grid"></div>
  <script>
  (function(){
    const scope = document.getElementById('scope');
    let ctx=null, analyser=null, mediaNode=null;
    function getCtx(){ return ctx || (ctx = new (window.AudioContext||window.webkitAudioContext)()); }
    function wire(){
      const c=getCtx();
      if(!analyser){ analyser=c.createAnalyser(); analyser.fftSize=2048; }
      let connected=false;
      if (window.__genGain && window.__genGain.connect){ try{ window.__genGain.connect(analyser); connected=true; }catch(e){} }
      const audio=document.getElementById('player')||document.getElementById('audio');
      if(!connected && audio){
        try{ if(!mediaNode) mediaNode=c.createMediaElementSource(audio); }catch(e){}
        try{ if(mediaNode){ mediaNode.connect(analyser); connected=true; } }catch(e){}
      }
    }
    function draw(){
      if(!scope) return;
      const g=scope.getContext('2d'); const W=scope.width,H=scope.height;
      const c=getCtx(); if (c.state==='suspended'){ requestAnimationFrame(draw); return; }
      wire();
      const buf=new Uint8Array(analyser.fftSize);
      (function loop(){
        analyser.getByteTimeDomainData(buf);
        g.clearRect(0,0,W,H); g.beginPath();
        const step=W/buf.length;
        for(let i=0;i<buf.length;i++){ const x=i*step; const y=(buf[i]/128)*H/2; i?g.lineTo(x,y):g.moveTo(x,y); }
        g.stroke(); requestAnimationFrame(loop);
      })();
    }
    document.addEventListener('click', async ()=>{ const c=getCtx(); if(c.state==='suspended') try{ await c.resume(); }catch(e){} }, {once:true, capture:true});
    draw();
    (async function(){
      try{
        const url=window.SUPABASE_URL, key=window.SUPABASE_KEY, bucket=window.SUPABASE_BUCKET;
        const sb=(window.sb)||(window.sb=window.supabase.createClient(url,key));
        const base=(window.SUPABASE_PUBLIC_BASE|| (url.replace(/\/+$/,'')+'/storage/v1/object/public/'+bucket)).replace(/\/+$/,'');
        const enc=p=>p.split('/').map(encodeURIComponent).join('/');
        const prefix='Brainwave_States';
        const {data,error}=await sb.storage.from(bucket).list(prefix,{limit:1000,sortBy:{column:'name',order:'asc'}});
        if(error){ console.warn(error); return; }
        const grid=document.getElementById('grid'); if(!grid) return;
        grid.innerHTML='';
        const folderThumb=`${base}/${enc(prefix+'/folder.png')}`;
        (data||[]).forEach(e=>{
          if(/\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(e.name)){
            const t=`${base}/${enc(prefix+'/'+e.name.replace(/\.[^.]+$/,'.png'))}`;
            grid.insertAdjacentHTML('beforeend',`
              <div style="display:inline-block;width:160px;margin:8px;text-align:center">
                <img src="${t}" style="width:140px;height:140px;object-fit:cover;border-radius:10px;background:#111"/>
                <div style="margin-top:6px;color:#ddd">${e.name}</div>
              </div>`);
          }
        });
      }catch(e){ console.error(e); }
    })();
  })();
  </script>
</body>
</html>