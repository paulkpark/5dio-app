<!DOCTYPE html>
<html lang="en">
<head>

<!-- Cloud Tunnel Safe Endpoints -->
<script>
window.USE_SUPABASE = true;

// ✅ Supabase 대시보드 → Settings → API 에서 복사
window.SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";

// ✅ Storage 버킷이름(우린 media)
window.SUPABASE_BUCKET = "media";

// ✅ 퍼블릭 베이스 URL: 맨 끝에 /media 까지 포함!
window.SUPABASE_PUBLIC_BASE = "https://xdjgumqdwedgzwqturcx.supabase.co/storage/v1/object/public/media";

window.CACHE_BUST = true;
</script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>5DIO — Desktop Full Version</title>
<style>
:root{
  --bg:#2f3541;
  --panel:#3b4350;
  --edge:#5a6677;
  --ink:#f7f9ff;
  --muted:#bdc7d6;
  --accent:#ffd166;
  --accent2:#00b7ff;
  --ok:#31d0aa;
  --danger:#ef476f;
  --knob-face:#c7cbd4;
  --knob-metal:#b7bcc6;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
h1{letter-spacing:3px;font-weight:800;margin:14px 12px 6px}
.app{max-width:1100px;margin:0 auto;padding:12px;display:grid;gap:12px}
header{display:flex;align-items:center;justify-content:space-between}
header .brand{font-size:20px;font-weight:800;letter-spacing:3px}
.btn{background:#1c2330;color:var(--ink);border:1px solid #2c384b;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn:active{transform:translateY(3.0px)}
.module{background:linear-gradient(180deg,#495364,#3a4350);border:1px solid var(--edge);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.35) inset, 0 1px 0 rgba(255,255,255,.03);padding:12px}
.module h3{margin:0 0 10px; letter-spacing:1px; font-weight:700}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
.small{font-size:12px;color:var(--muted)}
.inline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
input[type="number"], select{background:#1f2632;border:1px solid #485567;color:var(--ink);border-radius:8px;padding:8px 10px;font-size:16px;min-width:88px;outline:none}
input[type="number"]:focus, select:focus{border-color:#3b84c9;box-shadow:0 0 0 3px rgba(0,183,255,.15)}
input[type="range"]{width:100%;height:28px}
.knob{position:relative;width:80px;height:80px;margin:0 auto;border-radius:50%;background: radial-gradient(ellipse at 45% 45%, #fff 0%, var(--knob-face) 18%, var(--knob-metal) 58%, #969eab 90%);box-shadow: inset 0 6px 14px rgba(0,0,0,.35), inset 0 -4px 10px rgba(0,0,0,.25), 0 3px 10px rgba(0,0,0,.4)}
.knob::after{--r: 34px;content:""; position:absolute; left:50%; top:50%; width:10px; height:10px; background:#ffb703; border-radius:50%; transform: translate(-50%,-50%) rotate(var(--angle,0deg)) translate(0, calc(-1 * var(--r))); transition: transform .08s linear; box-shadow: 0 0 0 1px rgba(0,0,0,.25), 0 0 6px rgba(0,0,0,.2)}
.knob input[type=range]{position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:5}
.knob .label{position:absolute; left:0; right:0; bottom:-18px; text-align:center; font-size:12px; color:#e6eaf3}
.card{background:#232a36;border:1px solid #2f3745;border-radius:12px;padding:10px}
.card h4{margin:0 0 8px;font-size:13px;color:#e0e6ef;letter-spacing:.6px}
.strip{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
.library .nav{display:flex;align-items:center;gap:8px}
.library .rail{display:grid;grid-auto-flow:column;grid-auto-columns:calc((100% - 16px)/3);gap:8px;overflow-x:auto;padding:4px}
.tcard{background:#161c26;border:1px solid #273142;border-radius:12px;padding:6px;text-align:center;min-width:0}
.thumb{aspect-ratio:1/1;border-radius:8px;background:#2a3342}
.tcard .t{margin-top:8.0px;font-size:12px;color:#b7becd}
.player-grid{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
.player-top{display:flex;gap:10px;align-items:center}
#filePicker{flex:1 1 auto}
.player-bar{display:grid;grid-template-columns:auto auto 1fr auto auto;gap:12px;align-items:center}
#timeline{width:100%;height:28px}
.badge{font-variant-numeric:tabular-nums;background:#0e141c;border:1px solid #273042;border-radius:8px;padding:6px 10px;color:#c6cfdd}
.scope-wrap{position:relative}
#scope{width:100%;height:170px;background:#0a0d12;border-radius:10px;display:block;border:1px solid #1a202b}
.scope-ctrl{position:absolute;right:8px;top:10.0px;display:flex;gap:6px}
@media (max-width:640px){
  html, body { height:100%; overflow:hidden }
  .app{ height:100vh; display:grid; gap:10px; transform: scale(var(--mobile-scale, 1)); transform-origin: top left; width: calc(100% / var(--mobile-scale, 1)) }
  h1{ font-size:16px; margin:8px 6px 2px }
  .module{ padding:10px; border-radius:12px }
  .grid-3{ grid-template-columns: 1fr; gap:10px }
  .player-bar{ grid-template-columns: auto auto 1fr auto auto; gap:10px }
  .knob{ width:64px; height:64px }
  .knob::after{ --r:27px; width:9px; height:9px }
}
.hidden{display:none !important}
</style>

<!-- 5D SONIC runtime config for API/MEDIA roots -->
<script>
// You can override these from the console or an inline script BEFORE this runs:
//   window.LUNA_API_BASE = location.origin + '/api/tree';
//   window.LUNA_MEDIA_BASE = location.origin + '/media/';
window.LUNA_API_BASE = location.origin + '/api/tree';
window.LUNA_MEDIA_BASE = location.origin + '/media/';
</script>


<!-- Hard override for local server routes -->



<style id="lib-square-css">
#libGrid .thumb img{width:100%;aspect-ratio:1/1;height:auto;object-fit:cover;border-radius:8px;background:#0b1022}
</style>


<style id="loadedname-style">
#loadedName{ margin-left:8px; color:#a7b5d6; font-size:14px; max-width:55ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }
</style>


<style id="player-currenttrack-style">
/* Hide native file picker row */
#filePicker, label[for="filePicker"] { display: none !important; }
#currentTrack {
  display:flex; align-items:center; gap:8px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  padding:6px 8px; border-radius:10px; max-width: 420px;
}
#currentThumb {
  width:40px; height:40px; object-fit:cover; border-radius:8px;
  background:#0b1022; border:1px solid rgba(255,255,255,0.1);
}
#currentName {
  color:#a7b5d6; font-size:14px; max-width:32ch;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
</style>


<style id="lib-highlight-and-scope-trim">
/* Highlight for selected thumbnail */
#libGrid .thumb.thumb--active,
.thumb.thumb--active {
  border: 2px solid #7dd3fc !important;      /* cyan border */
  box-shadow: 0 0 0 2px rgba(125,211,252,0.25) inset, 0 0 10px rgba(125,211,252,0.25);
}
/* Remove oscilloscope control buttons spacing if their nodes remain */
.osc-toolbar, .scope-toolbar { display:none !important; }
button[data-scope="both"], button[data-scope="freeze"] { display:none !important; }
</style>


<style id="brand-offset-patch">
/* Move the top-left brand/title 10mm to the right */
.brand { margin-left: 10mm !important; }
</style>


<style id="brand-fontstyle-patch">
.brand {
    font-size: 2.2rem !important;
    color: #39FF14 !important; /* 네온 연두색 */
    text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14;
}
</style>

<script src="https://unpkg.com/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>

</head>
<body>

    <div class="menu-container">
      <div class="menu-button" onclick="toggleMenu()">☰</div>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener" role="menuitem">Shop</a>
        <a href="#" role="menuitem">FAQ</a>
        <a href="#" role="menuitem">Contact</a>
        <a href="#" role="menuitem">Manual</a>
        <a href="#" role="menuitem">About</a>
      </div>
    </div>
    <style>
      .menu-container { position: absolute; top: 12.0px; left: 10px; }
      .menu-button { font-size: 24px; cursor: pointer; user-select: none; }
      .dropdown-menu {
        display: none;
        flex-direction: column;
        position: absolute;
        background: rgba(0,0,0,0.85);
        padding: 10px;
        border-radius: 8px;
        margin-top: 7.0px;
        z-index: 1000;
      }
      .dropdown-menu a {
        color: white;
        padding: 6px 10px;
        text-decoration: none;
      }
      .dropdown-menu a:hover { background: rgba(255,255,255,0.1); }
    </style>
    <script>
      function toggleMenu() {
        const menu = document.getElementById('dropdownMenu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
      }
    </script>
    
<div class="app">
  <header>
    <div class="brand"> 5DIO </div>
    <button id="langToggle" class="btn" data-lang="en">EN / 한글</button>
  </header>

  <section class="module">
    <h3 data-en="Oscilloscope" data-ko="오실로스코프">Oscilloscope</h3>
    <div class="scope-wrap">
      <canvas id="scope" width="1040" height="170"></canvas>
      <div class="scope-ctrl">
        <button class="btn" id="scopeMode">Both</button>
        <button class="btn" id="scopeFreeze">Freeze</button>
      </div>
    </div>
  </section>

  <section class="module" id="gen">
    <h3 data-en="Frequency Generator" data-ko="주파수 생성기">Frequency Generator</h3>
    <div class="grid-3">
      <div class="card">
        <h4 data-en="L" data-ko="좌">L</h4>
        <div class="inline">
          <label data-en="Frequency" data-ko="주파수">Frequency</label>
          <input id="lFreqIn" type="number" min="0" max="25000" step="0.01" value="432.00"/>
          <span class="small">Hz</span>
        </div>
        <input id="lFreq" type="range" min="0" max="25000" step="0.01" value="432.00"/>
        <div class="inline">
          <label data-en="Wave" data-ko="파형">Wave</label>
          <select id="lWave"><option value="sine">sine</option><option value="square">square</option></select>
        </div>
        <div class="inline">
          <label data-en="Duty" data-ko="듀티">Duty</label>
          <input id="lDuty" type="range" min="1" max="99" step="1" value="50" style="flex:1"/>
          <input id="lDutyIn" type="number" min="1" max="99" step="1" value="50" style="width:78px"/>
        </div>
        <div class="inline">
          <label data-en="Level" data-ko="레벨">Level</label>
          <input id="lLevel" type="range" min="0" max="100" step="1" value="50" style="flex:1"/>
          <span class="small" id="lLevelTxt">50%</span>
        </div>
      </div>

      <div class="card">
        <h4 data-en="Mix & Master" data-ko="믹스 & 마스터">Mix &amp; Master</h4>
        <div class="strip">
          <div class="knob" id="masterKnob" data-start="210" data-sweep="270" style="--angle:0deg">
            <input id="masterGain" type="range" min="0" max="100" step="1" value="50"/>
            <div class="label" data-en="Master" data-ko="마스터">Master</div>
          </div>
          <div class="knob" id="balanceKnob" data-start="-135" data-sweep="270" style="--angle:0deg">
            <input id="balance" type="range" min="-100" max="100" step="1" value="0"/>
            <div class="label" data-en="Balance" data-ko="밸런스">Balance</div>
          </div>
          <div class="inline" style="gap:8px">
            <button class="btn" id="genPlayPause">▶/⏸</button>
            
          </div>
        </div>
        <hr/>
        <div class="card" style="background:#1e2531">
          <div class="inline" style="gap:10px; flex-wrap:wrap">
            <label data-en="Harmonics" data-ko="하모닉스">Harmonics</label>
            <label data-en="Count" data-ko="개수">Count</label>
            <select id="harmCount"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
            <label data-en="Base" data-ko="베이스">Base</label>
            <select id="harmBase"><option>1</option><option>2</option><option>3</option><option>4</option></select>
          </div>
          <div id="h1row" class="inline" style="gap:10px; margin-top:10.0px; width:100%">
            <label>H1</label><input id="h1" type="range" min="0" max="100" value="0" style="flex:1"/><span id="h1v" class="small">0%</span>
          </div>
          <div id="h2row" class="inline" style="gap:10px; margin-top:8.0px; width:100%">
            <label>H2</label><input id="h2" type="range" min="0" max="100" value="0" style="flex:1"/><span id="h2v" class="small">0%</span>
          </div>
          <div id="h3row" class="inline" style="gap:10px; margin-top:8.0px; width:100%">
            <label>H3</label><input id="h3" type="range" min="0" max="100" value="0" style="flex:1"/><span id="h3v" class="small">0%</span>
          </div>
          <div id="h4row" class="inline" style="gap:10px; margin-top:8.0px; width:100%">
            <label>H4</label><input id="h4" type="range" min="0" max="100" value="0" style="flex:1"/><span id="h4v" class="small">0%</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h4 data-en="R" data-ko="우">R</h4>
        <div class="inline">
          <label data-en="Frequency" data-ko="주파수">Frequency</label>
          <input id="rFreqIn" type="number" min="0" max="25000" step="0.01" value="432.00"/>
          <span class="small">Hz</span>
        </div>
        <input id="rFreq" type="range" min="0" max="25000" step="0.01" value="432.00"/>
        <div class="inline">
          <label data-en="Wave" data-ko="파형">Wave</label>
          <select id="rWave"><option value="sine">sine</option><option value="square">square</option></select>
        </div>
        <div class="inline">
          <label data-en="Duty" data-ko="듀티">Duty</label>
          <input id="rDuty" type="range" min="1" max="99" step="1" value="50" style="flex:1"/>
          <input id="rDutyIn" type="number" min="1" max="99" step="1" value="50" style="width:78px"/>
        </div>
        <div class="inline">
          <label data-en="Level" data-ko="레벨">Level</label>
          <input id="rLevel" type="range" min="0" max="100" step="1" value="50" style="flex:1"/>
          <span class="small" id="rLevelTxt">50%</span>
        </div>
      </div>
    </div>
  </section>

  <section class="module library">
    <h3 data-en="Library" data-ko="라이브러리">Library</h3>
    <div class="nav">
      <button class="btn" id="libPrev">◀</button>
      <div class="rail" id="libRail"></div>
      <button class="btn" id="libNext">▶</button>
    </div>
  </section>

  <section class="module">
    <h3 data-en="Audio Player" data-ko="오디오 플레이어">Audio Player</h3>
    <div class="player-grid">
      <div class="player-top">
        <input class="btn" id="filePicker" type="file" accept="audio/*"/>
      </div>
      <div class="player-bar">
        <button class="btn" id="playPause" title="Play/Pause (Space)">▶/⏸</button>
        <button class="btn" id="stop" title="Stop">⏹</button>
        <input id="timeline" type="range" min="0" max="1" step="0.001" value="0"/>
        <div class="badge"><span id="timeCur">00:00</span> / <span id="timeDur">00:00</span></div>
        <div class="knob" id="playerVolKnob" data-start="210" data-sweep="270" style="--angle:0deg">
          <input id="playerVol" type="range" min="0" max="100" step="1" value="60"/>
          <div class="label" data-en="Volume" data-ko="볼륨">Volume</div>
        </div>
      </div>
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </section>
</div>

<script>
/* i18n */
(function(){const t=document.getElementById('langToggle');function a(l){document.querySelectorAll('[data-en]').forEach(e=>{e.textContent=(l==='ko'&&e.dataset.ko)?e.dataset.ko:e.dataset.en});t.dataset.lang=l;t.textContent=l==='ko'?'한글 / EN':'EN / 한글'}t&&t.addEventListener('click',()=>{const c=t.dataset.lang||'en';a(c==='en'?'ko':'en')});a('en')})();
/* fit */
(function(){function f(){if(window.innerWidth>640){document.documentElement.style.setProperty('--mobile-scale',1);return}const a=document.querySelector('.app');if(!a)return;a.style.setProperty('--mobile-scale',1);const n=a.scrollHeight;const v=window.innerHeight;let s=1;if(n>v){s=Math.max(.6,Math.min(1,v/n))}document.documentElement.style.setProperty('--mobile-scale',s)}window.addEventListener('load',f);window.addEventListener('resize',f)})();
/* contexts */
const genCtx=new (window.AudioContext||window.webkitAudioContext)();const playerCtx=new (window.AudioContext||window.webkitAudioContext)();
let lOsc,rOsc,lGain,rGain,genMasterGain,genPan,genAnalyser;
function makePulsePeriodicWave(ctx,duty){const D=Math.min(Math.max(duty/100,.01),.99);const N=64;const real=new Float32Array(N+1),imag=new Float32Array(N+1);for(let n=1;n<=N;n++){const c=(2/(n*Math.PI))*Math.sin(n*Math.PI*D);real[n]=c*2}return ctx.createPeriodicWave(real,imag,{disableNormalization:false})}
function makeHarmonicWave(ctx,base,count,amps){const N=64,real=new Float32Array(N+1),imag=new Float32Array(N+1);real[base]=1;for(let i=1;i<=count;i++){const idx=base*(i+1);if(idx<=N)real[idx]=amps[i]||0}return ctx.createPeriodicWave(real,imag,{disableNormalization:false})}
function setupGenerator(){lOsc=genCtx.createOscillator();rOsc=genCtx.createOscillator();lGain=genCtx.createGain();rGain=genCtx.createGain();genMasterGain=genCtx.createGain();genPan=new StereoPannerNode(genCtx,{pan:0});genAnalyser=genCtx.createAnalyser();genAnalyser.fftSize=2048;lOsc.connect(lGain).connect(genPan);rOsc.connect(rGain).connect(genPan);genPan.connect(genMasterGain).connect(genAnalyser).connect(genCtx.destination);lOsc.start();rOsc.start()}setupGenerator();
const audioEl=document.getElementById('audio');const srcNode=playerCtx.createMediaElementSource(audioEl);const playerMasterGain=playerCtx.createGain();const playerAnalyser=playerCtx.createAnalyser();playerAnalyser.fftSize=2048;srcNode.connect(playerMasterGain).connect(playerAnalyser).connect(playerCtx.destination);
/* UI */
const UI={lFreq:document.getElementById('lFreq'),lFreqIn:document.getElementById('lFreqIn'),lWave:document.getElementById('lWave'),lDuty:document.getElementById('lDuty'),lDutyIn:document.getElementById('lDutyIn'),lLevel:document.getElementById('lLevel'),lLevelTxt:document.getElementById('lLevelTxt'),rFreq:document.getElementById('rFreq'),rFreqIn:document.getElementById('rFreqIn'),rWave:document.getElementById('rWave'),rDuty:document.getElementById('rDuty'),rDutyIn:document.getElementById('rDutyIn'),rLevel:document.getElementById('rLevel'),rLevelTxt:document.getElementById('rLevelTxt'),masterGain:document.getElementById('masterGain'),masterKnob:document.getElementById('masterKnob'),balance:document.getElementById('balance'),balanceKnob:document.getElementById('balanceKnob'),harmCount:document.getElementById('harmCount'),harmBase:document.getElementById('harmBase'),h1:document.getElementById('h1'),h2:document.getElementById('h2'),h3:document.getElementById('h3'),h4:document.getElementById('h4'),h1v:document.getElementById('h1v'),h2v:document.getElementById('h2v'),h3v:document.getElementById('h3v'),h4v:document.getElementById('h4v'),genPlayPause:document.getElementById('genPlayPause'),genStop:document.getElementById('genStop'),libRail:document.getElementById('libRail'),libPrev:document.getElementById('libPrev'),libNext:document.getElementById('libNext'),filePicker:document.getElementById('filePicker'),playPause:document.getElementById('playPause'),stop:document.getElementById('stop'),timeline:document.getElementById('timeline'),timeCur:document.getElementById('timeCur'),timeDur:document.getElementById('timeDur'),playerVol:document.getElementById('playerVol'),playerVolKnob:document.getElementById('playerVolKnob')};
function knobAngle(rangeEl){const k=rangeEl.closest('.knob');if(!k)return 0;const min=+rangeEl.min,max=+rangeEl.max,v=+rangeEl.value;const pct=(v-min)/(max-min);const start=+k.dataset.start||210;const sweep=+k.dataset.sweep||270;return start+pct*sweep}
function bindKnobAngle(knobEl,rangeEl){if(!knobEl||!rangeEl)return;const u=()=>knobEl.style.setProperty('--angle',knobAngle(rangeEl)+'deg');rangeEl.addEventListener('input',u);rangeEl.addEventListener('change',u);u()}
bindKnobAngle(UI.masterKnob,UI.masterGain);bindKnobAngle(UI.balanceKnob,UI.balance);bindKnobAngle(UI.playerVolKnob,UI.playerVol);
function bindNumberRange(rangeEl,numEl,onCommit){if(!rangeEl||!numEl)return;let last=rangeEl.value;const s=()=>{numEl.value=rangeEl.value;last=rangeEl.value;onCommit&&onCommit(+rangeEl.value)};const soft=()=>{const v=parseFloat(numEl.value);if(Number.isFinite(v)&&v>=+rangeEl.min&&v<=+rangeEl.max){rangeEl.value=String(v);rangeEl.dispatchEvent(new Event('input',{bubbles:true}))}};const c=()=>{let v=parseFloat(numEl.value);if(!Number.isFinite(v))v=parseFloat(last);v=Math.min(Math.max(v,+rangeEl.min),+rangeEl.max);rangeEl.value=String(v);numEl.value=String(v);last=String(v);rangeEl.dispatchEvent(new Event('input',{bubbles:true}));rangeEl.dispatchEvent(new Event('change',{bubbles:true}))};rangeEl.addEventListener('input',s);rangeEl.addEventListener('change',s);numEl.addEventListener('input',soft);numEl.addEventListener('change',c);numEl.addEventListener('blur',c);numEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();c()}});s()}
bindNumberRange(UI.lFreq,UI.lFreqIn,v=>{if(lOsc)lOsc.frequency.value=v});bindNumberRange(UI.rFreq,UI.rFreqIn,v=>{if(rOsc)rOsc.frequency.value=v});
function applyWave(which){const waveSel=which==='L'?UI.lWave:UI.rWave;const dutyEl=which==='L'?UI.lDuty:UI.rDuty;const osc=which==='L'?lOsc:rOsc;if(!osc)return;if(waveSel.value==='sine'){osc.type='sine'}else{osc.setPeriodicWave(makePulsePeriodicWave(genCtx,+dutyEl.value))}}
;['input','change'].forEach(ev=>{UI.lWave.addEventListener(ev,()=>{applyWave('L');applyHarmonics()});UI.rWave.addEventListener(ev,()=>{applyWave('R');applyHarmonics()});UI.lDuty.addEventListener(ev,()=>{if(UI.lWave.value==='square')applyWave('L')});UI.rDuty.addEventListener(ev,()=>{if(UI.rWave.value==='square')applyWave('R')})});
bindNumberRange(UI.lDuty,UI.lDutyIn,v=>{if(UI.lWave.value==='square')applyWave('L')});bindNumberRange(UI.rDuty,UI.rDutyIn,v=>{if(UI.rWave.value==='square')applyWave('R')});
function updateGenGains(){if(lGain)lGain.gain.value=(+UI.lLevel.value)/100;if(rGain)rGain.gain.value=(+UI.rLevel.value)/100;if(genMasterGain)genMasterGain.gain.value=(+UI.masterGain.value)/100;if(UI.lLevelTxt)UI.lLevelTxt.textContent=UI.lLevel.value+'%';if(UI.rLevelTxt)UI.rLevelTxt.textContent=UI.rLevel.value+'%'}
;['input','change'].forEach(ev=>{UI.lLevel.addEventListener(ev,updateGenGains);UI.rLevel.addEventListener(ev,updateGenGains);UI.masterGain.addEventListener(ev,updateGenGains)});
UI.balance.addEventListener('input',()=>{if(genPan)genPan.pan.value=(+UI.balance.value)/100});updateGenGains();
function applyHarmonics(){if(UI.lWave.value==='sine'||UI.rWave.value==='sine'){const base=parseInt(UI.harmBase.value)||1;const count=parseInt(UI.harmCount.value)||0;const amps={1:(+UI.h1.value)/100,2:(+UI.h2.value)/100,3:(+UI.h3.value)/100,4:(+UI.h4.value)/100};if(UI.lWave.value==='sine'&&lOsc){lOsc.setPeriodicWave(makeHarmonicWave(genCtx,base,count,amps))}if(UI.rWave.value==='sine'&&rOsc){rOsc.setPeriodicWave(makeHarmonicWave(genCtx,base,count,amps))}}UI.h1v.textContent=UI.h1.value+'%';UI.h2v.textContent=UI.h2.value+'%';UI.h3v.textContent=UI.h3.value+'%';UI.h4v.textContent=UI.h4.value+'%'}
;['input','change'].forEach(ev=>{UI.harmBase.addEventListener(ev,applyHarmonics);UI.harmCount.addEventListener(ev,applyHarmonics);UI.h1.addEventListener(ev,applyHarmonics);UI.h2.addEventListener(ev,applyHarmonics);UI.h3.addEventListener(ev,applyHarmonics);UI.h4.addEventListener(ev,applyHarmonics)});applyWave('L');applyWave('R');applyHarmonics();
let genRunning=false;function startGenerator(){genCtx.resume();genRunning=true}function pauseGenerator(){genRunning=false}function stopGenerator(){genRunning=false;if(lGain)lGain.gain.value=0;if(rGain)rGain.gain.value=0}
UI.genPlayPause.addEventListener('click',()=>{if(!genRunning){startGenerator()}else{pauseGenerator()}});UI.genStop.addEventListener('click',stopGenerator);
function fmt(t){const m=Math.floor(t/60),s=Math.floor(t%60);return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
UI.filePicker.addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;audioEl.src=URL.createObjectURL(f);audioEl.load();playerCtx.resume().then(()=>audioEl.play().catch(()=>{}))});
UI.playPause.addEventListener('click',()=>{playerCtx.resume();if(audioEl.paused)audioEl.play();else audioEl.pause()});
UI.stop.addEventListener('click',()=>{audioEl.pause();audioEl.currentTime=0});
audioEl.addEventListener('loadedmetadata',()=>{UI.timeDur.textContent=fmt(audioEl.duration||0)});
audioEl.addEventListener('timeupdate',()=>{const d=audioEl.duration||1;UI.timeCur.textContent=fmt(audioEl.currentTime||0);UI.timeline.value=(audioEl.currentTime/d).toFixed(3)});
UI.timeline.addEventListener('input',()=>{const d=audioEl.duration||1;audioEl.currentTime=+UI.timeline.value*d});
UI.playerVol.addEventListener('input',()=>{playerMasterGain.gain.value=(+UI.playerVol.value)/100;UI.playerVolKnob.style.setProperty('--angle',knobAngle(UI.playerVol)+'deg')});
playerMasterGain.gain.value=(+UI.playerVol.value)/100;UI.playerVolKnob.style.setProperty('--angle',knobAngle(UI.playerVol)+'deg');
const demo=Array.from({length:9},(_,i)=>({title:`Item ${i+1}`}));(function(items){const rail=UI.libRail;rail.innerHTML='';items.forEach(o=>{const d=document.createElement('div');d.className='tcard';d.innerHTML='<div class="thumb"></div><div class="t">'+o.title+'</div>';rail.appendChild(d)})})(demo);
UI.libNext.addEventListener('click',()=>UI.libRail.scrollBy({left:UI.libRail.clientWidth,behavior:'smooth'}));
UI.libPrev.addEventListener('click',()=>UI.libRail.scrollBy({left:-UI.libRail.clientWidth,behavior:'smooth'}));
const scope=document.getElementById('scope');const g=scope.getContext('2d');let freeze=false,mode='both';
document.getElementById('scopeFreeze').addEventListener('click',()=>freeze=!freeze);
document.getElementById('scopeMode').addEventListener('click',e=>{mode=mode==='both'?'gen':mode==='gen'?'player':'both';e.target.textContent=mode==='both'?'Both':(mode==='gen'?'Gen':'Player')});
const bufG=new Uint8Array(1024),bufP=new Uint8Array(1024);
function drawGrid(){g.fillStyle='#0b0f16';g.fillRect(0,0,scope.width,scope.height);g.strokeStyle='rgba(255,255,255,.08)';g.lineWidth=1;for(let x=0;x<scope.width;x+=50){g.beginPath();g.moveTo(x,0);g.lineTo(x,scope.height);g.stroke()}for(let y=0;y<scope.height;y+=50){g.beginPath();g.moveTo(0,y);g.lineTo(scope.width,y);g.stroke()}}
function tick(){if(!freeze){drawGrid();if(mode!=='player'&&genAnalyser){genAnalyser.getByteTimeDomainData(bufG);g.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#ffd166';g.lineWidth=2;g.beginPath();for(let i=0;i<bufG.length;i++){const x=i/bufG.length*scope.width;const y=bufG[i]/255*scope.height;i?g.lineTo(x,y):g.moveTo(x,y)}g.stroke()}if(mode!=='gen'&&playerAnalyser){playerAnalyser.getByteTimeDomainData(bufP);g.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent2')||'#00b7ff';g.lineWidth=2;g.beginPath();for(let i=0;i<bufP.length;i++){const x=i/bufP.length*scope.width;const y=bufP[i]/255*scope.height;i?g.lineTo(x,y):g.moveTo(x,y)}g.stroke()}}requestAnimationFrame(tick)}requestAnimationFrame(tick);
(function(){let d=false;const r=()=>{if(d)return;try{genCtx.resume();playerCtx.resume()}catch(e){}d=true;['touchstart','touchend','mousedown','keydown'].forEach(ev=>window.removeEventListener(ev,r))};['touchstart','touchend','mousedown','keydown'].forEach(ev=>window.addEventListener(ev,r,{passive:true}))})();
</script>



<!-- Generator transport override v3 (Play/Pause only, Stop removed) -->
<script>
(function(){
  if (!window.UI) return;

  // Remove Stop button if still in DOM
  if (UI.genStop && UI.genStop.parentNode) {
    UI.genStop.parentNode.removeChild(UI.genStop);
    UI.genStop = null;
  }

  // State machine
  let genState = 'stopped'; // 'playing' | 'paused' | 'stopped'
  let desiredL = (+UI.lLevel?.value || 50)/100;
  let desiredR = (+UI.rLevel?.value || 50)/100;

  function ensureGraph(){
    if (!window.lGain || !window.rGain || !window.lOsc || !window.rOsc || !window.genMasterGain || !window.genPan){
      if (typeof setupGenerator === 'function') setupGenerator();
    }
  }
  function readDesired(){ desiredL = (+UI.lLevel.value)/100; desiredR = (+UI.rLevel.value)/100; }
  function applyMaster(){ if (window.genMasterGain) genMasterGain.gain.value = (+UI.masterGain.value)/100;
                          if (window.genPan) genPan.pan.value = (+UI.balance.value)/100; }
  function applyDesired(){ if (window.lGain) lGain.gain.value = desiredL; if (window.rGain) rGain.gain.value = desiredR; }
  function muteChannels(){ if (window.lGain) lGain.gain.value = 0; if (window.rGain) rGain.gain.value = 0; }
  function labelPlay(){ if(UI.genPlayPause) UI.genPlayPause.textContent = '▶'; }
  function labelPause(){ if(UI.genPlayPause) UI.genPlayPause.textContent = '⏸'; }

  async function startGenerator(){
    ensureGraph();
    try { await genCtx.resume(); } catch(e){}
    readDesired();
    applyMaster();
    applyDesired();    // only here we unmute
    genState = 'playing';
    labelPause();
  }
  function pauseGenerator(){
    muteChannels();    // keep desired, but muted
    genState = 'paused';
    labelPlay();
  }

  // Rebind Play/Pause
  if (UI.genPlayPause) {
    const b = UI.genPlayPause.cloneNode(true);
    UI.genPlayPause.parentNode.replaceChild(b, UI.genPlayPause);
    UI.genPlayPause = b;
    UI.genPlayPause.addEventListener('click', ()=>{
      if (genState !== 'playing') startGenerator();
      else pauseGenerator();
    });
    labelPlay();
  }

  // Sliders/knobs never cause playback when paused/stopped
  function onLevelChange(){
    readDesired();
    if (genState === 'playing') applyDesired();
  }
  ['input','change'].forEach(ev=>{
    UI.lLevel && UI.lLevel.addEventListener(ev, onLevelChange);
    UI.rLevel && UI.rLevel.addEventListener(ev, onLevelChange);
    UI.masterGain && UI.masterGain.addEventListener(ev, ()=>{ if (genState === 'playing') applyMaster(); });
    UI.balance && UI.balance.addEventListener(ev, ()=>{ if (genState === 'playing') applyMaster(); });
  });

  // Start muted
  muteChannels();
  labelPlay();
})();
</script>


<script>
(function(){
  function updateHarmVisibility(){
    var cntEl = document.getElementById('harmCount');
    if(!cntEl) return;
    var n = parseInt(cntEl.value||'0')||0;
    for(var i=1;i<=4;i++){
      var row = document.getElementById('h'+i+'row');
      if(row){ row.style.display = (i<=n ? '' : 'none'); }
    }
  }
  var hc = document.getElementById('harmCount');
  if(hc){
    ['input','change'].forEach(function(ev){ hc.addEventListener(ev, updateHarmVisibility); });
    // initialize once on load
    updateHarmVisibility();
  }
})();
</script>


<script>
(function(){
  function fix2(v){ return (Math.round(v*100)/100).toFixed(2); }
  function bindFix2(inputId){
    var el = document.getElementById(inputId);
    if(!el) return;
    function commit(){
      var v = parseFloat(el.value);
      if (!isFinite(v)) return;
      v = Math.min(Math.max(v, parseFloat(el.min||'0')), parseFloat(el.max||'25000'));
      el.value = fix2(v);
    }
    ['change','blur'].forEach(function(ev){ el.addEventListener(ev, commit); });
    el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); commit(); el.dispatchEvent(new Event('change', {bubbles:true})); }});
  }
  bindFix2('lFreqIn');
  bindFix2('rFreqIn');
})();
</script>


<script>
// ===== Library: server-backed tree with thumbnails =====
(function(){
  const rail = document.getElementById('libRail');
  const prevBtn = document.getElementById('libPrev');
  const nextBtn = document.getElementById('libNext');
  const audio = document.getElementById('audio');

  const PAGE = 3;
  let curPath = '';
  let folders = [];
  let files = [];
  let page = 0;
  const stack = [];

  const backBtn = document.createElement('button');
  backBtn.className = 'btn';
  backBtn.textContent = 'Back';
  backBtn.style.marginRight = '8px';
  backBtn.onclick = ()=>{
    if (!stack.length) return;
    curPath = stack.pop(); window.curPath = curPath;
    page = 0;
    fetchAndRender(curPath, false);
  };
  rail.parentNode.insertBefore(backBtn, rail);
  const refreshBtn = document.createElement('button');
  refreshBtn.className='btn'; refreshBtn.textContent='Refresh';
  refreshBtn.style.margin='0 0 0 8px';
  refreshBtn.onclick = ()=>{ if (window.fetchAndRender) window.fetchAndRender(window.curPath||''); };
  rail.parentNode.insertBefore(refreshBtn, rail);
  setInterval(()=>{ if (window.fetchAndRender) window.fetchAndRender(window.curPath||''); }, 15000);

  function api(path=''){
    
  // Supabase mode: client-side listing
  if (window.USE_SUPABASE && window.supabase && window.SUPABASE_URL && window.SUPABASE_KEY) {
    const sb = window.__sb || (window.__sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY));
    const bucket = window.SUPABASE_BUCKET || 'media';
    const prefix = (path||'').replace(/^\//,'');

    return sb.storage.from(bucket).list(prefix, {
      limit: 1000,
      sortBy: { column: 'name', order: 'asc' }
    }).then(({ data, error }) => {
      if (error) throw error;
      const entries = data || [];
      const mediaBase = (window.SUPABASE_PUBLIC_BASE||'').replace(/\/+$/,'');
      const t = window.CACHE_BUST ? ('?t=' + Date.now()) : '';

      const folders = [];
      const files = [];

      for (const e of entries) {
        const name = e.name;
        const isFolder = !/\./.test(name);
        const full = (prefix ? prefix + '/' : '') + name;

        if (isFolder) {
          const thumb = mediaBase + '/' + full + '/folder.png' + t;
          folders.push({ name, path: full, thumb });
        } else {
          const isAudio = /\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(name);
          if (isAudio) {
            const base = name.replace(/\.[^.]+$/, '');
            const url = mediaBase + '/' + full + t;
            const thumb = mediaBase + '/' + (prefix?prefix + '/':'') + base + '.png' + t;
            files.push({ name, path: full, url, thumb });
          }
        }
      }
      return { folders, files };
    });
  }

  // Default: server API
  const url = '/api/tree' + (path ? ('?path=' + encodeURIComponent(path)) : '');
  return fetch(url).then(r=>{
    if(!r.ok) throw new Error('Library fetch failed');
    return r.json();
  });

    });
  }

  function renderItems(){
    rail.innerHTML='';
    const all = [...folders.map(f=>({type:'folder', ...f})), ...files.map(f=>({type:'file', ...f}))];
    const start = page*PAGE;
    const slice = all.slice(start, start+PAGE);
    slice.forEach(item=>{
      const d = document.createElement('div');
      d.className = 'tcard';
      const img = document.createElement('div');
      img.className='thumb';
      if(item.thumb){
        img.style.backgroundImage = 'url(' + item.thumb + ')';
        img.style.backgroundSize = 'cover';
        img.style.backgroundPosition = 'center';
      }
      const t = document.createElement('div');
      t.className = 't';
      t.textContent = item.name;
      d.appendChild(img); d.appendChild(t);
      d.onclick = ()=>{
        if(item.type==='folder'){
          stack.push(curPath);
          curPath = item.path; window.curPath = curPath;
          page = 0;
          fetchAndRender(curPath, false);
        }else{
          audio.src = item.url;
          audio.load();
          audio.play().catch(()=>{});
        }
      };
      rail.appendChild(d);
    });
    const totalPages = Math.ceil((folders.length + files.length)/PAGE);
    prevBtn.disabled = page<=0;
    nextBtn.disabled = page>=totalPages-1;
  }

  function fetchAndRender(path='', keepStack=true){
    api(path).then(data=>{
      folders = (data.folders||[]);
      files   = (data.files||[]);
      renderItems();
    }
  // expose for external refresh
  window.fetchAndRender = fetchAndRender;
  window.curPath = curPath;
).catch(err=>{
      rail.innerHTML = '<div class="t small">Failed to load library</div>';
    });
  }

  prevBtn.addEventListener('click', ()=>{ if(page>0){ page--; renderItems(); } });
  nextBtn.addEventListener('click', ()=>{ page++; renderItems(); });

  fetchAndRender('');
})();
</script>


<script>
// Audio Player: robust local file load + UI sync
(function(){
  const file = document.getElementById('filePicker');
  const audio = document.getElementById('audio');
  const ppBtn = document.getElementById('playPause');
  const stopBtn = document.getElementById('stop');
  const timeline = document.getElementById('timeline');
  const timeCur = document.getElementById('timeCur');
  const timeDur = document.getElementById('timeDur');

  function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }

  if (file && audio){
    file.addEventListener('change', async ()=>{
      const f = file.files && file.files[0];
      if(!f) return;
      try {
        const url = URL.createObjectURL(f);
        audio.src = url;
        audio.load();
        // Resume the audio context for autoplay (Safari/iOS needs gesture; file change is a gesture)
        if (window.playerCtx && playerCtx.state === 'suspended') { try { await playerCtx.resume(); } catch(e){} }
        await audio.play().catch(()=>{});
        if (ppBtn) ppBtn.textContent = '⏸';
      } catch(e) {
        console.warn('Audio load error:', e);
      }
    });
  }

  if (audio && ppBtn){
    ppBtn.addEventListener('click', async ()=>{
      if (window.playerCtx && playerCtx.state === 'suspended') { try { await playerCtx.resume(); } catch(e){} }
      if (audio.paused){ try { await audio.play(); ppBtn.textContent='⏸'; } catch(e){} }
      else { audio.pause(); ppBtn.textContent='▶/⏸'; }
    });
  }

  if (audio && stopBtn){
    stopBtn.addEventListener('click', ()=>{
      audio.pause();
      audio.currentTime = 0;
      if (ppBtn) ppBtn.textContent='▶/⏸';
    });
  }

  if (audio){
    audio.addEventListener('loadedmetadata', ()=>{
      if (timeDur) timeDur.textContent = fmt(audio.duration||0);
      if (timeline) timeline.value = 0;
    });
    audio.addEventListener('timeupdate', ()=>{
      const d = audio.duration || 1;
      if (timeCur) timeCur.textContent = fmt(audio.currentTime||0);
      if (timeline) timeline.value = (audio.currentTime/d).toFixed(3);
    });
  }
})();
</script>


<script>
// Generator Play/Pause: enforce gains on pause, no auto-start from sliders
(function(){
  if (!window.UI) return;
  let state = 'paused'; // 'playing'|'paused'

  function ensureGraph(){
    if (!window.lGain || !window.rGain || !window.lOsc || !window.rOsc){
      if (typeof setupGenerator === 'function') setupGenerator();
    }
  }
  function desired(){
    return {
      L: (+UI.lLevel?.value || 50)/100,
      R: (+UI.rLevel?.value || 50)/100,
      M: (+UI.masterGain?.value || 50)/100,
      B: (+UI.balance?.value || 0)/100
    };
  }
  function applyDesired(d){
    if (window.genMasterGain) genMasterGain.gain.value = d.M;
    if (window.genPan) genPan.pan.value = d.B;
    if (window.lGain) lGain.gain.value = d.L;
    if (window.rGain) rGain.gain.value = d.R;
  }
  function mute(){
    if (window.lGain) lGain.gain.value = 0;
    if (window.rGain) rGain.gain.value = 0;
  }
  async function play(){
    ensureGraph();
    try { await genCtx.resume(); } catch(e){}
    applyDesired(desired());
    state = 'playing';
    if (UI.genPlayPause) UI.genPlayPause.textContent = '⏸';
  }
  function pause(){
    mute();
    state = 'paused';
    if (UI.genPlayPause) UI.genPlayPause.textContent = '▶/⏸';
  }

  // Rebind the button to avoid duplicate listeners
  if (UI.genPlayPause){
    const b = UI.genPlayPause.cloneNode(true);
    UI.genPlayPause.parentNode.replaceChild(b, UI.genPlayPause);
    UI.genPlayPause = b;
    b.addEventListener('click', ()=>{
      if (state !== 'playing') play();
      else pause();
    });
    // initial
    pause();
  }

  // Sliders: only apply while playing; never unpause implicitly
  ['input','change'].forEach(ev=>{
    UI.lLevel && UI.lLevel.addEventListener(ev, ()=>{ if (state==='playing') applyDesired(desired()); });
    UI.rLevel && UI.rLevel.addEventListener(ev, ()=>{ if (state==='playing') applyDesired(desired()); });
    UI.masterGain && UI.masterGain.addEventListener(ev, ()=>{ if (state==='playing') applyDesired(desired()); });
    UI.balance && UI.balance.addEventListener(ev, ()=>{ if (state==='playing') applyDesired(desired()); });
  });
})();
</script>


<script>
/* ===== 5D SONIC hotfix: scope draw + generator pause + player load ===== */
(function(){
  /* ---- Oscilloscope ---- */
  const canvas = document.getElementById('scope');
  if (canvas) {
    const ctx2d = canvas.getContext('2d');

    // Prefer existing contexts; else create light fallbacks
    const gCtx = (typeof genCtx !== 'undefined') ? genCtx : new (window.AudioContext||window.webkitAudioContext)();
    const pCtx = (typeof playerCtx !== 'undefined') ? playerCtx : new (window.AudioContext||window.webkitAudioContext)();

    // Reuse or create analysers
    window.genAnalyser = window.genAnalyser || gCtx.createAnalyser();
    window.playerAnalyser = window.playerAnalyser || pCtx.createAnalyser();
    genAnalyser.fftSize = 2048;
    playerAnalyser.fftSize = 2048;

    // Try to fan-out from master nodes if available
    try { if (typeof genMasterGain !== 'undefined') genMasterGain.connect(genAnalyser); } catch(e){}
    try { if (typeof playerMasterGain !== 'undefined') playerMasterGain.connect(playerAnalyser); } catch(e){}

    const gBuf = new Uint8Array(genAnalyser.frequencyBinCount);
    const pBuf = new Uint8Array(playerAnalyser.frequencyBinCount);

    function drawGrid(){
      const w = canvas.width, h = canvas.height;
      ctx2d.clearRect(0,0,w,h);
      // background
      ctx2d.fillStyle = '#101522';
      ctx2d.fillRect(0,0,w,h);
      // grid
      ctx2d.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx2d.lineWidth = 1;
      for (let x=0; x<=w; x+=w/10){ ctx2d.beginPath(); ctx2d.moveTo(x,0); ctx2d.lineTo(x,h); ctx2d.stroke(); }
      for (let y=0; y<=h; y+=h/4){ ctx2d.beginPath(); ctx2d.moveTo(0,y); ctx2d.lineTo(w,y); ctx2d.stroke(); }
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      drawGrid();

      // generator (emerald)
      if (genAnalyser){
        const tbuf = new Uint8Array(genAnalyser.fftSize);
        genAnalyser.getByteTimeDomainData(tbuf);
        ctx2d.beginPath();
        for (let i=0;i<tbuf.length;i++){
          const x = (i / (tbuf.length-1)) * w;
          const y = (tbuf[i]/255) * h;
          (i===0) ? ctx2d.moveTo(x,y) : ctx2d.lineTo(x,y);
        }
        ctx2d.strokeStyle = 'rgba(0,230,180,0.9)';
        ctx2d.lineWidth = 2;
        ctx2d.stroke();
      }

      // player (blue)
      if (playerAnalyser){
        const tbuf2 = new Uint8Array(playerAnalyser.fftSize);
        playerAnalyser.getByteTimeDomainData(tbuf2);
        ctx2d.beginPath();
        for (let i=0;i<tbuf2.length;i++){
          const x = (i / (tbuf2.length-1)) * w;
          const y = (tbuf2[i]/255) * h;
          (i===0) ? ctx2d.moveTo(x,y) : ctx2d.lineTo(x,y);
        }
        ctx2d.strokeStyle = 'rgba(80,160,255,0.9)';
        ctx2d.lineWidth = 2;
        ctx2d.stroke();
      }

      requestAnimationFrame(draw);
    }
    draw();
  }

  /* ---- Generator Play/Pause: gate by master gain ---- */
  (function(){
    const btn = document.getElementById('genPlayPause');
    if (!btn) return;
    let paused = true;
    let lastMaster = 0.5;

    // Find master gain control element if exists
    const masterInput = document.getElementById('masterGain');

    function getMasterTarget(){
      if (masterInput) {
        const v = (+masterInput.value||50)/100;
        return Math.max(0, Math.min(1, v));
      }
      return lastMaster;
    }
    function setMaster(val){
      try {
        if (typeof genMasterGain !== 'undefined') {
          genMasterGain.gain.setTargetAtTime(val, (genCtx||window.AudioContext).currentTime||0, 0.01);
        }
      } catch(e){}
    }

    // initialize to paused (mute)
    setTimeout(()=>{ setMaster(0); }, 0);

    btn.addEventListener('click', async ()=>{
      try { if (genCtx && genCtx.state==='suspended') await genCtx.resume(); } catch(e){}
      if (paused){
        lastMaster = getMasterTarget();
        setMaster(lastMaster);
        btn.textContent = '⏸';
      } else {
        lastMaster = getMasterTarget();
        setMaster(0);
        btn.textContent = '▶/⏸';
      }
      paused = !paused;
    });

    // prevent sliders from re-starting audio; only apply if not paused
    ['lLevel','rLevel','balance','masterGain'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', ()=>{
        if (!paused){
          // let the main app apply its own level routing; we just make sure master stays at intended level
          lastMaster = getMasterTarget();
          setMaster(lastMaster);
        } else {
          setMaster(0);
        }
      });
    });
  })();

  /* ---- Audio Player: local file load + play ---- */
  (function(){
    const file = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
    const audio = document.getElementById('audio');
    const pp = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
    if (!audio) return;
    if (file){
      file.addEventListener('change', async ()=>{
        const f = file.files && file.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        audio.src = url;
        audio.load();
        try { if (playerCtx && playerCtx.state==='suspended') await playerCtx.resume(); } catch(e){}
        audio.play().catch(()=>{});
        if (pp) pp.textContent = '⏸';
      });
    }
    if (pp){
      pp.addEventListener('click', async ()=>{
        try { if (playerCtx && playerCtx.state==='suspended') await playerCtx.resume(); } catch(e){}
        if (audio.paused){ try{ await audio.play(); if(pp) pp.textContent='⏸'; }catch(e){} }
        else { audio.pause(); if(pp) pp.textContent='▶/⏸'; }
      });
    }
  })();
})();
</script>


<script>
/* ===== 5D SONIC: Audio Player volume + explicit controls (no autoplay) ===== */
(function(){
  const audio = document.getElementById('audio');
  if (!audio) return;

  // Controls (support multiple possible IDs)
  const file = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
  const btnPlay = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
  const btnStop = document.getElementById('audioStop') || document.getElementById('stop');
  const volInput = document.getElementById('playerVolume') || document.getElementById('playerVol') || document.getElementById('volume') || document.querySelector('[data-role="player-volume"]');
  const timeline = document.getElementById('timeline');
  const timeCur = document.getElementById('timeCur');
  const timeDur = document.getElementById('timeDur');

  // Create (or reuse) AudioContext + nodes for volume + analyser
  window.playerCtx = window.playerCtx || new (window.AudioContext||window.webkitAudioContext)();
  const ctx = window.playerCtx;

  // If we already created a source for this <audio>, reuse it
  if (!audio.__mediaNode) {
    audio.__mediaNode = ctx.createMediaElementSource(audio);
  }
  window.playerMasterGain = window.playerMasterGain || ctx.createGain();
  const gain = window.playerMasterGain;
  try {
    // Connect pipeline: audio element -> gain -> destination (+ analyser if exists elsewhere)
    audio.__mediaNode.disconnect();
  } catch(e){}
  audio.__mediaNode.connect(gain);
  gain.connect(ctx.destination);

  // ---------- Volume control ----------
  function setGainFromUI() {
    if (!volInput) return;
    // Accept 0..100(slider) or 0..1(knob). Default to 50%
    let v = parseFloat(volInput.value);
    if (!isFinite(v)) v = 50;
    if (v > 1.01) v = v / 100; // normalize 0..100 -> 0..1
    v = Math.min(1, Math.max(0, v));
    gain.gain.setTargetAtTime(v, ctx.currentTime, 0.01);
  }
  if (volInput) {
    // initialize & bind
    setGainFromUI();
    ['input','change'].forEach(evt => volInput.addEventListener(evt, setGainFromUI));
  }

  // ---------- File open (NO AUTOPLAY) ----------
  if (file) {
    file.addEventListener('change', () => {
      const f = file.files && file.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      audio.src = url;
      audio.load();
      // Do not autoplay; just set UI to "Play"
      if (btnPlay) btnPlay.textContent = 'Play';
    });
  }

  // ---------- Play/Pause/Stop controls ----------
  async function ensureCtx() {
    if (ctx.state === 'suspended') {
      try { await ctx.resume(); } catch(e){}
    }
  }
  if (btnPlay) {
    btnPlay.addEventListener('click', async () => {
      await ensureCtx();
      if (audio.paused) {
        try { await audio.play(); btnPlay.textContent = 'Pause'; } catch(e){}
      } else {
        audio.pause(); btnPlay.textContent = 'Play';
      }
    });
  }
  if (btnStop) {
    btnStop.addEventListener('click', () => {
      audio.pause();
      audio.currentTime = 0;
      if (btnPlay) btnPlay.textContent = 'Play';
    });
  }

  // ---------- Timeline + counters ----------
  function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  if (audio) {
    audio.addEventListener('loadedmetadata', () => {
      if (timeDur) timeDur.textContent = fmt(audio.duration || 0);
      if (timeline) timeline.value = 0;
    });
    audio.addEventListener('timeupdate', () => {
      const d = audio.duration || 1;
      if (timeCur) timeCur.textContent = fmt(audio.currentTime || 0);
      if (timeline) timeline.value = (audio.currentTime / d) * 100;
    });
  }
  if (timeline) {
    ['input','change'].forEach(evt => timeline.addEventListener(evt, () => {
      const d = audio.duration || 0;
      const pct = Math.max(0, Math.min(100, parseFloat(timeline.value || '0')));
      if (d > 0) audio.currentTime = (pct / 100) * d;
    }));
  }
})();
</script>


<!-- 5D SONIC: Audio Player volume + explicit controls (no autoplay) -->
<script>
(function(){
  const audio = document.getElementById('audio');
  if (!audio) return;

  const file   = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
  const btnPP  = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
  const btnStop= document.getElementById('audioStop')      || document.getElementById('stop');
  const volIn  = document.getElementById('playerVolume')   || document.getElementById('playerVol') || document.getElementById('volume') || document.querySelector('[data-role="player-volume"]');

  audio.autoplay = false;
  audio.removeAttribute('autoplay');

  let ctx, gain;
  try {
    ctx = window.playerCtx || new (window.AudioContext || window.webkitAudioContext)();
    window.playerCtx = ctx;
    if (!audio.__mediaNode) audio.__mediaNode = ctx.createMediaElementSource(audio);
    try { audio.__mediaNode.disconnect(); } catch(e){}
    gain = window.playerMasterGain || ctx.createGain();
    window.playerMasterGain = gain;
    audio.__mediaNode.connect(gain);
    gain.connect(ctx.destination);
  } catch (e) {
    ctx = null; gain = null;
  }

  function setVolumeFromUI() {
    if (!volIn) return;
    let v = parseFloat(volIn.value);
    if (!isFinite(v)) v = 50;
    if (v > 1.01) v = v / 100;
    v = Math.max(0, Math.min(1, v));
    if (gain && ctx) gain.gain.setTargetAtTime(v, ctx.currentTime, 0.01);
    audio.volume = v;
  }
  if (volIn) {
    setVolumeFromUI();
    ['input','change'].forEach(ev => volIn.addEventListener(ev, setVolumeFromUI));
  }

  if (file) {
    file.addEventListener('change', () => {
      const f = file.files && file.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      audio.src = url;
      audio.load();
      const onLoaded = () => {
        audio.pause(); audio.currentTime = 0;
        if (btnPP) btnPP.textContent = 'Play';
        audio.removeEventListener('loadeddata', onLoaded);
      };
      audio.addEventListener('loadeddata', onLoaded);
      if (btnPP) btnPP.textContent = 'Play';
    });
  }

  async function ensureCtx() {
    if (!ctx) return;
    if (ctx.state === 'suspended') { try { await ctx.resume(); } catch(e){} }
  }

  if (btnPP) {
    const clone = btnPP.cloneNode(true);
    btnPP.parentNode.replaceChild(clone, btnPP);
    const playBtn = clone;
    playBtn.addEventListener('click', async () => {
      await ensureCtx();
      if (audio.paused) {
        try { await audio.play(); playBtn.textContent = 'Pause'; } catch(e){}
      } else {
        audio.pause(); playBtn.textContent = 'Play';
      }
    });
  }

  if (btnStop) {
    const cloneS = btnStop.cloneNode(true);
    btnStop.parentNode.replaceChild(cloneS, btnStop);
    cloneS.addEventListener('click', () => {
      audio.pause();
      audio.currentTime = 0;
      const p = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
      if (p) p.textContent = 'Play';
    });
  }

  const timeline = document.getElementById('timeline');
  const timeCur  = document.getElementById('timeCur');
  const timeDur  = document.getElementById('timeDur');
  function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }

  audio.addEventListener('loadedmetadata', () => {
    if (timeDur) timeDur.textContent = fmt(audio.duration || 0);
    if (timeline) timeline.value = 0;
  });
  audio.addEventListener('timeupdate', () => {
    const d = audio.duration || 1;
    if (timeCur) timeCur.textContent = fmt(audio.currentTime || 0);
    if (timeline) timeline.value = ((audio.currentTime / d) * 100) || 0;
  });
  if (timeline) {
    ['input','change'].forEach(ev => timeline.addEventListener(ev, () => {
      const d = audio.duration || 0;
      const pct = Math.max(0, Math.min(100, parseFloat(timeline.value || '0')));
      if (d > 0) audio.currentTime = (pct / 100) * d;
    }));
  }
})();
</script>


<!-- 5D SONIC mini patch: player icons + accurate timeline + hide volume label -->
<style>
/* Hide volume label variants */
label[for="playerVolume"],
label[for="playerVol"],
label[for="volume"],
.player-volume-label { display:none !important; }
</style>
<script>
(function(){
  const audio = document.getElementById('audio');
  if (!audio) return;
  const btnPP  = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
  const btnStop= document.getElementById('audioStop')      || document.getElementById('stop');
  const timeline = document.getElementById('timeline');
  const timeCur  = document.getElementById('timeCur');
  const timeDur  = document.getElementById('timeDur');

  // 1) Play/Pause: use symbols
  if (btnPP){
    // set initial icon
    btnPP.textContent = '▶';
    // rebind to ensure icon toggle
    const clone = btnPP.cloneNode(true);
    btnPP.parentNode.replaceChild(clone, btnPP);
    clone.addEventListener('click', async ()=>{
      // ensure context resume if available
      try { if (window.playerCtx && playerCtx.state==='suspended') await playerCtx.resume(); } catch(e){}
      if (audio.paused) {
        try { await audio.play(); clone.textContent='⏸'; } catch(e){}
      } else {
        audio.pause(); clone.textContent='▶';
      }
    });
    // also switch icon when media ends
    audio.addEventListener('ended', ()=>{ clone.textContent='▶'; });
  }
  if (btnStop){
    // normalize stop icon to a symbol (optional; keeps existing if already icon)
    if (!btnStop.textContent.trim() || /stop/i.test(btnStop.textContent)) btnStop.textContent = '⏹';
    btnStop.addEventListener('click', ()=>{
      audio.pause(); audio.currentTime = 0;
      const p = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
      if (p) p.textContent = '▶';
    });
  }

  // 2) Accurate timeline: use seconds, not percent
  function fmt(t){ const m=Math.floor(t/60), s=Math.floor(t%60); return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }

  function configureTimeline(){
    if (!timeline) return;
    // Switch the slider to seconds domain
    const dur = isFinite(audio.duration) ? audio.duration : 0;
    timeline.min = 0;
    timeline.max = dur > 0 ? dur : 1; // avoid div-by-zero
    timeline.step = 0.01;
    timeline.value = 0;
    if (timeDur) timeDur.textContent = fmt(dur || 0);
    if (timeCur) timeCur.textContent = fmt(0);
  }

  function syncTimeline(){
    if (!timeline) return;
    if (!isFinite(audio.duration) || audio.duration <= 0) return;
    // Our listener runs after earlier ones, so we overwrite any percent-based writes
    timeline.value = audio.currentTime;
    if (timeCur) timeCur.textContent = fmt(audio.currentTime || 0);
  }

  audio.addEventListener('loadedmetadata', configureTimeline);
  audio.addEventListener('timeupdate', syncTimeline);

  if (timeline){
    ['input','change'].forEach(ev => timeline.addEventListener(ev, ()=>{
      const dur = isFinite(audio.duration) ? audio.duration : 0;
      if (dur > 0){
        // value is in seconds
        const v = parseFloat(timeline.value||'0');
        audio.currentTime = Math.max(0, Math.min(dur, v));
      }
    }));
  }

  // Ensure on file selection we reset icons and timeline (if earlier code didn't)
  const file = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
  if (file){
    file.addEventListener('change', ()=>{
      if (btnPP) { const p = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause'); if (p) p.textContent='▶'; }
      // timeline will be reconfigured on loadedmetadata
    });
  }
})();
</script>


<!-- 5D SONIC Library: server /api/tree thumbnail browser (robust, path-aware) -->
<style>
  /* Simple row for thumbnails */
  #libBar { display:flex; align-items:center; gap:8px; margin:6px 0; }
  #libRail { display:grid; grid-template-columns: repeat(3, minmax(80px,1fr)); gap:10px; }
  .thumb { background:#0f1422; border:1px solid #2a3250; border-radius:10px; padding:6px; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .thumb img { width:100%; height:90px; object-fit:cover; border-radius:8px; }
  .thumb .name { margin-top:8.0px; font-size:12px; color:#cfe0ff; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
  .thumb.dir { border-color:#4d5b86; }
  .thumb.file { border-color:#3d6fd6; }
  #libBack, #libRefresh { padding:6px 10px; border-radius:8px; border:1px solid #3a486f; background:#162036; color:#eaf2ff; cursor:pointer; }
  #libPath { color:#9fb7ff; font-size:12px; margin-left:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
</style>
<script>
(function(){
  // If containers don't exist, create a minimal bar + rail above the audio player
  let rail = document.getElementById('libRail');
  let bar  = document.getElementById('libBar');
  if (!rail) {
    rail = document.createElement('div'); rail.id = 'libRail';
    const anchor = document.getElementById('audio') || document.body;
    // create bar
    bar = document.createElement('div'); bar.id = 'libBar';
    const backBtn = document.createElement('button'); backBtn.id='libBack'; backBtn.textContent='Back';
    const refBtn  = document.createElement('button'); refBtn.id='libRefresh'; refBtn.textContent='Refresh';
    const pathLbl = document.createElement('span');   pathLbl.id='libPath'; pathLbl.textContent='/';
    bar.appendChild(backBtn); bar.appendChild(refBtn); bar.appendChild(pathLbl);
    anchor.parentNode.insertBefore(bar, anchor);
    anchor.parentNode.insertBefore(rail, anchor);
  }
  const backBtn = document.getElementById('libBack') || (function(){ const b=document.createElement('button'); b.id='libBack'; b.textContent='Back'; bar.prepend(b); return b; })();
  const refBtn  = document.getElementById('libRefresh') || (function(){ const b=document.createElement('button'); b.id='libRefresh'; b.textContent='Refresh'; bar.appendChild(b); return b; })();
  const pathLbl = document.getElementById('libPath') || (function(){ const s=document.createElement('span'); s.id='libPath'; s.textContent='/'; bar.appendChild(s); return s; })();

  const origin = location.origin; // expect same host:port as server when served via http://localhost:5178/...
  const API = (window.LUNA_API_BASE || (origin + '/api/tree'));
  const MEDIA = (window.LUNA_MEDIA_BASE || (origin + '/media/'));

  let curPath = '';
  const stack = [];

  async function fetchTree(path=''){
    const url = path ? (API + '?path=' + encodeURIComponent(path)) : API;
    try {
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    } catch (err) {
      console.warn('[5D SONIC] /api/tree fetch failed:', err);
      // UX hint when opened from file://
      if (location.protocol === 'file:') {
        console.warn('Open this client via http://localhost:5178/ to avoid CORS/file-origin issues.');
      }
      throw err;
    }
  }

  function normEntries(json){
    // Accept flexible shapes: {items:[...]}, {children:[...]}, or array itself
    const list = Array.isArray(json) ? json : (json.items || json.children || json.files || []);
    return list.map(it => {
      const type = it.type || (it.isDir ? 'dir' : (it.isFile ? 'file' : (it.items || it.children ? 'dir' : 'file')));
      const name = it.name || it.title || it.filename || 'untitled';
      const pth  = it.path || it.relpath || (curPath ? curPath + '/' + name : name);
      let thumb  = it.thumb || it.thumbnail || it.cover || null;
      let url    = it.url || it.src || null;
      // If url missing for files, derive from MEDIA + path
      if (!url && type === 'file') url = MEDIA + encodeURI(pth);
      // Normalize thumb to absolute
      if (thumb) {
        if (thumb.startsWith('/')) thumb = origin + thumb;
        else if (!/^https?:/i.test(thumb)) thumb = MEDIA + encodeURI(thumb.replace(/^media\//,''));
      } else {
        // guess a neighbor image with same basename
        const base = name.replace(/\.(mp3|wav|ogg|m4a|flac|aac)$/i, '');
        thumb = MEDIA + encodeURI((pth.replace(/\/[^\/]+$/,'/')) + base + '.jpg');
      }
      return { type, name, path: pth, thumb, url };
    });
  }

  function render(list){
    rail.innerHTML = '';
    list.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'thumb ' + (entry.type === 'dir' ? 'dir' : 'file');
      const img = document.createElement('img'); img.src = entry.thumb; img.alt = entry.name;
      const cap = document.createElement('div'); cap.className = 'name'; cap.textContent = entry.name;
      div.appendChild(img); div.appendChild(cap);
      div.onclick = () => {
        if (entry.type === 'dir') {
          stack.push(curPath);
          curPath = entry.path;
          pathLbl.textContent = '/' + curPath;
          fetchAndRender(curPath, true);
        } else {
          // Load into audio player
          const audio = document.getElementById('audio');
          const pp = document.getElementById('audioPlayPause') || document.getElementById('audPlayPause') || document.getElementById('playPause');
          if (audio) {
            audio.src = entry.url;
            audio.load();
            // do NOT autoplay; set play icon
            if (pp) pp.textContent = '▶';
          }
        }
      };
      rail.appendChild(div);
    });
    pathLbl.textContent = '/' + (curPath || '');
  }

  async function fetchAndRender(path='', keepStack=false){
    if (!keepStack) { stack.length = 0; }
    try {
      const json = await fetchTree(path);
      const entries = normEntries(json);
      // Sort: dirs first, then files; then name asc
      entries.sort((a,b)=> (a.type===b.type ? a.name.localeCompare(b.name) : (a.type==='dir' ? -1 : 1)));
      render(entries);
      window.fetchAndRender = fetchAndRender; // expose
      window.curPath = curPath;
    } catch(e){
      // Show a friendly hint
      rail.innerHTML = '<div style="color:#ffb4b4">Library fetch failed. Make sure to open this file via the server (e.g., http://localhost:5178/your-file.html) and that /api/tree is reachable.</div>';
    }
  }

  backBtn.onclick = ()=>{
    if (stack.length){
      curPath = stack.pop();
      fetchAndRender(curPath, true);
    } else {
      curPath = '';
      fetchAndRender('');
    }
  };
  refBtn.onclick = ()=> fetchAndRender(curPath || '', true);

  // initial load
  fetchAndRender('');
})();
</script>

<script>
/*
If you see 404 for MEDIA URLs, ensure your server maps the physical folder to /media, e.g.:
  app.use('/media', express.static('/Users/paulpark/Music/lunasonic_media'));
*/
</script>

<!-- === 5D SONIC: resilient Library bootstrap (no generator changes) === -->
<script>
(function(){
  // Config
  const ORIGIN = location.origin;
  const API    = window.LUNA_API_BASE   || (ORIGIN + '/api/tree');
  const MEDIA  = window.LUNA_MEDIA_BASE || (ORIGIN + '/media/');

  // 1) Find or build the Library panel contents by heading text
  function findLibraryPanel(){
    const hs = Array.from(document.querySelectorAll('h2, h3'));
    const hit = hs.find(h => /library/i.test(h.textContent||''));
    if(!hit) return null;
    // Prefer sibling container inside same panel
    const panel = hit.closest('.panel') || hit.parentElement;
    return panel || null;
  }

  function ensureControls(panel){
    // Create toolbar if missing
    let toolbar = panel.querySelector('.lib-toolbar');
    if(!toolbar){
      toolbar = document.createElement('div');
      toolbar.className = 'lib-toolbar';
      toolbar.style.display='flex'; toolbar.style.gap='8px'; toolbar.style.alignItems='center'; toolbar.style.margin='8px 0';
      panel.appendChild(toolbar);
    }
    let back = panel.querySelector('#libBack'); if(!back){ back = document.createElement('button'); back.id='libBack'; back.textContent='Back'; back.className='btn'; toolbar.appendChild(back); }
    let ref  = panel.querySelector('#libRefresh'); if(!ref){ ref = document.createElement('button'); ref.id='libRefresh'; ref.textContent='Refresh'; ref.className='btn'; toolbar.appendChild(ref); }
    let path = panel.querySelector('#libPath'); if(!path){ path = document.createElement('span'); path.id='libPath'; path.style.color='#a7b5d6'; path.style.marginLeft='6px'; toolbar.appendChild(path); }
    let grid = panel.querySelector('#libGrid'); if(!grid){
      grid = document.createElement('div'); grid.id='libGrid';
      grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(3, minmax(110px,1fr))'; grid.style.gap='10px';
      panel.appendChild(grid);
    }
    return {back:panel.querySelector('#libBack'), refresh:panel.querySelector('#libRefresh'), path:panel.querySelector('#libPath'), grid:panel.querySelector('#libGrid')};
  }

  // 2) Normalize server data -> common shape
  function normalize(items){
    return items.map(it=>{
      const type = it.type || (it.isFolder||it.kind==='folder' ? 'folder' : 'file');
      const name = it.name || 'untitled';
      const path = it.path || name;
      let thumb = it.thumb || null;
      let url   = it.url   || null;
      if(type==='folder'){
        thumb = MEDIA + encodeURIComponent(path) + '/folder.png';
      }else{
        if(!url) url = MEDIA + encodeURI(path);
        if(!thumb){
          const base = name.replace(/\.(mp3|wav|ogg|m4a|flac|aac)$/i,'');
          const dir  = path.replace(/\/[^\/]+$/,'/');
          thumb = MEDIA + encodeURI(dir + base + '.jpg');
        }
      }
      return {type,name,path,thumb,url};
    });
  }

  async function fetchTree(path=''){
    const url = path ? (API + '?path=' + encodeURIComponent(path)) : API;
    const res = await fetch(url);
    const data = await res.json();
    if (Array.isArray(data)) return normalize(data);
    if (data.items) return normalize(data.items);
    const folders = (data.folders||[]).map(f=>({type:'folder', ...f}));
    const files   = (data.files  ||[]).map(f=>({type:'file',   ...f}));
    return normalize([...folders, ...files]);
  }

  function card(entry){
    const wrap = document.createElement('div');
    wrap.className = 'thumb ' + (entry.type==='folder'?'dir':'file');
    wrap.style.background = '#0c1327';
    wrap.style.border = '1px solid #263354';
    wrap.style.borderRadius = '10px';
    wrap.style.padding = '6px';
    wrap.style.cursor = 'pointer';
    wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center';

    const img = document.createElement('img');
    img.alt = entry.name;
    img.src = entry.thumb;
    img.style.width='100%'; img.style.aspectRatio='1 / 1'; img.style.height='auto'; img.style.objectFit='cover'; img.style.borderRadius='8px'; img.style.background='#0b1022';
    img.onerror = function(){
      if (img.src.endsWith('/folder.png')) img.src = img.src.replace(/folder\.png$/, 'folder.jpg');
      else img.onerror = null;
    };

    const name = document.createElement('div');
    name.textContent = entry.name;
    name.style.marginTop='6px'; name.style.fontSize='12px'; name.style.color='#a7b5d6'; name.style.textAlign='center'; name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis'; name.style.width='100%';

    wrap.appendChild(img); wrap.appendChild(name);

    wrap.addEventListener('click', ()=>{
      if(entry.type==='folder'){
        stack.push(curPath); curPath = entry.path; update();
      }else{
        const audio = document.getElementById('audio') || document.querySelector('audio');
        if (audio){ audio.src = entry.url; const btn = document.getElementById('playPause') || document.querySelector('#playPause'); if(btn) btn.textContent='▶'; }
      }
    });

    return wrap;
  }

  // 3) Controller
  const panel = findLibraryPanel();
  if(!panel){ console.warn('[5D SONIC] Library panel not found'); return; }
  const UI = ensureControls(panel);
  let curPath = ''; const stack = [];

  async function update(){
    try{
      const list = await fetchTree(curPath);
      UI.grid.innerHTML='';
      list.forEach(it => UI.grid.appendChild(card(it)));
      UI.path.textContent = '/' + (curPath || '');
    }catch(e){
      UI.grid.innerHTML = '<div style="color:#ffb4b4">Library load failed</div>';
    }
  }

  if(UI.back) UI.back.onclick = ()=>{ curPath = stack.length ? stack.pop() : ''; update(); };
  if(UI.refresh) UI.refresh.onclick = ()=> update();

  // kick off after DOM is fully ready
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', update);
  else update();
})();
</script>


<script id="ensure-loadedname">
(function(){
  function ensureNameBox(){
    var nameBox = document.getElementById('loadedName');
    if (nameBox) return nameBox;
    var picker  = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
    if (picker && picker.parentElement){
      nameBox = document.createElement('span');
      nameBox.id = 'loadedName';
      picker.insertAdjacentElement('afterend', nameBox);
      return nameBox;
    }
    return null;
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureNameBox);
  } else {
    ensureNameBox();
  }
})();
</script>


<script id="library-trackSelected-listener">
(function(){
  function setName(name){
    var el = document.getElementById('loadedName') || document.querySelector('#loadedName');
    if(!el){
      var picker  = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
      if (picker && picker.parentElement){
        el = document.createElement('span');
        el.id = 'loadedName';
        picker.insertAdjacentElement('afterend', el);
      }
    }
    if (el) el.textContent = name || '';
  }
  document.addEventListener('library:trackSelected', function(e){
    setName(e && e.detail && e.detail.name);
  });
})();
</script>


<script id="inject-currenttrack">
(function(){
  function ensureCurrentTrack(){
    if (document.getElementById('currentTrack')) return;
    var timeline = document.getElementById('timeline');
    var container = document.createElement('div');
    container.id = 'currentTrack';
    var img = document.createElement('img'); img.id = 'currentThumb'; img.alt='thumbnail';
    var name = document.createElement('span'); name.id = 'currentName'; name.textContent = 'No track loaded';
    container.appendChild(img); container.appendChild(name);
    if (timeline && timeline.parentElement){
      timeline.parentElement.parentElement.insertBefore(container, timeline.parentElement);
    } else {
      // fallback: append near audio player section
      var playerPanel = document.querySelector('h2, h3');
      if (playerPanel && /Audio Player/i.test(playerPanel.textContent||'')){
        (playerPanel.parentElement||document.body).insertBefore(container, playerPanel.nextSibling);
      } else {
        document.body.insertBefore(container, document.body.firstChild);
      }
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensureCurrentTrack);
  else ensureCurrentTrack();
})();
</script>


<script id="currenttrack-listener">
(function(){
  function update(name, url){
    var nm = document.getElementById('currentName'); if(nm) nm.textContent = name||'';
    var th = document.getElementById('currentThumb');
    if(th && url){
      try{
        var jpg = url.replace(/\.(mp3|wav|ogg|m4a|flac|aac)(\?.*)?$/i, '.jpg$2'||'.jpg');
        if (!/\.jpg$/i.test(jpg)) jpg = url + '.jpg';
        th.src = jpg;
      }catch(e){}
    }
  }
  document.addEventListener('library:trackSelected', function(e){
    var d = e && e.detail || {}; update(d.name, d.url);
  });
  // Also hook manual file selection (hidden picker) if ever used
  var fp = document.getElementById('filePicker');
  if (fp) fp.addEventListener('change', function(ev){
    var f = ev.target.files && ev.target.files[0];
    if(!f) return;
    update(f.name, null);
  });
})();
</script>


<!-- 5D SONIC Overlay: safe current track display + library delegation (no audio graph changes) -->

<script id="overlay-currenttrack-safe">
(function(){
  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }

  ready(function(){
    // Hide native file picker
    try{
      var fp = document.getElementById('filePicker') || document.querySelector('input[type="file"]');
      if (fp) { fp.style.display='none'; var lbl = document.querySelector('label[for="filePicker"]'); if(lbl) lbl.style.display='none'; }
    }catch(e){}

    // Ensure currentTrack UI exists
    function ensureCurrentTrack(){
      var ct = document.getElementById('currentTrack');
      if (ct) return ct;
      var container = document.createElement('div');
      container.id = 'currentTrack';
      container.style.display='flex'; container.style.alignItems='center';
      container.style.gap='8px'; container.style.background='rgba(255,255,255,0.03)';
      container.style.border='1px solid rgba(255,255,255,0.08)';
      container.style.padding='6px 8px'; container.style.borderRadius='10px'; container.style.maxWidth='420px';

      var img = document.createElement('img'); img.id='currentThumb'; img.alt='thumbnail';
      img.style.width='40px'; img.style.height='40px'; img.style.objectFit='cover';
      img.style.borderRadius='8px'; img.style.background='#0b1022'; img.style.border='1px solid rgba(255,255,255,0.1)';
      var name = document.createElement('span'); name.id='currentName'; name.textContent='No track loaded';
      name.style.color='#a7b5d6'; name.style.fontSize='14px'; name.style.maxWidth='32ch';
      name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis';

      container.appendChild(img); container.appendChild(name);

      var timeline = document.getElementById('timeline');
      if (timeline && timeline.parentElement && timeline.parentElement.parentElement){
        try{ timeline.parentElement.parentElement.insertBefore(container, timeline.parentElement); }
        catch(e){ document.body.appendChild(container); }
      } else {
        document.body.appendChild(container);
      }
      return container;
    }
    ensureCurrentTrack();

    // Helper: set text into both currentName and loadedName (if present)
    function setNames(text){
      var nm = document.getElementById('currentName'); if(nm) nm.textContent = text || '';
      var lb = document.getElementById('loadedName') || document.querySelector('#loadedName'); if(lb) lb.textContent = text || '';
      // Some other handlers may overwrite shortly after; re-assert once.
      setTimeout(function(){ if(nm && !nm.textContent) nm.textContent = text || ''; if(lb && !lb.textContent) lb.textContent = text || ''; }, 50);
    }

    // Helper: set thumbnail, try candidates with fallback chain
    function setThumb(url, candidates){
      var th = document.getElementById('currentThumb'); if(!th) return;
      var list = candidates.filter(Boolean);
      if (url){
        var jpg = url.replace(/\.(mp3|wav|ogg|m4a|flac|aac)(\?.*)?$/i, '.jpg$2' || '.jpg');
        var png = url.replace(/\.(mp3|wav|ogg|m4a|flac|aac)(\?.*)?$/i, '.png$2' || '.png');
        list.push(jpg, png);
      }
      // Remove folder thumbs from candidates
      list = list.filter(function(s){ return !/folder\.(png|jpg)$/i.test(s||''); });
      var i = 0;
      function tryNext(){
        if (i >= list.length) return;
        var src = list[i++];
        th.onerror = tryNext;
        th.src = src;
      }
      tryNext();
    }

    // Event delegation for library clicks
    var libPanel = (function(){
      var hs = Array.from(document.querySelectorAll('h2,h3'));
      var hit = hs.find(h=>/library/i.test(h.textContent||''));
      return hit ? (hit.closest('.panel') || hit.parentElement) : null;
    })();
    var libGrid = document.getElementById('libGrid') || (libPanel && libPanel.querySelector('#libGrid')) || libPanel;
    if (libGrid){
      libGrid.addEventListener('click', function(e){
        var card = e.target.closest('.thumb, .dir, .file'); if(!card) return;
        var kind = (card.getAttribute('data-kind')||'').toLowerCase();
        var isFolder = (kind==='folder') || card.classList.contains('dir');
        if (isFolder) return; // folders handled elsewhere

        var path = card.getAttribute('data-path') || '';
        var name = (card.querySelector('.name') && card.querySelector('.name').textContent.trim()) || (path.split('/').pop()) || '';
        // derive url if not present
        var url = card.getAttribute('data-url') || null;
        if (!url && path) {
          var media = (window.LUNA_MEDIA_BASE || (location.origin + '/media/'));
          url = media + encodeURI(path);
        }
        // candidates for thumb: data-thumb, card <img>, derived from url (.jpg/.png)
        var cand = [];
        var dataThumb = card.getAttribute('data-thumb'); if(dataThumb) cand.push(dataThumb);
        var img = card.querySelector('img'); if(img && img.src) cand.push(img.src);

        setNames(name);
        setThumb(url, cand);

        // Signal for any external listeners
        try{ document.dispatchEvent(new CustomEvent('library:trackSelected',{detail:{name,url}})); }catch(e){}
      });
    }

    // Fallback: if <audio>.src changes, populate name (thumb stays as-is)
    var audio = document.getElementById('audio') || document.querySelector('audio');
    if (audio){
      var last = audio.currentSrc || audio.src;
      setInterval(function(){
        var now = audio.currentSrc || audio.src;
        if (now && now !== last){
          last = now;
          setNames(now.split('/').pop());
        }
      }, 400);
    }
  });
})();
</script>



<script id="overlay-remove-scope-buttons-and-highlight">
(function(){
  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
  ready(function(){
    // A) Remove oscilloscope "Both" & "Freeze" buttons if present
    try{
      var btns = Array.from(document.querySelectorAll('button'));
      btns.forEach(function(b){
        var t = (b.textContent||'').trim().toLowerCase();
        if (t==='both' || t==='freeze') {
          // Remove listeners by cloning, then remove node
          var clone = b.cloneNode(true); b.replaceWith(clone); clone.remove();
        }
      });
      // Remove any toolbar container that becomes empty
      var toolbars = Array.from(document.querySelectorAll('.osc-toolbar, .scope-toolbar'));
      toolbars.forEach(function(tb){ if(!tb.querySelector('button')) tb.remove(); });
    }catch(e){}

    // B) Thumbnail highlight: add .thumb--active to the clicked card and remove from others
    var libPanel = (function(){
      var hs = Array.from(document.querySelectorAll('h2,h3'));
      var hit = hs.find(h=>/library/i.test(h.textContent||''));
      return hit ? (hit.closest('.panel') || hit.parentElement) : null;
    })();
    var libGrid = document.getElementById('libGrid') || (libPanel && libPanel.querySelector('#libGrid')) || libPanel;
    function clearActive(){
      Array.from(document.querySelectorAll('.thumb.thumb--active')).forEach(function(el){ el.classList.remove('thumb--active'); });
    }
    if (libGrid){
      libGrid.addEventListener('click', function(e){
        var card = e.target.closest('.thumb, .dir, .file'); if(!card) return;
        // highlight only for file items (optional). If also for folders, remove the condition below.
        clearActive();
        card.classList.add('thumb--active');
      });
    }
    // Also respond to our custom event (e.g., when selection happens programmatically)
    document.addEventListener('library:trackSelected', function(e){
      var path = e && e.detail && e.detail.path;
      var match = path && document.querySelector('.thumb[data-path="'+CSS.escape(path)+'"]');
      if(match){ clearActive(); match.classList.add('thumb--active'); }
    });
  });
})();
</script>


<!-- Minimal status box to verify API/MEDIA reachability on this origin -->
<style>
#cloudStatus{font:14px/1.4 -apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#111827;color:#e5e7eb;padding:10px 12px;border-radius:10px;border:1px solid #374151;max-width:520px;margin:8px 0}
#cloudStatus b{color:#93c5fd} #cloudStatus .ok{color:#34d399} #cloudStatus .bad{color:#f87171}
#cloudStatus details{margin-top:8.0px}
</style>


<script>
// === 5D SONIC Desktop: Force audio pipeline & unlock ===
(function(){
  const getAudio = ()=> document.getElementById('audio') || document.querySelector('audio');
  let C = null, mediaNode = null, playerGain = null, masterGain = null;

  async function ensureCtx(){
    if (!C) C = new (window.AudioContext||window.webkitAudioContext)();
    if (C.state === 'suspended') { try{ await C.resume(); }catch(e){} }
    return C;
  }

  function ensureGraph(){
    const a = getAudio();
    if (!a) return false;
    if (!C) C = new (window.AudioContext||window.webkitAudioContext)();
    try{
      if (!a._mediaNode){
        // createMediaElementSource throws if duplicated; hence guard
        a._mediaNode = C.createMediaElementSource(a);
      }
    }catch(e){ /* ignore duplicate creation */ }
    if (!playerGain) playerGain = (window.playerGain && window.playerGain.gain)? window.playerGain : C.createGain();
    if (!masterGain) masterGain = (window.masterGain && window.masterGain.gain)? window.masterGain : C.createGain();
    // sane defaults
    if (playerGain.gain.value === 0) playerGain.gain.value = 0.8;
    if (masterGain.gain.value === 0) masterGain.gain.value = 0.6;
    try{
      a._mediaNode && a._mediaNode.connect(playerGain);
      playerGain.connect(masterGain);
      masterGain.connect(C.destination);
    }catch(e){}
    // expose for other code
    window.playerCtx = C; window.playerGain = playerGain; window.masterGain = masterGain;
    // audio element unmute
    a.muted = false;
    if (a.volume === 0) a.volume = 0.8;
    return true;
  }

  async function unlock(){
    await ensureCtx();
    ensureGraph();
  }

  // attach to first gesture
  document.addEventListener('click', unlock, {once:true, capture:true});
  document.addEventListener('touchstart', unlock, {once:true, passive:true, capture:true});

  // also attempt when pressing any play-like button
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (!t) return;
    const txt = (t.textContent||'').toLowerCase();
    if (txt.includes('play') || txt.includes('재생') || t.closest('[data-action="play"]')){
      unlock();
    }
  }, true);
})();
</script>


<script>
/* ===== Safari-solid audio bootstrap (create-on-gesture + single media node) ===== */
(function () {
  const A = document.getElementById('audio') || document.querySelector('audio');
  if (!A) return;

  A.autoplay = false;
  A.muted = false;
  A.playsInline = true;
  if (A.volume === 0) A.volume = 0.8;

  let ctx = null, mediaNode = null, playerGain = null, masterGain = null;

  function ensureOnceGraph() {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
    if (!mediaNode) {
      try { mediaNode = ctx.createMediaElementSource(A); } catch(e) { /* duplicate safe */ }
    }
    if (!playerGain) playerGain = ctx.createGain();
    if (!masterGain) masterGain = ctx.createGain();
    if (playerGain.gain.value === 0) playerGain.gain.value = 0.8;
    if (masterGain.gain.value === 0) masterGain.gain.value = 0.6;
    try { mediaNode && mediaNode.connect(playerGain); } catch(_) {}
    try { playerGain.connect(masterGain); } catch(_) {}
    try { masterGain.connect(ctx.destination); } catch(_) {}
    window.playerCtx = ctx; window.playerGain = playerGain; window.masterGain = masterGain;
  }

  async function unlockAndMaybePlay(shouldPlay){
    ensureOnceGraph();
    if (ctx.state === 'suspended') { try { await ctx.resume(); } catch(_) {} }
    A.muted = false;
    if (A.volume === 0) A.volume = 0.8;
    if (shouldPlay) {
      try {
        if (A.readyState < 2) {
          await new Promise(r => { const once=()=>{A.removeEventListener('canplay',once);r();}; A.addEventListener('canplay',once,{once:true}); A.load(); });
        }
        await A.play();
      } catch(e) { console.warn('play blocked:', e && e.name); }
    }
  }

  document.addEventListener('pointerdown', ()=>unlockAndMaybePlay(false), { once:true, capture:true });
  document.addEventListener('touchstart', ()=>unlockAndMaybePlay(false), { once:true, capture:true, passive:true });
  document.addEventListener('click', (e)=>{
    const t=e.target;
    const isPlay=(t && (t.dataset.action==='play'||/play|재생/i.test(t.textContent||''))) || (t && t.closest && t.closest('[data-action=\"play\"]'));
    if (isPlay) unlockAndMaybePlay(true);
  }, true);
})();
</script>


<script id="freq-decimal-input-patch">
(function(){
  function enableDecimalFor(el){
    if(!el) return;
    try{
      el.setAttribute('step','0.01');
      el.setAttribute('inputmode','decimal');
      el.setAttribute('pattern','[0-9]*[.,]?[0-9]*');
      // prevent multiple dots
      el.addEventListener('input', function(e){
        let v = e.target.value.replace(/[^0-9.]/g,'');
        const first = v.indexOf('.');
        if(first !== -1){
          // remove extra dots
          v = v.slice(0, first+1) + v.slice(first+1).replace(/[.]/g,'');
        }
        e.target.value = v;
      }, {passive:true});
    }catch(_){}
  }

  function patchAll(){
    const candidates = Array.from(document.querySelectorAll('input'))
      .filter(el => {
        const id  = (el.id||'').toLowerCase();
        const nm  = (el.name||'').toLowerCase();
        const cls = (el.className||'').toLowerCase();
        return /freq|frequency/.test(id) || /freq|frequency/.test(nm) || /freq/.test(cls);
      });
    candidates.forEach(enableDecimalFor);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', patchAll, {once:true});
  }else{
    patchAll();
  }
})();
</script>


<script id="freq-decimal-input-fix">
document.addEventListener('DOMContentLoaded', () => {
  const freqInputs = document.querySelectorAll('input[id*="freq"], input[name*="freq"], input[class*="freq"]');
  freqInputs.forEach(input => {
    input.setAttribute('type', 'text');
    input.setAttribute('inputmode', 'decimal');
    input.setAttribute('pattern', '[0-9]*[.,]?[0-9]*');
    input.addEventListener('input', (e) => {
      let value = e.target.value.replace(/[^0-9.]/g, '');
      const firstDot = value.indexOf('.');
      if (firstDot !== -1) {
        value = value.slice(0, firstDot + 1) + value.slice(firstDot + 1).replace(/\./g, '');
      }
      e.target.value = value;
    });
  });
});
</script>

<script>
function absMedia(pathLike){
  if(!pathLike) return null;
  let base = (window.LUNA_MEDIA_BASE||'').replace(/\/+$/,'');
  let url = null;
  if(/^https?:\/\//i.test(pathLike)) url = pathLike;
  else if(pathLike.startsWith('/media/')) url = location.origin + pathLike;
  else url = base + '/' + pathLike.replace(/^\/+/,'');
  if (window.CACHE_BUST) {
    const sep = url.includes('?') ? '&' : '?';
    url = url + sep + 't=' + Date.now();
  }
  return url;
}
</script>
</body>
</html>
