<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>5DIO — Full UI + Supabase Media Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; margin:0; }
    header { padding:10px 20px; font-size:20px; font-weight:bold; color:#8f8; }
    .oscilloscope, .freqgen, .library, .audioplayer { margin:10px 20px; padding:10px; background:#1a1b22; border-radius:8px; }
    .tcard { display:inline-block; margin:4px; width:200px; cursor:pointer; vertical-align:top; }
    .tcard .thumb { width:200px; height:200px; overflow:hidden; background:#222; display:flex; align-items:center; justify-content:center; }
    .tcard .thumb img { width:100%; object-fit:cover; }
    .tcard .t { padding:6px; font-size:14px; text-align:center; color:#ddd; }
    .library .nav { margin-bottom:10px; }
    .library button { margin-right:5px; }
    audio { width:100%; margin-top:10px; }
  </style>
  <script>
    window.SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
    window.SUPABASE_KEY = "public-anon-key";
    window.SUPABASE_BUCKET = "media";
    window.SUPABASE_PUBLIC_BASE = "https://xdjgumqdwedgzwqturcx.supabase.co/storage/v1/object/public/media";
    window.SUPABASE_RENDER_BASE = "https://xdjgumqdwedgzwqturcx.supabase.co/storage/v1/render/image/public/media";
  </script>
</head>
<body>
<header>5DIO</header>

<div class="oscilloscope">
  <div>Oscilloscope</div>
  <canvas id="oscilloscope" width="600" height="150" style="width:100%;background:black;"></canvas>
</div>

<div class="freqgen">
  <h3>Frequency Generator</h3>
  <div>
    L: <input type="number" id="freqL" value="432"> Hz
    Wave: <select id="waveL"><option>sine</option><option>square</option></select>
    <button onclick="startTone('L')">▶</button>
    <button onclick="stopTone('L')">■</button>
  </div>
  <div>
    R: <input type="number" id="freqR" value="432"> Hz
    Wave: <select id="waveR"><option>sine</option><option>square</option></select>
    <button onclick="startTone('R')">▶</button>
    <button onclick="stopTone('R')">■</button>
  </div>
</div>

<div class="library">
  <div class="nav">
    <button id="libPrev">◀</button>
    <button id="libNext">▶</button>
    <button id="libBack">Back</button>
    <button id="libRefresh">Refresh</button>
    <span id="libPath"></span>
  </div>
  <div id="libRail"></div>
</div>

<div class="audioplayer">
  <img id="currentThumb" alt="" style="display:none;width:56px;height:56px;border-radius:8px;">
  <span id="currentName"></span>
  <audio id="audio" controls preload="none"></audio>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const analyser = audioCtx.createAnalyser();
const oscCanvas = document.getElementById("oscilloscope");
const oscCtx = oscCanvas.getContext("2d");
analyser.fftSize = 2048;
const bufferLength = analyser.fftSize;
const dataArray = new Uint8Array(bufferLength);
function drawScope(){
  requestAnimationFrame(drawScope);
  analyser.getByteTimeDomainData(dataArray);
  oscCtx.fillStyle="black";
  oscCtx.fillRect(0,0,oscCanvas.width,oscCanvas.height);
  oscCtx.lineWidth=2;
  oscCtx.strokeStyle="#00ff99";
  oscCtx.beginPath();
  const sliceWidth = oscCanvas.width * 1.0 / bufferLength;
  let x = 0;
  for(let i=0;i<bufferLength;i++){
    const v = dataArray[i]/128.0;
    const y = v*oscCanvas.height/2;
    if(i===0) oscCtx.moveTo(x,y);
    else oscCtx.lineTo(x,y);
    x += sliceWidth;
  }
  oscCtx.lineTo(oscCanvas.width,oscCanvas.height/2);
  oscCtx.stroke();
}
drawScope();

let oscL=null, oscR=null;
function startTone(side){
  const freq = parseFloat(document.getElementById(`freq${side}`).value);
  const wave = document.getElementById(`wave${side}`).value;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = wave;
  osc.frequency.value = freq;
  osc.connect(gain).connect(analyser).connect(audioCtx.destination);
  osc.start();
  if(side==='L') oscL=osc; else oscR=osc;
}
function stopTone(side){
  if(side==='L' && oscL){ oscL.stop(); oscL.disconnect(); oscL=null; }
  if(side==='R' && oscR){ oscR.stop(); oscR.disconnect(); oscR=null; }
}

(function(){
  const rail   = document.getElementById('libRail');
  const btnPrev= document.getElementById('libPrev');
  const btnNext= document.getElementById('libNext');
  const btnBack= document.getElementById('libBack');
  const btnRef = document.getElementById('libRefresh');
  const audio  = document.getElementById('audio');

  if (!window.supabase || typeof window.supabase.createClient !== 'function') {
    console.warn('[5DIO] Supabase SDK not loaded');
    return;
  }
  const SB_URL   = window.SUPABASE_URL;
  const SB_KEY   = window.SUPABASE_KEY;
  const BUCKET   = window.SUPABASE_BUCKET || 'media';
  const PUBLIC_BASE = window.SUPABASE_PUBLIC_BASE;
  const RENDER_BASE = window.SUPABASE_RENDER_BASE + '/';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const THUMB_W = 640, THUMB_Q = 90;
  const enc = p => p.split('/').filter(Boolean).map(encodeURIComponent).join('/');
  const urlPublic = path => `${PUBLIC_BASE}/${enc(path)}`;
  const urlRender = (path,w=THUMB_W,q=THUMB_Q) => `${RENDER_BASE}${enc(path)}?width=${w}&quality=${q}&format=webp`;

  const PAGE = 3;
  let cwd='', page=0, items=[];
  const backStack=[];

  const isDir = row => row && row.id === null;
  const isMp3 = name => /\.mp3$/i.test(name);
  const pngOf = name => name.replace(/\.mp3$/i, '.png');

  async function list(prefix='') {
    const { data, error } = await sb.storage.from(BUCKET).list(prefix, {limit:1000, sortBy:{column:'name',order:'asc'}});
    if (error) throw error;
    return data||[];
  }

  function makeCard({title,isFolder,imgPath}){
    let src = isFolder ? urlPublic(imgPath) : urlRender(imgPath);
    const fallback = urlPublic(imgPath);
    const div = document.createElement('div');
    div.className='tcard';
    div.dataset.type=isFolder?'dir':'file';
    div.dataset.name=title;
    const th=document.createElement('img');
    th.alt=title;
    th.loading='lazy'; th.decoding='async';
    th.src=src;
    th.onerror=function(){ if(this.src!==fallback) this.src=fallback; };
    const tWrap=document.createElement('div'); tWrap.className='thumb'; tWrap.appendChild(th);
    const label=document.createElement('div'); label.className='t'; label.textContent=title;
    div.appendChild(tWrap); div.appendChild(label);

    div.addEventListener('click',()=>{
      if(isFolder){
        backStack.push(cwd);
        cwd=cwd?`${cwd}/${title}`:title;
        page=0; load();
      } else {
        const mp3Path=cwd?`${cwd}/${title}`:title;
        audio.src=urlPublic(mp3Path);
        audio.load(); audio.play().catch(()=>{});
        const tn=document.getElementById('currentThumb');
        const nm=document.getElementById('currentName');
        if(tn){ tn.src=urlRender(`${cwd}/${pngOf(title)}`,120); tn.style.display=''; }
        if(nm) nm.textContent=title;
      }
    });
    return div;
  }

  function render(){
    rail.innerHTML='';
    const total=items.length;
    const maxPage=Math.max(0,Math.ceil(total/PAGE)-1);
    if(page>maxPage) page=maxPage;
    const slice=items.slice(page*PAGE,page*PAGE+PAGE);
    slice.forEach(o=>rail.appendChild(o.node));
    btnPrev.disabled=(page===0);
    btnNext.disabled=(page>=maxPage);
    const pathEl=document.getElementById('libPath');
    if(pathEl) pathEl.textContent=cwd?`/${cwd}`:'/';
  }

  btnPrev.addEventListener('click',()=>{if(page>0){page--;render();}});
  btnNext.addEventListener('click',()=>{page++;render();});
  if(btnBack) btnBack.addEventListener('click',()=>{
    if(!backStack.length) return;
    cwd=backStack.pop(); page=0; load();
  });
  if(btnRef) btnRef.addEventListener('click',()=>load());

  async function load(){
    try{
      let rows;
      if(!cwd){
        rows=await list('');
        const dirs=rows.filter(isDir).map(d=>({
          node:makeCard({title:d.name,isFolder:true,imgPath:`${d.name}/folder.png`})
        }));
        items=dirs;
      } else {
        rows=await list(cwd);
        const dirs=rows.filter(isDir).map(d=>({
          node:makeCard({title:d.name,isFolder:true,imgPath:`${cwd}/${d.name}/folder.png`})
        }));
        const tracks=rows.filter(r=>r&&r.name&&isMp3(r.name)).map(r=>({
          node:makeCard({title:r.name,isFolder:false,imgPath:`${cwd}/${pngOf(r.name)}`})
        }));
        items=[...dirs,...tracks];
      }
      render();
    }catch(e){
      console.error('[5DIO] Library load failed',e);
      rail.innerHTML='<div class="t small" style="color:#f66">Library load failed</div>';
    }
  }

  audio.removeAttribute('src');
  audio.load();
  const tn=document.getElementById('currentThumb');
  const nm=document.getElementById('currentName');
  if(tn) tn.style.display='none';
  if(nm) nm.textContent='';

  load();
})();
</script>

</body>
</html>
