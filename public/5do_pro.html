<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Pro</title>
<style>
  :root{
    --bg:#0a0f1a;--panel:#0f1524;--panel2:#0d1424;--line:#273149;
    --text:#e7efff;--muted:#a9b6d6;--accent:#7ef1c0;--accent2:#55d0ff;--accent3:#a38cff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 700px at 10% -10%, rgba(142,107,255,.06), transparent),
                 radial-gradient(800px 600px at 110% 20%, rgba(82,255,224,.06), transparent),
                 var(--bg);color:var(--text);
       font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}

  /* Header */
  header{position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;
         padding:10px 14px;background:rgba(12,18,32,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .left-pack{display:flex;align-items:center;gap:10px}
  .app-title{font-weight:800;letter-spacing:.3px;font-size:18px;
             background:linear-gradient(90deg,var(--accent3),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;white-space:nowrap}
  .tabs{justify-self:center;display:flex;gap:10px;transform:translateX(40px)} /* 타이틀 확보 위해 살짝 우측 */
  .tab{border:1px solid var(--line);background:#0f172a;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
  .tab.active{border-color:rgba(142,107,255,.6);box-shadow:0 0 12px rgba(142,107,255,.25),0 0 18px rgba(82,255,224,.18)}
  .right-pack{justify-self:end;display:flex;align-items:center;gap:8px}
  .pill{border:1px solid var(--line);background:#0f172a;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;min-width:44px}

  /* Hamburger (Lite 동일 프레임) */
  .menu-container{position:relative}
  .hamburger{width:34px;height:26px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;cursor:pointer;background:#0f172a}
  .hamburger span,.hamburger span:before,.hamburger span:after{content:"";display:block;width:16px;height:2px;background:#cfe0ff;border-radius:2px;position:relative}
  .hamburger span:before{position:absolute;transform:translateY(-6px)}.hamburger span:after{position:absolute;transform:translateY(6px)}
  .dropdown{display:none;position:absolute;top:32px;left:0;background:var(--panel);border:1px solid var(--line);border-radius:12px;min-width:240px;overflow:hidden;z-index:1200;box-shadow:0 18px 42px rgba(0,0,0,.45)}
  .dropdown a{display:block;padding:10px 12px;color:var(--text);text-decoration:none;border-bottom:1px solid rgba(255,255,255,.05)}
  .dropdown a:last-child{border-bottom:0}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;pointer-events:none;z-index:900}
  .backdrop.show{display:block;pointer-events:auto}
  .menu-text{text-decoration:underline;cursor:pointer}

  /* Layout */
  main{max-width:1200px;margin:0 auto;padding:14px}
  section{display:none} section.active{display:block}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.03)}

  /* Library */
  .toolbar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:12px;max-height:52vh;overflow:auto;padding-right:4px}
  .grid::-webkit-scrollbar{width:8px}.grid::-webkit-scrollbar-thumb{background:#1c2946;border-radius:8px}
  .thumb{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1222;cursor:pointer}
  .thumb .skeleton{position:absolute;inset:0;background:linear-gradient(90deg,#0c1324 0%,#111a31 50%,#0c1324 100%);background-size:200% 100%;animation:shimmer 1.4s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .thumb img{display:block;width:100%;height:110px;object-fit:cover}
  .thumb .t{display:block;padding:8px;font-size:12px;color:#cfe0ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .visual-wrap{margin-top:12px;border:1px dashed var(--line);border-radius:12px;height:140px;position:relative;overflow:hidden}

  /* Generator */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  label{color:var(--muted);font-size:13px}
  .switch{--w:44px;--h:24px;position:relative;width:var(--w);height:var(--h);background:#1a2747;border:1px solid var(--line);border-radius:999px}
  .switch input{appearance:none;width:100%;height:100%;margin:0}
  .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#cfe0ff;transition:left .18s ease}
  .switch input:checked + .knob{left:22px;background:#97ffe9}
  #bbLine{display:flex;align-items:center;gap:10px}
  .ctrlbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .gbtn{height:44px;padding:0 14px;border-radius:10px;border:1px solid rgba(120,180,200,.22);background:#101a2e;color:#e7efff;cursor:pointer}
  .gbtn:active{transform:translateY(1px)}
  .preset-select{height:44px;border-radius:10px;border:1px solid rgba(120,180,200,.22);background:#101a2e;color:#e7efff;padding:0 10px;min-width:180px}
  .osc{margin-top:12px;border:1px dashed var(--line);border-radius:12px;height:160px;overflow:hidden}
  canvas{width:100%;height:100%}
  @media (max-width:768px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
        <a class="menu-text" data-file="faq">FAQ</a>
        <a class="menu-text" data-file="manual">Manual</a>
        <a class="menu-text" data-file="contact">Contact</a>
        <a class="menu-text" data-file="about">About</a>
      </div>
    </div>
    <div class="app-title">5DO Pro</div>
  </div>
  <div class="tabs" role="tablist" aria-label="Mode">
    <button class="tab active" data-target="lib" role="tab" aria-selected="true">5DO</button>
    <button class="tab" data-target="gen" role="tab" aria-selected="false">Freq. Gen.</button>
  </div>
  <div class="right-pack">
    <button id="langToggle" class="pill" title="EN/KO">KO</button>
  </div>
</header>
<div id="backdrop" class="backdrop"></div>

<main>
  <!-- Library page -->
  <section id="lib" class="active">
    <div class="card">
      <div class="toolbar">
        <button id="loopBtn" class="pill">Loop</button>
        <button id="timerBtn" class="pill">Timer</button>
        <button id="playlistBtn" class="pill">Playlist</button>
      </div>

      <div id="thumbs" class="grid"></div>
      <audio id="player" controls crossorigin="anonymous" style="margin-top:10px"></audio>
      <div class="visual-wrap"><canvas id="viz"></canvas></div>
    </div>
  </section>

  <!-- Generator page (separate tab) -->
  <section id="gen">
    <div class="card">
      <div class="row">
        <div class="field">
          <label id="lblFreq">주파수 (Hz)</label>
          <input id="genFreq" type="number" value="432" min="1" max="20000" step="0.1"/>
        </div>
        <div class="field">
          <label id="lblWave">파형</label>
          <select id="genWave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Sawtooth</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field">
          <div id="bbLine">
            <label id="lblBB">Binaural</label>
            <label class="switch" title="Binaural ON/OFF">
              <input id="genBinaural" type="checkbox"><span class="knob"></span>
            </label>
          </div>
          <label id="lblBBdiff" for="genBeat">차이 (Hz)</label>
          <input id="genBeat" type="number" value="7" step="0.1" min="0" max="100">
        </div>
        <div class="field">
          <label id="lblHarmonics" for="genHarmonics">배음</label>
          <input id="genHarmonics" type="text" value="1" placeholder="0.5,2,3">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field">
          <label id="lblLevel" for="genLevel">레벨</label>
          <input id="genLevel" type="range" value="50" min="0" max="100">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="ctrlbar">
            <button id="genToggle" class="gbtn" title="Play/Pause">재생/일시정지</button>
            <button id="btnSavePreset" class="gbtn" title="Save Preset">저장</button>
            <select id="presetSelect" class="preset-select">
              <option value="">프리셋 선택</option>
            </select>
            <button id="btnDeletePreset" class="gbtn" title="Delete Preset">삭제</button>
          </div>
        </div>
      </div>
      <div class="osc"><canvas id="osc"></canvas></div>
    </div>
  </section>
</main>

<!-- Playlists modal -->
<div id="plModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1500">
  <div style="width:min(700px,94vw);max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.5)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <h3 style="margin:0">Playlists</h3>
      <button id="plClose" class="pill">Close</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#0f172a">
        <h4 style="margin:0 0 8px">Manage</h4>
        <div style="display:flex;gap:8px;margin:6px 0"><input id="plNewName" type="text" placeholder="New playlist name" style="flex:1;min-width:0;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0f1524;color:#dfe7f6"><button id="plNewBtn" class="gbtn">New</button></div>
        <div style="display:flex;gap:8px;margin:6px 0"><select id="plSelect" class="preset-select" style="flex:1"></select><button id="plRenameBtn" class="gbtn">Rename</button><button id="plDeleteBtn" class="gbtn">Delete</button></div>
        <div id="plList" style="display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto"></div>
      </div>
      <div style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#0f172a">
        <h4 style="margin:0 0 8px">Add / Load</h4>
        <div style="display:flex;gap:8px;margin:6px 0"><button id="plAddCurrent" class="gbtn">Add Playing</button><button id="plAddAll" class="gbtn">Add All Visible</button></div>
        <div style="display:flex;gap:8px;margin:6px 0"><button id="plLoad" class="gbtn" style="flex:1">Load to Queue</button></div>
        <div style="font-size:.9rem;opacity:.75">Tip: “Add All Visible”는 현재 화면에 보이는 카드들을 순서대로 추가합니다.</div>
      </div>
    </div>
  </div>
</div>

<!-- Supabase (Lite와 동일한 클라이언트; 가드 포함) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  // ====== Lite의 경로/규칙과 동일 ======
  // 폴더 썸네일: folder.jpg / (영문) folder_e.jpg
  // 트랙 썸네일: <파일명>.jpg / (영문) <파일명>_E.jpg
  // /texts/*.txt 로더
  // 버킷명: media (확정)
  const SUPA_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
  const BUCKET   = "media";
  const PUBLIC_BASE = `${SUPA_URL}/storage/v1/object/public/${BUCKET}`;

  let supa=null;
  try{
    if(window.supabase){ supa = window.supabase.createClient(SUPA_URL, SUPA_KEY); }
  }catch(e){ console.warn("[5DO] Supabase disabled:", e); }

  // ====== i18n ======
  const I18N = {
    en:{tabs:{lib:"5DO",gen:"Freq. Gen."},loopOff:"Loop: Off",loopOn:"Loop: On",loop:"Loop",timer:"Timer",playlist:"Playlist",
         freq:"Frequency (Hz)",wave:"Waveform",binaural:"Binaural",difference:"Difference (Hz)",harmonics:"Harmonics",level:"Level",
         play:"Play/Pause",save:"Save",del:"Delete",sel:"Select Preset",pl:"Playlists",manage:"Manage",newName:"New playlist name",
         new:"New",rename:"Rename",delete:"Delete",add:"Add / Load",addPlaying:"Add Playing",addAll:"Add All Visible",loadQ:"Load to Queue",close:"Close",ready:"Ready",none:"None selected"},
    ko:{tabs:{lib:"5DO",gen:"주파수 생성기"},loopOff:"루프: 끔",loopOn:"루프: 켬",loop:"루프",timer:"타이머",playlist:"플레이리스트",
         freq:"주파수 (Hz)",wave:"파형",binaural:"Binaural",difference:"차이 (Hz)",harmonics:"배음",level:"레벨",
         play:"재생/일시정지",save:"저장",del:"삭제",sel:"프리셋 선택",pl:"플레이리스트",manage:"관리",newName:"새 목록 이름",
         new:"추가",rename:"이름변경",delete:"삭제",add:"추가 / 로드",addPlaying:"현재 곡 추가",addAll:"보이는 전부 추가",loadQ:"대기열로 로드",close:"닫기",ready:"재생 준비",none:"선택 없음"}
  };
  let lang = localStorage.getItem("lang") || "ko";
  const $ = s=>document.querySelector(s);
  const $$= s=>Array.from(document.querySelectorAll(s));
  const t = k => (I18N[lang] && k.split(".").reduce((o,kk)=>o&&o[kk], I18N[lang])) || k;

  function applyLang(){
    $('[data-target="lib"]').textContent = t('tabs.lib');
    $('[data-target="gen"]').textContent = t('tabs.gen');
    $('#langToggle').textContent = (lang==='en'?'EN':'KO');
    // generator
    $('#lblFreq').textContent = t('freq');
    $('#lblWave').textContent = t('wave');
    $('#lblBB').textContent   = t('binaural');
    $('#lblBBdiff').textContent = t('difference');
    $('#lblHarmonics').textContent = t('harmonics');
    $('#lblLevel').textContent = t('level');
    $('#genToggle').textContent = t('play');
    $('#btnSavePreset').textContent = t('save');
    $('#btnDeletePreset').textContent = t('del');
    const sel=$('#presetSelect'); if(sel && sel.options[0]) sel.options[0].textContent = t('sel');
    // lib toolbar
    $('#loopBtn').textContent = t('loop');
    $('#timerBtn').textContent = t('timer');
    $('#playlistBtn').textContent = t('playlist');
    // playlist modal labels
    $('#plClose').textContent = t('close');
    document.querySelector('#plModal h3').textContent = t('pl');
    document.querySelector('#plModal h4').textContent = t('manage');
    $('#plNewName').placeholder = t('newName');
    $('#plNewBtn').textContent = t('new');
    $('#plRenameBtn').textContent = t('rename');
    $('#plDeleteBtn').textContent = t('delete');
    document.querySelectorAll('#plModal h4')[1].textContent = t('add');
    $('#plAddCurrent').textContent = t('addPlaying');
    $('#plAddAll').textContent = t('addAll');
    $('#plLoad').textContent = t('loadQ');
  }

  // ====== Hamburger & Text Loader ======
  const menuBtn = $('#menuBtn'), menuDrop = $('#menuDrop'), backdrop = $('#backdrop');
  menuBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = menuDrop.style.display==='block';
    menuDrop.style.display = open ? 'none' : 'block';
    backdrop.classList.toggle('show', !open);
  });
  backdrop.addEventListener('click', ()=>{ menuDrop.style.display='none'; backdrop.classList.remove('show'); });
  document.body.addEventListener('click', (e)=>{
    if(!menuDrop.contains(e.target) && e.target!==menuBtn){
      menuDrop.style.display='none'; backdrop.classList.remove('show');
    }
  });
  $$('.menu-text').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const file=a.getAttribute('data-file');
      try{
        const res = await fetch(`/texts/${file}.txt?ts=${Date.now()}`);
        const txt = await res.text();
        showTextModal(txt);
      }catch(err){
        showTextModal(`[${file}.txt] 불러올 수 없습니다.`);
      }
      menuDrop.style.display='none'; backdrop.classList.remove('show');
    });
  });
  function showTextModal(text){
    let modal = document.getElementById('txtModal');
    if(!modal){
      modal = document.createElement('div');
      modal.id='txtModal';
      modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:2000';
      modal.innerHTML = `<div style="background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:760px;width:92%;max-height:75vh;overflow:auto;padding:16px">
        <div style="text-align:right;margin-bottom:8px"><button id="txtClose" class="pill">${t('close')}</button></div>
        <pre id="txtBody" style="white-space:pre-wrap;line-height:1.6"></pre></div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click',(e)=>{ if(e.target.id==='txtModal') modal.remove(); });
      modal.querySelector('#txtClose').addEventListener('click',()=>modal.remove());
    }
    modal.querySelector('#txtBody').textContent=text;
    modal.style.display='flex';
  }

  // ====== Tabs ======
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      const target=e.currentTarget.dataset.target;
      $$('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      // toggle scopes
      $('#viz').parentElement.style.display = (target==='lib')? '' : 'none';
      $('#osc').parentElement.style.display = (target==='gen')? '' : 'none';
    });
  });

  // ====== Language Toggle ======
  $('#langToggle').addEventListener('click',()=>{
    lang = (lang==='en')?'ko':'en';
    localStorage.setItem('lang', lang);
    applyLang();
    buildThumbs(); // 언어 접미 규칙에 맞춰 재빌드
  });

  // ====== Library (Lite 규칙) ======
  const thumbs = $('#thumbs'); const audioEl = $('#player');
  function folderThumb(path){ return `${PUBLIC_BASE}/${encodeURIComponent(path)}/${lang==='en'?'folder_e.jpg':'folder.jpg'}`; }
  function trackThumb(path, filename){
    const base = filename.replace(/\.(mp3|wav|m4a)$/i,'');
    const suffix = (lang==='en') ? '_E' : '';
    return `${PUBLIC_BASE}/${encodeURIComponent(path)}/${encodeURIComponent(base+suffix)}.jpg`;
  }
  function trackUrl(path, filename){
    return `${PUBLIC_BASE}/${encodeURIComponent(path)}/${encodeURIComponent(filename)}`;
  }
  const pathStack=[];
  const currentPath = ()=> pathStack.join('/');

  async function listPath(path){
    if(!supa) return []; // supabase 미로딩 시 안전하게 비우기
    const p = path ? path + '/' : '';
    const { data, error } = await supa.storage.from(BUCKET).list(p, { limit:1000, sortBy:{column:'name',order:'asc'} });
    if(error){ console.warn(error); return []; }
    return data || [];
  }
  function isFolder(item){ return !item?.metadata || !item?.metadata.mimetype; }
  function isAudio(item){ return !!item?.metadata?.mimetype && /^audio\//.test(item.metadata.mimetype); }

  async function buildThumbs(){
    try{
      thumbs.innerHTML='';
      const path = currentPath();
      const list = await listPath(path);
      const folders = list.filter(isFolder);
      const files   = list.filter(isAudio);

      // folders
      for(const f of folders){
        const card=document.createElement('div'); card.className='thumb'; card.dataset.type='folder'; card.dataset.name=f.name;
        const sk=document.createElement('div'); sk.className='skeleton'; card.appendChild(sk);
        const img=new Image(); img.loading='lazy'; img.onload=()=>sk.remove(); img.onerror=()=>{ sk.remove(); img.remove(); };
        const folderPath = path ? `${path}/${f.name}` : f.name;
        img.src = folderThumb(folderPath); card.appendChild(img);
        const title=document.createElement('span'); title.className='t'; title.textContent = f.name; card.appendChild(title);
        card.addEventListener('click',()=>{ pathStack.push(f.name); buildThumbs(); });
        thumbs.appendChild(card);
      }

      // files
      for(const file of files){
        const card=document.createElement('div'); card.className='thumb'; card.dataset.type='file'; card.dataset.name=file.name;
        const sk=document.createElement('div'); sk.className='skeleton'; card.appendChild(sk);
        const img=new Image(); img.loading='lazy'; img.onload=()=>sk.remove(); img.onerror=()=>{ sk.remove(); img.remove(); };
        img.src = trackThumb(path, file.name); card.appendChild(img);
        const title=document.createElement('span'); title.className='t'; title.textContent = file.name; card.appendChild(title);
        const url = trackUrl(path, file.name);
        card.dataset.href = url;  // 플레이리스트 'Add All Visible' 대비
        card.addEventListener('click',()=>{ audioEl.src = url; audioEl.load(); });
        thumbs.appendChild(card);
      }
    }catch(err){
      console.error('[5DO] buildThumbs failed:', err);
    }
  }

  // Loop / Timer / Playlist
  function syncLoopBtn(){ $('#loopBtn').textContent = audioEl.loop ? t('loopOn') : t('loopOff'); }
  $('#loopBtn').addEventListener('click',()=>{ audioEl.loop=!audioEl.loop; syncLoopBtn(); });
  $('#timerBtn').addEventListener('click',()=>{
    const mins=parseFloat(prompt(t('timer'),'20')||'0');
    if(mins>0){ setTimeout(()=>audioEl.pause(), mins*60000); alert('OK'); }
  });

  // Unlimited Playlists (localStorage)
  const PLS='playlists_5do_pro';
  function plDB(){ try{return JSON.parse(localStorage.getItem(PLS)||'{}')}catch(_){return{}} }
  function plSave(obj){ localStorage.setItem(PLS, JSON.stringify(obj)); }
  function openPl(){
    const modal = $('#plModal'); modal.style.display='flex';
    const db = plDB(); const sel=$('#plSelect'); sel.innerHTML='';
    Object.keys(db).forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o); });
    renderPlList();
  }
  function closePl(){ $('#plModal').style.display='none'; }
  function renderPlList(){
    const db = plDB(); const sel=$('#plSelect'); const name=sel.value; const list=$('#plList'); list.innerHTML='';
    (db[name]||[]).forEach((it,idx)=>{
      const row=document.createElement('div'); row.style.cssText='display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0f172a;color:#cfead1;';
      row.innerHTML = `<span style="max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${it}</span>
        <span style="display:flex;gap:6px">
          <button class="gbtn" data-i="${idx}" data-act="up">↑</button>
          <button class="gbtn" data-i="${idx}" data-act="down">↓</button>
          <button class="gbtn" data-i="${idx}" data-act="del">${t('delete')}</button>
        </span>`;
      list.appendChild(row);
    });
    list.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click',()=>{
        const i=+b.dataset.i; const act=b.dataset.act; const name=$('#plSelect').value; const db=plDB(); const arr=db[name]||[];
        if(act==='del') arr.splice(i,1);
        if(act==='up' && i>0){ const t=arr[i-1]; arr[i-1]=arr[i]; arr[i]=t; }
        if(act==='down' && i<arr.length-1){ const t=arr[i+1]; arr[i+1]=arr[i]; arr[i]=t; }
        db[name]=arr; plSave(db); renderPlList();
      });
    });
  }
  $('#playlistBtn').addEventListener('click', openPl);
  $('#plClose').addEventListener('click', closePl);
  $('#plNewBtn').addEventListener('click',()=>{
    const name=$('#plNewName').value.trim(); if(!name) return;
    const db=plDB(); if(!db[name]) db[name]=[]; plSave(db); $('#plNewName').value=''; openPl();
  });
  $('#plRenameBtn').addEventListener('click',()=>{
    const sel=$('#plSelect'); const cur=sel.value; if(!cur) return;
    const name=prompt(t('rename'),cur)||cur; const db=plDB(); if(cur!==name){ db[name]=db[cur]; delete db[cur]; plSave(db); openPl(); $('#plSelect').value=name; renderPlList(); }
  });
  $('#plDeleteBtn').addEventListener('click',()=>{
    const sel=$('#plSelect'); const cur=sel.value; if(!cur) return; const db=plDB(); delete db[cur]; plSave(db); openPl();
  });
  $('#plSelect').addEventListener('change', renderPlList);
  $('#plAddCurrent').addEventListener('click',()=>{
    const name=$('#plSelect').value; if(!name) return;
    const db=plDB(); const arr=db[name]||[]; if(audioEl.src) arr.push(audioEl.src);
    db[name]=arr; plSave(db); renderPlList();
  });
  $('#plAddAll').addEventListener('click',()=>{
    const name=$('#plSelect').value; if(!name) return;
    const db=plDB(); const arr=db[name]||[];
    document.querySelectorAll('#thumbs .thumb[data-type="file"]').forEach(card=>{
      const url = card.dataset.href;
      if(url) arr.push(url);
    });
    db[name]=arr; plSave(db); renderPlList();
  });
  $('#plLoad').addEventListener('click',()=>{
    const name=$('#plSelect').value; if(!name) return;
    const db=plDB(); const queue=(db[name]||[]).slice();
    if(queue.length){
      const playNext=()=>{
        const url=queue.shift(); if(!url){audioEl.pause(); return;}
        audioEl.src=url; audioEl.play().catch(()=>{});
        audioEl.onended=()=>playNext();
      };
      playNext();
    }
  });

  // ====== Visualizer ======
  let aCtx, analyser, msrc, rafViz;
  function ensureLibAudio(){ if(aCtx) return; aCtx=new (window.AudioContext||window.webkitAudioContext)(); analyser=aCtx.createAnalyser(); analyser.fftSize=1024; analyser.smoothingTimeConstant=.78; msrc=aCtx.createMediaElementSource(audioEl); msrc.connect(analyser); analyser.connect(aCtx.destination); }
  function drawViz(){
    const cvs=$('#viz'), cx=cvs.getContext('2d'); const W=cvs.width=cvs.clientWidth, H=cvs.height=cvs.clientHeight;
    const data=new Uint8Array(analyser.frequencyBinCount);
    (function loop(){ rafViz=requestAnimationFrame(loop); analyser.getByteFrequencyData(data); cx.fillStyle='#0b1222'; cx.fillRect(0,0,W,H);
      const bars=Math.min(96, Math.floor(W/7)); const step=Math.floor(data.length/bars); const bw=Math.max(3,(W/bars)*.6);
      for(let i=0;i<bars;i++){ const v=data[i*step]/255; const bh=Math.max(4, v*(H*.9)); const x=i*(W/bars)+(W/bars-bw)/2; const y=H-bh;
        const g=cx.createLinearGradient(0,y,0,y+bh); g.addColorStop(0,'#7ef1c0'); g.addColorStop(1,'#a38cff'); cx.fillStyle=g; cx.fillRect(x,y,bw,bh); }
    })();
  }
  audioEl.addEventListener('play',async()=>{ ensureLibAudio(); if(aCtx.state==='suspended') await aCtx.resume(); drawViz(); });
  audioEl.addEventListener('pause',()=>cancelAnimationFrame(rafViz)); audioEl.addEventListener('ended',()=>cancelAnimationFrame(rafViz));

  // ====== Generator & Oscilloscope ======
  let gctx, gGain, gMerge, gOscL, gOscR, gAnalyser, rafOsc, genOn=false;
  function ensureGenCtx(){ if(!gctx) gctx=new (window.AudioContext||window.webkitAudioContext)(); if(!gGain){ gGain=gctx.createGain(); gGain.gain.value=parseFloat(genLevel.value||'50')/100; gGain.connect(gctx.destination); } if(!gAnalyser){ gAnalyser=gctx.createAnalyser(); gAnalyser.fftSize=2048; } }
  function stopGen(){ try{gOscL&&gOscL.stop()}catch(e){} try{gOscR&&gOscR.stop()}catch(e){} gOscL=gOscR=null; if(gMerge){ try{gMerge.disconnect()}catch(e){} gMerge=null; cancelAnimationFrame(rafOsc); }
  async function startGen(){
    ensureGenCtx(); if(gctx.state==='suspended') await gctx.resume(); stopGen();
    const freq=parseFloat(genFreq.value||'432'), wave=genWave.value||'sine', useBB=genBinaural.checked, beat=Math.max(0,parseFloat(genBeat.value||'7'));
    const harms=(genHarmonics.value||'1').split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n)&&isFinite(n));
    gMerge=gctx.createChannelMerger(2); const tap=gctx.createGain(); tap.connect(gAnalyser); gMerge.connect(tap); gMerge.connect(gGain);
    function mk(f,ch){ const o=gctx.createOscillator(); o.type=wave; o.frequency.value=f; const g=gctx.createGain(); g.gain.value=0.9/Math.max(1,harms.length); o.connect(g); g.connect(gMerge,0,ch); o.start(); return o; }
    const L=useBB?(freq-beat/2):freq, R=useBB?(freq+beat/2):freq; gOscL=mk(L,0); gOscR=mk(R,1);
    harms.forEach(r=>{ if(!isFinite(r)||r===1) return; mk(L*r,0); mk(R*r,1); });
    drawOsc();
  }
  function drawOsc(){
    const cvs=$('#osc'), cx=cvs.getContext('2d'); const W=cvs.width=cvs.clientWidth, H=cvs.height=cvs.clientHeight;
    const buf=new Uint8Array(gAnalyser.fftSize);
    (function loop(){ rafOsc=requestAnimationFrame(loop); gAnalyser.getByteTimeDomainData(buf); cx.fillStyle='#0c1322'; cx.fillRect(0,0,W,H); cx.strokeStyle='#9fd6ff'; cx.lineWidth=1.4; cx.beginPath();
      for(let i=0;i<buf.length;i++){ const x=i/buf.length*W; const y=(buf[i]/255)*H; (i?cx.lineTo(x,y):cx.moveTo(x,y)); } cx.stroke(); })();
  }
  const genToggle=$('#genToggle');
  genToggle.addEventListener('click', async ()=>{ if(!genOn){ await startGen(); genOn=true; genToggle.textContent = (lang==='en')?'Pause':'일시정지'; } else { stopGen(); genOn=false; genToggle.textContent = t('play'); } });
  $('#genLevel').addEventListener('input',()=>{ ensureGenCtx(); gGain.gain.value=parseFloat(genLevel.value||'50')/100; });
  $('#genBinaural').addEventListener('change',()=>{ genBeat.disabled = !genBinaural.checked; }); genBeat.disabled = !genBinaural.checked;

  // ====== Presets (10) ======
  const PKEY='genPresets_pro_v1';
  function gdb(){ try{return JSON.parse(localStorage.getItem(PKEY)||'[]')}catch(e){return[]} }
  function gsave(arr){ localStorage.setItem(PKEY, JSON.stringify(arr.slice(0,10))); }
  function gcurrent(){ return {freq:genFreq.value,wave:genWave.value,bin:genBinaural.checked,beat:genBeat.value,harm:genHarmonics.value,level:genLevel.value}; }
  function renderPresetList(){ const sel=$('#presetSelect'); sel.innerHTML='<option value=\"\">'+t('sel')+'</option>'; gdb().forEach(p=>{ const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; sel.appendChild(o); }); }
  $('#btnSavePreset').addEventListener('click',()=>{ const name=prompt(lang==='en'?'Preset name':'프리셋 이름'); if(!name) return; const arr=gdb().filter(p=>p.name!==name); arr.unshift({name,data:gcurrent()}); gsave(arr); renderPresetList(); });
  $('#btnDeletePreset').addEventListener('click',()=>{ const name=$('#presetSelect').value; if(!name) return; gsave(gdb().filter(p=>p.name!==name)); renderPresetList(); });
  $('#presetSelect').addEventListener('change',()=>{ const name=$('#presetSelect').value; if(!name) return; const f=gdb().find(p=>p.name===name); if(!f) return; const d=f.data||{}; genFreq.value=d.freq||'432'; genWave.value=d.wave||'sine'; genBinaural.checked=!!d.bin; genBeat.value=d.beat||'7'; genHarmonics.value=d.harm||'1'; genLevel.value=d.level||'50'; genBeat.disabled=!genBinaural.checked; });

     // ====== Init ======
  applyLang(); buildThumbs(); syncLoopBtn();
  document.querySelector('#viz').parentElement.style.display='';
  document.querySelector('#osc').parentElement.style.display='none';
})();
</script>
</body>
</html>
