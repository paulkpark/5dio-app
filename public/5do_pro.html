<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>5DO Pro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#0b0d13; --panel:#12141b; --border:#222738;
  --ink:#e5e7eb; --accent:#9cff8b; --card:#181b25;
}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial;background:var(--bg);color:var(--ink)}
header{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;position:relative}
.logo{font-weight:700;color:var(--accent);font-size:1.2rem;margin-left:40px}
.tabs{display:flex;gap:6px}
.tab{padding:4px 6px;font-size:.72rem;border:1px solid var(--border);border-radius:8px;background:#171d2b;color:#cfead1;cursor:pointer}
.tab.active{background:#1f2739;border-color:#334}
.section{display:none}
.section.active{display:block}
.lang-toggle{color:#fff;border:1px solid #444;padding:4px 8px;border-radius:6px;cursor:pointer;background:#171d2b}
.menu-container{position:absolute;top:12px;left:10px;z-index:1000}
.menu-button{font-size:24px;color:#fff;cursor:pointer}
.dropdown-menu{display:none;flex-direction:column;position:absolute;background:rgba(0,0,0,0.9);padding:8px 10px;border-radius:10px;width:160px}
.dropdown-menu a{color:#fff;padding:6px 10px;text-decoration:none}
.dropdown-menu a:hover{background:rgba(255,255,255,0.1)}
.menu-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:900}

#oscLib{width:100%;height:120px;background:#090b11;border-bottom:1px solid var(--border)}
#navBtns{display:flex;justify-content:center;gap:8px;padding:8px}
.btn{background:#1e2232;border:1px solid #2c3147;color:#eee;border-radius:10px;padding:8px 10px;font-size:1.3rem;cursor:pointer}
.btn:hover{background:#2a3148}
#library{display:flex;overflow-x:auto;gap:10px;padding:10px;scroll-behavior:smooth;scroll-snap-type:x mandatory}
.card{flex:0 0 auto;width:160px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#10131d;border-radius:8px}

.controls{display:flex;flex-direction:column;align-items:flex-start;gap:10px;padding:12px;background:#0f1320;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.status{display:flex;align-items:center;gap:18px;margin-bottom:2px}
#statusThumb{width:124px;height:124px;border-radius:16px;background:radial-gradient(circle at center,#1a1f2f 40%,#0d0f18 100%);border:1px solid #2d334a;box-shadow:0 0 12px rgba(80,180,255,0.15);background-size:cover;background-position:center;position:relative;overflow:hidden}
#statusThumb::before{content:'';position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle,rgba(100,200,255,0.25),transparent 60%);animation:pulse 2s infinite ease-in-out}
#statusThumb.loaded::before{display:none}
@keyframes pulse{0%,100%{transform:scale(.8);opacity:.5}50%{transform:scale(1.1);opacity:1}}
.ctrl-stack{display:flex;flex-direction:column;gap:10px}
.ctrl-line{display:flex;align-items:center;gap:8px}
audio{width:92%;display:block;margin:10px auto}
.gen-wrap{padding:12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{background:#141a27;border:1px solid #2a3044;border-radius:12px;padding:10px}
.field h4{margin:0 0 8px;color:#dfe7f6;font-size:.95rem}
.field label{display:block;font-size:.85rem;color:#9aa3b7;margin-bottom:4px}
.field input,.field select{width:100%;background:#101522;color:#e9eefc;border:1px solid #2a3044;border-radius:8px;padding:6px}
.pill{padding:8px 12px;border-radius:100px;border:1px solid #2c3147;background:#1b2333;color:#e9eefc;cursor:pointer}
.pill.primary{background:#21324e;border-color:#355;color:#cfead1}
#oscGen{width:100%;height:140px;background:#0a0d14;border:1px solid #20263a;border-radius:12px;margin-top:12px}
</style>
</head>
<body>

<div class="menu-container">
  <div id="menuButton" class="menu-button">‚ò∞</div>
  <div id="dropdownMenu" class="dropdown-menu">
    <a href="https://5dshop.co.kr" target="_blank">Shop</a>
    <a href="#">FAQ</a><a href="#">Manual</a><a href="#">Contact</a><a href="#">About</a>
  </div>
  <div id="menuBackdrop" class="menu-backdrop"></div>
</div>

<header>
  <div class="logo">5DO Pro</div>
  <div class="tabs">
    <div class="tab active" data-tab="lib">5DO</div>
    <div class="tab" data-tab="gen">Freq. Gen.</div>
  </div>
  <div id="langToggle" class="lang-toggle">EN</div>
</header>

<canvas id="oscLib"></canvas>

<section id="section-lib" class="section active">
  <div id="navBtns">
    <button id="btnBack" class="btn">‚¨ÖÔ∏è</button>
    <button id="btnRefresh" class="btn">üîÑ</button>
  </div>
  <div id="library"></div>
  <div class="controls">
    <div class="status">
      <div id="statusThumb"></div>
      <div class="ctrl-stack">
        <div class="ctrl-line">
          <label for="vol">Volume</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="1">
        </div>
        <div class="ctrl-line"><label><input type="checkbox" id="loop"> Loop</label></div>
        <div class="ctrl-line">
          <label for="timer">Timer</label>
          <select id="timer"><option value="0">Off</option><option value="5">5 min</option><option value="10">10 min</option></select>
        </div>
      </div>
    </div>
    <audio id="player" controls preload="none"></audio>
  </div>
</section>

<section id="section-gen" class="section">
  <div class="gen-wrap">
    <div class="grid">
      <div class="field">
        <h4>Waveform</h4>
        <select id="genWave"><option value="sine">Sine</option><option value="square">Square</option></select>
      </div>
      <div class="field">
        <h4>Level</h4><input id="genLevel" type="range" min="0" max="1" step="0.01" value="0.5">
      </div>
      <div class="field">
        <h4>Frequency (Hz)</h4><input id="genFreq" type="number" min="1" max="24000" value="440">
      </div>
      <div class="field">
        <h4>Binaural</h4><input id="genBinaural" type="checkbox"> <label for="genBeat">Diff (Hz)</label><input id="genBeat" type="number" value="7">
      </div>
      <div class="field full">
        <div><button id="genStart" class="pill primary">‚ñ∂Ô∏è</button><button id="genStop" class="pill">‚èπÔ∏è</button></div>
        <canvas id="oscGen"></canvas>
      </div>
    </div>
  </div>
</section>

<script>
/* ÌñÑÎ≤ÑÍ±∞ */
const menuBtn=document.getElementById("menuButton"),menu=document.getElementById("dropdownMenu"),backdrop=document.getElementById("menuBackdrop");
menuBtn.onclick=()=>{const open=menu.style.display==="flex";menu.style.display=open?"none":"flex";backdrop.style.display=open?"none":"block";}
backdrop.onclick=()=>{menu.style.display="none";backdrop.style.display="none";}

/* ÌÉ≠ */
const tabs=document.querySelectorAll(".tab");
tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove("active"));t.classList.add("active");
document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
document.getElementById("section-"+t.dataset.tab).classList.add("active");});

/* ===== AUDIO PIPELINE ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function unlockAudio(){if(audioCtx.state!=="running")audioCtx.resume();}
document.addEventListener("click",unlockAudio,{once:true});
const player=document.getElementById("player");
const masterGain=audioCtx.createGain();masterGain.connect(audioCtx.destination);
const src=audioCtx.createMediaElementSource(player);src.connect(masterGain);
const analyser=audioCtx.createAnalyser();masterGain.connect(analyser);

/* ===== Ïò§Ïã§Î°úÏä§ÏΩîÌîÑ ===== */
analyser.fftSize=2048;const buf=new Uint8Array(analyser.fftSize);
const canvas=document.getElementById("oscLib"),ctx=canvas.getContext("2d");
function size(){canvas.width=canvas.clientWidth;canvas.height=120;}
size();window.addEventListener("resize",size);
(function draw(){requestAnimationFrame(draw);
analyser.getByteTimeDomainData(buf);ctx.fillStyle="#090b11";ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.lineWidth=2;ctx.strokeStyle="#9cff8b";ctx.beginPath();
const dx=canvas.width/buf.length;for(let i=0,x=0;i<buf.length;i++,x+=dx){const y=(buf[i]/128)*canvas.height/2;i?ctx.lineTo(x,y):ctx.moveTo(x,y);}
ctx.lineTo(canvas.width,canvas.height/2);ctx.stroke();})();

/* Î≥ºÎ•® */
const vol=document.getElementById("vol");vol.oninput=()=>{masterGain.gain.value=vol.value;}

/* ===== Supabase ===== */
const SUPABASE_URL="https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const PUBLIC=SUPABASE_URL+"/storage/v1/object/public/media/";
const enc=s=>s.split("/").filter(Boolean).map(encodeURIComponent).join("/");
const abs=p=>PUBLIC+enc(p);

/* ===== Library Loader ===== */
const lib=document.getElementById("library");let cwd="";
async function list(p=""){const {data}=await sb.storage.from("media").list(p,{limit:1000,sortBy:{column:"name",order:"asc"}});return data||[];}
async function load(p=""){cwd=p;lib.innerHTML="";for(const e of await list(p)){const n=e.name;const full=(p?p+"/":"")+n;
if(!n.includes(".")){const c=document.createElement("div");c.className="card";const img=document.createElement("img");img.src=abs(full+"/folder.png");
img.onerror=()=>img.src="https://placehold.co/200x200/111/aaa?text=Folder";c.onclick=()=>load(full);c.append(img);lib.append(c);}
else if(/\.(mp3|wav)$/i.test(n)){const c=document.createElement("div");c.className="card";const img=document.createElement("img");
const thumb=full.replace(/\.[^.]+$/,".png");img.src=abs(thumb);img.onerror=()=>img.src="https://placehold.co/200x200/222/888?text=Audio";
c.onclick=()=>{unlockAudio();player.src=abs(full);player.play();statusThumb.classList.add("loaded");statusThumb.style.backgroundImage=`url(${img.src})`};
c.append(img);lib.append(c);}}}
load();

/* ===== Generator ===== */
const genGain=audioCtx.createGain();genGain.connect(masterGain);
let genNodes=[];
function stopGen(){genNodes.forEach(n=>{try{n.stop();n.disconnect();}catch{}});genNodes=[];}
function startGen(){stopGen();unlockAudio();const f=parseFloat(genFreq.value||"440");const w=genWave.value||"sine";const l=parseFloat(genLevel.value||"0.5");genGain.gain.value=l;
const o=audioCtx.createOscillator();o.type=w;o.frequency.value=f;o.connect(genGain);o.start();genNodes=[o];}
genStart.onclick=startGen;genStop.onclick=stopGen;
const analyserG=audioCtx.createAnalyser();genGain.connect(analyserG);
analyserG.fftSize=2048;const bufG=new Uint8Array(analyserG.fftSize);
const canvG=document.getElementById("oscGen"),ctxG=canvG.getContext("2d");
function resG(){canvG.width=canvG.clientWidth;canvG.height=140;}
resG();window.addEventListener("resize",resG);
(function drawG(){requestAnimationFrame(drawG);
analyserG.getByteTimeDomainData(bufG);ctxG.fillStyle="#0a0d14";ctxG.fillRect(0,0,canvG.width,canvG.height);
ctxG.lineWidth=2;ctxG.strokeStyle="#77d0ff";ctxG.beginPath();
const dx=canvG.width/bufG.length;for(let i=0,x=0;i<bufG.length;i++,x+=dx){const y=(bufG[i]/128)*canvG.height/2;i?ctxG.lineTo(x,y):ctxG.moveTo(x,y);}
ctxG.lineTo(canvG.width,canvG.height/2);ctxG.stroke();})();
</script>
</body>
</html>
