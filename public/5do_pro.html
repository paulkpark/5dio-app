<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>5DO Pro</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<style>
  body{margin:0;background:#090b11;color:#fff;font-family:sans-serif;overflow:hidden}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#111;border-bottom:1px solid #222;}
  .logo{font-weight:700;color:#9cff8b;font-size:1.2rem;margin-left:32px;}
  .lang-toggle{cursor:pointer;font-size:0.9rem;background:#1a1a1a;padding:4px 10px;border-radius:8px;}
  .hamburger{position:absolute;top:12px;left:10px;cursor:pointer;font-size:24px;}
  .menu{position:absolute;top:48px;left:0;background:#151515;width:33%;display:none;flex-direction:column;padding:10px;z-index:10;}
  .menu.open{display:flex;}
  .menu a{color:#fff;text-decoration:none;padding:8px 0;}
  .library-section,.generator-section{display:none;padding:10px;}
  .active-section{display:block;}
  .status-thumb{width:124px;height:124px;background:black no-repeat center/cover;border-radius:12px;margin-right:10px;}
  .controls{display:flex;align-items:center;gap:10px;margin-top:8px;}
  .volume-slider,.timer-select{height:20px;}
  .thumbnail-container{display:flex;overflow-x:auto;gap:10px;padding:10px 0;}
  .thumb{width:120px;height:120px;background:#222 center/cover no-repeat;border-radius:12px;flex-shrink:0;}
  .thumb.loaded{box-shadow:0 0 10px #0f0;}
  .osc-wrap{margin-top:10px;}
  canvas{width:100%;height:100px;background:#000;display:block;}
  .tab-bar{display:flex;gap:6px;padding:6px;background:#111;border-bottom:1px solid #222;}
  .tab{padding:6px 10px;background:#171d2b;border:1px solid #333;border-radius:6px;cursor:pointer;}
  .tab.active{background:#1f2739;}
  .icon-btn{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
</style>
</head>
<body>
<div class="hamburger" id="hamburger">‚ò∞</div>
<header>
  <div class="logo">5DO Pro</div>
  <div class="lang-toggle" id="langToggle">EN</div>
</header>
<div class="menu" id="menu">
  <a href="https://5dshop.co.kr" target="_blank">Shop</a>
  <a href="#">FAQ</a>
  <a href="#">Manual</a>
  <a href="#">Contact</a>
  <a href="#">About</a>
</div>

<div class="tab-bar">
  <div class="tab active" id="tabLibrary">5DO</div>
  <div class="tab" id="tabGen">Freq. Gen.</div>
</div>

<!-- ========== LIBRARY PLAYER SECTION ========== -->
<section class="library-section active-section" id="librarySection">
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="status-thumb" id="statusThumb"></div>
    <div class="controls">
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" class="volume-slider">
      <button id="loopBtn" class="icon-btn">üîÅ</button>
      <select id="timerSelect" class="timer-select">
        <option value="0">Timer</option>
        <option value="5">5 min</option>
        <option value="10">10 min</option>
        <option value="15">15 min</option>
        <option value="20">20 min</option>
        <option value="30">30 min</option>
        <option value="45">45 min</option>
        <option value="60">60 min</option>
      </select>
      <button id="playBtn" class="icon-btn">‚ñ∂Ô∏è</button>
      <button id="stopBtn" class="icon-btn">‚èπÔ∏è</button>
    </div>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:6px;">
    <button id="backBtn" class="icon-btn">‚è™</button>
    <button id="refreshBtn" class="icon-btn">üîÑ</button>
  </div>
  <div class="thumbnail-container" id="thumbContainer"></div>
  <div class="osc-wrap"><canvas id="oscCanvas"></canvas></div>
</section>

<!-- ========== GENERATOR SECTION ========== -->
<section class="generator-section" id="genSection">
  <div style="margin-top:10px;">
    <button id="genPlay" class="icon-btn">‚ñ∂Ô∏è</button>
    <button id="genStop" class="icon-btn">‚èπÔ∏è</button>
    <input type="number" id="freqInput" value="432" min="1" max="20000" step="1">
  </div>
  <div class="osc-wrap"><canvas id="genOsc"></canvas></div>
</section>

<script>
/* ===== CACHE BUSTER ===== */
window.__MEDIA_REV = Date.now();
const bust = (u)=> u+(u.includes('?')?'&':'?')+'v='+window.__MEDIA_REV;

/* ===== UI ELEMENTS ===== */
const hamburger=document.getElementById('hamburger');
const menu=document.getElementById('menu');
hamburger.onclick=()=>menu.classList.toggle('open');
document.body.addEventListener('click',e=>{if(!menu.contains(e.target)&&e.target!==hamburger)menu.classList.remove('open')});

/* ===== TAB SWITCH ===== */
const tabLib=document.getElementById('tabLibrary');
const tabGen=document.getElementById('tabGen');
const libSec=document.getElementById('librarySection');
const genSec=document.getElementById('genSection');
tabLib.onclick=()=>{tabLib.classList.add('active');tabGen.classList.remove('active');libSec.classList.add('active-section');genSec.classList.remove('active-section');}
tabGen.onclick=()=>{tabGen.classList.add('active');tabLib.classList.remove('active');genSec.classList.add('active-section');libSec.classList.remove('active-section');}

/* ===== LANGUAGE TOGGLE ===== */
const langToggle=document.getElementById('langToggle');
let lang='EN';
langToggle.onclick=()=>{
  lang = lang==='EN'?'KO':'EN';
  langToggle.textContent=lang;
  // ÌïÑÏöî Ïãú label Î≤àÏó≠ Î°úÏßÅ Ï∂îÍ∞Ä
};

/* ===== AUDIO PLAYER ===== */
const statusThumb=document.getElementById('statusThumb');
const volumeSlider=document.getElementById('volumeSlider');
const loopBtn=document.getElementById('loopBtn');
const timerSelect=document.getElementById('timerSelect');
const playBtn=document.getElementById('playBtn');
const stopBtn=document.getElementById('stopBtn');

let audioCtx,srcNode,gainNode,analyser;
const audioEl=new Audio();
audioEl.crossOrigin="anonymous";
let currentTrack=null;
let loop=false;

playBtn.onclick=()=>audioEl.play();
stopBtn.onclick=()=>{audioEl.pause();audioEl.currentTime=0;}
loopBtn.onclick=()=>{loop=!loop;audioEl.loop=loop;loopBtn.style.opacity=loop?1:0.5;}
volumeSlider.oninput=()=>{audioEl.volume=volumeSlider.value;}
timerSelect.onchange=()=>{
  const min=parseInt(timerSelect.value);
  if(min>0)setTimeout(()=>audioEl.pause(),min*60000);
};

/* ===== LIBRARY THUMBNAILS ===== */
const thumbContainer=document.getElementById('thumbContainer');
const backBtn=document.getElementById('backBtn');
const refreshBtn=document.getElementById('refreshBtn');
let currentPath='';

function setStatusThumb(url){
  if(!url){statusThumb.style.background='black';statusThumb.style.backgroundImage='';}
  else{statusThumb.style.background='none';statusThumb.style.backgroundImage=`url(${url})`;}
}

function loadLibrary(){
  thumbContainer.innerHTML='';
  // Ïù¥ Î∂ÄÎ∂ÑÏóêÏÑú Supabase fetch ‚Üí thumbnails
  const demoThumbs=[
    'https://xdjgumqdwedgzwqturcx.supabase.co/storage/v1/render/image/public/media/Brainwave_States/folder.png',
    'https://xdjgumqdwedgzwqturcx.supabase.co/storage/v1/render/image/public/media/Nature_Resonance/folder.png'
  ];
  demoThumbs.forEach((t,i)=>{
    const div=document.createElement('div');
    div.className='thumb';
    const url=bust(t);
    div.style.backgroundImage=`url(${url})`;
    div.onclick=()=>{
      currentTrack=url;
      audioEl.src=demoThumbs[i].replace('render/image','object/public');
      setStatusThumb(url);
    }
    thumbContainer.appendChild(div);
  });
}
backBtn.onclick=()=>loadLibrary();
refreshBtn.onclick=()=>loadLibrary();
loadLibrary();

/* ===== OSCILLOSCOPE (Library) ===== */
const oscCanvas=document.getElementById('oscCanvas');
const ctx=oscCanvas.getContext('2d');
function initAudioCtx(){
  if(!audioCtx){
    audioCtx=new AudioContext();
    srcNode=audioCtx.createMediaElementSource(audioEl);
    gainNode=audioCtx.createGain();
    analyser=audioCtx.createAnalyser();
    srcNode.connect(gainNode).connect(analyser).connect(audioCtx.destination);
    analyser.fftSize=2048;
  }
}
audioEl.onplay=()=>{initAudioCtx();drawOsc();};
function drawOsc(){
  requestAnimationFrame(drawOsc);
  const buffer=new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(buffer);
  ctx.fillStyle='#000';ctx.fillRect(0,0,oscCanvas.width,oscCanvas.height);
  ctx.strokeStyle='#9cff8b';ctx.beginPath();
  const slice=oscCanvas.width/buffer.length;let x=0;
  for(let i=0;i<buffer.length;i++){
    const y=(buffer[i]/128)*oscCanvas.height/2;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    x+=slice;
  }
  ctx.stroke();
}

/* ===== GENERATOR ===== */
const genOsc=document.getElementById('genOsc');
const genCtx=genOsc.getContext('2d');
const genPlay=document.getElementById('genPlay');
const genStop=document.getElementById('genStop');
const freqInput=document.getElementById('freqInput');
let oscNode=null;

function initGenCtx(){
  if(!audioCtx)initAudioCtx();
}
genPlay.onclick=()=>{
  initGenCtx();
  oscNode=audioCtx.createOscillator();
  oscNode.frequency.value=parseFloat(freqInput.value);
  oscNode.connect(gainNode);
  oscNode.start();
  drawGenOsc();
};
genStop.onclick=()=>{
  if(oscNode){oscNode.stop();oscNode.disconnect();oscNode=null;}
};

function drawGenOsc(){
  requestAnimationFrame(drawGenOsc);
  const buffer=new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(buffer);
  genCtx.fillStyle='#000';genCtx.fillRect(0,0,genOsc.width,genOsc.height);
  genCtx.strokeStyle='#9cff8b';genCtx.beginPath();
  const slice=genOsc.width/buffer.length;let x=0;
  for(let i=0;i<buffer.length;i++){
    const y=(buffer[i]/128)*genOsc.height/2;
    i===0?genCtx.moveTo(x,y):genCtx.lineTo(x,y);
    x+=slice;
  }
  genCtx.stroke();
}
</script>
</body>
</html>
