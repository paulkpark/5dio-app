<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Pro</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#060a12; --panel:#0a1222; --panel2:#0c162c; --line:#23324f;
  --text:#e9f2ff; --muted:#a8b5d6; --glow:#74f0c8; --glow2:#8aa8ff; --accent:#9fe7ff;
  --btn:#101b34; --btnBorder:#79b4ff3a; --good:#71f0c5; --warn:#ffd27e;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 700px at 20% -10%, #131e36, transparent),
linear-gradient(#061021,#090f18);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,"Helvetica Neue",Arial}
/* Header */
header{position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;padding:12px 16px;background:rgba(6,14,25,.75);backdrop-filter: blur(10px);border-bottom:1px solid #ffffff14}
.title{font-weight:900;font-size:20px;letter-spacing:.2px;background:linear-gradient(90deg,#c6b3ff,#86e6ff,#84ffc9);-webkit-background-clip:text;color:transparent;text-shadow:0 0 18px #5ae0ff3a}
.left{display:flex;align-items:center;gap:12px}
.menu-wrap{position:relative}
.hamburger{width:36px;height:28px;border-radius:12px;border:1px solid var(--line);display:grid;place-items:center;background:linear-gradient(#0b172e,#0a1426);cursor:pointer;box-shadow:inset 0 0 0 1px #ffffff08}
.hamburger span,.hamburger span:before,.hamburger span:after{content:"";display:block;width:18px;height:2px;background:#cfe3ff;border-radius:2px;position:relative;box-shadow:0 0 10px #cfe3ff40}
.hamburger span:before{position:absolute;transform:translateY(-6px)} .hamburger span:after{position:absolute;transform:translateY(6px)}
.dropdown{display:none;position:absolute;top:36px;left:0;background:linear-gradient(180deg,#0d1528,#0a1222);border:1px solid var(--line);border-radius:14px;min-width:260px;overflow:hidden;box-shadow:0 10px 30px #0008}
.dropdown a{display:block;padding:12px 14px;color:var(--text);text-decoration:none;border-bottom:1px solid #ffffff10}
.dropdown a:last-child{border-bottom:0}
.backdrop{position:fixed;inset:0;background:#0008;display:none;pointer-events:none;z-index:900}
.backdrop.show{display:block;pointer-events:auto}
/* Tabs (shifted right for small title on one line) */
.tabs{justify-self:center;display:flex;gap:12px;transform:translateX(56px)}
.tab{padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(#0c1831,#0a1222);color:var(--text);cursor:pointer;box-shadow:0 0 0 1px #ffffff08,inset 0 0 20px #3bd1ff0e}
.tab.active{border-color:#7ef1c099;box-shadow:0 0 20px #86e6ff33, inset 0 0 30px #78ffcb1a}
/* Right controls */
.right{justify-self:end}
.pill{border:1px solid var(--line);background:linear-gradient(#0c1831,#0a1222);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;min-width:46px}
/* Layout */
main{max-width:1200px;margin:0 auto;padding:16px}
section{display:none} section.active{display:block}
.card{background:linear-gradient(180deg,#0a1326,#0a1222);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 10px 40px #0006}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.pbtn{height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--btnBorder);background:linear-gradient(#0e1a33,#0a152a);color:#eaf2ff;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;max-height:54vh;overflow:auto;padding-right:4px}
.thumb{position:relative;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#0b1222;cursor:pointer;transition:transform .12s}
.thumb:hover{transform:translateY(-2px)}
.thumb .skeleton{position:absolute;inset:0;background:linear-gradient(90deg,#0c152e 0%,#132342 50%,#0c152e 100%);background-size:200% 100%;animation:shimmer 1.3s infinite}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.thumb img{display:block;width:100%;height:112px;object-fit:cover}
.thumb .t{display:block;padding:8px 10px;font-size:12px;color:#cfe0ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.visual, .osc{margin-top:12px;border:1px solid var(--line);border-radius:14px;height:160px;position:relative;overflow:hidden;background:linear-gradient(180deg,#0a1428,#081021)}
/* Generator form */
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
label{color:var(--muted);font-size:13px}
input[type="number"], input[type="text"], select{height:40px;border-radius:10px;border:1px solid var(--line);background:#0f1931;color:var(--text);padding:0 10px}
input[type="range"]{accent-color:#82ffd6}
.gbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.gbtn{height:44px;min-width:44px;padding:0 14px;border-radius:12px;border:1px solid #86e6ff44;background:linear-gradient(180deg,#0f1b36,#0a1222);color:#eaf2ff;cursor:pointer;box-shadow:0 2px 16px #85e6ff1f, inset 0 0 20px #6fffd41b}
.gbtn:active{transform:translateY(1px)}
.preset{height:44px;border-radius:12px;border:1px solid #86e6ff44;background:#0f1b36;color:#eaf2ff;padding:0 10px;min-width:200px}
.switch{--w:48px;--h:26px;position:relative;width:var(--w);height:var(--h);background:#152346;border:1px solid var(--line);border-radius:999px}
.switch input{appearance:none;width:100%;height:100%;margin:0}
.knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:999px;background:#d8e6ff;transition:left .18s cubic-bezier(.2,.8,.2,1);box-shadow:0 2px 8px #0006}
.switch input:checked + .knob{left:24px;background:#89ffd9}
@media (max-width:820px){ .tabs{transform:translateX(48px)} .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="left">
    <div class="menu-wrap">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
        <a class="menu-text" data-file="faq">FAQ</a>
        <a class="menu-text" data-file="manual">Manual</a>
        <a class="menu-text" data-file="contact">Contact</a>
        <a class="menu-text" data-file="about">About</a>
      </div>
    </div>
    <div class="title">5DO Pro</div>
  </div>
  <div class="tabs">
    <button class="tab active" data-target="lib">5DO</button>
    <button class="tab" data-target="gen">Freq. Gen.</button>
  </div>
  <div class="right">
    <button id="langToggle" class="pill">KO</button>
  </div>
</header>
<div id="backdrop" class="backdrop"></div>

<main>
  <!-- Library -->
  <section id="lib" class="active">
    <div class="card">
      <div class="toolbar">
        <button id="loopBtn" class="pbtn">Loop</button>
        <button id="timerBtn" class="pbtn">Timer</button>
        <button id="playlistBtn" class="pbtn">Playlist</button>
      </div>
      <div id="thumbs" class="grid"></div>
      <audio id="player" controls style="margin-top:12px;width:100%"></audio>
      <div class="visual"><canvas id="viz"></canvas></div>
    </div>
  </section>

  <!-- Generator -->
  <section id="gen">
    <div class="card">
      <div class="row">
        <div class="field">
          <label id="lblFreq">Frequency (Hz)</label>
          <input id="gFreq" type="number" value="432" min="1" max="20000" step="0.1">
        </div>
        <div class="field">
          <label id="lblWave">Waveform</label>
          <select id="gWave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Sawtooth</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="field">
          <div style="display:flex;align-items:center;gap:10px">
            <label id="lblBB">Binaural</label>
            <label class="switch"><input id="gBB" type="checkbox"><span class="knob"></span></label>
          </div>
          <label id="lblDiff" for="gBeat">Difference (Hz)</label>
          <input id="gBeat" type="number" value="7" step="0.1" min="0" max="100">
        </div>
        <div class="field">
          <label id="lblHar">Harmonics</label>
          <input id="gHar" type="text" value="1" placeholder="0.5,2,3">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="field">
          <label id="lblLevel" for="gLevel">Level</label>
          <input id="gLevel" type="range" value="50" min="0" max="100">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="gbar">
            <button id="gToggle" class="gbtn" title="Play/Pause">Play</button>
            <button id="gSave" class="gbtn" title="Save Preset">Save</button>
            <select id="gPreset" class="preset"><option value="">Select Preset</option></select>
            <button id="gDelete" class="gbtn" title="Delete Preset">Delete</button>
          </div>
        </div>
      </div>

      <div class="osc"><canvas id="osc"></canvas></div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
window.addEventListener('DOMContentLoaded', function(){
  const SUPA_URL="https://xdjgumqdwedgzwqturcx.supabase.co";
  const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
  const BUCKET="media"; const PUBLIC_BASE=`${SUPA_URL}/storage/v1/object/public/${BUCKET}`;
  const supa = window.supabase?.createClient(SUPA_URL,SUPA_KEY) || null;

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const thumbs=$('#thumbs'), audioEl=$('#player');
  const langKey='lang5do_pro'; let lang=localStorage.getItem(langKey)||'ko';

  const I18N={en:{tabs:{lib:'5DO',gen:'Freq. Gen.'},loop:'Loop',timer:'Timer',playlist:'Playlist',freq:'Frequency (Hz)',wave:'Waveform',binaural:'Binaural',diff:'Difference (Hz)',har:'Harmonics',level:'Level',play:'Play',pause:'Pause',save:'Save',del:'Delete',sel:'Select Preset'},
              ko:{tabs:{lib:'5DO',gen:'주파수 생성기'},loop:'루프',timer:'타이머',playlist:'플레이리스트',freq:'주파수 (Hz)',wave:'파형',binaural:'Binaural',diff:'차이 (Hz)',har:'배음',level:'레벨',play:'재생',pause:'일시정지',save:'저장',del:'삭제',sel:'프리셋 선택'}};
  function t(k){ return k.split('.').reduce((o,kk)=>o&&o[kk],I18N[lang])||k; }
  function applyLang(){ $('[data-target="lib"]').textContent=t('tabs.lib'); $('[data-target="gen"]').textContent=t('tabs.gen'); $('#langToggle').textContent=(lang==='en'?'EN':'KO'); $('#lblFreq').textContent=t('freq'); $('#lblWave').textContent=t('wave'); $('#lblBB').textContent=t('binaural'); $('#lblDiff').textContent=t('diff'); $('#lblHar').textContent=t('har'); $('#lblLevel').textContent=t('level'); $('#loopBtn').textContent=t('loop'); $('#timerBtn').textContent=t('timer'); $('#playlistBtn').textContent=t('playlist'); const fo=$('#gPreset').querySelector('option'); if(fo) fo.textContent=t('sel'); $('#gToggle').textContent=genOn?t('pause'):t('play'); }
  applyLang();

  // Hamburger
  const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop'), backdrop=$('#backdrop');
  menuBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const open=menuDrop.style.display==='block'; menuDrop.style.display=open?'none':'block'; backdrop.classList.toggle('show',!open); });
  backdrop.addEventListener('click',()=>{ menuDrop.style.display='none'; backdrop.classList.remove('show'); });
  document.body.addEventListener('click',(e)=>{ if(!menuDrop.contains(e.target) && e.target!==menuBtn){ menuDrop.style.display='none'; backdrop.classList.remove('show'); }});
  $$('.menu-text').forEach(a=>a.addEventListener('click', async (e)=>{ e.preventDefault(); const name=a.dataset.file; try{ const res=await fetch(`/texts/${name}.txt?ts=${Date.now()}`); const txt=await res.text(); alert(txt); }catch(_){ alert(`[${name}.txt] 불러올 수 없습니다.`); } menuDrop.style.display='none'; backdrop.classList.remove('show'); }));

  // Tabs
  $$('.tab').forEach(btn=>btn.addEventListener('click',(e)=>{ $$('.tab').forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); const id=e.currentTarget.dataset.target; $$('main section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='gen'){ audioEl.pause(); } $('#viz').parentElement.style.display=(id==='lib')?'':'none'; $('#osc').parentElement.style.display=(id==='gen')?'':'none'; }));

  // Language toggle
  $('#langToggle').addEventListener('click',()=>{ lang=(lang==='en')?'ko':'en'; localStorage.setItem(langKey,lang); applyLang(); buildThumbs(); });

  // Supabase listing
  const AUDIO_RE=/\.(mp3|wav|m4a|aac|flac)$/i; const pathStack=[]; const currentPath=()=>pathStack.join('/');
  function isFolder(item){ return !item?.metadata; } function isAudioName(name){ return AUDIO_RE.test(name); }
  function folderThumb(path){ const img=(lang==='en')?'folder_e.jpg':'folder.jpg'; return `${PUBLIC_BASE}/${path?path+'/':''}${img}`; }
  function trackThumb(path, filename){ const base=filename.replace(AUDIO_RE,''); const suf=(lang==='en')?'_E':''; return `${PUBLIC_BASE}/${path?path+'/':''}${encodeURIComponent(base+suf)}.jpg`; }
  function trackUrl(path, filename){ return `${PUBLIC_BASE}/${path?path+'/':''}${encodeURIComponent(filename)}`; }
  async function listPath(path){ if(!supa) return []; const p=path?path+'/':''; const {data,error}=await supa.storage.from('media').list(p,{limit:1000,sortBy:{column:'name',order:'asc'}}); if(error){ console.warn('[listPath]',error); return []; } return data||[]; }
  async function buildThumbs(){ thumbs.innerHTML=''; const path=currentPath(); const list=await listPath(path);
    for(const f of list.filter(isFolder)){ const card=document.createElement('div'); card.className='thumb'; const sk=document.createElement('div'); sk.className='skeleton'; card.appendChild(sk); const img=new Image(); img.loading='lazy'; img.onload=()=>sk.remove(); img.onerror=()=>{ sk.remove(); img.remove(); }; const folderPath=path?`${path}/${f.name}`:f.name; img.src=folderThumb(folderPath); card.appendChild(img); const t=document.createElement('span'); t.className='t'; t.textContent=f.name; card.appendChild(t); card.addEventListener('click',()=>{ pathStack.push(f.name); buildThumbs(); }); thumbs.appendChild(card); }
    for(const file of list.filter(it=>!isFolder(it)&&isAudioName(it.name))){ const card=document.createElement('div'); card.className='thumb'; const sk=document.createElement('div'); sk.className='skeleton'; card.appendChild(sk); const img=new Image(); img.loading='lazy'; img.onload=()=>sk.remove(); img.onerror=()=>{ sk.remove(); img.remove(); }; img.src=trackThumb(path,file.name); card.appendChild(img); const t=document.createElement('span'); t.className='t'; t.textContent=file.name; card.appendChild(t); const url=trackUrl(path,file.name); card.addEventListener('click',()=>{ audioEl.src=url; audioEl.load(); audioEl.play().catch(()=>{}); }); thumbs.appendChild(card); } }

  // Visualizer
  let aCtx, analyser, msrc, rafViz;
  function ensureLibAudio(){ if(aCtx) return; aCtx=new (window.AudioContext||window.webkitAudioContext)(); analyser=aCtx.createAnalyser(); analyser.fftSize=1024; analyser.smoothingTimeConstant=.78; msrc=aCtx.createMediaElementSource(audioEl); msrc.connect(analyser); analyser.connect(aCtx.destination); }
  function drawViz(){ const cvs=$('#viz'), cx=cvs.getContext('2d'); const W=cvs.width=cvs.clientWidth, H=cvs.height=cvs.clientHeight; const data=new Uint8Array(analyser.frequencyBinCount);
    (function loop(){ rafViz=requestAnimationFrame(loop); analyser.getByteFrequencyData(data); cx.fillStyle='#0a1428'; cx.fillRect(0,0,W,H); const bars=Math.min(96, Math.floor(W/7)); const step=Math.floor(data.length/bars); const bw=Math.max(3,(W/bars)*.6);
      for(let i=0;i<bars;i++){ const v=data[i*step]/255; const bh=Math.max(4, v*(H*.9)); const x=i*(W/bars)+(W/bars-bw)/2; const y=H-bh; const g=cx.createLinearGradient(0,y,0,y+bh); g.addColorStop(0,'#84ffc9'); g.addColorStop(1,'#8aa8ff'); cx.fillStyle=g; cx.fillRect(x,y,bw,bh); } })();
  }
  audioEl.addEventListener('play',async()=>{ ensureLibAudio(); if(aCtx.state==='suspended') await aCtx.resume(); drawViz(); });
  audioEl.addEventListener('pause',()=>cancelAnimationFrame(rafViz)); audioEl.addEventListener('ended',()=>cancelAnimationFrame(rafViz));

  // Loop / Timer / Playlist
  $('#loopBtn').addEventListener('click',()=>{ audioEl.loop=!audioEl.loop; alert((audioEl.loop?(lang==='en'?'Loop: On':'루프: 켜짐'):(lang==='en'?'Loop: Off':'루프: 꺼짐'))); });
  $('#timerBtn').addEventListener('click',()=>{ const mins=parseFloat(prompt(lang==='en'?'Minutes':'분 입력','20')||'0'); if(mins>0){ setTimeout(()=>audioEl.pause(), mins*60000); alert('OK'); } });
  const PLS_KEY='pls_v1'; const plsDB=()=>{ try{return JSON.parse(localStorage.getItem(PLS_KEY)||'[]')}catch(_){return[]} }; const plsSave=(db)=>localStorage.setItem(PLS_KEY,JSON.stringify(db));
  $('#playlistBtn').addEventListener('click',()=>{ const act=prompt(lang==='en'?'Playlist action: new / add / list / del':'플레이리스트 작업: new / add / list / del'); if(!act) return; const db=plsDB();
    if(act==='new'){ const name=prompt(lang==='en'?'Playlist name':'플레이리스트 이름'); if(!name) return; db.push({name,tracks:[]}); plsSave(db); alert('OK'); }
    if(act==='add'){ const name=prompt('target name'); if(!name) return; const url=audioEl.src; const entry=db.find(p=>p.name===name); if(entry){ entry.tracks.push({path:url}); plsSave(db); alert('added'); } }
    if(act==='list'){ alert(JSON.stringify(db.map(p=>({name:p.name,count:p.tracks.length})),null,2)); }
    if(act==='del'){ const name=prompt('name to delete'); if(!name) return; const out=db.filter(p=>p.name!==name); plsSave(out); alert('deleted'); }
  });

  // Generator
  let gctx,gGain,gMerge,gOscL,gOscR,gAnalyser,rafOsc,genOn=false;
  function ensureGenCtx(){ if(!gctx) gctx=new (window.AudioContext||window.webkitAudioContext)(); if(!gGain){ gGain=gctx.createGain(); gGain.gain.value=parseFloat(gLevel.value||'50')/100; gGain.connect(gctx.destination);} if(!gAnalyser){ gAnalyser=gctx.createAnalyser(); gAnalyser.fftSize=2048; } }
  function stopGen(){ try{gOscL&&gOscL.stop()}catch(e){} try{gOscR&&gOscR.stop()}catch(e){} gOscL=gOscR=null; if(gMerge){ try{gMerge.disconnect()}catch(e){} gMerge=null; cancelAnimationFrame(rafOsc); }
  async function startGen(){ ensureGenCtx(); if(gctx.state==='suspended') await gctx.resume(); stopGen(); const freq=parseFloat(gFreq.value||'432'), wave=gWave.value||'sine', useBB=gBB.checked, beat=Math.max(0,parseFloat(gBeat.value||'7')); const harms=(gHar.value||'1').split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n)&&isFinite(n));
    gMerge=gctx.createChannelMerger(2); const tap=gctx.createGain(); tap.connect(gAnalyser); gMerge.connect(tap); gMerge.connect(gGain);
    function mk(f,ch){ const o=gctx.createOscillator(); o.type=wave; o.frequency.value=f; const g=gctx.createGain(); g.gain.value=0.9/Math.max(1,harms.length); o.connect(g); g.connect(gMerge,0,ch); o.start(); return o; }
    const L=useBB?(freq-beat/2):freq, R=useBB?(freq+beat/2):freq; gOscL=mk(L,0); gOscR=mk(R,1); harms.forEach(r=>{ if(!isFinite(r)||r===1) return; mk(L*r,0); mk(R*r,1); }); drawOsc();
  }
  function drawOsc(){ const cvs=$('#osc'), cx=cvs.getContext('2d'); const W=cvs.width=cvs.clientWidth, H=cvs.height=cvs.clientHeight; const buf=new Uint8Array(gAnalyser.fftSize);
    (function loop(){ rafOsc=requestAnimationFrame(loop); gAnalyser.getByteTimeDomainData(buf); cx.fillStyle='#081021'; cx.fillRect(0,0,W,H); cx.strokeStyle='#9fd6ff'; cx.lineWidth=1.4; cx.beginPath(); for(let i=0;i<buf.length;i++){ const x=i/buf.length*W; const y=(buf[i]/255)*H; (i?cx.lineTo(x,y):cx.moveTo(x,y)); } cx.stroke(); })();
  }
  $('#gToggle').addEventListener('click', async ()=>{ if(!genOn){ await startGen(); genOn=true; $('#gToggle').textContent=t('pause'); } else { stopGen(); genOn=false; $('#gToggle').textContent=t('play'); } });
  $('#gLevel').addEventListener('input',()=>{ ensureGenCtx(); gGain.gain.value=parseFloat(gLevel.value||'50')/100; });
  $('#gBB').addEventListener('change',()=>{ gBeat.disabled=!gBB.checked; }); gBeat.disabled=!gBB.checked;
  const PKEY='genPresets_pro_clean_v1'; const gdb=()=>{ try{return JSON.parse(localStorage.getItem(PKEY)||'[]')}catch(e){return[]} }; const gsave=(arr)=>localStorage.setItem(PKEY,JSON.stringify(arr.slice(0,10))); const gcurrent=()=>({freq:gFreq.value,wave:gWave.value,bin:gBB.checked,beat:gBeat.value,harm:gHar.value,level:gLevel.value});
  function renderPresetList(){ const sel=$('#gPreset'); sel.innerHTML='<option value="">'+t('sel')+'</option>'; gdb().forEach(p=>{ const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; sel.appendChild(o); }); }
  $('#gSave').addEventListener('click',()=>{ const name=prompt(lang==='en'?'Preset name':'프리셋 이름'); if(!name) return; const arr=gdb().filter(p=>p.name!==name); arr.unshift({name,data:gcurrent()}); gsave(arr); renderPresetList(); });
  $('#gDelete').addEventListener('click',()=>{ const name=$('#gPreset').value; if(!name) return; gsave(gdb().filter(p=>p.name!==name)); renderPresetList(); });
  $('#gPreset').addEventListener('change',()=>{ const name=$('#gPreset').value; if(!name) return; const f=gdb().find(p=>p.name===name); if(!f) return; const d=f.data||{}; gFreq.value=d.freq||'432'; gWave.value=d.wave||'sine'; gBB.checked=!!d.bin; gBeat.value=d.beat||'7'; gHar.value=d.harm||'1'; gLevel.value=d.level||'50'; gBeat.disabled=!gBB.checked; });

  // Unlock
  const unlock=()=>{ try{ if(aCtx && aCtx.state==='suspended') aCtx.resume(); if(gctx && gctx.state==='suspended') gctx.resume(); }catch(_){} window.removeEventListener('touchend',unlock); window.removeEventListener('click',unlock); };
  window.addEventListener('touchend',unlock,{once:true}); window.addEventListener('click',unlock,{once:true});

  // Build
  applyLang(); buildThumbs(); renderPresetList();
  $('#viz').parentElement.style.display=''; $('#osc').parentElement.style.display='none';
});
</script>
</body>
</html>
