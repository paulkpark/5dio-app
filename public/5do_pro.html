<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Pro</title>
<style>
:root{
  --bg:#0b0f17; --panel:#121a26; --accent:#86ffc8; --accent2:#55d0ff;
  --text:#e6f6ee; --muted:#9bb3bf; --border:#1f2a3a; --ink:#0e131b;
}
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,pretendard,sans-serif}
button,input,select{font:inherit}
a{color:inherit;text-decoration:none}
.hidden{display:none!important}

/* Header + Tabs */
header{display:flex;align-items:center;gap:10px;justify-content:space-between;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border); position:sticky;top:0;z-index:50}
.left-pack{display:flex;align-items:center;gap:10px}
.logo{font-weight:700;color:var(--accent);font-size:1.05rem;letter-spacing:.5px;display:flex;align-items:center;gap:10px}
.tabs{display:flex;gap:8px}
.tab{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#171d2b;color:#cfead1;cursor:pointer}
.tab.active{background:#1f2739;border-color:#334}

/* Hamburger (프레임 포함: Lite와 동일 스타일) */
.menu-container{position:relative}
.hamburger{width:28px;height:22px;border:1px solid #2a3647;border-radius:6px;display:grid;place-items:center;cursor:pointer;position:relative;top:3px}
.hamburger::before,.hamburger::after,.hamburger span{content:"";display:block;width:16px;height:2px;background:#cfead1;border-radius:2px}
.hamburger span{transform:translateY(0)}
.hamburger::before{transform:translateY(-5px)}
.hamburger::after{transform:translateY(5px)}
.dropdown{position:absolute;left:0;top:36px;min-width:260px;max-width:min(90vw,320px);background:#0f1622;border:1px solid var(--border);border-radius:12px;padding:12px;display:none;z-index:60}
.dropdown.open{display:block}
.dropdown .item{display:block;padding:10px 12px;border-radius:8px;color:#dfe9f1}
.dropdown .item:hover{background:#172131}
.dropdown .doc{white-space:pre-wrap;max-height:45vh;overflow:auto;margin-top:8px;padding:10px;background:#0b111a;border:1px solid #1a2534;border-radius:10px}

/* Main sections */
section{display:none;padding:12px}
section.active{display:block}

/* Library bar (Back/Refresh + EN/KR 토글 선택시 확장 용도 가능) */
.topbar{display:flex;align-items:center;gap:10px;justify-content:space-between;margin:10px 0}
.navbtn{width:32px;height:32px;border:1px solid var(--border);background:#0f1622;border-radius:8px;display:grid;place-items:center;cursor:pointer}
.path{font-size:.9rem;color:var(--muted)}

/* Horizontal thumbnail rail */
.rail{display:flex;gap:10px;overflow-x:auto;padding:8px;border:1px solid var(--border);border-radius:12px;background:#0f1622}
.card{flex:0 0 auto;width:120px}
.thumb{width:120px;height:120px;background:#0e141e;border:1px solid #1a2534;border-radius:12px;display:grid;place-items:center;position:relative;overflow:hidden}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.thumb .tag{position:absolute;bottom:6px;left:6px;font-size:.72rem;padding:2px 6px;border-radius:6px;background:#0c121b;color:#9fb7c7;border:1px solid #1d2a3a}
.ctitle{font-size:.86rem;margin-top:6px;color:#cfead1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Player strip */
.player{margin-top:14px;border:1px solid var(--border);border-radius:14px;background:#0f1622;padding:10px}
.playrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.statusThumb{width:124px;height:124px;border-radius:12px;border:1px solid #1a2534;overflow:hidden;background:
  radial-gradient(120px 120px at 20% 20%, #172235 0,#0b0f17 70%),
  conic-gradient(from 0deg,#0f1827,#152239,#0f1827);
  position:relative}
.statusThumb img{width:100%;height:100%;object-fit:cover;display:block}
.controls{display:flex;align-items:center;gap:12px;flex:1;min-width:240px}
.controls button{height:36px;padding:0 14px;border:1px solid var(--border);background:#172131;color:#dff2e7;border-radius:10px;cursor:pointer}
.controls button:hover{background:#1b2738}
.volblk{display:flex;align-items:center;gap:10px}
.volblk input[type="range"]{width:180px}
.opts{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.opts select,.opts input[type="checkbox"]{height:36px}
.smalllabel{font-size:.8rem;color:#9fb7c7}

/* Visualizer (bar spectrum) boxed 고정창) */
.vizbox{margin-top:10px;border:1px solid var(--border);border-radius:12px;background:#0f1622;padding:8px}
#viz{width:100%;height:120px;display:block}

/* Playlist bottom sheet */
.sheet-mask{position:fixed;inset:0;background:#0006;display:none;z-index:90}
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);
  background:#0f1622;border-top:1px solid var(--border);border-radius:16px 16px 0 0;
  padding:14px;z-index:95;transition:.25s}
.sheet.open{transform:translateY(0)}
.sheet-mask.show{display:block}
.sheet h3{margin:0 0 10px 0;font-size:1rem;color:#cfead1}
.sheet .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.sheet input[type="text"]{flex:1;min-width:180px;padding:8px;border:1px solid var(--border);border-radius:10px;background:#121b29;color:#e9faf1}
.sheet .list{max-height:40vh;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#0b111a}
.sheet .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #132034}
.sheet .item:last-child{border-bottom:0}
.sheet .item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%}
.sheet .item .btns{display:flex;gap:8px}
.sheet .item button{padding:4px 10px;border:1px solid var(--border);border-radius:8px;background:#152033;color:#dfe9f1;cursor:pointer}

/* Gen placeholder (당신의 기존 주파수 생성기 UI를 이곳에 붙여넣기) */
.gen-wrap{border:1px dashed #244; border-radius:12px; padding:12px;background:#0f1622}

/* Utilities */
.icon{font-size:18px}
.hr{height:1px;background:linear-gradient(90deg,transparent,#22344a,transparent);margin:10px 0}
</style>
</head>
<body>

<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a class="item" data-doc="shop">Shop (새 탭)</a>
        <a class="item" data-doc="faq">FAQ</a>
        <a class="item" data-doc="manual">Manual</a>
        <a class="item" data-doc="contact">Contact</a>
        <a class="item" data-doc="about">About</a>
        <div id="menuDoc" class="doc hidden"></div>
      </div>
    </div>
    <div class="logo">5DO Pro</div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="lib">5DO</button>
    <button class="tab" data-tab="gen">Freq. Gen.</button>
  </div>
</header>

<section id="lib" class="active">
  <div class="topbar">
    <div style="display:flex;gap:8px;align-items:center">
      <button class="navbtn" id="btnBack" title="Back">⟵</button>
      <button class="navbtn" id="btnRefresh" title="Refresh">↻</button>
    </div>
    <div class="path" id="pathTxt"></div>
    <div style="display:flex;gap:8px">
      <button class="navbtn" id="btnOpenSheet" title="Playlist">♫</button>
    </div>
  </div>

  <div class="rail" id="rail"></div>

  <div class="player">
    <div class="playrow">
      <div class="statusThumb" id="statusThumb"></div>
      <div class="controls">
        <button id="btnPlay">▶︎</button>
        <button id="btnPause">⏸︎</button>
        <button id="btnStop">⏹︎</button>
        <div class="volblk">
          <span class="smalllabel">Vol</span>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"/>
          <label><input id="mute" type="checkbox"/> <span class="smalllabel">Mute</span></label>
        </div>
      </div>
      <div class="opts">
        <label class="smalllabel"><input type="checkbox" id="loop"/> Loop</label>
        <div>
          <span class="smalllabel">Timer</span>
          <select id="timerSel">
            <option value="0">Off</option>
            <option value="5">5m</option>
            <option value="10">10m</option>
            <option value="15">15m</option>
            <option value="20">20m</option>
            <option value="30">30m</option>
            <option value="45">45m</option>
            <option value="60">60m</option>
          </select>
        </div>
      </div>
    </div>

    <div class="vizbox"><canvas id="viz"></canvas></div>

    <audio id="player" crossorigin="anonymous"></audio>
  </div>
</section>

<section id="gen">
  <!-- ✅ 당신의 기존 Pro 주파수 생성기 UI/스크립트를 이 컨테이너 안에 붙여 넣으세요. -->
  <div class="gen-wrap">
    <div class="smalllabel">Paste your Freq. Gen. UI here (kept as-is).</div>
  </div>
</section>

<!-- Playlist Bottom Sheet -->
<div class="sheet-mask" id="sheetMask"></div>
<div class="sheet" id="sheet">
  <h3>Playlists</h3>
  <div class="row">
    <input type="text" id="plName" placeholder="New playlist name"/>
    <button id="plSave">Save current</button>
  </div>
  <div class="list" id="plList"></div>
</div>

<script>
/* =========================
   Config (Supabase + Paths)
   ========================= */
const SUPA_URL  = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPA_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET    = "media";
const PUB_BASE  = `${SUPA_URL}/storage/v1/object/public/${BUCKET}`; // 원본 접근
const IMG_BASE  = `${SUPA_URL}/storage/v1/render/image/public/${BUCKET}`; // 리사이즈 썸네일

/* ==============
   UI Wiring
   ============== */
const rail = document.getElementById('rail');
const pathTxt = document.getElementById('pathTxt');
const btnBack = document.getElementById('btnBack');
const btnRefresh = document.getElementById('btnRefresh');
const btnOpenSheet = document.getElementById('btnOpenSheet');

const btnPlay = document.getElementById('btnPlay');
const btnPause = document.getElementById('btnPause');
const btnStop = document.getElementById('btnStop');
const vol = document.getElementById('vol');
const mute = document.getElementById('mute');
const loop = document.getElementById('loop');
const timerSel = document.getElementById('timerSel');
const player = document.getElementById('player');
const statusThumb = document.getElementById('statusThumb');

const canvas = document.getElementById('viz');
const g = canvas.getContext('2d');

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('section').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
    // Viz는 라이브러리 탭에서만 렌더 루프
    if(t.dataset.tab==='lib'){ startVizIfPlaying(); } else { stopViz(); }
  });
});

/* Hamburger */
const menuBtn = document.getElementById('menuBtn');
const menuDrop = document.getElementById('menuDrop');
const menuDoc  = document.getElementById('menuDoc');
menuBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  menuDrop.classList.toggle('open');
  if(!menuDrop.classList.contains('open')) menuDoc.classList.add('hidden');
});
document.addEventListener('click', (e)=>{
  if(!menuDrop.contains(e.target) && !menuBtn.contains(e.target)){
    menuDrop.classList.remove('open'); menuDoc.classList.add('hidden');
  }
});
menuDrop.addEventListener('click', async (e)=>{
  const a = e.target.closest('.item'); if(!a) return;
  const key = a.dataset.doc;
  if(key==='shop'){ window.open('https://5dshop.co.kr','_blank','noopener'); return; }
  menuDoc.classList.remove('hidden');
  try{
    const res = await fetch(`/texts/${key}.txt?ts=`+Date.now());
    menuDoc.textContent = res.ok ? await res.text() : '(no content)';
  }catch{ menuDoc.textContent='(failed to load)'; }
});

/* ===========
   State
   =========== */
let cwd = "";               // current “virtual” path inside bucket
let stack = [];             // history for Back
let timerId = null;
let audioCtx, srcNode, gainNode, analyser;
let vizRunning = false;
let decodedQueue = [];      // 현재(가시) 폴더의 트랙 리스트 (썸네일/URL 포함)

/* ===========================
   Helpers (URL & Thumbnails)
   =========================== */
const encPath = (p)=> p.split('/').map(encodeURIComponent).join('/');
const fileURL = (path)=> `${PUB_BASE}/${encPath(path)}`;
const imgURL  = (path, w=360)=> `${IMG_BASE}/${encPath(path)}?width=${w}&quality=70&format=webp`;

/* 폴더 썸네일: folder.jpg 우선 → folder.png 폴백 */
const folderThumb = async (folder) => {
  const jpg = `${folder}/folder.jpg`;
  const png = `${folder}/folder.png`;
  const ok = await head(fileURL(jpg));
  return ok ? imgURL(jpg, 360) : imgURL(png, 360);
};

/* 파일 썸네일: 파일명과 동일(.jpg) → .png 폴백 */
const audioThumb = async (folder, base) => {
  const jpg = `${folder}/${base}.jpg`;
  const png = `${folder}/${base}.png`;
  const ok = await head(fileURL(jpg));
  return ok ? imgURL(jpg, 360) : imgURL(png, 360);
};
async function head(url){
  try{ const r = await fetch(url, {method:'HEAD', cache:'no-store'}); return r.ok; }catch{ return false; }
}

/* ======================
   List (root or folder)
   ====================== */
/* Supabase public list: 오브젝트 인덱싱이 없으므로
   - 폴더 목록은 사전 약속된 category 폴더명 배열을 사용하거나
   - 서버에서 tree API를 제공해야 함.
   여기서는 실사용 구조에 맞춰 “1-depth 카테고리 폴더들이 고정/유한”이라고 가정하고 간단 배열 선언.
*/
const ROOT_FOLDERS = [
  "Brainwave_States","Crystal_Frequencies","White_Noise",
  "Torus_Harmonics","Meditation_Breathwork","Quantum_Torus_X"
];

async function listRoot(){
  pathTxt.textContent = "/";
  rail.innerHTML = "";
  decodedQueue = [];
  for(const fo of ROOT_FOLDERS){
    const card = await makeFolderCard(fo);
    rail.appendChild(card);
  }
}

async function makeFolderCard(name){
  const card = document.createElement('div'); card.className='card';
  const t = document.createElement('div'); t.className='thumb';
  const img = document.createElement('img');
  img.alt = name;
  try{ img.src = await folderThumb(name); }catch{ /* ignore */ }
  t.appendChild(img);
  const tag = document.createElement('div'); tag.className='tag'; tag.textContent=''; t.appendChild(tag);
  const title = document.createElement('div'); title.className='ctitle'; title.textContent=name;
  card.appendChild(t); card.appendChild(title);
  card.addEventListener('click', ()=> enterFolder(name));
  return card;
}

async function enterFolder(name){
  stack.push(cwd);
  cwd = name;
  await listFolder(name);
}

async function listFolder(folder){
  pathTxt.textContent = "/"+folder;
  rail.innerHTML = "";
  decodedQueue = [];

  // 간단 규칙: 해당 폴더에 있는 mp3 나열 (이름 목록이 고정이 아니라면 서버가 파일목록 JSON을 내려줘야 함)
  // 여기서는 “썸네일이 존재하는 파일들만 표시”를 위해 후보 이름을 HEAD로 탐지.
  const candidates = await guessAudioNames(folder);
  for(const base of candidates){
    const card = await makeAudioCard(folder, base);
    rail.appendChild(card);
    decodedQueue.push({folder, base});
  }
}

// 휴리스틱: 폴더의 썸네일 리스트를 미리 알고 있지 않으므로, 몇 가지 네임패턴/샘플을 탐색.
// 실제 서비스에선 서버에서 JSON 목록을 내려받도록 바꾸는 걸 권장.
async function guessAudioNames(folder){
  // 간단히 png/jpg 썸네일 존재로 판단 → 같은 이름의 mp3 존재 가정
  // 아래 샘플 후보를 늘리고 싶으면 push.
  const seeds = [
    "Gamma","Gamma_Expansion","Alpha","Theta","Delta","Schumann",
    "Rose_Quartz","Moldavite_Activation","Rainy_Day_in_Amazon_Forest"
  ];
  const out=[];
  for(const base of seeds){
    const ok = (await head(fileURL(`${folder}/${base}.jpg`))) ||
               (await head(fileURL(`${folder}/${base}.png`)));
    const okmp3 = await head(fileURL(`${folder}/${base}.mp3`));
    if(ok && okmp3) out.push(base);
  }
  return out;
}

async function makeAudioCard(folder, base){
  const card = document.createElement('div'); card.className='card';
  const t = document.createElement('div'); t.className='thumb';
  const img = document.createElement('img'); img.alt=base;
  try{ img.src = await audioThumb(folder, base); }catch{}
  t.appendChild(img);
  const tag = document.createElement('div'); tag.className='tag'; tag.textContent=''; t.appendChild(tag);
  const title = document.createElement('div'); title.className='ctitle'; title.textContent=base.replace(/_/g,' ');
  card.appendChild(t); card.appendChild(title);
  card.addEventListener('click', ()=> selectTrack(folder, base)); // 로딩만, 자동재생 금지
  return card;
}

/* =====================
   Select / Play Logic
   ===================== */
function setStatusThumb(url){
  statusThumb.innerHTML = '';
  if(url){
    const img = document.createElement('img');
    img.src = url; statusThumb.appendChild(img);
  } // 없으면 기본 배경
}

async function selectTrack(folder, base){
  // 썸네일 표시
  try{ setStatusThumb(await audioThumb(folder, base)); }catch{ setStatusThumb(null); }
  // 소스만 설정(자동재생 금지)
  player.src = fileURL(`${folder}/${base}.mp3`) + `?ts=${Date.now()}`;
  player.loop = loop.checked;
  // 사용자가 ▶︎ 눌러야만 재생
}

/* ===========
   Back/Refresh
   =========== */
btnBack.addEventListener('click', async ()=>{
  if(!stack.length){ cwd=""; await listRoot(); return; }
  cwd = stack.pop()||"";
  if(cwd){ await listFolder(cwd); } else { await listRoot(); }
});
btnRefresh.addEventListener('click', async ()=>{
  if(cwd){ await listFolder(cwd); } else { await listRoot(); }
});

/* ===========
   Audio Graph
   =========== */
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  const dest = audioCtx.destination;

  if(srcNode) srcNode.disconnect();
  const elNode = audioCtx.createMediaElementSource(player);
  srcNode = elNode;
  elNode.connect(gainNode).connect(analyser).connect(dest);
  updateGain();
}
function updateGain(){
  if(!gainNode) return;
  const val = mute.checked ? 0 : Number(vol.value||0.9);
  gainNode.gain.value = val;
}
vol.addEventListener('input', updateGain);
mute.addEventListener('change', updateGain);
loop.addEventListener('change', ()=>{ player.loop = loop.checked; });

/* iOS Unlock */
['pointerdown','touchstart','click'].forEach(ev=>{
  window.addEventListener(ev, ()=>{
    if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
  }, {passive:true, once:false});
});

/* ===== Controls ===== */
btnPlay.addEventListener('click', async ()=>{
  ensureAudio();
  if(audioCtx.state==='suspended') await audioCtx.resume();
  await player.play().catch(()=>{});
  startVizIfPlaying();
});
btnPause.addEventListener('click', ()=>{
  player.pause(); stopViz();
});
btnStop.addEventListener('click', ()=>{
  player.pause(); player.currentTime = 0; stopViz();
});

/* Timer */
timerSel.addEventListener('change', ()=>{
  if(timerId){ clearTimeout(timerId); timerId=null; }
  const min = Number(timerSel.value||0);
  if(min>0){
    timerId = setTimeout(()=>{ player.pause(); stopViz(); }, min*60*1000);
  }
});

/* ==============
   Visualizer
   ============== */
function resizeViz(){
  canvas.width = canvas.clientWidth * devicePixelRatio;
  canvas.height = canvas.clientHeight * devicePixelRatio;
}
window.addEventListener('resize', resizeViz); resizeViz();

function startVizIfPlaying(){
  if(vizRunning) return;
  if(!audioCtx || player.paused) return;
  vizRunning = true; renderViz();
}
function stopViz(){ vizRunning=false; }

function renderViz(){
  if(!vizRunning) return;
  requestAnimationFrame(renderViz);
  const W = canvas.width, H = canvas.height;
  g.clearRect(0,0,W,H);
  g.fillStyle = '#0b0f17';
  g.fillRect(0,0,W,H);

  const buf = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(buf);

  const bars = 72; // 미니멀
  const step = Math.floor(buf.length / bars);
  const bw = Math.max(2, Math.floor(W/(bars*1.3)));
  for(let i=0;i<bars;i++){
    const v = buf[i*step] / 255;
    const h = Math.max(2, Math.floor(v * (H*0.9)));
    const x = Math.floor(i*(W/bars));
    const y = H - h;
    const grd = g.createLinearGradient(x,y,x,y+h);
    grd.addColorStop(0, 'rgba(126,241,192,.92)');
    grd.addColorStop(.6,'rgba(85,208,255,.85)');
    grd.addColorStop(1, 'rgba(163,140,255,.80)');
    g.fillStyle = grd;
    g.fillRect(x+2, y, bw, h);
  }
}

/* ===========
   Playlist UI
   =========== */
const sheetMask = document.getElementById('sheetMask');
const sheet = document.getElementById('sheet');
const plName = document.getElementById('plName');
const plSave = document.getElementById('plSave');
const plList = document.getElementById('plList');

btnOpenSheet.addEventListener('click', ()=>{ openSheet(); renderPL(); });
sheetMask.addEventListener('click', closeSheet);
function openSheet(){ sheet.classList.add('open'); sheetMask.classList.add('show'); }
function closeSheet(){ sheet.classList.remove('open'); sheetMask.classList.remove('show'); }

plSave.addEventListener('click', ()=>{
  const name = (plName.value||'').trim();
  if(!name) return;
  // 현재 폴더의 decodedQueue를 그 상태로 저장 (트랙 절대경로 리스트)
  const items = decodedQueue.map(x=>`${x.folder}/${x.base}.mp3`);
  const key = `PL_${name}`;
  localStorage.setItem(key, JSON.stringify(items));
  if(!localStorage.getItem('__PL_INDEX__')){
    localStorage.setItem('__PL_INDEX__', JSON.stringify([name]));
  }else{
    const idx = JSON.parse(localStorage.getItem('__PL_INDEX__'));
    if(!idx.includes(name)){ idx.push(name); localStorage.setItem('__PL_INDEX__', JSON.stringify(idx)); }
  }
  renderPL();
});

function renderPL(){
  plList.innerHTML = '';
  const idx = JSON.parse(localStorage.getItem('__PL_INDEX__')||'[]');
  for(const nm of idx){
    const row = document.createElement('div'); row.className='item';
    const left = document.createElement('div'); left.className='name'; left.textContent = nm;
    const btns = document.createElement('div'); btns.className='btns';
    const bLoad = document.createElement('button'); bLoad.textContent='Load';
    const bDel  = document.createElement('button'); bDel.textContent='Delete';
    bLoad.addEventListener('click', ()=> loadPlaylist(nm));
    bDel.addEventListener('click', ()=> delPlaylist(nm));
    btns.appendChild(bLoad); btns.appendChild(bDel);
    row.appendChild(left); row.appendChild(btns);
    plList.appendChild(row);
  }
}
function loadPlaylist(nm){
  const key = `PL_${nm}`;
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  // 로드 시, rail을 ‘해당 트랙 카드들’로 구성 (간편 로더)
  rail.innerHTML=''; decodedQueue=[];
  (async ()=>{
    for(const p of arr){
      const [folder, file] = p.split('/'); // folder/base.mp3
      const base = file.replace(/\.mp3$/,'');
      const card = await makeAudioCard(folder, base);
      rail.appendChild(card);
      decodedQueue.push({folder, base});
    }
    pathTxt.textContent = `(playlist) ${nm}`;
    cwd = ""; stack=[];
  })();
  closeSheet();
}
function delPlaylist(nm){
  const key = `PL_${nm}`; localStorage.removeItem(key);
  const idx = JSON.parse(localStorage.getItem('__PL_INDEX__')||'[]').filter(x=>x!==nm);
  localStorage.setItem('__PL_INDEX__', JSON.stringify(idx));
  renderPL();
}

/* ===========
   Init
   =========== */
async function boot(){
  await listRoot();
  updateGain();
}
boot();

/* =============
   Resize canvas
   ============= */
new ResizeObserver(resizeViz).observe(document.querySelector('.vizbox'));
</script>
</body>
</html>
