<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Lite</title>
<style>
  :root{
    --bg:#0b0f17; --panel:#101826; --panel2:#0f1524; --border:#334;
    --text:#cfead1; --muted:#8fb1a0; --accent:#7ef1c0; --accent2:#55d0ff; --accent3:#a38cff;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{display:flex;align-items:center;gap:10px;justify-content:space-between;
    padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
  .left-pack{display:flex;align-items:center;gap:10px}
  .logo{font-weight:700;color:var(--accent);font-size:1.05rem}
  .right-pack{display:flex;align-items:center;gap:10px}

  /* Hamburger (Lite 스타일 프레임) */
  .menu-container{position:relative}
  .hamburger{width:34px;height:26px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;cursor:pointer;background:#131c2b}
  .hamburger span,.hamburger span::before,.hamburger span::after{display:block;content:"";width:16px;height:2px;background:#cfead1;border-radius:2px;position:relative}
  .hamburger span::before{position:absolute;top:-6px}
  .hamburger span::after {position:absolute;top: 6px}

  .side-menu{display:none;position:absolute;top:34px;left:0;background:#0f1524;border:1px solid #324;
    border-radius:12px;padding:10px;width:min(260px,80vw);box-shadow:0 20px 50px rgba(0,0,0,.45)}
  .side-menu.open{display:block}
  .menu-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:saturate(120%) blur(2px);display:none}
  .menu-backdrop.show{display:block}
  .side-menu a{display:block;padding:10px;border-bottom:1px dashed #2f3a55}
  .side-menu a:last-child{border-bottom:none}
  .menu-text{text-decoration:underline;cursor:pointer}

  /* Lang toggle */
  #langToggle{min-width:44px;height:28px;padding:0 10px;border:1px solid var(--border);border-radius:10px;background:#131c2b;color:var(--text);cursor:pointer}

  /* Toolbar */
  .toolbar{display:flex;align-items:center;gap:10px;padding:10px 14px 6px}
  .icon-btn{width:38px;height:38px;border:1px solid rgba(120,180,200,.22);border-radius:12px;background:#0f1524;
    display:grid;place-items:center;cursor:pointer;box-shadow:inset 0 0 12px rgba(126,241,192,.08)}
  .icon-btn:hover{box-shadow:inset 0 0 16px rgba(126,241,192,.12)}
  .icon{width:20px;height:20px;display:block}
  .icon path{stroke:url(#grad);stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 2px rgba(126,241,192,.35))}
  svg defs linearGradient stop:nth-child(1){stop-color:var(--accent)}
  svg defs linearGradient stop:nth-child(2){stop-color:var(--accent2)}
  svg defs linearGradient stop:nth-child(3){stop-color:var(--accent3)}

  /* Horizontal thumbnails */
  .strip{display:flex;gap:10px;overflow-x:auto;scroll-snap-type:x mandatory;padding:10px 14px}
  .strip::-webkit-scrollbar{height:8px}
  .strip::-webkit-scrollbar-thumb{background:#1a2438;border-radius:8px}
  .card{min-width:120px;scroll-snap-align:start;background:#0f1524;border:1px solid #283044;border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:10px;background:#09101c;overflow:hidden;background-size:cover;background-position:center}
  .thumb[data-src]{background-image:none} /* lazy 상태 */
  .label{display:none}

  /* Player + status */
  .player-wrap{padding:0 14px 14px}
  .status-wrap{display:flex;align-items:center;gap:12px;margin:6px 0 10px}
  .status-thumb{
    width:124px;height:124px;border-radius:14px;position:relative;overflow:hidden;
    background: radial-gradient(120px 80px at 40% 35%, #1a2335 0%, #0b0f17 70%),
                linear-gradient(135deg, rgba(126,241,192,.15), rgba(85,208,255,.12), rgba(163,140,255,.15));
    box-shadow: 0 0 18px rgba(126,241,192,.25), inset 0 0 24px rgba(163,140,255,.15);
    border:1px solid rgba(120,180,200,.12);
    background-size: cover; background-position: center; background-repeat:no-repeat;
  }
  .status-thumb::before{
    content:"";position:absolute;inset:-25% -25%;
    background: conic-gradient(from 0deg,#7ef1c0,#55d0ff,#a38cff,#7ef1c0);
    filter: blur(22px);opacity:.22;animation:spinGlow 6s linear infinite;
  }
  .status-thumb.loaded::before{ display:none; }
  @keyframes spinGlow{to{transform:rotate(360deg)}}
  audio{width:100%;margin-top:6px;background:#0f1524;border:1px solid #273246;border-radius:12px}
  .muted{color:#7ea296}

  /* Spectrum Visualizer (bottom) */
  .visual-wrap{padding:6px 12px 14px}
  #vizCanvas{width:100%;height:140px;display:block;background:linear-gradient(180deg,#0e1524 0%, #0b0f17 100%);
    border-top:1px solid #243145;border-bottom:1px solid #243145;border-radius:12px}


/* Tabs for Pro */
.tabs{ display:flex; gap:8px; align-items:center; justify-content:center; }
.tab{ padding:6px 10px; border:1px solid #334; border-radius:8px; background:#171d2b; color:#dfe7f6; cursor:pointer; font-size:.85rem }
.tab.active{ background:#1f2739; border-color:#556 }
.section{ display:none } .section.active{ display:block }

</style>
</head>
<body>

<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <nav id="sideMenu" class="side-menu">
        <a class="mbtn" href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
        <a class="mbtn menu-text" data-file="faq">FAQ</a>
        <a class="mbtn menu-text" data-file="manual">Manual</a>
        <a class="mbtn menu-text" data-file="contact">Contact</a>
        <a class="mbtn menu-text" data-file="about">About</a>
      </nav>
    </div>
    <div class="logo">5DO Lite</div>
  </div>
  <div class="right-pack">
    <button id="langToggle" title="EN/KO">KO</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-target="lib">5DO</div>
    <div class="tab" data-target="gen">Freq. Gen.</div>
  </div>

</header>
<div class="menu-backdrop" id="menuBackdrop"></div>

<!-- Toolbar with gradient defs -->
<section id="lib" class="section active">
<div class="toolbar">
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px">
    <defs>
      <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%"  stop-color="#7ef1c0"/>
        <stop offset="50%" stop-color="#55d0ff"/>
        <stop offset="100%" stop-color="#a38cff"/>
      </linearGradient>
    </defs>
  </svg>

  <button id="btnBack" class="icon-btn" title="Back" aria-label="Back">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M14 6l-6 6 6 6M19 12H8"></path>
    </svg>
  </button>

  <button id="btnRoot" class="icon-btn" title="Root" aria-label="Root">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 4a4 4 0 0 1 4 4v1h2a2 2 0 0 1 2 2v7h-6v-4H10v4H4v-7a2 2 0 0 1 2-2h2V8a4 4 0 0 1 4-4z"></path>
    </svg>
  </button>

  <button id="btnRefresh" class="icon-btn" title="Refresh" aria-label="Refresh">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M20 12a8 8 0 1 1-2.34-5.66M20 4v6h-6"></path>
    </svg>
  </button>
</div>

<!-- Horizontal thumbnails -->
<div id="strip" class="strip" aria-label="Media Library"></div>

<!-- Player -->
<div class="player-wrap">
  <div class="status-wrap">
    <div id="loadingThumb" class="status-thumb" aria-label="loading thumbnail"></div>
    <div class="muted" id="statusText"></div>
  </div>
  <audio id="player" controls crossorigin="anonymous"></audio>
</div>

<!-- Spectrum Visualizer -->
</section>
<section id="gen" class="section" aria-label="Generator">
  <div class="gen-wrap">
    <div class="field full">
      <canvas id="oscGen" height="100"></canvas>
    </div>

    <div class="grid">
      <div class="field">
        <h4 id="lblFreq">Frequency (Hz)</h4>
        <input id="genFreq" type="number" min="1" max="24000" step="0.1" value="432">
      </div>
      <div class="field">
        <h4 id="lblWave">Waveform</h4>
        <select id="genWave">
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="sawtooth">Saw</option>
          <option value="triangle">Triangle</option>
        </select>
      </div>

      <div class="field">
        <h4 id="lblBB">Binaural</h4>
        <label><input id="genBinaural" type="checkbox"> <span id="lblBBEnable">Enable</span></label>
        <label id="lblBBdiff" for="genBeat">Difference (Hz)</label>
        <input id="genBeat" type="number" min="0" max="1000" step="0.1" value="7">
      </div>
      <div class="field">
        <h4 id="lblHarmonics">Harmonics</h4>
        <label id="lblHarmHelp" for="genHarmonics">Multiplier</label>
        <input id="genHarmonics" type="number" min="1" max="8" step="1" value="1">
      </div>

      <div class="field">
        <h4 id="lblLevel">Level</h4>
        <input id="genLevel" type="range" min="0" max="1" step="0.01" value="0.5">
      </div>
      <div class="field">
        <h4 id="lblDuty">Duty Cycle</h4>
        <input id="genDuty" type="range" min="0.05" max="0.95" step="0.01" value="0.50" disabled>
      </div>

      <div class="field full">
        <div class="gen-actions">
          <input id="sweepStart" type="number" value="100"  aria-label="Sweep Start (Hz)" style="width:90px">
          <input id="sweepEnd"   type="number" value="1000" aria-label="Sweep End (Hz)"   style="width:90px">
          <input id="sweepTime"  type="number" value="10"   aria-label="Sweep Time (s)"   style="width:90px">
          <button id="sweepGo" class="pill" title="Sweep">Sweep</button>
        </div>
      </div>

      <div class="field full">
        <div class="gen-actions">
          <button id="genStart" class="pill primary" title="Play">▶️</button>
          <button id="genStop"  class="pill"          title="Stop">⏹️</button>
          <button id="btnSavePreset" class="pill" title="Save Preset">💾</button>
          <button id="btnLoadPreset" class="pill" title="Load Preset">📜</button>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="visual-wrap">
  <canvas id="vizCanvas" height="140"></canvas>
</div>

<!-- Modal for /texts/*.txt -->
<div id="txtModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:9999">
  <div style="background:#0f1524;color:#cfead1;border:1px solid #334;max-width:720px;width:90%;max-height:75vh;overflow:auto;border-radius:14px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
    <div style="text-align:right;margin-bottom:8px">
      <button id="txtClose" style="padding:6px 10px;border:1px solid #334;background:#192033;color:#cfead1;border-radius:8px;cursor:pointer">Close</button>
    </div>
    <pre id="txtBody" style="white-space:pre-wrap;line-height:1.55;font-family:system-ui, Apple SD Gothic Neo, Noto Sans KR, sans-serif;"></pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  // ===== Supabase =====
  const SUPA_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
  const supa = supabase.createClient(SUPA_URL, SUPA_KEY);
  const BUCKET = 'media';
  const PUBLIC_BASE = `${SUPA_URL}/storage/v1/object/public/${BUCKET}`;

  // ===== El refs & state =====
  const $ = s => document.querySelector(s);
  const $$= s => Array.from(document.querySelectorAll(s));

  const langBtn = $('#langToggle');
  let lang = localStorage.getItem('lang') || 'ko';
  const setLangLabel = ()=> langBtn.textContent = (lang==='en'?'EN':'KO'); setLangLabel();

  const strip = $('#strip');
  const player= $('#player');
  const statusThumb = $('#loadingThumb');
  const statusText  = $('#statusText');

  // path stack & helpers
  const pathStack = [];
  const currentPath = ()=> pathStack.join('/');

  // ===== Lazy loader =====
  const io = new IntersectionObserver((entries)=>{
    for(const e of entries){
      if(e.isIntersecting){
        const el = e.target;
        const url = el.getAttribute('data-src');
        if(url){
          el.style.backgroundImage = `url("${url}")`;
          el.removeAttribute('data-src');
        }
        io.unobserve(el);
      }
    }
  }, {root:null,rootMargin:'200px',threshold:0.01});

  // ===== URL helpers (JPG only, lang-suffix) =====
  function folderJpg(folder){
    const name = (lang==='en') ? 'folder_e.jpg' : 'folder.jpg';
    return `${PUBLIC_BASE}/${encodeURIComponent(folder)}/${name}`;
  }
  function trackThumbJpg(folder, trackFile){
    const base = trackFile.replace(/\.(mp3|wav|m4a)$/i,'');
    const suffix = (lang==='en') ? '_E' : '';
    return `${PUBLIC_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(base+suffix)}.jpg`;
  }
  function trackAudioUrl(folder, trackFile){
    return `${PUBLIC_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(trackFile)}`;
  }

  // ===== List from Supabase =====
  async function listPath(path){
    const p = path ? path + '/' : '';
    const { data, error } = await supa.storage.from(BUCKET).list(p, {
      limit: 1000, sortBy: { column:'name', order:'asc' }
    });
    if(error){ console.warn(error); return []; }
    return data || [];
  }
  const isFolder = item => !item?.metadata || !item?.metadata.mimetype;
  const isAudio  = item => !!item?.metadata?.mimetype && /^audio\//.test(item.metadata.mimetype);

  // ===== Render =====
  async function render(){
    strip.innerHTML = '';
    const path = currentPath();
    const items = await listPath(path);
    const folders = items.filter(isFolder);
    const files   = items.filter(isAudio);

    // folders
    for(const f of folders){
      const card = document.createElement('div');
      card.className = 'card';
      const th = document.createElement('div');
      th.className='thumb';
      th.setAttribute('data-src', folderJpg(f.name)); // lazy
      card.appendChild(th);
      const lb = document.createElement('div'); lb.className='label'; card.appendChild(lb); // hidden label (kept for layout)
      card.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        pathStack.push(f.name);
        render();
      });
      strip.appendChild(card);
      io.observe(th);
    }

    // files
    for(const file of files){
      const card = document.createElement('div');
      card.className='card';
      const th = document.createElement('div');
      th.className='thumb';
      th.setAttribute('data-src', trackThumbJpg(path || '', file.name)); // lazy
      card.appendChild(th);
      const lb = document.createElement('div'); lb.className='label'; card.appendChild(lb);
      card.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        const url = trackAudioUrl(path || '', file.name);
        // 로드만 하고 자동재생 금지
        player.src = url;
        player.load?.();
        // 로딩 썸네일 갱신
        statusThumb.classList.add('loaded');
        statusThumb.style.backgroundImage = `url("${trackThumbJpg(path || '', file.name)}")`;
        statusText.textContent = (lang==='en' ? 'Ready to play' : '재생 준비됨');
      });
      strip.appendChild(card);
      io.observe(th);
    }
  }

  // ===== Menu =====
  (function initMenu(){
    const btn = $('#menuBtn');
    const pane= $('#sideMenu');
    const bd  = $('#menuBackdrop');
    const open = ()=>{ pane.classList.add('open'); bd.classList.add('show'); };
    const close= ()=>{ pane.classList.remove('open'); bd.classList.remove('show'); };
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); pane.classList.contains('open')?close():open(); });
    bd.addEventListener('click', close);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

    // /texts modal
    $$('.menu-text').forEach(a=>{
      const file = a.getAttribute('data-file');
      a.addEventListener('click', async (e)=>{
        e.preventDefault();
        try{
          const res = await fetch(`/texts/${file}.txt?ts=${Date.now()}`);
          const txt = await res.text();
          $('#txtBody').textContent = txt;
          $('#txtModal').style.display='flex';
          close();
        }catch(err){ alert('문서를 불러올 수 없습니다. (/texts/*.txt 확인)'); }
      });
    });
    $('#txtClose').addEventListener('click', ()=> $('#txtModal').style.display='none');
    $('#txtModal').addEventListener('click', (e)=>{ if(e.target.id==='txtModal') $('#txtModal').style.display='none';});
  })();

  // ===== Nav buttons =====
  $('#btnBack').addEventListener('click', ()=>{ if(pathStack.length) pathStack.pop(); render(); });
  $('#btnRoot').addEventListener('click', ()=>{ pathStack.length=0; render(); });
  $('#btnRefresh').addEventListener('click', ()=> render());

  // ===== Lang toggle =====
  langBtn.addEventListener('click', ()=>{
    lang = (lang==='en'?'ko':'en');
    localStorage.setItem('lang', lang);
    setLangLabel();
    // 상태 초기화 후 다시 렌더
    statusThumb.classList.remove('loaded');
    statusThumb.style.backgroundImage='';
    statusText.textContent = (lang==='en' ? 'No track loaded' : '선곡되지 않음');
    render();
    try { updateGeneratorLang(); } catch {}
  });

  // ===== Spectrum Visualizer (5DO 네온 바) =====
  let audioCtx, analyser, sourceNode, vizRAF = 0;
  const vizCanvas = document.getElementById('vizCanvas');
  const vctx = vizCanvas.getContext('2d', {alpha:false});
  function resizeViz(){
    // 픽셀 밀도 대응
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = vizCanvas.clientWidth || vizCanvas.parentElement.clientWidth;
    const cssH = vizCanvas.clientHeight || 140;
    vizCanvas.width  = Math.floor(cssW * dpr);
    vizCanvas.height = Math.floor(cssH * dpr);
    vctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resizeViz); resizeViz();

  function ensureAudioGraph(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      window.audioCtx = audioCtx;
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      analyser.smoothingTimeConstant = 0.78;
      sourceNode = audioCtx.createMediaElementSource(player);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
  }

  function drawViz(){
    const w = vizCanvas.width, h = vizCanvas.height;
    vctx.clearRect(0,0,w,h);
    // 배경
    const gradBg = vctx.createLinearGradient(0,0,0,h);
    gradBg.addColorStop(0,'#0e1524'); gradBg.addColorStop(1,'#0b0f17');
    vctx.fillStyle = gradBg; vctx.fillRect(0,0,w,h);

    const bufLen = analyser.frequencyBinCount;
    const data = new Uint8Array(bufLen);
    analyser.getByteFrequencyData(data);

    const bars = Math.min(96, Math.floor(w/7));
    const step = Math.floor(bufLen / bars);
    const barW = Math.max(3, (w / bars) * 0.6);

    for(let i=0;i<bars;i++){
      const idx = i*step;
      const v = data[idx] / 255; // 0~1
      const barH = Math.max(4, v * (h*0.9));
      const x = i * (w / bars) + (w / bars - barW)/2;
      const y = h - barH;

      const g = vctx.createLinearGradient(0,y,0,y+barH);
      g.addColorStop(0,'#7ef1c0'); g.addColorStop(0.5,'#55d0ff'); g.addColorStop(1,'#a38cff');
      vctx.fillStyle = g;
      vctx.fillRect(x,y,barW,barH);

      // 외곽선 살짝
      vctx.globalAlpha = 0.18;
      vctx.strokeStyle = '#bfe';
      vctx.strokeRect(x+0.5,y+0.5,barW-1,barH-1);
      vctx.globalAlpha = 1;
    }
  }

  function startViz(){
    cancelAnimationFrame(vizRAF);
    const loop = ()=>{
      vizRAF = requestAnimationFrame(loop);
      if(!analyser) return;
      drawViz();
    };
    vizRAF = requestAnimationFrame(loop);
  }
  function stopViz(){ cancelAnimationFrame(vizRAF); vizRAF = 0; }

  // 사용자 제스처 후만 오디오 그래프 허용
  player.addEventListener('play', async ()=>{
    ensureAudioGraph();
    if(audioCtx.state === 'suspended'){ try{ await audioCtx.resume(); }catch{} }
    startViz();
  });
  player.addEventListener('pause', ()=> stopViz());
  player.addEventListener('ended', ()=> stopViz());

  // ===== Init =====
  statusThumb.classList.remove('loaded');
  statusText.textContent = (lang==='en' ? 'No track loaded' : '선곡되지 않음');
  render();

  // ===== Tabs (Library <-> Generator) =====
  (function initTabs(){
    const tabs = document.querySelectorAll('.tab');
    const sections = document.querySelectorAll('.section');
    const playerEl = document.getElementById('player');
    tabs.forEach(t=>t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      sections.forEach(s=>s.classList.remove('active'));
      t.classList.add('active');
      const target = document.getElementById(t.dataset.target);
      if (target) target.classList.add('active');
      if (t.dataset.target === 'gen' && playerEl) { try { playerEl.pause(); } catch {} }
    }));
  })();


  console.log('[5DO Lite] ready with spectrum + lazy JPG thumbnails + Pro tabs');
})();
</script>

<script>
// ===== Generator I18N =====
const GEN_I18N = {
  en: {
    freq: "Frequency (Hz)",
    wave: "Waveform",
    waves: {sine:"Sine", square:"Square", triangle:"Triangle", sawtooth:"Sawtooth"},
    harmonics: "Harmonics",
    binaural: "Binaural",
    left: "Left (Hz)",
    right: "Right (Hz)",
    offset: "Offset (Hz)",
    am: "AM Depth",
    sweep: "Sweep",
    from: "From (Hz)",
    to: "To (Hz)",
    secs: "Seconds",
    go: "Sweep",
    playTitle: "Play",
    stopTitle: "Stop",
    savePresetTitle: "Save Preset",
    loadPresetTitle: "Load Preset"
  },
  ko: {
    freq: "주파수 (Hz)",
    wave: "파형",
    waves: {sine:"사인", square:"사각", triangle:"삼각", sawtooth:"톱니"},
    harmonics: "하모닉스",
    binaural: "바이노럴",
    left: "좌 (Hz)",
    right: "우 (Hz)",
    offset: "오프셋 (Hz)",
    am: "AM 깊이",
    sweep: "스윕",
    from: "시작 (Hz)",
    to: "끝 (Hz)",
    secs: "초",
    go: "스윕",
    playTitle: "재생",
    stopTitle: "정지",
    savePresetTitle: "프리셋 저장",
    loadPresetTitle: "프리셋 불러오기"
  }
};

function updateGeneratorLang(){
  try{
    const L = (window.lang === 'en') ? GEN_I18N.en : GEN_I18N.ko;
    const byId = (id)=>document.getElementById(id);

    const lblFreq = byId('lblFreq');
    const lblWave = byId('lblWave');
    const lblHarm = document.getElementById('lblHarmonics');
    const lblBin  = document.getElementById('lblBinaural');
    const lblLeft = document.getElementById('lblLeft');
    const lblRight= document.getElementById('lblRight');
    const lblOff  = document.getElementById('lblOffset');
    const lblAM   = document.getElementById('lblAM');
    const lblSweep= document.getElementById('lblSweep');
    const lblFrom = document.getElementById('lblFrom');
    const lblTo   = document.getElementById('lblTo');
    const lblSecs = document.getElementById('lblSecs');
    const sweepGo = byId('sweepGo');

    if(lblFreq) lblFreq.textContent = L.freq;
    if(lblWave) lblWave.textContent = L.wave;
    if(lblHarm) lblHarm.textContent = L.harmonics;
    if(lblBin)  lblBin.textContent  = L.binaural;
    if(lblLeft) lblLeft.textContent = L.left;
    if(lblRight)lblRight.textContent= L.right;
    if(lblOff)  lblOff.textContent  = L.offset;
    if(lblAM)   lblAM.textContent   = L.am;
    if(lblSweep)lblSweep.textContent= L.sweep;
    if(lblFrom) lblFrom.textContent = L.from;
    if(lblTo)   lblTo.textContent   = L.to;
    if(lblSecs) lblSecs.textContent = L.secs;
    if(sweepGo) sweepGo.textContent = L.go;

    // Wave options
    const waveSel = byId('genWave');
    if (waveSel && waveSel.options && waveSel.options.length >= 4){
      const vals = ['sine','square','triangle','sawtooth'];
      for (let i=0;i<vals.length;i++){
        for (let j=0;j<waveSel.options.length;j++){
          if (waveSel.options[j].value === vals[i]){
            waveSel.options[j].textContent = L.waves[vals[i]];
            break;
          }
        }
      }
    }

    // Action button titles
    const genStart = byId('genStart');
    const genStop  = byId('genStop');
    const btnSave  = byId('btnSavePreset');
    const btnLoad  = byId('btnLoadPreset');
    if (genStart) genStart.title = L.playTitle;
    if (genStop)  genStop.title  = L.stopTitle;
    if (btnSave)  btnSave.title  = L.savePresetTitle;
    if (btnLoad)  btnLoad.title  = L.loadPresetTitle;
  }catch(e){ /* no-op */ }
}

// Run once on DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
  // window.lang is managed by Lite base (localStorage)
  if (!window.lang) window.lang = localStorage.getItem('lang') || 'ko';
  updateGeneratorLang();
});
</script>

</body>
</html>

<script>
/* ========= Generator (Osc, Harmonics, Binaural, Sweep, Presets) ========= */
const waveSel=document.getElementById('genWave');
const freqInp=document.getElementById('genFreq');
const lvlInp=document.getElementById('genLevel');
const bbChk=document.getElementById('genBinaural');
const beatInp=document.getElementById('genBeat');
const harmInp=document.getElementById('genHarmonics');
const dutyInp=document.getElementById('genDuty');

const genGain=(()=>{ const g=audioCtx.createGain(); g.connect(audioCtx.destination); return g; })();
let genRunning=false; let genMeta=[];

function clearGen(){ genMeta.forEach(o=>{try{o.node.stop()}catch{} try{o.node.disconnect()}catch{}}); genMeta=[]; }
function buildGenNodes(base,useBB,beat,harm,wave){
  clearGen();
  const mk=(f,m=1,b=0)=>{ const o=audioCtx.createOscillator(); o.type=wave; o.frequency.value=f*m+b; o.connect(genGain); o.start(); genMeta.push({node:o,mult:m,beatAdd:b}); };
  if(useBB){ mk(base,1,0); mk(base,1,beat);} else { mk(base,1,0); }
  for(let m=2;m<=harm;m++){ if(useBB){ mk(base,m,0); mk(base,m,beat);} else { mk(base,m,0);} }
}
function startGenerator(){
  ensureAudioUnlocked(); if(!player.paused) player.pause();
  if(genRunning) clearGen();
  const wave=waveSel.value, base=+freqInp.value||432, lvl=+lvlInp.value||0.5, useBB=!!bbChk.checked, beat=+beatInp.value||7, harm=Math.max(1,Math.min(8,parseInt(harmInp.value)||1));
  genGain.gain.value=lvl; buildGenNodes(base,useBB,beat,harm,wave); dutyInp.disabled=(wave!=='square'); genRunning=true;
}
function stopGenerator(){ if(!genRunning) return; clearGen(); genRunning=false; genGain.gain.setTargetAtTime(0,audioCtx.currentTime,0.02); }
function updateGenerator(){ if(!genRunning) return; const wave=waveSel.value, base=+freqInp.value||432, useBB=!!bbChk.checked, beat=+beatInp.value||7, harm=Math.max(1,Math.min(8,parseInt(harmInp.value)||1)); buildGenNodes(base,useBB,beat,harm,wave); }
freqInp.oninput=updateGenerator; waveSel.oninput=()=>{ dutyInp.disabled=(waveSel.value!=='square'); updateGenerator(); };
bbChk.oninput=updateGenerator; beatInp.oninput=updateGenerator; lvlInp.oninput=e=>{ genGain.gain.value=+e.target.value; };

document.getElementById('sweepGo').onclick=()=>{
  if(!genRunning||genMeta.length===0) return;
  const s=+document.getElementById('sweepStart').value||100, e=+document.getElementById('sweepEnd').value||1000, t=+document.getElementById('sweepTime').value||10;
  const now=audioCtx.currentTime; genMeta.forEach(o=>{ const sf=s*o.mult+(o.beatAdd||0), ef=e*o.mult+(o.beatAdd||0);
    try{ o.node.frequency.cancelScheduledValues(now); o.node.frequency.setValueAtTime(sf,now); o.node.frequency.linearRampToValueAtTime(ef,now+t);}catch{} });
};
document.getElementById('genStart').onclick=()=>{ audioCtx.resume(); startGenerator(); };
document.getElementById('genStop').onclick = stopGenerator;

/* Presets */
document.getElementById('btnSavePreset').onclick=()=>{
  const name=prompt(isKo?'프리셋 이름?':'Preset name?'); if(!name) return;
  const p={ wave:waveSel.value, freq:+freqInp.value, binaural:bbChk.checked, beat:+beatInp.value, harm:+harmInp.value, level:+lvlInp.value };
  const all=JSON.parse(localStorage.getItem('presets')||'{}'); all[name]=p; localStorage.setItem('presets',JSON.stringify(all)); alert((isKo?'저장됨: ':'Saved: ')+name);
};
document.getElementById('btnLoadPreset').onclick=()=>{
  const all=JSON.parse(localStorage.getItem('presets')||'{}'), names=Object.keys(all);
  if(!names.length){ alert(isKo?'프리셋이 없습니다.':'No presets.'); return; }
  const sel=prompt((isKo?'선택: ':'Select: ')+"\n"+names.join('\n')); if(!sel||!all[sel]) return;
  const p=all[sel]; waveSel.value=p.wave; freqInp.value=p.freq; bbChk.checked=p.binaural; beatInp.value=p.beat; harmInp.value=p.harm; lvlInp.value=p.level;
  updateGenerator();
};

/* Mini scope (Generator) */
(function genScope(){
  const cvs=document.getElementById("oscGen"); const ctx=cvs.getContext("2d");
  const an=audioCtx.createAnalyser(); an.fftSize=2048; genGain.connect(an);
  const buf=new Uint8Array(an.fftSize);
  function resize(){ cvs.width=cvs.clientWidth||window.innerWidth; } resize(); window.addEventListener("resize",resize);
  (function loop(){ requestAnimationFrame(loop); an.getByteTimeDomainData(buf);
    ctx.fillStyle="#090b11"; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.lineWidth=2; ctx.strokeStyle="#9cff8b"; ctx.beginPath();
    const dx=cvs.width/buf.length; for(let i=0,x=0;i<buf.length;i++,x+=dx){ const y=(buf[i]/128)*(cvs.height/2); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }
    ctx.lineTo(cvs.width,cvs.height/2); ctx.stroke(); })();
})();

</script>
</body>
</html>