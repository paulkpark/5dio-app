<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>5DO Pro</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<link rel="preconnect" href="https://xdjgumqdwedgzwqturcx.supabase.co">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#0b0d13; --panel:#12141b; --card:#181b25; --ink:#e5e7eb;
  --muted:#9aa3b7; --border:#222738; --accent:#9cff8b;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}

/* Header / Tabs / Lang / Hamburger */
header{
  position:relative;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)
}
.menu-container{
  position:absolute;top:12px;left:10px;
  display:flex;align-items:center;z-index:1000
}
.menu-button{font-size:24px;color:#fff;cursor:pointer;line-height:1}
.dropdown-menu{
  display:none;flex-direction:column;position:absolute;background:rgba(0,0,0,0.9);
  padding:8px 10px;border-radius:10px;width:160px;top:28px;left:0;z-index:1100
}
.dropdown-menu a{
  color:#fff;text-decoration:underline;display:block;
  padding:8px 12px;border-radius:6px;cursor:pointer
}
.dropdown-menu a:hover{background:rgba(255,255,255,0.1)}
.menu-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:900}

.logo{font-weight:700;color:var(--accent);font-size:1.2rem;margin-left:50px}
.tabs{display:flex;gap:6px;align-items:center}
.tab{padding:4px 8px;font-size:.74rem;border:1px solid var(--border);border-radius:8px;background:#171d2b;color:#cfead1;cursor:pointer}
.tab.active{background:#1f2739;border-color:#334}
.section{display:none}.section.active{display:block}
.lang-toggle{color:#fff;border:1px solid #444;padding:4px 8px;border-radius:6px;cursor:pointer;background:#171d2b}

/* Library */
#navRow{display:flex;justify-content:center;gap:8px;padding:8px}
.btn{background:#1e2232;border:1px solid #2c3147;color:#eee;border-radius:10px;padding:8px 10px;font-size:1.2rem;cursor:pointer}
.btn:hover{background:#2a3148}
#library{display:flex;overflow-x:auto;gap:10px;padding:10px;scroll-behavior:smooth;scroll-snap-type:x mandatory}
.card{flex:0 0 auto;width:160px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;scroll-snap-align:start}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#0f1320;border-radius:8px}

/* Controls + Status thumb */
.controls{display:flex;flex-direction:column;gap:12px;padding:12px;background:#0f1320;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.statusRow{display:flex;align-items:center;gap:18px}
#statusThumb{
  width:124px;height:124px;border-radius:16px;
  background:#0d0f18;border:1px solid #2d334a;
  position:relative;overflow:hidden;background-size:cover;background-position:center;
}
#statusThumb.loading::before{
  content:"";position:absolute;inset:-30%;
  background:conic-gradient(from 0deg at 50% 50%,#10283e,#1b3a5b,#234a72,#1b3a5b,#10283e);
  filter:blur(28px);opacity:.9;animation:aurora 6.5s linear infinite;
}
#statusThumb.loaded::before{content:none}
@keyframes aurora{
  0%{transform:rotate(0) scale(1.05)}
  50%{transform:rotate(180deg) scale(1.10)}
  100%{transform:rotate(360deg) scale(1.05)}
}
.ctrlStack{display:flex;flex-direction:column;gap:10px}
.ctrlLine{display:flex;align-items:center;gap:8px}
audio{width:92%;display:block;margin:8px auto}

/* Generator */
.gen-wrap{padding:12px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{background:#141a27;border:1px solid #2a3044;border-radius:12px;padding:10px;display:flex;flex-direction:column;justify-content:center}
.field h4{margin:0 0 8px;color:#dfe7f6;font-size:.95rem}
.field.full{grid-column:1/-1}
.gen-actions{display:flex;gap:12px;align-items:center;justify-content:center}
.pill{padding:8px 12px;border-radius:999px;border:1px solid #2c3147;background:#1b2333;color:#e9eefc;cursor:pointer}
.pill.primary{background:#21324e;border-color:#355;color:#cfead1}
input[disabled]{opacity:.5;filter:grayscale(0.3)}

/* Modal for text files */
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1200; }
.modal-content { background:#12141b; color:#fff; margin:10% auto; padding:20px; border-radius:12px; width:90%; max-width:700px; border:1px solid #2a3044; line-height:1.6; white-space:pre-wrap; }
.close { float:right; cursor:pointer; font-size:1.5rem; }
.modal h2{margin-top:0}

/* Radial Visualizer (Library Ï†ÑÏö©) */
#radialVizWrap{
  display:none;justify-content:center;align-items:center;
  padding:12px 0; background:#0b0f17;
  border-top:1px solid #20263a; border-bottom:1px solid #20263a;
}
#radialViz{
  width:min(640px,92vw);
  height:240px;
  display:block;
}
</style>
</head>
<body>

<!-- Hamburger -->
<div class="menu-container">
  <div id="menuButton" class="menu-button">‚ò∞</div>
  <nav id="dropdownMenu" class="dropdown-menu">
    <a href="https://5dshop.co.kr" target="_blank" rel="noopener" class="menu-item">Shop</a>
    <a href="texts/faq.txt" class="menu-item">FAQ</a>
    <a href="texts/manual.txt" class="menu-item">Manual</a>
    <a href="texts/contact.txt" class="menu-item">Contact</a>
    <a href="texts/about.txt" class="menu-item">About</a>
  </nav>
  <div id="menuBackdrop" class="menu-backdrop"></div>
</div>

<header>
  <div class="logo">5DO Pro</div>
  <div class="tabs">
    <div class="tab active" data-tab="lib">5DO</div>
    <div class="tab" data-tab="gen">Freq. Gen.</div>
  </div>
  <button id="langToggle" class="lang-toggle">EN</button>
</header>

<!-- Modal -->
<div id="menuModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span id="modalClose" class="close" aria-label="Close">&times;</span>
    <div id="modalBody">Loading...</div>
  </div>
</div>

<section id="section-lib" class="section active" aria-label="Library">
  <div id="navRow">
    <button id="btnBack" class="btn" title="Back">‚¨ÖÔ∏è</button>
    <button id="btnRefresh" class="btn" title="Refresh">üîÑ</button>
    <button id="btnSaveList" class="btn" title="Save Playlist">üíæ</button>
    <button id="btnLoadList" class="btn" title="Load Playlist">üìú</button>
  </div>

  <div id="library"></div>

  <!-- Radial Visualizer: ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌîåÎ†àÏù¥Ïñ¥ Ï†ÑÏö© -->
  <div id="radialVizWrap"><canvas id="radialViz"></canvas></div>

  <div class="controls">
    <div class="statusRow">
      <div id="statusThumb" class="loading"></div>
      <div class="ctrlStack">
        <div class="ctrlLine">
          <label for="vol" id="lblVol">Volume</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="1">
        </div>
        <div class="ctrlLine">
          <label><input type="checkbox" id="loop"> <span id="lblLoop">Loop</span></label>
        </div>
        <div class="ctrlLine">
          <label for="timer" id="lblTimer">Timer</label>
          <select id="timer">
            <option value="0">Off</option><option value="5">5 min</option>
            <option value="10">10 min</option><option value="15">15 min</option>
            <option value="20">20 min</option><option value="30">30 min</option>
            <option value="45">45 min</option><option value="60">60 min</option>
          </select>
        </div>
      </div>
    </div>
    <audio id="player" controls preload="none" playsinline controlslist="nodownload noplaybackrate"></audio>
  </div>
</section>

<section id="section-gen" class="section" aria-label="Generator">
  <div class="gen-wrap">
    <div class="field full">
      <canvas id="oscGen" height="100"></canvas>
    </div>

    <div class="grid">
      <!-- 1Ï§Ñ: Ï£ºÌååÏàò & ÌååÌòï -->
      <div class="field">
        <h4 id="lblFreq">Frequency (Hz)</h4>
        <input id="genFreq" type="number" min="1" max="24000" step="0.1" value="432">
      </div>
      <div class="field">
        <h4 id="lblWave">Waveform</h4>
        <select id="genWave">
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="sawtooth">Saw</option>
          <option value="triangle">Triangle</option>
        </select>
      </div>

      <!-- 2Ï§Ñ: Î∞îÏù¥ÎÖ∏Îü¥ & ÌïòÎ™®ÎãâÏä§ -->
      <div class="field">
        <h4 id="lblBB">Binaural</h4>
        <label><input id="genBinaural" type="checkbox"> <span id="lblBBEnable">Enable</span></label>
        <label for="genBeat" id="lblBBdiff">Difference (Hz)</label>
        <input id="genBeat" type="number" min="0" max="1000" step="0.1" value="7">
      </div>
      <div class="field">
        <h4 id="lblHarmonics">Harmonics</h4>
        <label for="genHarmonics" id="lblHarmHelp">Multiplier</label>
        <input id="genHarmonics" type="number" min="1" max="8" step="1" value="1">
      </div>

      <!-- 3Ï§Ñ: Î†àÎ≤® & ÎìÄÌã∞ÏÇ¨Ïù¥ÌÅ¥ -->
      <div class="field">
        <h4 id="lblLevel">Level</h4>
        <input id="genLevel" type="range" min="0" max="1" step="0.01" value="0.5">
      </div>
      <div class="field">
        <h4 id="lblDuty">Duty Cycle</h4>
        <input id="genDuty" type="range" min="0.05" max="0.95" step="0.01" value="0.50" disabled>
      </div>

      <!-- 4Ï§Ñ: Ïä§Ïúï -->
      <div class="field full">
        <div class="gen-actions">
          <input id="sweepStart" type="number" value="100"  aria-label="Sweep Start (Hz)" style="width:90px">
          <input id="sweepEnd"   type="number" value="1000" aria-label="Sweep End (Hz)"   style="width:90px">
          <input id="sweepTime"  type="number" value="10"   aria-label="Sweep Time (s)"   style="width:90px">
          <button id="sweepGo" class="pill" title="Sweep">Sweep</button>
        </div>
      </div>

      <!-- 5Ï§Ñ: Ïû¨ÏÉù Ïª®Ìä∏Î°§ -->
      <div class="field full">
        <div class="gen-actions">
          <button id="genStart" class="pill primary" title="Play">‚ñ∂Ô∏è</button>
          <button id="genStop"  class="pill"          title="Stop">‚èπÔ∏è</button>
          <button id="btnSavePreset" class="pill" title="Save Preset">üíæ</button>
          <button id="btnLoadPreset" class="pill" title="Load Preset">üìú</button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ========== Hamburger & Backdrop ========== */
const menuBtn = document.getElementById("menuButton");
const menu = document.getElementById("dropdownMenu");
const backdrop = document.getElementById("menuBackdrop");
menuBtn.onclick = ()=>{
  const open = menu.style.display==="flex";
  menu.style.display = open ? "none" : "flex";
  backdrop.style.display = open ? "none" : "block";
};
backdrop.onclick = ()=>{ menu.style.display="none"; backdrop.style.display="none"; };

/* ========== Modal for text files ========== */
const modal = document.getElementById("menuModal");
const modalBody = document.getElementById("modalBody");
const modalClose = document.getElementById("modalClose");
modalClose.onclick = ()=> modal.style.display="none";
window.addEventListener('click',e=>{ if(e.target===modal) modal.style.display="none"; });

function openModalWithText(text){
  modalBody.textContent = text;
  modal.style.display = "block";
  menu.style.display="none"; backdrop.style.display="none";
}

/* Î©îÎâ¥ Ìï≠Î™©(Shop Ï†úÏô∏) Ìï∏Îì§Îü¨ */
document.querySelectorAll('.dropdown-menu .menu-item').forEach(link=>{
  if (link.textContent.trim() !== 'Shop') {
    link.addEventListener('click', (e)=>{
      e.preventDefault();
      const url = link.getAttribute('href'); // texts/*.txt
      fetch(url, {cache:'no-store'})
        .then(r=> r.ok ? r.text() : Promise.reject(r.status))
        .then(txt=> openModalWithText(txt))
        .catch(()=> openModalWithText('‚ö†Ô∏è ÎÇ¥Ïö©ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'));
    });
  }
});

/* ========== Tabs ========== */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t=>t.onclick=()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById("section-"+t.dataset.tab).classList.add("active");
  if (t.dataset.tab==="gen") player.pause();
});

/* ========== Supabase (public path) ========== */
const SUPABASE_URL="https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET="media";
const sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const PUBLIC_BASE = SUPABASE_URL.replace(/\/+$/,'') + "/storage/v1/object/public/" + BUCKET + "/";
const enc = s => s.split("/").filter(Boolean).map(encodeURIComponent).join("/");
const abs = p => PUBLIC_BASE + enc(p);

/* ========== Audio pipeline (Generator Ï†ÑÏö© WebAudio) ========== */
const audioCtx = window.audioCtx || new (window.AudioContext||window.webkitAudioContext)();
window.audioCtx = audioCtx;

// Ï†úÎÑàÎ†àÏù¥ÌÑ∞ ÎßàÏä§ÌÑ∞ Í≤åÏù∏
if(!window._audio || !window._audio.masterGain){
  const g = audioCtx.createGain();
  g.gain.value = 1;
  g.connect(audioCtx.destination);
  window._audio = Object.assign(window._audio||{}, { masterGain:g });
}
// (Ï§ëÏöî) ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïò§ÎîîÏò§Îäî WebAudioÏóê Ïó∞Í≤∞ÌïòÏßÄ ÏïäÏùå
window._audio._mediaSrcAttached = true;

// ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤òÎ°ú Ïò§ÎîîÏò§ Ï†ïÏ±Ö Ìï¥Ï†ú
function resumeAC(){ if(audioCtx.state!=='running'){ audioCtx.resume().catch(()=>{}); } }
['pointerdown','touchstart','keydown','click'].forEach(ev=>{
  document.addEventListener(ev, resumeAC, { once:true, passive:true });
});

/* ========== Library ========== */
const lib = document.getElementById("library");
const btnBack = document.getElementById("btnBack");
const btnRefresh = document.getElementById("btnRefresh");
const btnSaveList = document.getElementById("btnSaveList");
const btnLoadList = document.getElementById("btnLoadList");
const statusThumb = document.getElementById("statusThumb");

const player = document.getElementById("player");
const vol = document.getElementById("vol");
player.crossOrigin = "anonymous";
player.playsInline = true;
player.loop = false;

function setStatus(img){
  if(!img){
    statusThumb.classList.remove('loaded');
    statusThumb.classList.add('loading');
    statusThumb.style.background = "none";
    statusThumb.style.backgroundImage = "";
    return;
  }
  statusThumb.classList.add('loaded');
  statusThumb.classList.remove('loading');
  statusThumb.style.background = "none";
  statusThumb.style.backgroundImage = `url('${img}')`;
  statusThumb.style.backgroundSize = "cover";
  statusThumb.style.backgroundPosition = "center";
}

async function list(path=""){
  const {data,error} = await sb.storage.from(BUCKET).list(path,{limit:1000,sortBy:{column:"name",order:"asc"}});
  if(error){ console.warn(error); return []; }
  return data||[];
}

let cwd = "";
async function load(path=""){
  cwd = path;
  lib.innerHTML = "";
  setStatus(""); // Î°úÎî© ÏÉÅÌÉú

  const rows = await list(path);
  for(const e of rows){
    const name = e.name;
    const full = (path? path + "/" : "") + name;

    // Ìè¥Îçî
    if(!name.includes(".")){
      const card = document.createElement("div");
      card.className = "card"; card.dataset.kind="folder"; card.dataset.path=full;
      const img = document.createElement("img"); img.loading="lazy";
      img.src = abs(full + "/folder.png");
      img.onerror = () => img.src = "https://placehold.co/300x300/111/aaa?text=Folder";
      card.onclick = () => { resumeAC(); load(full); };
      card.append(img); lib.append(card);
      continue;
    }

    // Ïò§ÎîîÏò§
    if(/\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(name)){
      const card = document.createElement("div");
      card.className = "card"; card.dataset.kind="audio"; card.dataset.path=full;
      const img = document.createElement("img"); img.loading="lazy";
      const thumb = full.replace(/\.[^.]+$/, ".png");
      img.src = abs(thumb);
      img.onerror = () => img.src = "https://placehold.co/300x300/222/888?text=Audio";
      card.onclick = () => {
        resumeAC();
        player.pause(); player.currentTime=0;
        player.src = abs(full);
        const art = abs(thumb);
        setStatus(art);
        // Media Session Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
        setNowPlaying({ title: name.replace(/\.[^.]+$/,''), artist: '5DIO', art });
        setTimeout(()=>{ player.play().catch(()=>{}); }, 60);
      };
      card.append(img); lib.append(card);
    }
  }
}

/* nav */
btnBack.onclick = () => {
  if(!cwd) return;
  const seg = cwd.split("/"); seg.pop();
  load(seg.join("/"));
};
btnRefresh.onclick = () => load(cwd);

/* drag-to-scroll */
let isDown=false,sx=0,sl=0;
lib.addEventListener('mousedown',e=>{isDown=true;sx=e.pageX;sl=lib.scrollLeft;});
['mouseleave','mouseup'].forEach(ev=>lib.addEventListener(ev,()=>{isDown=false;}));
lib.addEventListener('mousemove',e=>{if(!isDown) return; lib.scrollLeft = sl - (e.pageX - sx)*1.5;});

/* Ï¥àÍ∏∞ Î£®Ìä∏ Î°úÎìú */
load("");

/* Î≥ºÎ•®/Î£®ÌîÑ/ÌÉÄÏù¥Î®∏ */
player.muted = false;
player.volume = vol ? (+vol.value || 1) : 1;
vol.addEventListener('input', (ev)=>{
  const v = parseFloat(ev.target.value || '1') || 1;
  player.volume = v;
  if(window._audio?.masterGain) window._audio.masterGain.gain.value = v; // Ï†úÎÑàÎ†àÏù¥ÌÑ∞ÎèÑ ÎèôÍ∏∞Ìôî
});
document.getElementById('loop').addEventListener('change', e=>{ player.loop = e.target.checked; });

let timerHandle=null;
document.getElementById('timer').addEventListener('change', e=>{
  if(timerHandle){ clearTimeout(timerHandle); timerHandle=null; }
  const mins = parseInt(e.target.value||"0",10);
  if(mins>0){
    timerHandle = setTimeout(()=>{ try{ player.pause(); }catch{} }, mins*60*1000);
  }
});

/* Playlist (localStorage) */
btnSaveList.onclick = ()=>{
  const name = prompt(isKo?"ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïù¥Î¶Ñ?":"Playlist name?"); if(!name) return;
  const items = [...lib.querySelectorAll(".card")].filter(c=>c.dataset.kind==="audio")
    .map(c=>({path:c.dataset.path, thumb:c.dataset.path.replace(/\.[^.]+$/,'.png')}));
  const all = JSON.parse(localStorage.getItem("playlists")||"{}"); all[name]=items;
  localStorage.setItem("playlists", JSON.stringify(all));
  alert((isKo?"Ï†ÄÏû•Îê®: ":"Saved: ")+name);
};
btnLoadList.onclick = ()=>{
  const all = JSON.parse(localStorage.getItem("playlists")||"{}");
  const names = Object.keys(all); if(!names.length){ alert(isKo?"ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.":"No playlists found."); return; }
  const sel = prompt((isKo?"ÏÑ†ÌÉù: ":"Select: ")+"\n"+names.join("\n")); if(!sel||!all[sel]) return;
  lib.innerHTML=""; setStatus("");
  all[sel].forEach(({path,thumb})=>{
    const c=document.createElement("div"); c.className="card"; c.dataset.kind="audio"; c.dataset.path=path;
    const img=document.createElement("img"); img.loading="lazy";
    const t=abs(thumb);
    img.src=t; img.onerror=()=>img.src="https://placehold.co/300x300/222/888?text=Audio";
    c.onclick=()=>{ resumeAC(); player.pause(); player.currentTime=0; player.src=abs(path); setStatus(t); setNowPlaying({title:path.split('/').pop().replace(/\.[^.]+$/,''),artist:'5DIO',art:t}); setTimeout(()=>player.play().catch(()=>{}),60); };
    c.append(img); lib.append(c);
  });
};

/* ========== Generator (WebAudio) ========== */
const waveSel  = document.getElementById("genWave");
const freqInp  = document.getElementById("genFreq");
const lvlInp   = document.getElementById("genLevel");
const bbChk    = document.getElementById("genBinaural");
const beatInp  = document.getElementById("genBeat");
const harmInp  = document.getElementById("genHarmonics");
const dutyInp  = document.getElementById("genDuty");

const genGain = (function(){ const g = audioCtx.createGain(); g.connect(window._audio.masterGain); return g; })();
let genRunning=false;
let genMeta=[]; // [{node, mult, beatAdd}...]

function clearGen(){
  genMeta.forEach(o=>{ try{o.node.stop()}catch{} try{o.node.disconnect()}catch{} });
  genMeta = [];
}
function buildGenNodes(baseFreq, useBB, beat, harmonics, wave){
  clearGen();
  const mk = (freq, mult=1, beatAdd=0)=>{
    const o=audioCtx.createOscillator();
    o.type = wave;
    o.frequency.value = freq*mult + beatAdd;
    o.connect(genGain);
    o.start();
    genMeta.push({node:o, mult, beatAdd});
  };
  if(useBB){
    mk(baseFreq, 1, 0);
    mk(baseFreq, 1, beat);
  }else{
    mk(baseFreq, 1, 0);
  }
  for(let m=2;m<=harmonics;m++){
    if(useBB){
      mk(baseFreq, m, 0);
      mk(baseFreq, m, beat);
    }else{
      mk(baseFreq, m, 0);
    }
  }
}
function startGenerator(){
  resumeAC();
  if(!player.paused) player.pause();
  if(genRunning) clearGen();

  const wave = waveSel.value;
  const base = parseFloat(freqInp.value||"432");
  const lvl  = parseFloat(lvlInp.value||"0.5");
  const useBB= !!bbChk.checked;
  const beat = parseFloat(beatInp.value||"7");
  const harm = Math.max(1, Math.min(8, parseInt(harmInp.value)||1));

  genGain.gain.value = lvl;
  buildGenNodes(base, useBB, beat, harm, wave);

  dutyInp.disabled = (wave!=="square");
  genRunning = true;
}
function stopGenerator(){
  if(!genRunning) return;
  clearGen();
  genRunning=false;
  genGain.gain.setTargetAtTime(0,audioCtx.currentTime,0.02);
}
function updateGenerator(){
  if(!genRunning) return;
  const wave = waveSel.value;
  const base = parseFloat(freqInp.value||"432");
  const useBB= !!bbChk.checked;
  const beat = parseFloat(beatInp.value||"7");
  const harm = Math.max(1, Math.min(8, parseInt(harmInp.value)||1));

  const structureChanged =
    (genMeta.length===0) ||
    (wave !== genMeta._wave) ||
    (useBB !== genMeta._bb) ||
    (harm !== genMeta._harm);

  if(structureChanged){
    buildGenNodes(base, useBB, beat, harm, wave);
    genMeta._wave = wave; genMeta._bb = useBB; genMeta._harm = harm;
  }else{
    genMeta.forEach(o=>{
      const target = base*o.mult + (useBB ? (o.beatAdd?beat:0) : 0);
      try{
        o.node.frequency.cancelScheduledValues(audioCtx.currentTime);
        o.node.frequency.setTargetAtTime(target, audioCtx.currentTime, 0.02);
      }catch{}
    });
  }
}
freqInp.oninput = updateGenerator;
waveSel.oninput = updateGenerator;
bbChk .oninput = updateGenerator;
beatInp.oninput = updateGenerator;
harmInp.oninput = updateGenerator;
lvlInp .oninput = e => { genGain.gain.value = parseFloat(e.target.value); };
dutyInp.oninput = ()=>{};

/* Sweep */
document.getElementById('sweepGo').onclick = ()=>{
  if(!genRunning || genMeta.length===0) return;
  const s = +document.getElementById('sweepStart').value || 100;
  const e = +document.getElementById('sweepEnd').value   || 1000;
  const t = +document.getElementById('sweepTime').value  || 10;
  const now = audioCtx.currentTime;
  genMeta.forEach(o=>{
    const startF = s*o.mult + (o.beatAdd||0);
    const endF   = e*o.mult + (o.beatAdd||0);
    try{
      o.node.frequency.cancelScheduledValues(now);
      o.node.frequency.setValueAtTime(startF, now);
      o.node.frequency.linearRampToValueAtTime(endF, now + t);
    }catch{}
  });
};
const genStartBtn = document.getElementById("genStart");
const genStopBtn  = document.getElementById("genStop");
genStartBtn.addEventListener("click", ()=>{ audioCtx.resume(); startGenerator(); genMeta._wave=waveSel.value; genMeta._bb=!!bbChk.checked; genMeta._harm=(+harmInp.value||1); });
genStopBtn .addEventListener("click", stopGenerator);

/* Generator mini scope */
(function genScope(){
  const cvs = document.getElementById("oscGen"); const ctx2 = cvs.getContext("2d");
  const analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
  genGain.connect(analyser);
  const buf = new Uint8Array(analyser.fftSize);
  function resize(){ cvs.width = cvs.clientWidth || window.innerWidth; }
  resize(); window.addEventListener("resize", resize);
  (function draw(){
    requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(buf);
    ctx2.fillStyle="#090b11"; ctx2.fillRect(0,0,cvs.width,cvs.height);
    ctx2.lineWidth=2; ctx2.strokeStyle="#9cff8b"; ctx2.beginPath();
    const dx=cvs.width/buf.length;
    for(let i=0,x=0;i<buf.length;i++,x+=dx){
      const y=(buf[i]/128)*(cvs.height/2);
      i?ctx2.lineTo(x,y):ctx2.moveTo(x,y);
    }
    ctx2.lineTo(cvs.width,cvs.height/2); ctx2.stroke();
  })();
})();

/* Presets */
document.getElementById("btnSavePreset").onclick = ()=>{
  const name = prompt(isKo?"ÌîÑÎ¶¨ÏÖã Ïù¥Î¶Ñ?":"Preset name?"); if(!name) return;
  const p = {
    wave: waveSel.value, freq: +freqInp.value || 432, level: +lvlInp.value || 0.5,
    binaural: !!bbChk.checked, beat: +beatInp.value || 7,
    harmonics: +harmInp.value || 1, duty: +dutyInp.value || 0.5
  };
  const all = JSON.parse(localStorage.getItem("gen_presets")||"{}"); all[name]=p;
  localStorage.setItem("gen_presets", JSON.stringify(all));
  alert((isKo?"Ï†ÄÏû•Îê®: ":"Saved: ")+name);
};
document.getElementById("btnLoadPreset").onclick = ()=>{
  const all = JSON.parse(localStorage.getItem("gen_presets")||"{}");
  const names = Object.keys(all); if(!names.length){ alert(isKo?"ÌîÑÎ¶¨ÏÖãÏù¥ ÏóÜÏäµÎãàÎã§.":"No presets."); return; }
  const sel = prompt((isKo?"ÏÑ†ÌÉù: ":"Select: ")+"\n"+names.join("\n")); if(!sel||!all[sel]) return;
  const p = all[sel];
  waveSel.value = p.wave||"sine";
  freqInp.value = p.freq||432;
  lvlInp.value  = p.level||0.5; genGain.gain.value = p.level||0.5;
  bbChk.checked = !!p.binaural;
  beatInp.value = p.beat||7;
  harmInp.value = p.harmonics||1;
  dutyInp.value = p.duty||0.5;
  dutyInp.disabled = (waveSel.value!=="square");
  updateGenerator();
  alert((isKo?"Î∂àÎü¨Ïò¥: ":"Loaded: ")+sel);
};

/* EN/KO Toggle */
const langBtn = document.getElementById("langToggle"); let isKo=false;
function applyLang(){
  document.getElementById("lblVol").textContent   = isKo ? "Î≥ºÎ•®" : "Volume";
  document.getElementById("lblLoop").textContent  = isKo ? "Î∞òÎ≥µ" : "Loop";
  document.getElementById("lblTimer").textContent = isKo ? "ÌÉÄÏù¥Î®∏" : "Timer";
  document.querySelector('.tab[data-tab="lib"]').textContent = "5DO";
  document.querySelector('.tab[data-tab="gen"]').textContent = isKo ? "Ï£ºÌååÏàò ÏÉùÏÑ±Í∏∞" : "Freq. Gen.";

  document.getElementById("lblFreq").textContent   = isKo ? "Ï£ºÌååÏàò (Hz)" : "Frequency (Hz)";
  document.getElementById("lblWave").textContent   = isKo ? "ÌååÌòï" : "Waveform";
  document.getElementById("lblBB").textContent     = isKo ? "Î∞îÏù¥ÎÖ∏Îü¥" : "Binaural";
  document.getElementById("lblBBEnable").textContent= isKo ? "ÌôúÏÑ±Ìôî" : "Enable";
  document.getElementById("lblBBdiff").textContent  = isKo ? "Ï∞®Ïù¥ (Hz)" : "Difference (Hz)";
  document.getElementById("lblHarmonics").textContent = isKo ? "ÌïòÎ™®ÎãâÏä§" : "Harmonics";
  document.getElementById("lblHarmHelp").textContent  = isKo ? "Î∞∞Ïàò" : "Multiplier";
  document.getElementById("lblLevel").textContent   = isKo ? "Î†àÎ≤®" : "Level";
  document.getElementById("lblDuty").textContent    = isKo ? "ÎìÄÌã∞ ÏÇ¨Ïù¥ÌÅ¥" : "Duty Cycle";
}
langBtn.onclick=()=>{ isKo=!isKo; langBtn.textContent=isKo?"KO":"EN"; applyLang(); };
applyLang();

/* ===== Library: ÏÇ¨Ïö¥Îìú Ï∂úÎ†• ÏßÑÎã® Î°úÍ∑∏ ===== */
player.addEventListener('play', ()=>{ if(audioCtx.state!=='running') audioCtx.resume().catch(()=>{}); });
['play','pause','volumechange','canplay','stalled','error'].forEach(ev=>{
  player.addEventListener(ev, ()=>{
    console.log('[5DO::DIAG]', ev, {
      acState: audioCtx.state, muted: player.muted, vol: player.volume,
      src: player.currentSrc || player.src, paused: player.paused, readyState: player.readyState,
      error: player.error ? (player.error.code + ' ' + (player.error.message || '')) : null
    });
  });
});
</script>

<!-- ===== Background Playback (Media Session) + Radial Visualizer (5DO tuned) ===== -->
<script>
/* Media Session: Î∞±Í∑∏ÎùºÏö¥Îìú/ÎùΩÏä§ÌÅ¨Î¶∞ Ïª®Ìä∏Î°§ */
(function(){
  const audio = document.getElementById('player');
  if(!audio) return;

  audio.playsInline = true;
  audio.muted = false;

  if ('mediaSession' in navigator) {
    function updateMeta() {
      const title  = (window._5doNow && window._5doNow.title)  || '5DO Pro';
      const artist = (window._5doNow && window._5doNow.artist) || '5DIO';
      const art    = (window._5doNow && window._5doNow.art)    || '';
      try {
        navigator.mediaSession.metadata = new MediaMetadata({
          title, artist, album: '5DO',
          artwork: art ? [{ src: art, sizes: '512x512', type: 'image/png' }] : []
        });
      } catch(_) {}
    }
    navigator.mediaSession.setActionHandler('play', async () => {
      try { await audio.play(); } catch {}
      navigator.mediaSession.playbackState = 'playing';
    });
    navigator.mediaSession.setActionHandler('pause', () => {
      audio.pause(); navigator.mediaSession.playbackState = 'paused';
    });
    navigator.mediaSession.setActionHandler('stop', () => {
      audio.pause(); audio.currentTime = 0; navigator.mediaSession.playbackState = 'none';
    });
    const STEP = 10;
    navigator.mediaSession.setActionHandler('seekbackward', (d) => { audio.currentTime = Math.max(0, audio.currentTime - (d.seekOffset || STEP)); });
    navigator.mediaSession.setActionHandler('seekforward',  (d) => { audio.currentTime = Math.min(audio.duration||1e9, audio.currentTime + (d.seekOffset || STEP)); });
    navigator.mediaSession.setActionHandler('seekto', (d) => { if (typeof d.seekTime === 'number') audio.currentTime = d.seekTime; });
    ['loadedmetadata','play','pause'].forEach(ev=> audio.addEventListener(ev, ()=>{
      navigator.mediaSession.playbackState = audio.paused ? 'paused' : 'playing'; updateMeta();
    }));
    window.setNowPlaying = function({title, artist, art}){ window._5doNow = {title,artist,art}; updateMeta(); };
  }

  const AC = window.audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  window.audioCtx = AC;
  function resumeAC(){ if(AC.state!=='running'){ AC.resume().catch(()=>{}); } }
  ['pointerdown','touchstart','keydown','click'].forEach(ev=>{
    document.addEventListener(ev, resumeAC, { once:true, passive:true });
  });
  const playerEl = document.getElementById('player');
  playerEl.addEventListener('play', resumeAC);
})();

/* Radial Spectrum (5DO ÏÉâÍ∞ê ÌäúÎãù) ‚Äî Library Player Ï†ÑÏö© */
(function(){
  const player = document.getElementById('player');
  if(!player) return;

  const wrap = document.getElementById('radialVizWrap');
  const canvas = document.getElementById('radialViz');
  const ctx = canvas.getContext('2d');

  const AC = window.audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  const analyser = AC.createAnalyser();
  analyser.fftSize = 1024;
  analyser.smoothingTimeConstant = 0.88;
  const data = new Uint8Array(analyser.frequencyBinCount);

  let srcNode = null;
  function connectAnalyser(){
    try{ srcNode && srcNode.disconnect(); }catch{}
    srcNode = null;
    const stream = player.captureStream ? player.captureStream() :
                   (player.mozCaptureStream ? player.mozCaptureStream() : null);
    if(stream){
      try{
        srcNode = AC.createMediaStreamSource(stream);
        srcNode.connect(analyser);
        return true;
      }catch(e){ console.warn('[RadialViz] connect failed', e); }
    }
    return false;
  }

  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width  * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resize).observe(canvas); resize();

  let rafId = 0, running=false;
  function draw(){
    rafId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    const cw = canvas.clientWidth, ch = canvas.clientHeight;
    ctx.clearRect(0,0,cw,ch);

    const cx = cw/2, cy = ch/2;
    const innerR = 48;
    const outerR = Math.min(cw,ch)/2 - 10;
    const maxBar = outerR - innerR;

    // Î∞∞Í≤Ω
    ctx.fillStyle='#0b0f17';
    ctx.fillRect(0,0,cw,ch);

    // Ï§ëÏïô Ïõê
    ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2);
    ctx.fillStyle='#0e1422'; ctx.fill();

    // 5DO ÎÑ§Ïò® Í∑∏ÎùºÎç∞Ïù¥ÏÖò
    const grad = ctx.createRadialGradient(cx,cy,innerR,cx,cy,outerR);
    grad.addColorStop(0.0,'#7ef1c0');  
    grad.addColorStop(0.5,'#55d0ff');  
    grad.addColorStop(1.0,'#a38cff');  

    for(let i=0;i<data.length;i++){
      const t = i/data.length;
      const ang = t*Math.PI*2;
      const v = data[i]/255;
      const eased = Math.pow(v,0.8);
      const len = innerR + eased * maxBar * 1.25;

      const x1 = cx + innerR*Math.cos(ang);
      const y1 = cy + innerR*Math.sin(ang);
      const x2 = cx + len*Math.cos(ang);
      const y2 = cy + len*Math.sin(ang);

      ctx.strokeStyle = grad;
      ctx.lineWidth = 1.5 + (1.5*(1-t)); // Ï†ÄÏó≠ ÍµµÍ≤å, Í≥†Ïó≠ ÏñáÍ≤å
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
    }

    // Ïô∏Í≥Ω ÎßÅ
    ctx.beginPath();
    ctx.arc(cx, cy, outerR, 0, Math.PI*2);
    ctx.strokeStyle = 'rgba(126,241,192,0.4)';
    ctx.lineWidth = 1.2;
    ctx.stroke();
  }

  function start(){ if(running) return; if(!connectAnalyser()) return; running=true; wrap.style.display="flex"; draw(); }
  function stop(){ running=false; cancelAnimationFrame(rafId); try{ srcNode && srcNode.disconnect(); }catch{} ctx.clearRect(0,0,canvas.width,canvas.height); wrap.style.display="none"; }

  player.addEventListener('play', ()=>{ if(AC.state!=='running'){ AC.resume(); } start(); });
  player.addEventListener('pause', stop);
  player.addEventListener('emptied', stop);

  // ÌÉ≠ Ï†ÑÌôò Ïãú ÏûêÎèô Ï†ïÏßÄ/Ïû¨ÏãúÏûë
  const libTabBtn = document.querySelector('.tab[data-tab="lib"]');
  const genTabBtn = document.querySelector('.tab[data-tab="gen"]');
  function onTabChange(){
    const libActive = document.getElementById('section-lib')?.classList.contains('active');
    if(libActive && !player.paused) start(); else stop();
  }
  libTabBtn && libTabBtn.addEventListener('click', onTabChange);
  genTabBtn && genTabBtn.addEventListener('click', onTabChange);

  if(!player.paused && player.currentSrc) start();
})();
</script>
</body>
</html>
