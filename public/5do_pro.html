<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>5DO Pro</title>
<style>
  :root{
    --bg:#0b0f17;
    --panel:#101826;
    --border:#263148;
    --accent:#87e7c4;
    --text:#e7f2ee;
    --muted:#8aa0b3;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  header{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
  .left{display:flex;align-items:center;gap:10px}
  .hambox{width:36px;height:28px;display:grid;place-items:center;border:1px solid var(--border);border-radius:8px;cursor:pointer;position:relative;top:3px}
  .hambox svg{width:18px;height:18px}
  .title{font-weight:700;color:var(--accent)}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#171d2b;color:#cfead1;cursor:pointer}
  .tab.active{background:#1f2739;border-color:#334}
  main{padding:14px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  /* library bar */
  .libbar{display:flex;align-items:center;gap:10px;margin:0 0 12px}
  .iconbtn{width:34px;height:34px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;cursor:pointer;background:#141c2a}
  .iconbtn svg{width:18px;height:18px}
  /* carousel strip */
  .strip{display:flex;gap:10px;overflow:auto;padding:8px;background:var(--panel);border:1px solid var(--border);border-radius:12px;scroll-snap-type:x mandatory}
  .card{min-width:120px;max-width:120px;scroll-snap-align:start;background:#0f1723;border:1px solid var(--border);border-radius:10px;cursor:pointer;display:flex;flex-direction:column;overflow:hidden}
  .thumb{width:100%;height:120px;background:#0c1320;display:grid;place-items:center}
  .thumb img{width:100%;height:100%;object-fit:contain;aspect-ratio:1/1;display:block}
  .label{padding:8px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px}
  /* status + controls */
  .statusRow{display:flex;align-items:center;gap:12px;margin-top:12px;flex-wrap:wrap}
  .statusThumb{width:124px;height:124px;border-radius:12px;border:1px solid var(--border);background:
    radial-gradient(120px 120px at 30% 30%, rgba(135,231,196,.25), transparent 60%),
    radial-gradient(160px 160px at 70% 60%, rgba(145,170,255,.18), transparent 60%),
    #0e1422; position:relative; overflow:hidden}
  .controls{display:flex;align-items:center;gap:10px;flex:1;min-width:240px;flex-wrap:wrap}
  .controls .row{gap:8px}
  input[type="range"]{width:180px}
  /* visualizer bar (below audio player) */
  .vizWrap{margin-top:12px}
  canvas#barviz{width:100%;height:120px;background:#0c131f;border:1px solid var(--border);border-radius:12px;display:block}
  /* sections */
  .section{display:none}
  .section.active{display:block}
  /* generator layout (2-col rows on mobile/desktop) */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .full{grid-column:1/-1}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#171d2b;color:#cfead1;cursor:pointer}
  .btn.primary{background:#1e293b;color:#d7ffee;border-color:#3a4b63}
  audio{width:100%;margin-top:6px}
</style>
</head>
<body>

<header>
  <div class="left">
    <div class="hambox" id="hambtn" title="Menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="#cfead1" stroke-width="2" stroke-linecap="round"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </div>
    <div class="title">5DO Pro</div>
  </div>
  <div class="tabs">
    <div class="tab active" id="tabLib">5DO</div>
    <div class="tab" id="tabGen">Freq. Gen.</div>
  </div>
</header>

<main>
  <!-- ============ LIBRARY ============ -->
  <section id="secLib" class="section active">
    <div class="libbar">
      <button class="iconbtn" id="btnBack" title="Back" aria-label="Back">
        <svg viewBox="0 0 24 24" fill="none" stroke="#cfead1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button class="iconbtn" id="btnRefresh" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="#cfead1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-3-6.7M21 3v6h-6"/></svg>
      </button>
      <span id="crumbs" style="color:#9bb4c5"></span>
    </div>

    <div id="strip" class="strip" aria-label="library strip"></div>

    <div class="statusRow">
      <div class="statusThumb" id="statusThumb"></div>

      <div class="controls">
        <div class="row">
          <label>Volume</label>
          <input type="range" id="vol" min="0" max="1" step="0.01" value="0.8"/>
          <label><input type="checkbox" id="loopChk"> Loop</label>
          <select id="timerSel">
            <option value="0">Timer: Off</option>
            <option value="5">5m</option><option value="10">10m</option>
            <option value="15">15m</option><option value="20">20m</option>
            <option value="30">30m</option><option value="45">45m</option><option value="60">60m</option>
          </select>
        </div>
        <div class="row">
          <button class="btn primary" id="btnPlay">▶︎ Play</button>
          <button class="btn" id="btnPause">⏸︎ Pause</button>
          <button class="btn" id="btnStop">⏹︎ Stop</button>
        </div>
        <audio id="player" preload="metadata" controls></audio>
      </div>
    </div>

    <div class="vizWrap">
      <canvas id="barviz" height="120"></canvas>
    </div>
  </section>

  <!-- ============ GENERATOR ============ -->
  <section id="secGen" class="section">
    <div class="panel">
      <div class="full"><canvas id="genScope" height="140" style="width:100%;background:#0c131f;border:1px solid var(--border);border-radius:12px"></canvas></div>
      <div class="grid2" style="margin-top:12px">
        <div class="panel">
          <label>Frequency (Hz)</label>
          <input type="number" id="genFreq" value="432" min="1" step="0.1" style="width:100%"/>
        </div>
        <div class="panel">
          <label>Waveform</label>
          <select id="genWave" style="width:100%">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Sawtooth</option>
          </select>
        </div>
        <div class="panel">
          <label>Binaural (Hz)</label>
          <input type="number" id="genBinaural" value="0" min="0" max="40" step="0.1" style="width:100%"/>
        </div>
        <div class="panel">
          <label>Harmonics (×)</label>
          <input type="number" id="genHarm" value="0" min="0" max="8" step="1" style="width:100%"/>
        </div>
        <div class="panel">
          <label>Level</label>
          <input type="range" id="genLevel" min="0" max="1" step="0.01" value="0.6" style="width:100%"/>
        </div>
        <div class="panel">
          <label>Duty (%)</label>
          <input type="range" id="genDuty" min="1" max="99" step="1" value="50" style="width:100%"/>
        </div>
        <div class="panel full">
          <div class="row">
            <button class="btn primary" id="genPlayBtn" title="Play">&#9654;</button>
            <button class="btn" id="genStopBtn" title="Stop">&#9632;</button>
            <button class="btn" id="genSweepBtn" title="Sweep">Sweep</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.43.4/dist/umd/supabase.js"></script>
<script>
/** =========================
 *  0) SUPABASE CONFIG
 *  ========================= */
const SUPA_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

// image helpers
const imgx = (path, q) => `${SUPA_URL}/storage/v1/render/image/public/${BUCKET}/${encodePath(path)}${q?`?${q}`:''}`;
const objx = (path) => `${SUPA_URL}/storage/v1/object/public/${BUCKET}/${encodePath(path)}`;
function encodePath(p){ return p.split('/').map(encodeURIComponent).join('/'); }

/** =========================
 *  1) UI ELEMENTS
 *  ========================= */
const tabLib = document.getElementById('tabLib');
const tabGen = document.getElementById('tabGen');
const secLib = document.getElementById('secLib');
const secGen = document.getElementById('secGen');

tabLib.onclick = ()=>{ tabLib.classList.add('active'); tabGen.classList.remove('active'); secLib.classList.add('active'); secGen.classList.remove('active'); stopGenerator(); };
tabGen.onclick = ()=>{ tabGen.classList.add('active'); tabLib.classList.remove('active'); secGen.classList.add('active'); secLib.classList.remove('active'); };

document.getElementById('hambtn').onclick = ()=>window.open("https://5dshop.co.kr","_blank");

/** =========================
 *  2) LIBRARY BROWSER
 *  ========================= */
const strip = document.getElementById('strip');
const crumbs = document.getElementById('crumbs');
const btnBack = document.getElementById('btnBack');
const btnRefresh = document.getElementById('btnRefresh');

let pathStack = []; // e.g. ["Brainwave_States"]

async function listRoot(){
  pathStack = [];
  crumbs.textContent = '/';
  strip.innerHTML = "";
  const { data, error } = await sb.storage.from(BUCKET).list("", {limit:100, sortBy:{column:'name', order:'asc'}});
  if(error){ console.error(error); return; }
  // Folders only (heuristic: we consider a "folder" if it contains / exists when we list)
  // Supabase list at root returns objects; to emulate folders, predefine known folders or probe folder.png existence
  // Here: probe by common known category names from your storage or by folder.png existence from a list
  const guessFolders = await guessFoldersFromFiles(data.map(d=>d.name));
  for(const folder of guessFolders){
    strip.appendChild(renderFolderCard(folder));
  }
}

async function guessFoldersFromFiles(names){
  // If your bucket is organized as Category/xxx files, server-side list with 'search' isn't hierarchical.
  // We’ll use a fixed list you showed earlier. You can edit this to your real set.
  const candidates = [
    "Brainwave_States","Divine_Tunes","White_Noise","Amazon_Forest","Earth_Schumann","Gamma",
    "Theta","Delta","Alpha","Beta","Echos_of_the_Eternal_Flow"
  ];
  // Only include ones that actually resolve folder.png
  const found = [];
  await Promise.all(candidates.map(async c=>{
    const url = imgx(`${c}/folder.png`, "width=360&quality=70&format=webp");
    const ok = await headOk(url);
    if(ok) found.push(c);
  }));
  // fallback: from names (top-level files), we cannot infer folders reliably; return candidates found
  return found;
}

function renderFolderCard(name){
  const card = document.createElement('div');
  card.className = "card";
  const th = document.createElement('div'); th.className = "thumb";
  const img = document.createElement('img');
  img.alt = "Folder";
  img.src = imgx(`${name}/folder.png`, "width=360&quality=70&format=webp");
  th.appendChild(img);
  const lb = document.createElement('div'); lb.className = "label"; lb.textContent = name;
  card.appendChild(th); card.appendChild(lb);
  card.onclick = ()=>loadFolder(name);
  return card;
}

async function loadFolder(folder){
  // push history
  pathStack.push(folder);
  crumbs.textContent = "/" + pathStack.join("/");
  strip.innerHTML = "";
  // list files under folder by probing common extensions (Supabase Storage v2 UMD has no recursive list)
  // Strategy: list all objects and filter by prefix via RLS disabled for anon read on bucket_id='media'.
  const { data, error } = await sb.storage.from(BUCKET).list(folder, {limit:100, sortBy:{column:'name', order:'asc'}});
  if(error){ console.error(error); return; }

  // Show audios and any subimages; assume *.mp3 and *.png pair
  const audios = data.filter(x=>/\.mp3$/i.test(x.name));
  if(audios.length===0){
    // Still show something (maybe nested names or different case)
    const imgs = data.filter(x=>/\.png$/i.test(x.name));
    imgs.forEach(file=>{
      strip.appendChild(renderAudioLikeCard(folder, file.name.replace(/\.png$/i,'')));
    });
  }else{
    audios.forEach(file=>{
      const base = file.name.replace(/\.mp3$/i,'');
      strip.appendChild(renderAudioLikeCard(folder, base));
    });
  }
}

function renderAudioLikeCard(folder, base){
  const card = document.createElement('div');
  card.className = "card";
  const th = document.createElement('div'); th.className = "thumb";
  const img = document.createElement('img');
  img.alt = "Audio";
  // try base.png, fallback folder.png
  const p1 = imgx(`${folder}/${base}.png`, "width=360&quality=70&format=webp");
  img.src = p1;
  img.onerror = ()=>{ img.src = imgx(`${folder}/folder.png`, "width=360&quality=70&format=webp"); };
  th.appendChild(img);
  const lb = document.createElement('div'); lb.className = "label"; lb.textContent = base;
  card.appendChild(th); card.appendChild(lb);
  card.onclick = ()=>{ selectTrack(folder, base); };
  return card;
}

btnBack.onclick = ()=>{
  if(pathStack.length>0) pathStack.pop();
  if(pathStack.length===0) listRoot();
  else loadFolder(pathStack[pathStack.length-1]);
};
btnRefresh.onclick = ()=>{
  if(pathStack.length===0) listRoot();
  else loadFolder(pathStack[pathStack.length-1]);
};

/** =========================
 *  3) AUDIO + UNLOCK + VOLUME + TIMER + NO AUTOPLAY
 *  ========================= */
const player = document.getElementById('player');
const vol = document.getElementById('vol');
const loopChk = document.getElementById('loopChk');
const timerSel = document.getElementById('timerSel');
const btnPlay = document.getElementById('btnPlay');
const btnPause = document.getElementById('btnPause');
const btnStop = document.getElementById('btnStop');
const statusThumb = document.getElementById('statusThumb');

let audioCtx = null, gainNode = null, mediaSrcNode = null, analyser = null;
let barViz = document.getElementById('barviz');
let barCtx = barViz.getContext('2d');
let rafId = 0;
let timerId = 0;
let currentSrc = "";

function ensureAudioUnlocked(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    gainNode = audioCtx.createGain();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    gainNode.connect(analyser).connect(audioCtx.destination);
  }
  if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
}
document.addEventListener('pointerdown', ensureAudioUnlocked, {once:true});

vol.addEventListener('input', ()=>{
  if(gainNode) gainNode.gain.value = parseFloat(vol.value);
  // iOS Safari fails setVolume on <audio>; WebAudio path solves it
});

loopChk.onchange = ()=>{ player.loop = loopChk.checked; };
timerSel.onchange = ()=>{
  if(timerId){ clearTimeout(timerId); timerId=0; }
  const minutes = parseInt(timerSel.value,10)||0;
  if(minutes>0){
    timerId = setTimeout(()=>{ stopPlayback(); }, minutes*60*1000);
  }
};

btnPlay.onclick = ()=>{
  ensureAudioUnlocked();
  if(!mediaSrcNode){
    mediaSrcNode = audioCtx.createMediaElementSource(player);
    mediaSrcNode.connect(gainNode);
  }
  player.play().catch(e=>console.warn(e));
  startBarVisualizer();
};
btnPause.onclick = ()=>{ player.pause(); stopBarVisualizerIfPaused(); };
btnStop.onclick = ()=>{ stopPlayback(); };

function stopPlayback(){
  player.pause();
  player.currentTime = 0;
  stopBarVisualizerIfPaused(true);
}

function selectTrack(folder, base){
  // 1) 썸네일/상태만 갱신
  statusThumb.style.backgroundImage = `url("${imgx(`${folder}/${base}.png`, "width=360&quality=70&format=webp")}")`;
  statusThumb.style.backgroundSize = 'cover';
  statusThumb.style.backgroundPosition = 'center';
  // 2) 소스만 교체 (자동재생 금지)
  currentSrc = objx(`${folder}/${base}.mp3`);
  player.src = currentSrc;
  player.load();
  // 재생은 Play 버튼으로만!
}

player.addEventListener('play', ()=>{ startBarVisualizer(); });
player.addEventListener('pause', ()=>{ stopBarVisualizerIfPaused(); });
player.addEventListener('ended', ()=>{ stopBarVisualizerIfPaused(true); });

/** =========================
 *  4) BAR SPECTRUM VISUALIZER
 *  ========================= */
function startBarVisualizer(){
  if(!analyser) return;
  cancelAnimationFrame(rafId);
  const buf = new Uint8Array(analyser.frequencyBinCount);
  const draw = ()=>{
    rafId = requestAnimationFrame(draw);
    barCtx.clearRect(0,0,barViz.width,barViz.height);
    analyser.getByteFrequencyData(buf);
    const W = barViz.width, H = barViz.height;
    const bars = 72;
    const step = Math.floor(buf.length / bars);
    for(let i=0;i<bars;i++){
      const v = buf[i*step]/255;
      const h = v*H*0.9;
      const x = i*(W/bars);
      const bw = (W/bars)*0.9;
      // gradient color: emerald->cyan->violet
      const g = barCtx.createLinearGradient(x, H-h, x, H);
      g.addColorStop(0, '#7ef1c0');
      g.addColorStop(0.6, '#55d0ff');
      g.addColorStop(1, '#a38cff');
      barCtx.fillStyle = g;
      barCtx.fillRect(x, H-h, bw, h);
      // subtle outer-glow
      barCtx.globalAlpha = 0.08;
      barCtx.fillRect(x, H-h-6, bw, 6);
      barCtx.globalAlpha = 1;
    }
  };
  draw();
}
function stopBarVisualizerIfPaused(force=false){
  if(force || player.paused){
    cancelAnimationFrame(rafId);
    rafId = 0;
    // keep last frame; no clear
  }
}
// handle canvas sizing
function fitCanvas(cnv){
  const rect = cnv.getBoundingClientRect();
  cnv.width = Math.floor(rect.width * devicePixelRatio);
  cnv.height = Math.floor(rect.height * devicePixelRatio);
  cnv.getContext('2d').scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener('resize', ()=>fitCanvas(barViz));
fitCanvas(barViz);

/** =========================
 *  5) GENERATOR (play/stop + scope + real-time controls)
 *  ========================= */
let genCtx=null, genGain=null, genOscL=null, genOscR=null, genMerger=null, genAnalyser=null, genRAF=0;
const genScope = document.getElementById('genScope');
const gctx = genScope.getContext('2d');
const fFreq = document.getElementById('genFreq');
const fWave = document.getElementById('genWave');
const fBin  = document.getElementById('genBinaural');
const fHar  = document.getElementById('genHarm');
const fLvl  = document.getElementById('genLevel');
const fDuty = document.getElementById('genDuty');
const genPlayBtn = document.getElementById('genPlayBtn');
const genStopBtn = document.getElementById('genStopBtn');
const genSweepBtn = document.getElementById('genSweepBtn');

function genEnsure(){
  if(!genCtx){
    genCtx = new (window.AudioContext||window.webkitAudioContext)();
    genGain = genCtx.createGain();
    genAnalyser = genCtx.createAnalyser();
    genAnalyser.fftSize = 2048;
    genGain.connect(genAnalyser).connect(genCtx.destination);
  }
  if(genCtx.state==='suspended') genCtx.resume();
}
function createOsc(freq, type){
  const osc = genCtx.createOscillator();
  osc.type = type;
  osc.frequency.value = freq;
  return osc;
}
function startGenerator(){
  genEnsure();
  stopGenerator();

  const base = parseFloat(fFreq.value)||432;
  const wave = fWave.value;
  const bina = parseFloat(fBin.value)||0;
  const lvl  = parseFloat(fLvl.value)||0.6;
  const har  = parseInt(fHar.value)||0;

  // L/R with binaural
  genOscL = createOsc(base, wave);
  genOscR = createOsc(base + bina, wave);

  genMerger = genCtx.createChannelMerger(2);
  const gL = genCtx.createGain(); gL.gain.value = lvl;
  const gR = genCtx.createGain(); gR.gain.value = lvl;

  genOscL.connect(gL).connect(genMerger, 0, 0);
  genOscR.connect(gR).connect(genMerger, 0, 1);
  genMerger.connect(genGain);

  // harmonics (simple additive)
  if(har>0){
    for(let k=2;k<=har+1;k++){
      const oL = createOsc(base*k, wave);
      const oR = createOsc((base+bina)*k, wave);
      const aL = genCtx.createGain(); aL.gain.value = lvl*(1/(k*1.5));
      const aR = genCtx.createGain(); aR.gain.value = lvl*(1/(k*1.5));
      oL.connect(aL).connect(genMerger, 0, 0);
      oR.connect(aR).connect(genMerger, 0, 1);
      oL.start(); oR.start();
      // stash for stop
      (genOscL.extras ??= []).push(oL);
      (genOscR.extras ??= []).push(oR);
    }
  }

  genGain.gain.value = lvl;
  genOscL.start(); genOscR.start();
  drawGenScope();
}
function stopGenerator(){
  cancelAnimationFrame(genRAF);
  genRAF = 0;
  try{
    if(genOscL){ genOscL.stop(); if(genOscL.extras) genOscL.extras.forEach(o=>o.stop()); }
    if(genOscR){ genOscR.stop(); if(genOscR.extras) genOscR.extras.forEach(o=>o.stop()); }
  }catch(e){}
  genOscL=genOscR=null;
  if(genMerger){ try{genMerger.disconnect();}catch(e){} genMerger=null; }
}
function drawGenScope(){
  const buf = new Uint8Array(genAnalyser.fftSize);
  const draw = ()=>{
    genRAF = requestAnimationFrame(draw);
    genAnalyser.getByteTimeDomainData(buf);
    const W = genScope.width = genScope.clientWidth * devicePixelRatio;
    const H = genScope.height = genScope.clientHeight * devicePixelRatio;
    gctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    gctx.fillStyle = '#0c131f'; gctx.fillRect(0,0,W,H);
    gctx.lineWidth = 2; gctx.strokeStyle = '#9cff8b';
    gctx.beginPath();
    const slice = W / buf.length;
    let x=0;
    for(let i=0;i<buf.length;i++){
      const y = (buf[i]/128.0)*H/2;
      if(i===0) gctx.moveTo(x,y); else gctx.lineTo(x,y);
      x += slice;
    }
    gctx.stroke();
  };
  draw();
}

// realtime updates
[fFreq,fWave,fBin,fHar,fLvl,fDuty].forEach(el=>{
  el.addEventListener('input', ()=>{
    if(genOscL||genOscR){
      startGenerator(); // simple restart apply
    }
  });
});
genPlayBtn.onclick = ()=>{ startGenerator(); };
genStopBtn.onclick = ()=>{ stopGenerator(); };
genSweepBtn.onclick = ()=>{
  genEnsure();
  const start = 40, end = 1200, dur = 8; // sec
  stopGenerator();
  const wave = fWave.value;
  const lvl  = parseFloat(fLvl.value)||0.6;
  const now = genCtx.currentTime;

  const osc = genCtx.createOscillator();
  const g   = genCtx.createGain();
  osc.type = wave;
  osc.frequency.setValueAtTime(start, now);
  osc.frequency.exponentialRampToValueAtTime(end, now + dur);
  g.gain.value = lvl;
  osc.connect(g).connect(genGain).connect(genCtx.destination);
  osc.start();
  setTimeout(()=>{ try{osc.stop();}catch(e){} }, dur*1000);
};

/** =========================
 *  6) HELPERS
 *  ========================= */
async function headOk(url){
  try{
    const r = await fetch(url, {method:'HEAD', cache:'no-store'});
    return r.ok;
  }catch(e){ return false; }
}

/** =========================
 *  7) INIT
 *  ========================= */
(async function init(){
  // volume init
  // gainNode is created on unlock; set value when ready after unlock or on first play
  vol.dispatchEvent(new Event('input'));
  await listRoot();
})();
</script>
</body>
</html>
