<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>5DO Pro v15 STABLE</title>
<style>
:root{
  --bg:#0a0f1a;
  --card:#0f1524;
  --line:#2a3044;
  --text:#e7efff;
  --muted:#a7b3d6;
  --accent1:#8E6BFF; /* violet */
  --accent2:#52FFE0; /* aqua */
  --glow: 0 0 12px rgba(142,107,255,.35), 0 0 18px rgba(82,255,224,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:radial-gradient(1200px 700px at 10% -10%, rgba(142,107,255,.06), transparent),
                    radial-gradient(800px 600px at 110% 20%, rgba(82,255,224,.06), transparent),
                    var(--bg);
  color:var(--text); font: 14px/1.4 system-ui, -apple-system, "Helvetica Neue", Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans CJK KR", sans-serif;
}

/* header */
header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:10px 14px;gap:10px;border-bottom:1px solid var(--line);background:rgba(8,12,20,.5);backdrop-filter:blur(8px);position:sticky;top:0;z-index:20}
.left-pack{display:flex;align-items:center;gap:12px}
.app-title{font-weight:700;letter-spacing:.4px;font-size:18px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text;background-clip:text;color:transparent;
  text-shadow:0 0 24px rgba(142,107,255,.25);
}
.tabs{justify-self:center;display:flex;gap:10px;transform:translateX(30px);} /* +30px total */
.tab{border:1px solid var(--line);background:var(--card);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
.tab.active{border-color:rgba(142,107,255,.6);box-shadow:var(--glow)}
.right-pack{justify-self:end;display:flex;align-items:center;gap:8px}
.pill{border:1px solid var(--line);background:var(--card);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}

/* layout sections */
main{max-width:1100px;margin:0 auto;padding:16px}
section{display:none}
section.active{display:block}

/* cards & fields */
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.03)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
label{color:var(--muted);font-size:13px}

/* audio/visual */
audio{width:100%}
.visual-wrap{margin-top:12px;border:1px dashed var(--line);border-radius:12px;height:120px;display:flex;align-items:center;justify-content:center;color:#7f8ab2}
canvas{width:100%;height:100%}

/* generator controls */
.ctrlbar{display:grid;grid-template-columns:52px 52px 52px 1fr;gap:10px;align-items:center;margin-top:8px}
.icon-btn{display:flex;align-items:center;justify-content:center;height:52px;width:52px;border-radius:14px;border:1px solid rgba(120,180,200,.22);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.08));
           box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 0 0 0 rgba(142,107,255,0); cursor:pointer; transition:.2s transform, .2s box-shadow}
.icon{width:26px;height:26px;stroke:#d9f7f0;fill:none;stroke-width:2;opacity:.95}
.icon-btn:hover{transform:scale(1.03); box-shadow: var(--glow)}
.icon-btn.active{animation:breath 3s ease-in-out infinite}
@keyframes breath{
  0%{box-shadow:0 0 0 rgba(0,0,0,0)}
  50%{box-shadow:0 0 14px rgba(142,107,255,.18), 0 0 22px rgba(82,255,224,.16)}
  100%{box-shadow:0 0 0 rgba(0,0,0,0)}
}
.preset-select{height:52px;border-radius:14px;border:1px solid rgba(120,180,200,.22);background:var(--card);color:var(--text);padding:0 12px}

/* sliders */
input[type="range"]{accent-color:#7fe9da}

/* Mobile quick actions under Library player */
.quick-actions{display:flex;gap:10px;margin:10px 0 0;flex-wrap:wrap}
.mobile-only{display:none}
@media (max-width: 768px){
  .mobile-only{display:flex}
  .toolbar .pill{display:none}
  .row{grid-template-columns:1fr}
}

/* Modal for Playlist */
#plModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
#plSheet{width:min(680px,94vw);max-height:80vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 24px 64px rgba(0,0,0,.5);padding:16px}
#plHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
#plHeader h3{margin:0;font-size:1.05rem;color:var(--text)}
#plClose{background:transparent;border:0;color:#9fb7ff;font-size:20px;cursor:pointer}
#plGrid{display:grid;grid-template-columns: 1fr 1fr; gap:14px}
#plLeft, #plRight{border:1px solid var(--line);border-radius:12px;padding:12px;min-height:220px;background:#0f172a}
#plLeft h4, #plRight h4{margin:0 0 8px;color:#dfe7f6;font-size:.95rem}
.pl-row{display:flex;align-items:center;gap:8px;margin:6px 0}
.pl-row input[type="text"]{flex:1;min-width:0;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:var(--card);color:#dfe7f6}
.pl-btn{height:34px;padding:0 10px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:#dfe7f6;cursor:pointer}
.pl-btn:hover{filter:brightness(1.06)}
.pl-list{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto}
.pl-item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:var(--card);color:#cfead1}
.pl-item .act{display:flex;gap:6px}
.small{font-size:.82rem;opacity:.75}
.truncate{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
<header>
  <div class="left-pack">
    <div class="app-title">5DO Pro</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-target="lib">5DO</button>
    <button class="tab" data-target="gen">Freq. Gen.</button>
  </div>

  <div class="right-pack">
    <button id="langToggle" class="pill" title="EN/KO">KO</button>
  </div>
</header>

<main>
  <!-- Library -->
  <section id="lib" class="active">
    <div class="card">
      <div class="toolbar" style="display:flex;gap:10px;margin-bottom:10px">
        <button id="loopBtn" class="pill">Loop</button>
        <button id="timerBtn" class="pill">Timer</button>
        <button id="playlistBtn" class="pill">Playlist</button>
      </div>
      <audio id="player" controls crossorigin="anonymous"></audio>
      <div id="qaBar" class="quick-actions mobile-only">
        <button id="loopBtnM" class="pill">Loop</button>
        <button id="timerBtnM" class="pill">Timer</button>
        <button id="playlistBtnM" class="pill">Playlist</button>
      </div>
      <div class="visual-wrap"><span>Visualizer (Library)</span><canvas id="viz"></canvas></div>
    </div>
  </section>

  <!-- Generator -->
  <section id="gen">
    <div class="card">
      <div class="row">
        <div class="field">
          <label id="lblFreq" for="genFreq">Frequency (Hz)</label>
          <input id="genFreq" type="number" value="432" min="1" max="20000" step="0.1"/>
        </div>
        <div class="field">
          <label id="lblWave" for="genWave">Waveform</label>
          <select id="genWave">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Sawtooth</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label id="lblBB">Binaural <input id="genBinaural" type="checkbox" style="margin-left:8px;vertical-align:middle"></label>
          <label id="lblBBdiff" for="genBeat">Difference (Hz)</label>
          <input id="genBeat" type="number" value="7" step="0.1" min="0" max="100">
        </div>
        <div class="field">
          <label id="lblHarmonics" for="genHarmonics">Harmonics</label>
          <input id="genHarmonics" type="text" value="1" placeholder="e.g. 0.5,2,3">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label id="lblLevel" for="genLevel">Level</label>
          <input id="genLevel" type="range" value="50" min="0" max="100">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="gen-actions ctrlbar">
            <button id="genToggle" class="icon-btn" title="Play/Pause" aria-label="Play/Pause">
              <svg class="icon" viewBox="0 0 24 24"><polygon points="8,5 8,19 19,12" stroke-linejoin="round"/></svg>
            </button>
            <button id="btnSavePreset" class="icon-btn" title="Save Preset" aria-label="Save">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M12 3v10m0 0l-4-4m4 4l4-4"/>
                <rect x="5" y="15" width="14" height="6" rx="1"/>
              </svg>
            </button>
            <button id="btnDeletePreset" class="icon-btn" title="Delete Preset" aria-label="Delete">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M6 7h12M9 7v11m6-11v11M5 7l1 14h12l1-14M9 4h6l1 3H8z"/>
              </svg>
            </button>
            <select id="presetSelect" class="preset-select"><option value="">Select Preset</option></select>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Playlist Modal -->
<div id="plModal">
  <div id="plSheet">
    <div id="plHeader">
      <h3>Playlists</h3>
      <button id="plClose" aria-label="Close">✕</button>
    </div>
    <div id="plGrid">
      <div id="plLeft">
        <h4>Manage</h4>
        <div class="pl-row">
          <input id="plNewName" type="text" placeholder="New playlist name">
          <button id="plNewBtn" class="pl-btn">New</button>
        </div>
        <div class="pl-row">
          <select id="plSelect" class="preset-select" style="flex:1"></select>
          <button id="plRenameBtn" class="pl-btn">Rename</button>
          <button id="plDeleteBtn" class="pl-btn">Delete</button>
        </div>
        <div class="pl-list" id="plList"></div>
      </div>
      <div id="plRight">
        <h4>Add / Load</h4>
        <div class="pl-row">
          <button id="plAddCurrent" class="pl-btn">Add Playing</button>
          <button id="plAddAll" class="pl-btn">Add All Visible</button>
        </div>
        <div class="pl-row">
          <button id="plLoad" class="pl-btn" style="flex:1">Load Playlist to Player Queue</button>
        </div>
        <div class="small">Tip: “Add All Visible”는 현재 보이는 카드들을 순서대로 플레이리스트에 추가합니다.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Global State & i18n ===== */
window.lang = 'ko'; // default KO per your app
const I18N = {
  en: {
    tabs:{lib:'5DO', gen:'Freq. Gen.'},
    loopOff:'Loop: Off', loopOn:'Loop: On', loop:'Loop', timer:'Timer', playlist:'Playlist',
    frequency:'Frequency (Hz)', waveform:'Waveform', binaural:'Binaural', difference:'Difference (Hz)', harmonics:'Harmonics', level:'Level',
    ppTooltip:'Play/Pause', saveTip:'Save Preset', delTip:'Delete Preset', selectPreset:'Select Preset',
    playlists:'Playlists', manage:'Manage', newName:'New playlist name', new:'New', rename:'Rename', delete:'Delete',
    addLoad:'Add / Load', addPlaying:'Add Playing', addAll:'Add All Visible', loadToQueue:'Load Playlist to Player Queue',
    tip:'Tip: “Add All Visible” adds visible cards in order.',
    sleepAsk:'Sleep timer (minutes)?', timerSet:'Timer set'
  },
  ko: {
    tabs:{lib:'5DO', gen:'주파수 생성기'},
    loopOff:'루프: 꺼짐', loopOn:'루프: 켜짐', loop:'루프', timer:'타이머', playlist:'플레이리스트',
    frequency:'주파수 (Hz)', waveform:'파형', binaural:'바이노럴', difference:'차이 (Hz)', harmonics:'배음', level:'레벨',
    ppTooltip:'재생/일시정지', saveTip:'프리셋 저장', delTip:'프리셋 삭제', selectPreset:'프리셋 선택',
    playlists:'플레이리스트', manage:'관리', newName:'새 플레이리스트 이름', new:'새로 만들기', rename:'이름 변경', delete:'삭제',
    addLoad:'추가 / 로드', addPlaying:'현재 재생 추가', addAll:'보이는 항목 모두 추가', loadToQueue:'플레이리스트를 큐로 로드',
    tip:'팁: “보이는 항목 모두 추가”는 그리드에 보이는 카드들을 순서대로 추가합니다.',
    sleepAsk:'수면 타이머 (분)?', timerSet:'타이머 설정됨'
  }
};

function t(key){
  const L = I18N[window.lang]||I18N.en;
  return key.split('.').reduce((o,k)=>o&&o[k], L) || key;
}

function applyLang(){
  // Tabs text
  document.querySelector('[data-target="lib"]').textContent = t('tabs.lib');
  document.querySelector('[data-target="gen"]').textContent = t('tabs.gen');
  // Library buttons (desktop + mobile)
  const setLoopText = (btn, looping)=>{ if(!btn) return; btn.textContent = looping? t('loopOn') : t('loopOff'); };
  const player = document.getElementById('player');
  setLoopText(document.getElementById('loopBtn'), player?.loop);
  setLoopText(document.getElementById('loopBtnM'), player?.loop);
  const setText=(id,key)=>{ const el=document.getElementById(id); if(el) el.textContent=t(key); };
  setText('timerBtn','timer'); setText('playlistBtn','playlist');
  setText('timerBtnM','timer'); setText('playlistBtnM','playlist');

  // Generator labels
  const set = (id,key)=>{ const el=document.getElementById(id); if(el) el.textContent=t(key); };
  set('lblFreq','frequency'); set('lblWave','waveform'); set('lblBB','binaural'); set('lblBBdiff','difference');
  set('lblHarmonics','harmonics'); set('lblLevel','level');
  // Tooltips
  const pp=document.getElementById('genToggle'); if(pp){ pp.title=t('ppTooltip'); pp.setAttribute('aria-label',t('ppTooltip')); }
  const sv=document.getElementById('btnSavePreset'); if(sv){ sv.title=t('saveTip'); sv.setAttribute('aria-label',t('saveTip')); }
  const dl=document.getElementById('btnDeletePreset'); if(dl){ dl.title=t('delTip'); dl.setAttribute('aria-label',t('delTip')); }
  // Preset placeholder
  const sel=document.getElementById('presetSelect'); if(sel && sel.options[0]) sel.options[0].textContent = t('selectPreset');

  // Playlist modal texts
  const qs=(s)=>document.querySelector(s);
  qs('#plHeader h3').textContent = t('playlists');
  qs('#plLeft h4').textContent = t('manage');
  document.getElementById('plNewName').placeholder = t('newName');
  document.getElementById('plNewBtn').textContent = t('new');
  document.getElementById('plRenameBtn').textContent = t('rename');
  document.getElementById('plDeleteBtn').textContent = t('delete');
  qs('#plRight h4').textContent = t('addLoad');
  document.getElementById('plAddCurrent').textContent = t('addPlaying');
  document.getElementById('plAddAll').textContent = t('addAll');
  document.getElementById('plLoad').textContent = t('loadToQueue');
  qs('#plRight .small').textContent = t('tip');
}

/* ===== Header interactions ===== */
document.getElementById('langToggle').addEventListener('click', ()=>{
  window.lang = (window.lang==='en') ? 'ko' : 'en';
  applyLang();
});

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const target = e.currentTarget.dataset.target;
    document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
    document.getElementById(target).classList.add('active');
    // visualizer: hide on gen
    const vw = document.querySelector('.visual-wrap');
    if(vw){ vw.style.display = (target==='gen') ? 'none' : ''; }
  });
});

/* ===== Library basic queue & visualizer ===== */
const audio = document.getElementById('player');
let ctx, analyser, vsrc;
function ensureLibCtx(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = ctx.createAnalyser(); analyser.fftSize = 1024;
  vsrc = ctx.createMediaElementSource(audio);
  vsrc.connect(analyser); analyser.connect(ctx.destination);
}
audio.addEventListener('play', ()=>{ ensureLibCtx(); ctx.resume(); });
audio.addEventListener('ended', ()=>{
  if(window._libPlaylist && window._libPlaylist.length){
    const next = (window._libIndex||0) + 1;
    if(next < window._libPlaylist.length) window.playAt(next);
  }
});

const loopBtn = document.getElementById('loopBtn');
const loopBtnM = document.getElementById('loopBtnM');
function syncLoopText(){ 
  const looping = !!audio.loop;
  if(loopBtn) loopBtn.textContent = looping? t('loopOn') : t('loopOff');
  if(loopBtnM) loopBtnM.textContent = looping? t('loopOn') : t('loopOff');
}
[loopBtn, loopBtnM].forEach(btn=> btn && btn.addEventListener('click', ()=>{ audio.loop = !audio.loop; syncLoopText(); }));

const timerBtn = document.getElementById('timerBtn');
const timerBtnM = document.getElementById('timerBtnM');
[timerBtn, timerBtnM].forEach(btn=> btn && btn.addEventListener('click', ()=>{
  const mins = parseFloat(prompt(t('sleepAsk'),'20')||'0');
  if(mins>0){ setTimeout(()=>{ try{ audio.pause(); }catch(e){} }, mins*60000); alert(t('timerSet')); }
}));

// Playlist modal wiring
const plModal = document.getElementById('plModal');
const plOpen = document.getElementById('playlistBtn');
const plOpenM = document.getElementById('playlistBtnM');
const plClose = document.getElementById('plClose');
[plOpen, plOpenM].forEach(b=> b && b.addEventListener('click', ()=>{ plModal.style.display='flex'; }));
plClose.addEventListener('click', ()=> plModal.style.display='none');
plModal.addEventListener('click', (e)=>{ if(e.target===plModal) plModal.style.display='none'; });

/* ===== Unlimited Playlists (localStorage) ===== */
const PKEY='userPlaylists_v15';
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
function pdb(){ try{return JSON.parse(localStorage.getItem(PKEY)||'{}');}catch(e){return{}} }
function pset(db){ localStorage.setItem(PKEY, JSON.stringify(db)); }
function pnames(){ return Object.keys(pdb()); }
function ptracks(name){ return (pdb()[name]||[]) }
function psetTracks(name, arr){ const db=pdb(); db[name]=arr; pset(db); }
function padd(name, url, title){ const db=pdb(); if(!db[name]) db[name]=[]; db[name].push({url,title}); pset(db); }
function pren(oldn, newn){ const db=pdb(); if(!db[oldn]||db[newn]) return; db[newn]=db[oldn]; delete db[oldn]; pset(db); }
function pdel(name){ const db=pdb(); delete db[name]; pset(db); }

const plNewName=$('#plNewName'), plNewBtn=$('#plNewBtn'), plSelect=$('#plSelect'), plRenameBtn=$('#plRenameBtn'), plDeleteBtn=$('#plDeleteBtn'),
      plList=$('#plList'), plAddCurrent=$('#plAddCurrent'), plAddAll=$('#plAddAll'), plLoad=$('#plLoad');

function plRefresh(){
  if(!plSelect) return;
  const names=pnames().sort(); plSelect.innerHTML='';
  names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; plSelect.appendChild(o); });
  if(names[0]) plSelect.value = plSelect.value || names[0];
  plRenderList();
}
function plRenderList(){
  if(!plList) return; plList.innerHTML='';
  const name = plSelect.value; if(!name){ plList.innerHTML='<div class="small">No playlist</div>'; return; }
  const rows = ptracks(name);
  rows.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='pl-item';
    const left=document.createElement('div'); left.textContent = (t.title||'') + ' '; left.className='truncate';
    const right=document.createElement('div'); right.className='act';
    const up=document.createElement('button'); up.className='pl-btn'; up.textContent='↑';
    const down=document.createElement('button'); down.className='pl-btn'; down.textContent='↓';
    const del=document.createElement('button'); del.className='pl-btn'; del.textContent='✕';
    up.addEventListener('click', ()=>{ const arr=ptracks(name); if(i<=0) return; [arr[i-1],arr[i]]=[arr[i],arr[i-1]]; psetTracks(name,arr); plRenderList(); });
    down.addEventListener('click', ()=>{ const arr=ptracks(name); if(i>=arr.length-1) return; [arr[i+1],arr[i],]=[arr[i],arr[i+1]]; psetTracks(name,arr); plRenderList(); });
    del.addEventListener('click', ()=>{ const arr=ptracks(name); arr.splice(i,1); psetTracks(name,arr); plRenderList(); });
    right.append(up,down,del); row.append(left,right); plList.appendChild(row);
  });
}
plNewBtn.addEventListener('click', ()=>{
  const name=(plNewName.value||'').trim(); if(!name) return;
  const db=pdb(); if(db[name]){ alert('이미 존재하는 이름입니다'); return; }
  db[name]=[]; pset(db); plNewName.value=''; plRefresh(); plSelect.value=name; plRenderList();
});
plRenameBtn.addEventListener('click', ()=>{
  const name=plSelect.value; if(!name) return;
  const next = prompt('새 이름', name); if(!next||next===name) return;
  const db=pdb(); if(db[next]){ alert('이미 존재하는 이름입니다'); return; }
  pren(name,next); plRefresh(); plSelect.value=next; plRenderList();
});
plDeleteBtn.addEventListener('click', ()=>{
  const name=plSelect.value; if(!name) return;
  if(!confirm(`'${name}' 삭제할까요?`)) return;
  pdel(name); plRefresh();
});
plSelect.addEventListener('change', plRenderList);
plAddCurrent.addEventListener('click', ()=>{
  const name=plSelect.value; if(!name) return;
  const curUrl = audio.currentSrc || audio.src; if(!curUrl){ alert('재생중인 항목이 없습니다'); return; }
  const title = document.querySelector('.now-title')?.textContent || curUrl.split('/').pop();
  padd(name, curUrl, title); plRenderList();
});
plAddAll.addEventListener('click', ()=>{
  const name=plSelect.value; if(!name) return;
  const cards = $$('.files .card'); // if present
  const tracks = cards.map(c=>({ url: c.getAttribute('data-url')||c.dataset.url||'', title: c.querySelector('.t')?.textContent||''})).filter(t=>t.url);
  const arr = ptracks(name).concat(tracks); psetTracks(name,arr); plRenderList();
});
plLoad.addEventListener('click', ()=>{
  const name=plSelect.value; if(!name) return;
  const rows=ptracks(name); if(!rows.length){ alert('플레이리스트가 비어 있습니다'); return; }
  window._libPlaylist = rows.map(r=>r.url);
  window._libIndex = -1;
  window.playAt = function(i){
    if(!_libPlaylist||!_libPlaylist.length) return;
    if(i<0||i>=_libPlaylist.length) return;
    _libIndex = i; audio.src = _libPlaylist[i];
    audio.play().catch(()=>{});
  };
  playAt(0); plModal.style.display='none';
});

/* ===== Generator Audio Engine ===== */
let gctx, masterGain, genNodes = {oscL:null, oscR:null, merger:null, analyser:null};
function ensureGenCtx(){
  if(!gctx) gctx = new (window.AudioContext||window.webkitAudioContext)();
  if(!masterGain){ masterGain = gctx.createGain(); masterGain.gain.value = (parseFloat(document.getElementById('genLevel').value||'50')/100); masterGain.connect(gctx.destination); }
  return gctx;
}

function stopGen(){
  try{ genNodes.oscL && genNodes.oscL.stop(); }catch(e){}
  try{ genNodes.oscR && genNodes.oscR.stop(); }catch(e){}
  genNodes.oscL = genNodes.oscR = null;
  if(genNodes.merger){ try{ genNodes.merger.disconnect(); }catch(e){} genNodes.merger=null; }
}

async function startGen(){
  const ctx = ensureGenCtx();
  if(ctx.state==='suspended') await ctx.resume();
  stopGen();

  const freq = parseFloat(document.getElementById('genFreq').value||'432');
  const wave = (document.getElementById('genWave').value||'sine').toLowerCase();
  const useBin = !!document.getElementById('genBinaural').checked;
  const beat = Math.max(0, parseFloat(document.getElementById('genBeat').value||'7'));
  const harm = (document.getElementById('genHarmonics').value||'1')
                 .split(',').map(s=>parseFloat(s.trim())).filter(n=>!isNaN(n)&&isFinite(n));

  const merger = ctx.createChannelMerger(2);
  merger.connect(masterGain);
  genNodes.merger = merger;

  function makeOsc(f, pan){ // pan: 0 = L, 1 = R to channel in merger
    const o = ctx.createOscillator();
    o.type = wave; o.frequency.value = f;
    const g = ctx.createGain(); g.gain.value = 0.9 / Math.max(1, harm.length);
    o.connect(g); g.connect(merger, 0, pan); o.start();
    return {o,g};
  }

  // base or binaural pair
  const baseL = useBin ? (freq - beat/2) : freq;
  const baseR = useBin ? (freq + beat/2) : freq;
  const bundleL = makeOsc(baseL, 0);
  genNodes.oscL = bundleL.o;

  if(useBin){
    const bundleR = makeOsc(baseR, 1);
    genNodes.oscR = bundleR.o;
  }else{
    // mono to both channels for richness
    const mono = ctx.createGain();
    bundleL.o.disconnect(); bundleL.o.connect(mono);
    mono.connect(genNodes.merger,0,0); mono.connect(genNodes.merger,0,1);
    genNodes.oscL = bundleL.o;
  }

  // simple harmonic add (ratio list multiplies base frequency)
  if(harm && harm.length>0){
    harm.forEach(r=>{
      if(!isFinite(r) || r===1) return;
      const hhL = makeOsc(baseL*r, 0);
      if(useBin){ const hhR = makeOsc(baseR*r, 1); }
    });
  }
}

/* Play/Pause Toggle */
const genToggle = document.getElementById('genToggle');
const svgPlay  = '<svg class="icon" viewBox="0 0 24 24"><polygon points="8,5 8,19 19,12" stroke-linejoin="round"/></svg>';
const svgPause = '<svg class="icon" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14" rx="1"/><rect x="14" y="5" width="4" height="14" rx="1"/></svg>';
let genPlaying = false;
function setGenIcon(){ genToggle.innerHTML = genPlaying ? svgPause : svgPlay; genToggle.classList.toggle('active', genPlaying); }
genToggle.addEventListener('click', async ()=>{
  if(!genPlaying){ await startGen(); genPlaying=true; setGenIcon(); }
  else{ stopGen(); genPlaying=false; setGenIcon(); }
});

/* Level slider -> masterGain */
document.getElementById('genLevel').addEventListener('input', (e)=>{
  ensureGenCtx(); masterGain.gain.value = (parseFloat(e.target.value||'50')/100);
});

/* Presets (names keep original language) */
const PKEY_GEN='genPresets_v15';
function gdb(){ try{return JSON.parse(localStorage.getItem(PKEY_GEN)||'[]')}catch(e){return[]} }
function gsave(arr){ localStorage.setItem(PKEY_GEN, JSON.stringify(arr.slice(0,10))); }
function gcurrent(){
  return {
    freq:document.getElementById('genFreq').value,
    wave:document.getElementById('genWave').value,
    bin:document.getElementById('genBinaural').checked,
    beat:document.getElementById('genBeat').value,
    harm:document.getElementById('genHarmonics').value,
    level:document.getElementById('genLevel').value
  };
}
function renderPresetList(){
  const sel=document.getElementById('presetSelect');
  sel.innerHTML='<option value="">'+t('selectPreset')+'</option>';
  gdb().forEach(p=>{ const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; sel.appendChild(o); });
}
document.getElementById('btnSavePreset').addEventListener('click', ()=>{
  const name = prompt(window.lang==='en'?'Preset name':'프리셋 이름'); if(!name) return;
  const arr = gdb().filter(p=>p.name!==name); arr.unshift({name, data:gcurrent()}); gsave(arr); renderPresetList();
  alert(window.lang==='en'?'Preset saved':'프리셋 저장됨');
});
document.getElementById('btnDeletePreset').addEventListener('click', ()=>{
  const sel=document.getElementById('presetSelect'); if(!sel.value) return;
  gsave(gdb().filter(p=>p.name!==sel.value)); renderPresetList();
});
document.getElementById('presetSelect').addEventListener('change', ()=>{
  const name = document.getElementById('presetSelect').value; if(!name) return;
  const f = gdb().find(p=>p.name===name); if(!f) return;
  const d=f.data||{};
  document.getElementById('genFreq').value=d.freq||'432';
  document.getElementById('genWave').value=d.wave||'sine';
  document.getElementById('genBinaural').checked=!!d.bin;
  document.getElementById('genBeat').value=d.beat||'7';
  document.getElementById('genHarmonics').value=d.harm||'1';
  document.getElementById('genLevel').value=d.level||'50';
});

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  applyLang();
  plRefresh();
  renderPresetList();
  syncLoopText();
});
</script>
</body>
</html>
