<!doctype html>
<html lang="ko">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Pro</title>
<style>
:root{
  --bg:#0a0f14; --panel:#0e1520; --line:#122033; --muted:#7e9ab5; --txt:#e8f2ff;
  --accent:#8fe8ff; --accent2:#39e3ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Arial,sans-serif}

/* Header */
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0a1018,#0a0f14 60%);
  border-bottom:1px solid #0f1b2a;padding:8px 10px}
.header-row{display:flex;align-items:center;gap:10px;justify-content:space-between;max-width:1120px;margin:0 auto;position:relative}
.left{display:flex;align-items:center;gap:10px}
.center-tabs{position:absolute;left:calc(50% + 10px);transform:translateX(-50%);display:flex;align-items:center;gap:8px}
.right{margin-left:auto;display:flex;align-items:center;gap:10px}
.app-title{
  font-weight:700;font-size:18px;letter-spacing:.3px;color:#9fe5ff;
  text-shadow:0 0 3px rgba(180,240,255,1),0 0 8px rgba(110,220,255,.95),0 0 18px rgba(50,180,255,.85),0 0 36px rgba(0,120,255,.7);
  white-space:nowrap;
}
@media (max-width:420px){ .center-tabs{ gap:6px } .app-title{ font-size:16px } }

/* Buttons */
button,.btn{background:#0f1a28;border:1px solid #13263c;color:var(--txt);padding:8px 10px;border-radius:8px;cursor:pointer}
button:hover,.btn:hover{border-color:#1a3f64}
button.small{padding:6px 8px;border-radius:7px;font-size:12px}
button.ghost{background:transparent;border-color:#17314f}
button.accent{background:#0d1e2f;border-color:#1d415f;box-shadow:0 0 8px rgba(57,227,255,.15) inset}

/* Hamburger */
.hamburger{width:36px;height:28px;position:relative;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.hamburger span,.hamburger span:before,.hamburger span:after{
  content:"";display:block;width:20px;height:2px;background:#8fe8ff;box-shadow:0 0 6px rgba(110,220,255,.95),0 0 14px rgba(50,180,255,.85);
  position:absolute;border-radius:2px;transition:.2s
}
.hamburger span:before{transform:translateY(-6px)}
.hamburger span:after{transform:translateY(6px)}
.dropdown{position:absolute;top:42px;left:6px;background:var(--panel);border:1px solid var(--line);border-radius:10px;display:none;min-width:220px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.dropdown a{display:block;padding:10px 12px;color:var(--txt);text-decoration:none;border-bottom:1px solid #0f1b2a}
.dropdown a:last-child{border-bottom:0}
.dropdown a:hover{background:#0f1825}

/* Tabs */
.tab{padding:7px 10px;border-radius:8px;border:1px solid #17314f;background:#0b1724;color:#cfe9ff}
.tab.active{background:#0d1e2f;border-color:#1d415f;box-shadow:0 0 8px rgba(57,227,255,.15) inset}

main{max-width:1120px;margin:10px auto 40px;padding:0 10px}
.section{display:none}
.section.active{display:block}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}

/* Library strip (horizontal scroll) */
.strip{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
.card{flex:0 0 128px;display:flex;flex-direction:column;background:#0b131e;border:1px solid #102035;border-radius:14px;overflow:hidden;cursor:pointer;scroll-snap-align:start}
.thumb{width:100%;height:128px;background:#0a1018;background-size:cover;background-position:center;border-bottom:1px solid #0f1b2a}
.label{padding:8px 9px;color:#cae4ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Status / Player */
.status{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
#statusThumb{width:84px;height:84px;border:1px solid #14253b;border-radius:12px;background:#0b1018;background-size:cover;background-position:center}
.status-blank{
  background:#0b1019;
  background-image:
    radial-gradient(60% 40% at 50% 0%, rgba(90,210,255,.08), rgba(0,0,0,0)),
    radial-gradient(70% 60% at 50% 100%, rgba(0,120,255,.06), rgba(0,0,0,0));
}
.playerbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.playerbar .controls{display:flex;align-items:center;gap:8px}

/* Nav row */
.nav-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
#breadcrumb{display:none!important}

/* Oscilloscope */
.osc-hdr{display:flex;align-items:center;gap:12px;margin:8px 0}
#osc{width:100%;height:160px;border:1px solid rgba(255,255,255,.1);border-radius:8px;background:#02070d}

/* Modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:100}
.modal{position:fixed;inset:auto 0 0 0;margin:auto;top:8%;max-width:720px;background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:none;z-index:101;padding:16px}
.modal .mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.modal .mbody{max-height:60vh;overflow:auto;white-space:pre-wrap;color:#cfe6ff}

/* Visibility by mode */
body.mode-library #oscWrap{display:none!important}

/* Title keep one line on small screens */
@media (max-width:390px){ .center-tabs{ left:calc(58%) } }
</style>
</head>
<body class="mode-library">
<header>
  <div class="header-row">
    <div class="left">
      <div class="menu">
        <div id="menuBtn" class="hamburger"><span></span></div>
        <div id="menuDrop" class="dropdown">
          <a href="texts/faq.txt"     class="menu-text" data-key="faq">FAQ</a>
          <a href="texts/manual.txt"  class="menu-text" data-key="manual">Manual</a>
          <a href="texts/contact.txt" class="menu-text" data-key="contact">Contact</a>
          <a href="texts/about.txt"   class="menu-text" data-key="about">About</a>
          <a href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop ↗</a>
        </div>
      </div>
      <div class="app-title">5DO Pro</div>
    </div>

    <div class="center-tabs">
      <button class="tab active" id="tabLibrary" data-tab-btn="library">Library</button>
      <button class="tab" id="tabGenerator" data-tab-btn="generator">Generator</button>
    </div>

    <div class="right">
      <button id="langBtn" class="btn small">한국어</button>
    </div>
  </div>
</header>

<main>
  <!-- Library -->
  <section id="library" class="section active">
    <div class="panel">
      <div class="nav-row">
        <button id="btnBack" class="btn small">←</button>
        <button id="btnHome" class="btn small">Home</button>
        <button id="btnRefresh" class="btn small">⟳</button>
        <div id="breadcrumb">/</div>
      </div>
      <div class="strip" id="strip"></div>
    </div>

    <div class="panel">
      <div class="status">
        <div id="statusThumb" class="status-blank"></div>
        <div class="playerbar">
          <audio id="player" controls playsinline webkit-playsinline preload="metadata" style="min-width:260px;max-width:80%"></audio>
          <div class="controls">
            <button id="btnPlay"  class="btn small accent" data-i18n="playpause">Play/Pause</button>
            <button id="btnLoop"  class="btn small" data-i18n="loopOff">Loop: Off</button>
            <button id="btnTimer" class="btn small" data-i18n="timer">Timer</button>
          </div>
          <div class="controls">
            <label style="color:#b8d1ea">Playlist</label>
            <div id="playlist" class="strip" style="gap:6px;overflow-y:hidden"></div>
            <button id="btnAddPL"  class="btn small" data-i18n="new">+ New</button>
            <button id="btnSavePL" class="btn small" data-i18n="save">Save</button>
            <button id="btnLoadPL" class="btn small" data-i18n="load">Load</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Generator -->
  <section id="generator" class="section">
    <div class="panel">
      <div class="row" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <label data-i18n="waveform">Waveform</label>
        <select id="waveSel">
          <option value="sine">Sine</option>
          <option value="triangle">Triangle</option>
          <option value="sawtooth">Sawtooth</option>
          <option value="square">Square</option>
          <option value="pulse">Pulse</option>
        </select>

        <label data-i18n="frequency" style="margin-left:10px">Frequency (Hz)</label>
        <input id="freqNum" type="number" value="440" min="1" max="20000" step="1" style="width:120px">
        <input id="freqSlider" type="range" min="1" max="20000" step="1" style="flex:1;min-width:220px">
      </div>

      <!-- Duty 항상 노출 -->
      <div class="row" id="dutyRow" style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <label data-i18n="duty">Duty</label>
        <input id="duty" type="range" min="5" max="95" step="1" value="50" style="flex:1;min-width:220px">
      </div>

      <div class="row" style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <label>Binaural</label>
        <input id="bnEnable" type="checkbox" style="transform:translateY(1px)">
        <label data-i18n="difference" style="margin-left:10px">Difference (Hz)</label>
        <input id="bnDiff" type="number" value="4" min="1" max="100" step="1" style="width:80px">
      </div>

      <div id="oscWrap" class="panel" style="margin-top:12px">
        <div class="osc-hdr">
          <label data-i18n="osc">Oscilloscope</label>
          <input id="oscColor" type="color" value="#39e3ff" title="Wave Color">
          <label data-i18n="zoom">Zoom x</label>
          <select id="oscZoom"><option>1</option><option selected>2</option><option>3</option></select>
        </div>
        <canvas id="osc"></canvas>
      </div>

      <div class="row" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="genPlay" class="btn accent" data-i18n="playpause">Play/Pause</button>
        <button id="genStop" class="btn" data-i18n="stop">Stop</button>
        <button id="genSave" class="btn" data-i18n="savePreset">Save Preset</button>
        <button id="genLoad" class="btn" data-i18n="loadPreset">Load Preset</button>
      </div>
    </div>
  </section>
</main>

<!-- Backdrop & Dropdown -->
<div class="backdrop" id="backdrop"></div>

<!-- Modal -->
<div class="modal-back" id="modalBack"></div>
<div class="modal" id="modal">
  <div class="mhead">
    <div id="modalTitle">Info</div>
    <button id="modalClose" class="btn small">✕</button>
  </div>
  <div id="modalBody" class="mbody">…</div>
</div>

<script>
/* ===== Supabase public media base ===== */
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";

/* ====== Globals / i18n ====== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
let LANG=(document.documentElement.lang||'ko').toLowerCase().startsWith('en')?'en':'ko';

const I18N={
  ko:{library:'라이브러리',generator:'주파수 생성기',waveform:'파형',frequency:'주파수 (Hz)',duty:'듀티',difference:'차이 (Hz)',osc:'오실로스코프',zoom:'줌',
      noTrack:'선곡되지 않음',ready:'재생 준비됨',loopOn:'루프: 켬',loopOff:'루프: 끔',timer:'타이머',playpause:'재생/일시정지',stop:'정지',
      new:'+ 새로 만들기',save:'저장',load:'불러오기',savePreset:'프리셋 저장',loadPreset:'프리셋 불러오기',home:'홈',back:'뒤로',refresh:'새로고침'},
  en:{library:'Library',generator:'Generator',waveform:'Waveform',frequency:'Frequency (Hz)',duty:'Duty',difference:'Difference (Hz)',osc:'Oscilloscope',zoom:'Zoom',
      noTrack:'No track loaded',ready:'Ready to play',loopOn:'Loop: On',loopOff:'Loop: Off',timer:'Timer',playpause:'Play/Pause',stop:'Stop',
      new:'+ New',save:'Save',load:'Load',savePreset:'Save Preset',loadPreset:'Load Preset',home:'Home',back:'Back',refresh:'Refresh'}
};
function t(k){return I18N[LANG][k]||k;}
function applyLang(){
  $('#tabLibrary').textContent=t('library'); $('#tabGenerator').textContent=t('generator');
  $$('[data-i18n="waveform"]').forEach(n=>n.textContent=t('waveform'));
  $$('[data-i18n="frequency"]').forEach(n=>n.textContent=t('frequency'));
  $$('[data-i18n="duty"]').forEach(n=>n.textContent=t('duty'));
  $$('[data-i18n="difference"]').forEach(n=>n.textContent=t('difference'));
  $$('[data-i18n="osc"]').forEach(n=>n.textContent=t('osc'));
  $$('[data-i18n="zoom"]').forEach(n=>n.textContent=t('zoom'));
  $$('[data-i18n="playpause"]').forEach(n=>n.textContent=t('playpause'));
  $$('[data-i18n="stop"]').forEach(n=>n.textContent=t('stop'));
  $$('[data-i18n="new"]').forEach(n=>n.textContent=t('new'));
  $$('[data-i18n="save"]').forEach(n=>n.textContent=t('save'));
  $$('[data-i18n="load"]').forEach(n=>n.textContent=t('load'));
  $$('[data-i18n="savePreset"]').forEach(n=>n.textContent=t('savePreset'));
  $$('[data-i18n="loadPreset"]').forEach(n=>n.textContent=t('loadPreset'));
  $('#btnHome').textContent=t('home'); $('#btnBack').textContent='←'; $('#btnRefresh').textContent='⟳';
  $('#btnLoop').textContent=loop? t('loopOn'):t('loopOff'); $('#btnTimer').textContent=t('timer');
  $('#langBtn').textContent=(LANG==='en'?'English':'한국어');
  if(!STATE.currentTrack){ $('#statusText')?.remove(); const st=$('#statusThumb'); const s=document.createElement('div'); s.id='statusText'; st.parentElement.appendChild(s); s.textContent=t('noTrack'); }
}

/* ====== Hamburger & Modal ====== */
const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop'), backdrop=$('#backdrop');
function closeMenu(){ menuDrop.style.display='none'; backdrop.classList.remove('show'); }
menuBtn.addEventListener('click',()=>{ menuDrop.style.display= menuDrop.style.display==='block'?'none':'block'; if(menuDrop.style.display==='block') backdrop.classList.add('show'); else backdrop.classList.remove('show');});
backdrop.addEventListener('click',closeMenu);

const mBack=$('#modalBack'), modal=$('#modal'), mTitle=$('#modalTitle'), mBody=$('#modalBody'), mClose=$('#modalClose');
function showModal(title, text){ mTitle.textContent=title; mBody.textContent=text; mBack.style.display='block'; modal.style.display='block'; }
function hideModal(){ mBack.style.display='none'; modal.style.display='none'; }
mClose.addEventListener('click', hideModal); mBack.addEventListener('click', hideModal);

$$('.menu-text').forEach(a=>{
  a.addEventListener('click', async (e)=>{
    e.preventDefault(); closeMenu();
    const href=a.getAttribute('href');
    try{ const r=await fetch(href,{cache:'no-store'}); const txt=await r.text(); showModal(a.textContent.trim(), txt); }
    catch(_){ showModal(a.textContent.trim(), LANG==='en'?'Failed to load.':'불러올 수 없습니다.'); }
  });
});

/* ====== Tabs ====== */
const tabLibrary=$('#tabLibrary'), tabGenerator=$('#tabGenerator');
const secLibrary=$('#library'), secGenerator=$('#generator');
function setTab(name){
  if(name==='generator'){
    tabGenerator.classList.add('active');tabLibrary.classList.remove('active');
    secGenerator.classList.add('active');secLibrary.classList.remove('active');
    document.body.classList.add('mode-generator');document.body.classList.remove('mode-library');
  }else{
    tabLibrary.classList.add('active');tabGenerator.classList.remove('active');
    secLibrary.classList.add('active');secGenerator.classList.remove('active');
    document.body.classList.add('mode-library');document.body.classList.remove('mode-generator');
  }
}
tabLibrary.addEventListener('click',()=>setTab('library'));
tabGenerator.addEventListener('click',()=>setTab('generator'));

/* ====== Supabase URL helpers ====== */
function folderUrl(path){ return `${MEDIA_BASE}/${encodeURIComponent(path)}`; }
function trackUrl(path, file){ return `${MEDIA_BASE}/${encodeURIComponent(path)}/${encodeURIComponent(file)}`; }

/* ---------- Image ping 기반 썸네일 로더 ---------- */
function probeImage(url){
  return new Promise((resolve)=> {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=> resolve(url);
    img.onerror = ()=> resolve(null);
    img.src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(); // cache-bust
  });
}
async function pickFirstExisting(urls){
  for(const u of urls){
    const ok = await probeImage(u);
    if (ok) return ok;
  }
  return null;
}
function buildBasePath(path){ return `${MEDIA_BASE}/${encodeURIComponent(path)}/`; }
async function resolveTrackThumb(path, stem){
  const base = buildBasePath(path);
  const cand = (LANG==='en')
    ? [`${base}${encodeURIComponent(stem)}_E.jpg`,
       `${base}${encodeURIComponent(stem)}_E.JPG`,
       `${base}${encodeURIComponent(stem)}_E.jpeg`]
    : [`${base}${encodeURIComponent(stem)}.jpg`,
       `${base}${encodeURIComponent(stem)}.JPG`,
       `${base}${encodeURIComponent(stem)}.jpeg`];
  return await pickFirstExisting(cand);
}
async function resolveFolderThumb(path){
  const base = buildBasePath(path);
  const names = (LANG==='en')
    ? ['folder_e.jpg','folder_e.JPG','folder_e.jpeg']
    : ['folder.jpg','folder.JPG','folder.jpeg'];
  return await pickFirstExisting(names.map(n => base + encodeURIComponent(n)));
}
async function setStatusThumbAsync(path, stem){
  const st = document.getElementById('statusThumb');
  const url = await resolveTrackThumb(path, stem);
  if (url){
    st.classList.remove('status-blank');
    st.style.backgroundImage = `url("${url}")`;
    let s = st.parentElement.querySelector('#statusText');
    if(!s){ s=document.createElement('div'); s.id='statusText'; st.parentElement.appendChild(s); }
    s.textContent = t('ready');
  } else {
    statusBlank();
  }
}


// ========= Supabase client =========
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";   // ← 퍼블릭 anon 키
const BUCKET = "media";

const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const MEDIA_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}`;

// ========= 상태 =========
const STATE = { path: '', stack: [], currentTrack: null, playlistName: (LANG==='en'?'Default':'기본'), playlists:{} };
const strip = document.getElementById('strip');
const PLAYER = document.getElementById('player');

// ========= 유틸 =========
const isAudio = (name)=> /\.mp3$/i.test(name);
const stemOf  = (fname)=> fname.replace(/\.[^.]+$/,'');
const joinPublic = (...parts)=> parts.map(s => encodeURIComponent(s)).join('/');
const trackPublicUrl = (folder, file)=> `${MEDIA_BASE}/${joinPublic(folder, file)}`;

// 썸네일 규칙
async function resolveFolderThumb(folder){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  const names = (LANG==='en')
    ? ['folder_e.jpg','folder_e.JPG','folder_e.jpeg']
    : ['folder.jpg','folder.JPG','folder.jpeg'];
  for(const n of names){
    const u = base + n;
    if (await pingImage(u)) return u;
  }
  return null;
}
async function resolveTrackThumb(folder, file){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  const stem = stemOf(file);
  const cand = (LANG==='en')
    ? [`${stem}_E.jpg`,`${stem}_E.JPG`,`${stem}_E.jpeg`]
    : [`${stem}.jpg`,`${stem}.JPG`,`${stem}.jpeg`];
  for(const n of cand){
    const u = base + n;
    if (await pingImage(u)) return u;
  }
  return null;
}
function pingImage(url){
  return new Promise(res=>{
    const img=new Image(); img.onload=()=>res(true); img.onerror=()=>res(false);
    img.src = url+(url.includes('?')?'&':'?')+'v='+Date.now();
  });
}

// ========= Storage Scan 핵심 =========
// 1) 루트 카테고리 폴더 나열
async function listRootFolders(){
  const out = [];
  // Supabase Storage list (루트)
  let page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list('', { limit: 100, offset: page*100 });
    if (error) throw error;
    // 폴더만 추출: Storage는 폴더를 "id/metadata가 빈 객체 & name만 있는 엔트리"로 돌려줌
    const folders = (data||[]).filter(it => !it.id && !it.metadata && !/\./.test(it.name));
    out.push(...folders.map(f => f.name));
    more = (data||[]).length === 100;
    page++;
  }
  // 알파벳/한글 순 정렬(원하면 커스텀 정렬)
  out.sort((a,b)=> a.localeCompare(b));
  return out;
}

// 2) 특정 폴더 내 파일 나열 (오디오만)
async function listTracks(folder){
  const tracks=[];
  let page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list(folder, { limit:100, offset:page*100 });
    if (error) throw error;
    (data||[]).forEach(it=>{
      if (isAudio(it.name)) tracks.push({ file: it.name, name: stemOf(it.name) });
    });
    more = (data||[]).length === 100;
    page++;
  }
  // 파일명 정렬
  tracks.sort((a,b)=> a.name.localeCompare(b.name));
  return tracks;
}

// ========= 렌더링 =========
async function renderStrip(){
  strip.innerHTML = '';
  if(!STATE.path){
    // 루트: 카테고리 폴더들
    const folders = await listRootFolders();
    if (!folders.length){
      // 루트 비어있을 때(혹은 권한/경로 문제)
      const empty = document.createElement('div');
      empty.style.color='#9ab6d1'; empty.textContent = (LANG==='en'?'No folders':'폴더가 없습니다');
      strip.appendChild(empty);
      return;
    }
    for(const name of folders){
      const card = await makeFolderCard(name);
      strip.appendChild(card);
    }
  } else {
    // 폴더 내부: 트랙 썸네일만 (맨앞 Blank/Back 제거)
    const list = await listTracks(STATE.path);
    for(const tr of list){
      const card = await makeTrackCard(STATE.path, tr.file);
      strip.appendChild(card);
    }
  }
}

async function makeFolderCard(folderName){
  const card=document.createElement('div'); card.className='card folder';
  const th=document.createElement('div'); th.className='thumb'; card.appendChild(th);
  const lb=document.createElement('div'); lb.className='label'; lb.textContent=folderName; card.appendChild(lb);

  // 썸네일
  const u = await resolveFolderThumb(folderName);
  if (u) th.style.backgroundImage=`url("${u}")`;

  // 클릭 → 진입
  card.addEventListener('click', ()=>{
    STATE.stack.push(STATE.path);
    STATE.path = folderName;
    renderStrip().catch(console.error);
    statusBlank();
  });
  return card;
}

async function makeTrackCard(folder, file){
  const stem = stemOf(file);
  const card=document.createElement('div'); card.className='card';
  const th=document.createElement('div'); th.className='thumb'; card.appendChild(th);
  const lb=document.createElement('div'); lb.className='label'; lb.textContent=stem; card.appendChild(lb);

  // 썸네일
  const u = await resolveTrackThumb(folder, file);
  if (u) th.style.backgroundImage=`url("${u}")`;

  // 클릭 → 로딩 & 상태썸네일 갱신
  card.addEventListener('click', ()=>{
    const url = trackPublicUrl(folder, file);
    PLAYER.src = url; PLAYER.load();
    setStatusThumbAsync(folder, stem);
    STATE.currentTrack = { name: stem, url };
  });
  return card;
}

// ========= 상태 썸네일 & 안내 =========
function statusBlank(){
  const st=document.getElementById('statusThumb');
  st.classList.add('status-blank');
  st.style.backgroundImage='none';
  let txt = st.parentElement.querySelector('#statusText');
  if(!txt){ txt=document.createElement('div'); txt.id='statusText'; st.parentElement.appendChild(txt); }
  txt.textContent = (LANG==='en'?'No track loaded':'선곡되지 않음');
}

// ========= 네비 버튼 =========
document.getElementById('btnBack').addEventListener('click',()=>{
  STATE.path = STATE.stack.pop() || '';
  renderStrip().catch(console.error);
});
document.getElementById('btnHome').addEventListener('click',()=>{
  STATE.stack.length=0; STATE.path='';
  renderStrip().catch(console.error);
});
document.getElementById('btnRefresh').addEventListener('click',()=>{
  renderStrip().catch(console.error);
});

// ========= 부팅 =========
(async function bootScan(){
  statusBlank();
  STATE.path=''; STATE.stack.length=0;
  await renderStrip();
})();
</script>
</body>
</html>
