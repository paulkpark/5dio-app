<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>5DO Pro</title>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
:root{
  --bg:#0a0f14; --panel:#0e1520; --line:#13243a; --muted:#8aa6c3; --txt:#e8f2ff;
  --blue:#9fe5ff; --blue2:#39e3ff; --stroke:#1d415f; --glow:rgba(57,227,255,.18);
  --card:#0b131e; --thumb:#0a1018; --accent:#7fd9ff;
  --title-glow:0 0 3px rgba(180,240,255,1),0 0 8px rgba(110,220,255,.95),0 0 18px rgba(50,180,255,.85),0 0 36px rgba(0,120,255,.7);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Noto Sans KR, sans-serif}
a{color:inherit;text-decoration:none}
button{cursor:pointer}

header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;background:linear-gradient(180deg,#0a1018,#0a0f14 60%);border-bottom:1px solid #0f1b2a}
.left-pack{display:flex;align-items:center;gap:10px}
.app-title{color:var(--blue);text-shadow:var(--title-glow);white-space:nowrap;font-weight:800;font-size:18px}
.center-tabs{position:absolute;left:calc(50% + 40px);transform:translateX(-50%);top:10px;display:flex;gap:8px}
.tab{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}
.tab.active{background:#0f2336}
.right-pack{display:flex;align-items:center;gap:8px;transform:translateX(-10px)}
#langBtn{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}

.hamburger{width:32px;height:22px;position:relative;transform:translateY(2px)}
.hamburger span,.hamburger span:before,.hamburger span:after{
  position:absolute;left:0;right:0;height:2px;background:#8fe8ff;content:"";box-shadow:0 0 6px rgba(110,220,255,.95),0 0 14px rgba(50,180,255,.85)
}
.hamburger span{top:10px}
.hamburger span:before{top:-8px}
.hamburger span:after{top:8px}

.dropdown{position:absolute;top:42px;left:0;background:#0b1420;border:1px solid #16324f;min-width:240px;border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.45);display:none}
.dropdown a{display:block;padding:11px 14px;border-bottom:1px solid #0f1b2a}
.dropdown a:last-child{border-bottom:0}
.dropdown a:hover{background:#0e1a2a}
.menu-container{position:relative}

main{padding:12px}
.hidden{display:none!important}

.status{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin:6px 0 12px}
#statusThumb{width:72px;height:72px;border:1px solid #14253b;border-radius:12px;background:#0b1018;background-size:cover;background-position:center}
.status-blank{
  background-image:radial-gradient(60% 40% at 50% 0%, rgba(90,210,255,.08), rgba(0,0,0,0)),
                   radial-gradient(70% 60% at 50% 100%, rgba(0,120,255,.06), rgba(0,0,0,0));
}
.status-meta{min-width:220px;max-width:min(560px,60vw)}
.status-title{font-weight:800;color:#cfe9ff;margin-bottom:2px}
.status-line{color:#9bbad6;opacity:.9;font-size:13px;line-height:1.4}

.playerbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.playerbar .controls button{background:#0d1e2f;border:1px solid var(--stroke);color:var(--txt);padding:8px 10px;border-radius:10px;box-shadow:inset 0 0 10px var(--glow)}
.nav-row{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
.nav-row .nav-btn{width:48px;height:48px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;background:#0d1e2f;border:1px solid var(--stroke);box-shadow:inset 0 0 10px var(--glow);padding:0}
.nav-row .nav-btn svg{width:24px;height:24px;stroke:#8fe8ff;fill:none;filter:drop-shadow(0 0 4px rgba(110,220,255,.9)) drop-shadow(0 0 10px rgba(50,180,255,.7))}

#breadcrumb,#statusText,.label{display:none!important}

#favoritesWrap{margin:10px 0 2px 0; display:none;}
#favoritesTitle{color:#cfe9ff;font-weight:800;margin:4px 0 8px 2px}
#favoritesStrip{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory}
#favoritesStrip .card{flex:0 0 132px;scroll-snap-align:start}

.strip{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;scroll-snap-type:x mandatory}
.card{flex:0 0 132px;display:flex;flex-direction:column;background:var(--card);
  border:1px solid #102035;border-radius:14px;overflow:hidden;cursor:pointer;scroll-snap-align:start;position:relative}
.thumb{width:100%;height:132px;background:var(--thumb);background-size:cover;background-position:center}
.card .star{
  position:absolute; right:8px; top:8px; width:26px; height:26px;
  border-radius:9px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15);
  display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(2px);
}
.card .star svg{width:18px;height:18px; stroke:#8fe8ff; fill:none; filter: drop-shadow(0 0 4px rgba(110,220,255,.8))}
.card.fav .star svg{ fill:#9fe5ff; stroke:#9fe5ff; }

/* Generator */
.section{margin-top:14px;border-top:1px solid #0f1b2a;padding-top:12px}
.gen-wrap{display:grid;gap:14px}
.gen-row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
@media (max-width:640px){ .gen-row{grid-template-columns:1fr;gap:8px} }
.gen-label{color:#cfe9ff;font-weight:700}
.gen-sub{color:#a7c4de}
.gen-flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.gen-input{background:#0f1a28;border:1px solid #13263c;color:#e9f4ff;border-radius:10px;padding:8px 10px}
.gen-range{width:min(560px,100%)}
.gen-check{display:flex;gap:8px;align-items:center;color:#cfe6ff}
#osc{display:block;width:100%;height:140px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#02070d}

.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:90}
.modal{position:fixed;inset:auto 0 0 0;margin:auto;top:8%;max-width:760px;background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:none;z-index:101;padding:16px}
.mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}

/* Playlist Panel */
#plPanel{display:none; position:fixed; inset:auto 10px 10px 10px; top:12%; max-width:760px; margin:auto;
  background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.45); z-index:120}
#plHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #15263f}
#plBody{padding:12px 14px; display:grid; gap:10px}
.pl-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0b1420;border:1px solid #12253e;border-radius:10px;padding:8px 10px}
#plFoot{display:flex;justify-content:flex-end;gap:10px;padding:10px 14px;border-top:1px solid #15263f}
.btn{background:#0d1e2f;border:1px solid #1d415f;color:#e8f2ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{transform:translateY(-1px)}
.small{font-size:12px;padding:6px 8px}

/* Remove duplicate version label if any */
#verBadge{display:none}
</style>
</head>
<body>
<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener" data-i18n="menu.shop">Shop</a>
        <a href="#" class="menu-text" data-txt="faq" data-i18n="menu.faq">FAQ</a>
        <a href="#" class="menu-text" data-txt="manual" data-i18n="menu.manual">Manual</a>
        <a href="#" class="menu-text" data-txt="contact" data-i18n="menu.contact">Contact</a>
        <a href="#" class="menu-text" data-txt="about" data-i18n="menu.about">About</a>
      </div>
    </div>
    <div class="app-title">5DO Pro <small id="verBadge"></small></div>
  </div>

  <div class="center-tabs">
    <button id="tabLibrary" class="tab active" data-i18n="tab.library">Library</button>
    <button id="tabGenerator" class="tab" data-i18n="tab.generator">Generator</button>
  </div>

  <div class="right-pack">
    <button id="langBtn">KR/EN</button>
  </div>
</header>

<main>
  <!-- Library Page -->
  <section id="pageLibrary">
    <div class="nav-row">
      <button id="btnBack" class="nav-btn" title="Back" aria-label="Back">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M15 6l-6 6 6 6"/></svg>
      </button>
      <button id="btnHome" class="nav-btn" title="Home" aria-label="Home">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M3 12l9-8 9 8"/><path d="M9 21V9h6v12"/></svg>
      </button>
      <button id="btnRefresh" class="nav-btn" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M21 12a9 9 0 1 0-2.64 6.36"/><path d="M21 12v-6h-6"/></svg>
      </button>
    </div>

    <div id="favoritesWrap">
      <div id="favoritesTitle">★ Favorites</div>
      <div id="favoritesStrip"></div>
    </div>

    <div class="strip" id="strip"></div>

    <div class="status">
      <div id="statusThumb" class="status-blank"></div>
      <div class="status-meta">
        <div id="metaTitle" class="status-title"></div>
        <div id="metaDesc" class="status-line"></div>
        <div id="metaComposer" class="status-line"></div>
      </div>
    </div>

    <div class="playerbar">
      <div class="controls">
        <button id="btnPlay" data-i18n="player.play">Play</button>
        <button id="btnPause" data-i18n="player.pause">Pause</button>
        <button id="btnLoop" data-i18n="player.loop">Loop</button>
        <button id="btnTimer" data-i18n="player.timer">Timer</button>
        <button id="btnPlaylist" data-i18n="player.playlists" onclick="openPlPanel()">Playlists</button>
      </div>
      <audio id="player" controls playsinline style="width:min(480px, 100%);"></audio>
    </div>
  </section>

  <!-- Generator Page -->
  <section id="pageGenerator" class="hidden">
    <canvas id="osc"></canvas>

    <div class="gen-wrap">
      <div class="gen-row">
        <div class="gen-label" data-i18n="gen.waveform">Waveform</div>
        <div class="gen-flex">
          <select id="wf" class="gen-input">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Saw</option>
          </select>
          <div class="gen-check">
            <label>Binaural</label>
            <input type="checkbox" id="binEnable"/>
            <label class="gen-sub">Difference (Hz)</label>
            <input id="binDiff" class="gen-input" type="number" min="0" max="40" step="0.1" value="4"/>
          </div>
        </div>
      </div>

      <div class="gen-row">
        <div class="gen-label" data-i18n="gen.frequency">Frequency (Hz)</div>
        <div class="gen-flex">
          <input id="freq" class="gen-input" type="number" min="0" max="20000" step="0.1" value="432"/>
          <input id="freqRange" class="gen-range" type="range" min="0" max="20000" step="1" value="432"/>
        </div>
      </div>

      <div class="gen-row">
        <div class="gen-label">Duty Cycle</div>
        <div class="gen-flex">
          <input id="dutyNum" class="gen-input" type="number" min="1" max="100" step="1" value="50"/>
          <input id="duty" class="gen-range" type="range" min="1" max="100" step="1" value="50"/>
        </div>
      </div>

      <div class="gen-row">
        <div class="gen-label" data-i18n="gen.controls">Controls</div>
        <div class="gen-flex">
          <button id="genPlay" class="btn">Play</button>
          <button id="genStop" class="btn">Stop</button>
          <select id="oscColor" class="gen-input">
            <option value="#39e3ff">Neon Blue</option>
            <option value="#00ff8c">Neon Green</option>
            <option value="#ffd166">Amber</option>
            <option value="#ff5ea0">Magenta</option>
            <option value="#ffffff">White</option>
          </select>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal for menu texts -->
<div class="backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <div class="mhead">
    <div id="modalTitle" style="font-weight:800;color:#cfe9ff">Info</div>
    <button id="modalClose" class="btn small">Close</button>
  </div>
  <div id="modalBody" style="white-space:pre-wrap;line-height:1.55;color:#d7e8ff"></div>
</div>

<!-- Playlist Panel -->
<div id="plPanel" role="dialog" aria-modal="true" aria-labelledby="plTitle">
  <div id="plHead">
    <div id="plTitle" style="color:#cfe9ff;font-weight:800">Playlists</div>
    <div>
      <button id="plNewBtn" class="btn small">+ New</button>
      <button id="plImportBtn" class="btn small">Import</button>
      <button id="plExportBtn" class="btn small">Export</button>
      <button id="plCloseBtn" class="btn small">Close</button>
    </div>
  </div>
  <div id="plBody"></div>
  <div id="plFoot">
    <button id="plSaveBtn" class="btn">Save</button>
  </div>
</div>

<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const MEDIA_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}`;

/* ===== i18n ===== */
let LANG = 'ko';
const I18N = {
  'ko': {
    'tab.library':'라이브러리','tab.generator':'주파수 생성기',
    'menu.shop':'Shop','menu.faq':'FAQ','menu.manual':'매뉴얼','menu.contact':'연락처','menu.about':'소개',
    'player.play':'재생','player.pause':'일시정지','player.loop':'루프','player.timer':'타이머','player.playlists':'플레이리스트',
    'gen.waveform':'파형','gen.frequency':'주파수 (Hz)','gen.controls':'컨트롤',
    'pl.no':'플레이리스트가 없습니다. 생성해 주세요.','pl.new':'새 목록','pl.delete':'삭제','pl.save':'저장','pl.import':'가져오기','pl.export':'내보내기','pl.close':'닫기'
  },
  'en': {
    'tab.library':'Library','tab.generator':'Generator',
    'menu.shop':'Shop','menu.faq':'FAQ','menu.manual':'Manual','menu.contact':'Contact','menu.about':'About',
    'player.play':'Play','player.pause':'Pause','player.loop':'Loop','player.timer':'Timer','player.playlists':'Playlists',
    'gen.waveform':'Waveform','gen.frequency':'Frequency (Hz)','gen.controls':'Controls',
    'pl.no':'No playlists. Create one.','pl.new':'New List','pl.delete':'Delete','pl.save':'Save','pl.import':'Import','pl.export':'Export','pl.close':'Close'
  }
};
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = (I18N[LANG] && I18N[LANG][key]) ? I18N[LANG][key] : el.textContent;
  });
  // Playlist header buttons
  document.getElementById('plTitle').textContent = (LANG==='en'?'Playlists':'플레이리스트');
  document.getElementById('plNewBtn').textContent = (LANG==='en'?'+ New':'+ 새 목록');
  document.getElementById('plImportBtn').textContent = (LANG==='en'?'Import':'가져오기');
  document.getElementById('plExportBtn').textContent = (LANG==='en'?'Export':'내보내기');
  document.getElementById('plCloseBtn').textContent = (LANG==='en'?'Close':'닫기');
  document.getElementById('plSaveBtn').textContent = (LANG==='en'?'Save':'저장');
}

/* ===== Shorthands & State ===== */
const $ = (s,r=document)=>r.querySelector(s);
const strip = $('#strip');
const player = $('#player');
const statusThumb = $('#statusThumb');
const STATE = { path:'', stack:[], currentTrack:null };

/* ===== Helpers ===== */
function imgOk(url){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(true); i.onerror=()=>res(false);
    i.src=url+(url.includes('?')?'&':'?')+'v='+Date.now();
  });
}
function stem(n){ return n.replace(/\.[^.]+$/, ''); }

async function folderThumb(folder){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  const names = (LANG==='en') ? ['folder_e.jpg','folder_E.jpg','folder_e.JPG'] : ['folder.jpg','folder.JPG'];
  for(const n of names){
    const u = base + n;
    if(await imgOk(u)) return u;
  }
  return null;
}
async function trackThumb(folder, file){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  const s = stem(file);
  const cand = (LANG==='en') ? [`${s}_E.jpg`,`${s}_E.JPG`,`${s}_E.jpeg`] : [`${s}.jpg`,`${s}.JPG`,`${s}.jpeg`];
  for(const n of cand){
    const u = base + n;
    if(await imgOk(u)) return u;
  }
  return null;
}

async function listRoot(){
  let out=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list('', { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    const pageFolders = (data||[]).filter(it => !/\./.test(it.name)).map(it=>it.name);
    out.push(...pageFolders);
    more = (data||[]).length===100;
    page++;
  }
  return out.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
}
async function listTracks(folder){
  let list=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list(folder, { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    for(const it of (data||[])){
      if(/\.mp3$/i.test(it.name)) list.push(it.name);
    }
    more = (data||[]).length===100; page++;
  }
  return list.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
}

function statusBlank(){
  statusThumb.classList.add('status-blank');
  statusThumb.style.backgroundImage='none';
  $('#metaTitle').textContent='';
  $('#metaDesc').textContent='';
  $('#metaComposer').textContent='';
}

/* ===== Favorites ===== */
const FAV_KEY='fiveDO_favs';
function loadFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||'[]')); }catch{ return new Set(); } }
function saveFavs(set){ localStorage.setItem(FAV_KEY, JSON.stringify([...set])); }
const FAVS = loadFavs();
function starSvg(){ return '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7"><path d="M12 3l3 6 6 .9-4.5 4.4 1 6.2-5.5-3-5.5 3 1-6.2L3 9.9 9 9z"/></svg>'; }
function trackId(folder, file){ return (folder? `${folder}/${file}` : file); }

async function renderFavoritesStrip(){
  const wrap = $('#favoritesWrap'), fstrip = $('#favoritesStrip');
  const list = [...FAVS];
  if(list.length===0){ wrap.style.display='none'; fstrip.innerHTML=''; return; }
  wrap.style.display=''; fstrip.innerHTML='';
  for(const id of list){
    const seg = id.split('/');
    const folder = seg.length>1 ? seg.slice(0,-1).join('/') : '';
    const file   = seg[seg.length-1];
    const card = document.createElement('div'); card.className='card fav';
    const th   = document.createElement('div'); th.className='thumb'; card.append(th);
    const star = document.createElement('div'); star.className='star'; star.innerHTML=starSvg(); card.append(star);
    const u = await (folder ? trackThumb(folder, file) : null);
    if(u) th.style.backgroundImage=`url("${u}")`;
    card.addEventListener('click', (e)=>{
      if(e.target.closest('.star')) return;
      const url = `${MEDIA_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(file)}`;
      player.src = url; player.load?.(); player.play().catch(()=>{});
      (async()=>{
        const u2 = await trackThumb(folder, file);
        if(u2){ statusThumb.classList.remove('status-blank'); statusThumb.style.backgroundImage=`url("${u2}")`; }
      })();
      $('#metaTitle').textContent = stem(file).replace(/[_\-]+/g,' ');
    });
    star.addEventListener('click',(e)=>{
      e.stopPropagation();
      const isFav = FAVS.has(id);
      if(isFav){ FAVS.delete(id); card.classList.remove('fav'); }
      else { FAVS.add(id); card.classList.add('fav'); }
      saveFavs(FAVS);
      renderFavoritesStrip();
    });
    fstrip.appendChild(card);
  }
}

/* ===== Render strip ===== */
async function renderStrip(){
  strip.innerHTML='';
  if(!STATE.path){
    await renderFavoritesStrip();
    const folders = await listRoot();
    for(const name of folders){
      const card = document.createElement('div'); card.className='card folder';
      const th   = document.createElement('div'); th.className='thumb'; card.append(th);
      const u = await folderThumb(name);
      if(u) th.style.backgroundImage=`url("${u}")`;
      const star = document.createElement('div'); star.className='star'; star.innerHTML=starSvg(); card.append(star);
      card.addEventListener('click',(e)=>{
        if(e.target.closest('.star')) return;
        STATE.stack.push(''); STATE.path=name; statusBlank(); renderStrip();
      });
      strip.appendChild(card);
    }
  }else{
    const files = await listTracks(STATE.path);
    for(const f of files){
      const card = document.createElement('div'); card.className='card';
      card.setAttribute('data-file', f);
      const th   = document.createElement('div'); th.className='thumb'; card.append(th);
      const u = await trackThumb(STATE.path, f);
      if(u) th.style.backgroundImage=`url("${u}")`;
      const star = document.createElement('div'); star.className='star'; star.innerHTML=starSvg(); card.append(star);
      card.addEventListener('click',(e)=>{
        if(e.target.closest('.star')) return;
        const url = `${MEDIA_BASE}/${encodeURIComponent(STATE.path)}/${encodeURIComponent(f)}`;
        player.src = url; player.load?.(); player.play().catch(()=>{});
        (async()=>{
          const u2 = await trackThumb(STATE.path, f);
          if(u2){ statusThumb.classList.remove('status-blank'); statusThumb.style.backgroundImage=`url("${u2}")`; }
        })();
        $('#metaTitle').textContent = stem(f).replace(/[_\-]+/g,' ');
        STATE.currentTrack = { name: stem(f), url };
      });
      star.addEventListener('click',(e)=>{
        e.stopPropagation();
        const id = trackId(STATE.path, f);
        const isFav = FAVS.has(id);
        if(isFav){ FAVS.delete(id); card.classList.remove('fav'); }
        else { FAVS.add(id); card.classList.add('fav'); }
        saveFavs(FAVS);
        renderFavoritesStrip();
      });
      if(FAVS.has(trackId(STATE.path,f))) card.classList.add('fav');
      strip.appendChild(card);
    }
  }
}

/* ===== Tabs / Language / Menu ===== */
function showPage(which){
  if(which==='lib'){ $('#pageLibrary').classList.remove('hidden'); $('#pageGenerator').classList.add('hidden');
    $('#tabLibrary').classList.add('active'); $('#tabGenerator').classList.remove('active');
  }else{
    $('#pageLibrary').classList.add('hidden'); $('#pageGenerator').classList.remove('hidden');
    $('#tabLibrary').classList.remove('active'); $('#tabGenerator').classList.add('active');
  }
}
$('#tabLibrary').addEventListener('click',()=>showPage('lib'));
$('#tabGenerator').addEventListener('click',()=>showPage('gen'));
$('#langBtn').addEventListener('click',()=>{ LANG = (LANG==='en'?'ko':'en'); applyLang(); renderStrip(); if(!STATE.currentTrack) statusBlank(); });

const menuBtn = $('#menuBtn'), menuDrop = $('#menuDrop'), backdrop=$('#backdrop'), modal=$('#modal');
menuBtn.addEventListener('click',()=>{
  const v = menuDrop.style.display==='block' ? 'none' : 'block';
  menuDrop.style.display=v;
});
backdrop.addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
$('#modalClose').addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
document.querySelectorAll('.menu-text').forEach(a=>{
  a.addEventListener('click', async (e)=>{
    e.preventDefault();
    menuDrop.style.display='none';
    const key = a.dataset.txt; // faq, manual, contact, about
    const path = `texts/${key}.txt`;
    try{
      const res = await fetch(path+'?v='+Date.now());
      const txt = await res.text();
      $('#modalTitle').textContent = (a.textContent||'Info');
      $('#modalBody').textContent = txt;
      backdrop.style.display='block'; modal.style.display='block';
    }catch(err){
      $('#modalTitle').textContent = 'Error';
      $('#modalBody').textContent = 'Failed to load.';
      backdrop.style.display='block'; modal.style.display='block';
    }
  });
});

/* ===== Player controls & nav ===== */
$('#btnPlay').addEventListener('click',()=>player.play());
$('#btnPause').addEventListener('click',()=>player.pause());
$('#btnLoop').addEventListener('click',()=>{ player.loop = !player.loop; alert(player.loop ? (LANG==='en'?'Loop On':'루프 켜짐') : (LANG==='en'?'Loop Off':'루프 꺼짐')); });
$('#btnTimer').addEventListener('click',()=>{
  const m = prompt(LANG==='en'?'Sleep timer (minutes)':'수면 타이머 (분)'); 
  const t = Number(m||0); if(!t) return;
  setTimeout(()=>{ player.pause(); }, t*60000);
});

$('#btnBack').addEventListener('click',()=>{ STATE.path=''; STATE.stack.pop(); renderStrip(); });
$('#btnHome').addEventListener('click',()=>{ STATE.path=''; STATE.stack.length=0; renderStrip(); });
$('#btnRefresh').addEventListener('click',()=>renderStrip());

/* ===== Generator (WebAudio) ===== */
let aCtx=null, oscL=null, oscR=null, gainL=null, gainR=null, merger=null, analyser=null;
const cvs = document.getElementById('osc'), ctx2d = cvs.getContext('2d');
let rafId = 0;
function drawOsc(color){
  const W=cvs.width= cvs.clientWidth; const H=cvs.height = cvs.clientHeight;
  ctx2d.clearRect(0,0,W,H);
  if(!analyser){ cancelAnimationFrame(rafId); return; }
  const buf = new Uint8Array(1024); analyser.getByteTimeDomainData(buf);
  ctx2d.strokeStyle=color; ctx2d.lineWidth=2;
  ctx2d.beginPath();
  for(let i=0;i<buf.length;i++){
    const x = i*(W/(buf.length-1));
    const y = (buf[i]/255)*H;
    if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
  }
  ctx2d.stroke();
  rafId = requestAnimationFrame(()=>drawOsc(color));
}
function clearOsc(){
  cancelAnimationFrame(rafId);
  ctx2d.clearRect(0,0,cvs.width,cvs.height);
}
function stopGen(){
  try{ if(oscL){oscL.stop();} }catch{}
  try{ if(oscR){oscR.stop();} }catch{}
  if(oscL){ oscL.disconnect(); oscL=null; }
  if(oscR){ oscR.disconnect(); oscR=null; }
  if(gainL){ gainL.disconnect(); gainL=null; }
  if(gainR){ gainR.disconnect(); gainR=null; }
  if(merger){ merger.disconnect(); merger=null; }
  if(analyser){ analyser.disconnect(); analyser=null; }
  clearOsc();
}
function playGen(){
  if(!aCtx) aCtx = new (window.AudioContext||window.webkitAudioContext)();
  const wf = document.getElementById('wf').value;
  const f0 = parseFloat(document.getElementById('freq').value)||0;
  const bina = document.getElementById('binEnable').checked;
  const diff = parseFloat(document.getElementById('binDiff').value)||0;
  const duty = Math.max(1, Math.min(100, parseInt(document.getElementById('duty').value||'50',10)));

  stopGen();

  oscL = aCtx.createOscillator();
  oscL.type = (wf==='square'?'square':(wf==='triangle'?'triangle':(wf==='sawtooth'?'sawtooth':'sine')));
  oscL.frequency.value = f0;

  if(bina){
    oscR = aCtx.createOscillator();
    oscR.type = oscL.type;
    oscR.frequency.value = Math.max(0, f0 + diff);
  }

  gainL = aCtx.createGain(); gainL.gain.value = 0.2;
  if(bina) gainR = aCtx.createGain(), gainR.gain.value=0.2;

  merger = aCtx.createChannelMerger(2);
  analyser = aCtx.createAnalyser(); analyser.fftSize=2048;

  if(wf==='square'){
    // crude duty via waveshaper
    const shaper = aCtx.createWaveShaper();
    const curve = new Float32Array(256);
    const th = (duty/100)*2-1;
    for(let i=0;i<256;i++){ const x = i/128-1; curve[i] = (x<th)? -1 : 1; }
    shaper.curve = curve;
    oscL.connect(shaper).connect(gainL);
    if(bina) oscR.connect(shaper).connect(gainR);
  }else{
    oscL.connect(gainL);
    if(bina) oscR.connect(gainR);
  }

  gainL.connect(merger,0,0);
  if(bina) gainR.connect(merger,0,1); else gainL.connect(merger,0,1);
  merger.connect(analyser).connect(aCtx.destination);

  const color = document.getElementById('oscColor').value;
  drawOsc(color);

  try{ oscL.start(); if(bina) oscR.start(); }catch{}
}
document.getElementById('genPlay').addEventListener('click', async ()=>{
  try{ if(aCtx && aCtx.state==='suspended') await aCtx.resume(); }catch{}
  playGen();
});
document.getElementById('genStop').addEventListener('click', stopGen);
document.getElementById('oscColor').addEventListener('change', ()=>{ /* color applied on next frame */ });

// Sync inputs
document.getElementById('freqRange').addEventListener('input', e=>{ document.getElementById('freq').value = e.target.value; if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('freq').addEventListener('input', e=>{ document.getElementById('freqRange').value = e.target.value; if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('wf').addEventListener('change', ()=>{ if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('binEnable').addEventListener('change', ()=>{ if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('binDiff').addEventListener('input', ()=>{ if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('duty').addEventListener('input', e=>{ document.getElementById('dutyNum').value=e.target.value; if(aCtx && aCtx.state==='running') playGen(); });
document.getElementById('dutyNum').addEventListener('input', e=>{ let v=e.target.value; document.getElementById('duty').value=v; if(aCtx && aCtx.state==='running') playGen(); });

/* ===== Simple Playlist (Local + Cloud JSON) ===== */
const USER_ID_KEY='fiveDO_user_id';
function uid(){ return 'u'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function getUserId(){ let x=localStorage.getItem(USER_ID_KEY); if(!x){ x=uid(); localStorage.setItem(USER_ID_KEY,x); } return x; }
const USER_ID = getUserId();
const PL_KEY='fiveDO_playlists';
const PL_CLOUD_PATH = `playlists/${USER_ID}.json`;
function nowISO(){ return new Date().toISOString(); }
function newPLState(){ return {version:1,updatedAt:nowISO(),lists:[]}; }
function loadPLLocal(){ try{ return JSON.parse(localStorage.getItem(PL_KEY)||''); }catch{ return null; } }
function savePLLocal(obj){ try{ obj.updatedAt=nowISO(); localStorage.setItem(PL_KEY, JSON.stringify(obj)); }catch{} }
async function loadPLCloud(){
  const url = `${MEDIA_BASE}/${PL_CLOUD_PATH}`;
  try{ const res = await fetch(url+'?t='+Date.now(), {cache:'no-store'}); if(!res.ok) return null; return await res.json(); }
  catch{ return null; }
}
async function savePLCloud(obj){
  try{
    const { data, error } = await SB.storage.from(BUCKET)
      .upload(PL_CLOUD_PATH, new Blob([JSON.stringify(obj)], {type:'application/json'}), { upsert:true });
    if(error) throw error;
    return true;
  }catch(e){ console.warn('[playlist] cloud save failed', e); return false; }
}
async function syncPlaylists(){
  let local = loadPLLocal();
  let cloud = await loadPLCloud();
  if(!local && !cloud){
    local = newPLState(); savePLLocal(local); await savePLCloud(local); return local;
  }
  if(local && !cloud){ await savePLCloud(local); return local; }
  if(!local && cloud){ savePLLocal(cloud); return cloud; }
  const L = new Date(local.updatedAt||0).getTime();
  const C = new Date(cloud.updatedAt||0).getTime();
  const base = (C>L)? cloud : local;
  savePLLocal(base); if(C<L) await savePLCloud(base);
  return base;
}
let PL_STATE=null;
const plPanel = document.getElementById('plPanel'), plBody=document.getElementById('plBody');
function openPlPanel(){ plPanel.style.display='block'; renderPL(); }
function closePlPanel(){ plPanel.style.display='none'; }
function renderPL(){
  plBody.innerHTML='';
  const lists = (PL_STATE?.lists)||[];
  if(lists.length===0){ const row=document.createElement('div'); row.className='pl-row'; row.textContent=(LANG==='en'?'No playlists. Create one.':'플레이리스트가 없습니다. 생성해 주세요.'); plBody.appendChild(row); return; }
  lists.forEach((pl,i)=>{
    const row=document.createElement('div'); row.className='pl-row';
    const name=document.createElement('input'); name.className='gen-input'; name.value=pl.name||('List '+(i+1));
    const cnt=document.createElement('div'); cnt.style.opacity=.7; cnt.textContent=`${pl.items?.length||0} ${LANG==='en'?'tracks':'곡'}`;
    const left=document.createElement('div'); left.style.display='flex'; left.style.gap='10px'; left.append(name,cnt);
    const del=document.createElement('button'); del.className='btn small'; del.textContent=(LANG==='en'?'Delete':'삭제');
    del.addEventListener('click',()=>{ PL_STATE.lists.splice(i,1); renderPL(); });
    row.append(left,del);
    name.addEventListener('input',()=>{ pl.name=name.value; });
    plBody.appendChild(row);
  });
}
document.getElementById('plNewBtn').addEventListener('click',()=>{ PL_STATE.lists.push({id:'pl_'+Date.now(),name:(LANG==='en'?'New List':'새 목록'),items:[]}); renderPL(); });
document.getElementById('plExportBtn').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(PL_STATE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='playlists.json'; a.click();
});
document.getElementById('plImportBtn').addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; try{ const text=await f.text(); const json=JSON.parse(text); if(json?.lists){ PL_STATE=json; renderPL(); } }catch(e){ console.warn('import failed', e); } };
  inp.click();
});
document.getElementById('plSaveBtn').addEventListener('click', async ()=>{ savePLLocal(PL_STATE); await savePLCloud(PL_STATE); closePlPanel(); });
window.openPlPanel = openPlPanel;

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Remove any version/date label injection
  /* version badge disabled */
  applyLang();

  // Unlock for iOS init gesture
  const unlock=()=>{ try{ player.play().then(()=>player.pause()).catch(()=>{}); }catch(_){} window.removeEventListener('touchend',unlock); window.removeEventListener('click',unlock); };
  window.addEventListener('touchend',unlock,{once:true}); window.addEventListener('click',unlock,{once:true});

  PL_STATE = await syncPlaylists();

  STATE.path=''; STATE.stack=[];
  await renderStrip();
  statusBlank();

  showPage('lib');
});
</script>
</body>
</html>
