<!doctype html>
<meta charset="utf-8">
<title>5DO Thumbnail Generator — AI Background Ready</title>
<style>
  :root{ --bg:#0b1110; --card:#0e1715; --border:#1b2a26; --ink:#e8f5f1; --accent:#1f6456; }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 -apple-system, BlinkMacSystemFont, SF Pro Text, Segoe UI, Roboto, Helvetica, Arial, Apple SD Gothic Neo, Noto Sans KR, sans-serif}
  .wrap{max-width:1240px; margin:28px auto; padding:0 16px}
  .grid{display:grid; grid-template-columns: 420px 1fr; gap:18px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
  h1{margin:0 0 14px; font-weight:700; font-size:18px}
  label{font-size:12px; opacity:.9}
  input[type=text], input[type=url], select, textarea{width:100%; padding:10px 12px; margin:.35rem 0 1rem; background:#0c1413; color:var(--ink); border:1px solid var(--border); border-radius:10px}
  textarea{min-height:72px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .btn{display:inline-flex; gap:10px; align-items:center; background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer}
  .btn.secondary{background:#183f38}
  .muted{opacity:.8}
  canvas{width:100%; height:auto; border-radius:14px; border:1px solid var(--border); background:#061a17}
  .small{font-size:12px; opacity:.8}
  .checkboxes{display:flex; gap:14px; flex-wrap:wrap; margin:.25rem 0 1rem}
  #status{margin-top:8px; font-size:12px; color:#c7ffd9}
  #status.err{color:#ffb7b7}
  .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px}
</style>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <div class="topbar">
        <h1 id="t_app">5DO Thumbnail Generator</h1>
        <div>
          <label for="lang" class="small" id="t_lang">Language</label>
          <select id="lang">
            <option value="en">English</option>
            <option value="ko">한국어</option>
          </select>
        </div>
      </div>

      <label id="t_thumbType">Thumbnail Type</label>
      <select id="thumbType">
        <option value="category" id="t_type_category">Category Folder (Title only)</option>
        <option value="track" id="t_type_track">Audio Track (Title + Subtitle bottom-center)</option>
      </select>

      <label id="t_title">Title</label>
      <input id="title" type="text" placeholder="ORGAN HEALING SEQUENCES" value="ORGAN HEALING SEQUENCES">

      <div id="subtitleBlock">
        <label id="t_subtitle">Subtitle (shown bottom-center for Track)</label>
        <input id="subtitle" type="text" placeholder="15-Minute Frequency Protocol">
      </div>

      <div class="row">
        <div>
          <label id="t_titleFont">Title Font (macOS installed)</label>
          <select id="titleFont"></select>
        </div>
        <div>
          <label id="t_subtitleFont">Subtitle Font (macOS installed)</label>
          <select id="subtitleFont"></select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label id="t_titleSize">Title Size</label>
          <input id="titleSize" type="range" min="56" max="120" value="88">
        </div>
        <div>
          <label id="t_subtitleSize">Subtitle Size</label>
          <input id="subtitleSize" type="range" min="32" max="72" value="46">
        </div>
        <div>
          <label id="t_tracking">Letter Spacing</label>
          <input id="tracking" type="range" min="0" max="8" value="0">
        </div>
      </div>

      <label id="t_focus">Focus Keyword (optional)</label>
      <div class="row">
        <input id="focus" type="text" placeholder="e.g. liver, heart chakra, solar plexus, detox, aura">
        <div>
          <label class="small" for="focusMode" id="t_focusMode">Focus Mode</label>
          <select id="focusMode">
            <option value="manual" id="t_focusManual">Manual</option>
            <option value="auto" id="t_focusAuto">Auto-map</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label id="t_style">Style Template</label>
          <select id="style">
            <option value="quantumClinical" id="t_style_quantum">Quantum + Clinical (Emerald–Gold)</option>
            <option value="minimalZen" id="t_style_minimal">Minimal Zen</option>
            <option value="auroraBlue" id="t_style_aurora">Aurora Blue</option>
            <option value="roseQuartz" id="t_style_rose">Rose Quartz</option>
            <option value="amethyst" id="t_style_amethyst">Amethyst</option>
            <option value="solarGold" id="t_style_solar">Solar Gold</option>
            <option value="deepSpace" id="t_style_deep">Deep Space</option>
            <option value="natureLeaf" id="t_style_leaf">Nature Leaf</option>
            <option value="oceanTeal" id="t_style_ocean">Ocean Teal</option>
            <option value="monochrome" id="t_style_mono">Monochrome</option>
            <option value="crystalWhite" id="t_style_crystal">Crystal White</option>
          </select>
        </div>
      </div>

      <label id="t_prompt">Background Hint (prompt-ish note, 한국어 OK)</label>
      <input id="prompt" type="text" placeholder="emerald-gold plasma, torus energy, gentle healing / 장기 포커스 에너지 링">

      <div class="row">
        <div>
          <label>Background Source</label>
          <select id="bgSource">
            <option value="procedural">Procedural (Canvas)</option>
            <option value="ai">AI via Endpoint</option>
          </select>
        </div>
        <div>
          <label>AI Endpoint (Cloudflare Worker)</label>
          <input id="endpoint" type="url" placeholder="https://five-do.workers.dev">
        </div>
      </div>

      <div>
        <label id="t_export">Export Formats (multi-select)</label>
        <div class="checkboxes">
          <label><input type="checkbox" id="fmtPNG" checked> PNG</label>
          <label><input type="checkbox" id="fmtJPG"> JPG</label>
          <label><input type="checkbox" id="fmtWEBP"> WEBP</label>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <button class="btn" id="btnRender">Generate</button>
        <button class="btn secondary" id="btnRegenerate">Regenerate (apply edits)</button>
        <button class="btn secondary" id="btnDownload">Download Selected</button>
        <span class="small muted" id="t_hint">1024×1024. Track mode shows subtitle bottom-center.</span>
      </div>

      <label id="t_editlab">Edit Instructions</label>
      <textarea id="editBox" placeholder="예: title bigger, subtitle lower, tracking +2, focus liver on, style minimal, title font Cinzel, subtitle font Noto Sans KR, title:'ORGAN HEALING SEQUENCES', subtitle:'15-Minute Frequency Protocol'"></textarea>
      <div id="status" aria-live="polite"></div>
    </div>

    <div class="card">
      <canvas id="cv" width="1024" height="1024"></canvas>
    </div>
  </div>
</div>

<script>
/* ========== INIT / I18N ========== */
window.addEventListener('DOMContentLoaded', init);

function init(){
  try{
    setupFonts();
    bindUI();
    applyLang(localStorage.getItem('lang') || 'ko');
    renderProcedural(); // 첫 렌더는 procedural
    setStatus(i18n[document.getElementById('lang').value].ready);
  }catch(e){ setError('Init failed: '+e.message); }
}
function setStatus(msg){ const s=document.getElementById('status'); s.classList.remove('err'); s.textContent=msg; }
function setError(msg){ const s=document.getElementById('status'); s.classList.add('err'); s.textContent=msg; }

const i18n = {
  en:{ app:'5DO Thumbnail Generator', lang:'Language', type:'Thumbnail Type', type_category:'Category Folder (Title only)', type_track:'Audio Track (Title + Subtitle bottom-center)', title:'Title', subtitle:'Subtitle (shown bottom-center for Track)', titleFont:'Title Font (macOS installed)', subtitleFont:'Subtitle Font (macOS installed)', titleSize:'Title Size', subtitleSize:'Subtitle Size', tracking:'Letter Spacing', focus:'Focus (optional)', focusMode:'Focus Mode', focusManual:'Manual', focusAuto:'Auto-map', style:'Style Template', prompt:'Background Hint (prompt-ish note, Korean OK)', export:'Export Formats (multi-select)', hint:'1024×1024. Track mode shows subtitle bottom-center.', editlab:'Edit Instructions', ready:'Ready. Generate to preview.' },
  ko:{ app:'5DO 썸네일 생성기', lang:'언어', type:'썸네일 유형', type_category:'카테고리 폴더 (제목만)', type_track:'오디오 트랙 (제목 + 하단 중앙 부제)', title:'제목', subtitle:'부제목 (트랙 선택 시 하단 중앙 표시)', titleFont:'제목 폰트 (macOS 설치 글꼴)', subtitleFont:'부제 폰트 (macOS 설치 글꼴)', titleSize:'제목 크기', subtitleSize:'부제 크기', tracking:'자간', focus:'포커스(선택)', focusMode:'포커스 모드', focusManual:'수동', focusAuto:'자동 매핑', style:'스타일 템플릿', prompt:'배경 힌트 (프롬프트식 메모, 한국어 OK)', export:'내보내기 형식 (다중선택)', hint:'1024×1024. 트랙 모드에서 부제는 하단 중앙에 표시됩니다.', editlab:'편집 지시(문장으로 입력 가능)', ready:'준비 완료. Generate를 눌러 미리보기를 생성하세요.' }
};

function applyLang(lang){
  const t = i18n[lang] || i18n.en;
  const setText=(id,txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
  setText('t_app', t.app); setText('t_lang', t.lang); setText('t_thumbType', t.type); setText('t_type_category', t.type_category); setText('t_type_track', t.type_track); setText('t_title', t.title); setText('t_subtitle', t.subtitle); setText('t_titleFont', t.titleFont); setText('t_subtitleFont', t.subtitleFont); setText('t_titleSize', t.titleSize); setText('t_subtitleSize', t.subtitleSize); setText('t_tracking', t.tracking); setText('t_focus', t.focus); setText('t_style', t.style); setText('t_prompt', t.prompt); setText('t_export', t.export); setText('t_hint', t.hint); setText('t_editlab', t.editlab);
  document.getElementById('btnRender').textContent = 'Generate';
  document.getElementById('btnRegenerate').textContent = 'Regenerate (apply edits)';
  document.getElementById('btnDownload').textContent = (lang==='ko')?'선택 형식 다운로드':'Download Selected';
  document.getElementById('title').placeholder = (lang==='ko')?'오거나이즈: ORGAN HEALING SEQUENCES':'ORGAN HEALING SEQUENCES';
  document.getElementById('subtitle').placeholder = (lang==='ko')?'15분 주파수 프로토콜':'15-Minute Frequency Protocol';
  document.getElementById('prompt').placeholder = (lang==='ko')?'에메랄드-골드 플라즈마, 토러스 에너지, 부드러운 힐링 / 장기 포커스 에너지 링':'emerald-gold plasma, torus energy, gentle healing / organ focus energy ring';
  if(lang==='ko'){ selectOptionTextContains('subtitleFont','Apple SD Gothic'); }
  localStorage.setItem('lang', lang);
  document.getElementById('lang').value = lang;
}

const macFonts = [
  {name:'SF Pro Display', css:'SF Pro Display'},
  {name:'San Francisco (System)', css:'-apple-system, SF Pro Text'},
  {name:'Helvetica Neue', css:'Helvetica Neue'},
  {name:'Helvetica', css:'Helvetica'},
  {name:'Arial', css:'Arial'},
  {name:'Times New Roman', css:'Times New Roman'},
  {name:'Georgia', css:'Georgia'},
  {name:'Cinzel', css:'Cinzel, Times New Roman, Georgia, serif'},
  {name:'Cormorant Garamond', css:'Cormorant Garamond, Georgia, serif'},
  {name:'Apple SD Gothic Neo', css:'Apple SD Gothic Neo, Noto Sans KR, sans-serif'},
  {name:'Noto Sans KR', css:'Noto Sans KR, Apple SD Gothic Neo, sans-serif'},
  {name:'Nanum Gothic', css:'Nanum Gothic, Noto Sans KR, sans-serif'},
  {name:'Pretendard (if installed)', css:'Pretendard, Noto Sans KR, sans-serif'},
  {name:'Inter', css:'Inter, Arial, sans-serif'}
];

function setupFonts(){
  const titleFontSel = document.getElementById('titleFont');
  const subtitleFontSel = document.getElementById('subtitleFont');
  [titleFontSel, subtitleFontSel].forEach(sel=>{
    sel.innerHTML='';
    macFonts.forEach(f=>{ const o=document.createElement('option'); o.value=f.css; o.textContent=f.name; sel.appendChild(o); });
  });
  selectOptionTextContains('titleFont','Cinzel');
  selectOptionTextContains('subtitleFont','Apple SD Gothic');
}

function selectOptionTextContains(selectId, text){
  const sel = document.getElementById(selectId);
  for(let i=0;i<sel.options.length;i++){ if(sel.options[i].text.indexOf(text)>-1){ sel.selectedIndex=i; break; } }
}

function bindUI(){
  document.getElementById('btnRender').addEventListener('click', async ()=>{
    try{
      const mode = document.getElementById('bgSource').value;
      if(mode==='ai'){ await generateAIBackground(); drawTexts(); }
      else { renderProcedural(); }
      setStatus(i18n[document.getElementById('lang').value].ready);
    }catch(e){ setError('Render error: '+e.message); }
  });
  document.getElementById('btnRegenerate').addEventListener('click', ()=>{ try{ const instr=document.getElementById('editBox').value.trim(); applyEdits(instr); renderProcedural(); setStatus('Regenerated.'); }catch(e){ setError('Regenerate error: '+e.message); } });
  document.getElementById('btnDownload').addEventListener('click', ()=>{ try{ downloadSelected(); setStatus('Downloaded.'); }catch(e){ setError('Download error: '+e.message); } });
  document.getElementById('thumbType').addEventListener('change', e=>{ const block=document.getElementById('subtitleBlock'); block.style.display = e.target.value === 'track' ? 'block' : 'none'; });
  document.getElementById('lang').addEventListener('change', e=>{ applyLang(e.target.value); });
}

/* ========== CANVAS CORE ========== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let subtitleBottomOffset = 70;
window.__glowBoost = 1.0;
window.__focusPos = null;
window.__focusColor = null;

function containsKorean(text){ for(let i=0;i<text.length;i++){ const code=text.charCodeAt(i); if(code>=12593 && code<=55229) return true; } return false; }

function mapFocusAuto(txt){
  if(!txt) return {};
  const t = String(txt).toLowerCase();
  let pos = [0.52, 0.55];
  let color = 'rgba(120,255,210,0.35)';
  let style = null;
  const set = (xf,yf,c,st)=>{ pos=[xf,yf]; if(c) color=c; if(st) style=st; };
  if(t.includes('liver')||t.includes('간')) set(0.65,0.62,'rgba(120,255,180,0.38)','natureLeaf');
  else if(t.includes('heart')||t.includes('심장')) set(0.52,0.50,'rgba(120,255,180,0.38)','roseQuartz');
  else if(t.includes('lung')||t.includes('폐')) set(0.50,0.46,'rgba(140,220,255,0.32)','auroraBlue');
  else if(t.includes('kidney')||t.includes('신장')) set(0.58,0.70,'rgba(120,220,255,0.32)','oceanTeal');
  else if(t.includes('pineal')||t.includes('송과')) set(0.52,0.32,'rgba(160,150,255,0.38)','amethyst');
  return { pos, color, style };
}

function drawFocusOverlay(){
  if(!window.__focusPos) return;
  const fx = (window.__focusPos[0] <= 1) ? window.__focusPos[0]*cv.width : window.__focusPos[0];
  const fy = (window.__focusPos[1] <= 1) ? window.__focusPos[1]*cv.height: window.__focusPos[1];
  const main = window.__focusColor || 'rgba(120,255,210,' + (0.35*(window.__glowBoost||1)) + ')';
  const glow = ctx.createRadialGradient(fx, fy, 10, fx, fy, 160);
  glow.addColorStop(0, main);
  glow.addColorStop(0.5, 'rgba(120,255,210,' + (0.18*(window.__glowBoost||1)) + ')');
  glow.addColorStop(1, 'rgba(120,255,210,0.0)');
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(fx, fy, 200, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = 'rgba(250,235,180,' + (0.55*(window.__glowBoost||1)) + ')';
  ctx.lineWidth = 1.8;
  [120,155,190].forEach(r=>{ ctx.beginPath(); for(let a=0;a<=Math.PI*2;a+=0.035){ const x=fx+Math.cos(a)*r; const y=fy+Math.sin(a)*r*0.6; if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); });
}

function drawBackground(style){
  const W = cv.width, H = cv.height;
  ctx.fillStyle = '#061a17'; ctx.fillRect(0,0,W,H);
  function gradientRad(c0,c1,c2){ const g=ctx.createRadialGradient(W*0.5,H*0.55,50,W*0.5,H*0.55,700); g.addColorStop(0,c0); g.addColorStop(0.5,c1); g.addColorStop(1,c2); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); }
  function baseEmerald(){ gradientRad('#0d2f29','#0b3a32','#061a17'); }
  function torus(stroke){ const s = stroke || 'rgba(255,220,140,0.28)'; ctx.save(); ctx.translate(W*0.5, H*0.58); ctx.strokeStyle=s; ctx.lineWidth=2.5; for(let r=190;r<=330;r+=28){ ctx.beginPath(); for(let a=0;a<=Math.PI*2;a+=0.02){ const wobble=1+0.015*Math.sin(a*6+r*0.03); const x=Math.cos(a)*r*wobble; const y=Math.sin(a)*(r*0.45)*wobble; if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); } ctx.restore(); }
  const styles = {
    minimalZen: ()=>{ const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0f1f1b'); g.addColorStop(1,'#0a1512'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); },
    quantumClinical: ()=>{ baseEmerald(); torus('rgba(255,220,140,' + (0.28*(window.__glowBoost||1)) + ')'); },
    auroraBlue: ()=>{ gradientRad('#081b2a','#0b2740','#06121e'); torus('rgba(120,200,255,0.22)'); },
    roseQuartz: ()=>{ gradientRad('#2a0f1a','#401126','#17080e'); torus('rgba(255,180,210,0.24)'); },
    amethyst: ()=>{ gradientRad('#140a26','#25124b','#0c0720'); torus('rgba(200,170,255,0.26)'); },
    solarGold: ()=>{ gradientRad('#2b1f05','#513b07','#140d03'); torus('rgba(255,225,150,0.30)'); },
    deepSpace: ()=>{ gradientRad('#05070b','#0a0f16','#030408'); torus('rgba(190,220,255,0.20)'); },
    natureLeaf: ()=>{ gradientRad('#0c2316','#134022','#07160e'); torus('rgba(160,255,200,0.26)'); },
    oceanTeal: ()=>{ gradientRad('#062022','#0b3a3f','#041214'); torus('rgba(120,255,230,0.24)'); },
    monochrome: ()=>{ gradientRad('#0a0a0a','#151515','#050505'); torus('rgba(220,220,220,0.22)'); },
    crystalWhite: ()=>{ gradientRad('#0b0d10','#111518','#0a0d10'); torus('rgba(255,255,255,0.28)'); }
  };
  (styles[document.getElementById('style').value]||styles.quantumClinical)();
}
function setLetterSpacing(spacing){ return Number(spacing)||0; }

function drawTextBlock(opts){
  const text = opts.text; if(!text) return 0; const x=opts.x; const y=opts.y; const maxWidth=opts.maxWidth; const align=opts.align||'center'; const fontFamily=opts.fontFamily; const fontSize=opts.fontSize||88; const tracking=opts.tracking||0;
  ctx.textAlign = align; ctx.textBaseline = 'top'; ctx.fillStyle = '#FFFFFF'; ctx.font = '700 ' + fontSize + 'px ' + fontFamily;
  const isKR = containsKorean(text); const words = isKR ? text.split('') : text.split(' '); const lines = []; let line = '';
  function widthOf(str){ if(!tracking) return ctx.measureText(str).width; let w = 0; for(let i=0;i<str.length;i++){ w += ctx.measureText(str[i]).width + tracking; } return w; }
  for(let i=0;i<words.length;i++){ const wrd=words[i]; const test = line ? (isKR ? line + wrd : line + ' ' + wrd) : wrd; if(widthOf(test) > maxWidth && line){ lines.push(line); line = wrd; } else { line = test; } }
  if(line) lines.push(line);
  let yy = y; const lh = Math.round(fontSize * (isKR ? 1.08 : 1.1));
  for(let li=0; li<lines.length; li++){
    const str = lines[li]; if(!tracking){ ctx.fillText(str, x, yy); } else { let xx = x; const w = widthOf(str); if(align==='center') xx -= w/2; else if(align==='right') xx -= w; for(let j=0;j<str.length;j++){ const ch=str[j]; ctx.fillText(ch, xx, yy); xx += ctx.measureText(ch).width + tracking; } }
    yy += lh;
  }
  return yy - y;
}

function drawTexts(){
  const W=cv.width, H=cv.height;
  const title = document.getElementById('title').value.trim();
  const subtitle = document.getElementById('subtitle').value.trim();
  const thumbType = document.getElementById('thumbType').value;
  const titleFont = document.getElementById('titleFont').value;
  const subtitleFont = document.getElementById('subtitleFont').value;
  const titleSize = Number(document.getElementById('titleSize').value);
  const subtitleSize = Number(document.getElementById('subtitleSize').value);
  const tracking = setLetterSpacing(document.getElementById('tracking').value);
  const topMargin = 80;
  drawTextBlock({ text: title || '', x: W/2, y: topMargin, maxWidth: W*0.82, align:'center', fontFamily: titleFont, fontSize: titleSize, tracking });
  if(thumbType === 'track' && subtitle){
    drawTextBlock({ text: subtitle, x: W/2, y: H - subtitleBottomOffset - subtitleSize, maxWidth: W*0.85, align:'center', fontFamily: subtitleFont, fontSize: subtitleSize, tracking: Math.min(tracking, 4) });
  }
}

function renderProcedural(){
  const focusText = document.getElementById('focus').value.trim();
  const focusMode = (document.getElementById('focusMode')||{value:'manual'}).value;
  let style = document.getElementById('style').value;
  window.__focusPos = null; window.__focusColor = null;

  if (focusMode === 'auto'){
    const m = mapFocusAuto(focusText);
    if(m.style) style = m.style;
    if(m.pos) window.__focusPos = m.pos;
    if(m.color) window.__focusColor = m.color;
  } else if (focusText){
    const dict = {liver:[0.65,0.62], heart:[0.52,0.50], lung:[0.50,0.46], kidney:[0.58,0.70]};
    window.__focusPos = dict[focusText] || [0.52,0.55];
  }

  drawBackground(style);
  drawFocusOverlay();
  drawTexts();
}

/* ========== AI BACKGROUND FETCH ========== */
async function generateAIBackground(){
  const endpoint = (document.getElementById('endpoint').value || '').trim();
  if(!endpoint){ throw new Error('Endpoint is empty'); }
  const prompt = document.getElementById('prompt').value.trim() || 'emerald-gold torus plasma, abstract, no text';
  setStatus('Generating via AI…');
  const r = await fetch(endpoint, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ prompt, size:'1024x1024' })
  });
  if(!r.ok){
    const t = await r.text();
    setError('API error: ' + t);
    throw new Error('API error');
  }
  const j = await r.json();
  if(!j.image){ setError('No image from API'); throw new Error('no image'); }

  // draw returned image to canvas
  await new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{ ctx.drawImage(img, 0,0, cv.width, cv.height); resolve(); };
    img.onerror = reject;
    img.src = j.image; // data URL
  });
  setStatus('AI background generated.');
}

/* ========== EDIT/EXPORT ========== */
function applyEdits(instr){
  if(!instr) return;
  const lower = String(instr).toLowerCase();
  const get = id=>document.getElementById(id);
  function getQuoted(label){ const needle = label + ':"'; const i = instr.indexOf(needle); if(i>=0){ const s = i + needle.length; const e = instr.indexOf('"', s); if(e> s) return instr.slice(s, e); } return null; }
  const qTitle = getQuoted('title'); if(qTitle!==null) get('title').value = qTitle;
  const qSub = getQuoted('subtitle'); if(qSub!==null) get('subtitle').value = qSub;
  function inc(id, step){ const el=get(id); const v = Number(el.value)||0; const min=Number(el.min)||0; const max=Number(el.max)||999; el.value = String(Math.max(min, Math.min(max, v+step))); }
  if(lower.includes('title bigger') || instr.includes('제목 크게')) inc('titleSize', +6);
  if(lower.includes('title smaller') || instr.includes('제목 작게')) inc('titleSize', -6);
  if(lower.includes('subtitle bigger') || instr.includes('부제 크게')) inc('subtitleSize', +4);
  if(lower.includes('subtitle smaller') || instr.includes('부제 작게')) inc('subtitleSize', -4);
  if(lower.includes('increase spacing') || lower.includes('more spacing') || instr.includes('자간 늘')) inc('tracking', +1);
  if(lower.includes('decrease spacing') || lower.includes('less spacing') || instr.includes('자간 줄')) inc('tracking', -1);
  if(lower.includes('subtitle lower') || lower.includes('subtitle down') || instr.includes('부제 아래')) subtitleBottomOffset = Math.max(20, subtitleBottomOffset - 10);
  if(lower.includes('subtitle higher') || lower.includes('subtitle up') || instr.includes('부제 위'))   subtitleBottomOffset = Math.min(160, subtitleBottomOffset + 10);
  if(lower.includes('liver focus on') || instr.includes('간 포커스 켜')) get('focus').value = 'liver';
  if(lower.includes('focus off') || instr.includes('포커스 끄')) get('focus').value = '';
  if(lower.includes('style minimal') || instr.includes('미니멀')) get('style').value = 'minimalZen';
  if(lower.includes('style quantum') || instr.includes('임상') || instr.includes('에메랄드') || instr.includes('골드')) get('style').value = 'quantumClinical';
  const tfi = lower.indexOf('title font '); if(tfi>=0){ const key = instr.slice(tfi+11).split(',')[0].trim(); pickFont('titleFont', key); }
  const sfi = lower.indexOf('subtitle font '); if(sfi>=0){ const key2 = instr.slice(sfi+14).split(',')[0].trim(); pickFont('subtitleFont', key2); }
  if(lower.includes('more glow') || instr.includes('글로우 더') || instr.includes('광채 업')) window.__glowBoost = Math.min(2.0, window.__glowBoost + 0.2);
  if(lower.includes('less glow') || instr.includes('글로우 줄') || instr.includes('광채 다운')) window.__glowBoost = Math.max(0.4, window.__glowBoost - 0.2);
}
function pickFont(selId, key){ if(!key) return; const sel=document.getElementById(selId); const k=String(key).toLowerCase(); for(let i=0;i<sel.options.length;i++){ if(sel.options[i].text.toLowerCase().includes(k)){ sel.selectedIndex=i; break; } } }

function downloadSelected(){
  const wantPNG = document.getElementById('fmtPNG').checked;
  const wantJPG = document.getElementById('fmtJPG').checked;
  const wantWEBP = document.getElementById('fmtWEBP').checked;
  if(!wantPNG && !wantJPG && !wantWEBP){ setError('Select at least one format.'); return; }
  const title = (document.getElementById('title').value.trim()||'thumbnail').replace(/[^A-Za-z0-9_\-]+/g,'_');
  if(wantPNG){ dl(cv.toDataURL('image/png'), title + '.png'); }
  if(wantJPG){ dl(cv.toDataURL('image/jpeg', 0.95), title + '.jpg'); }
  if(wantWEBP){ dl(cv.toDataURL('image/webp', 0.95), title + '.webp'); }
}
function dl(dataURL, filename){ const a=document.createElement('a'); a.href = dataURL; a.download = filename; a.click(); }
</script>
