<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
<title>5DO</title>
<link rel="manifest" href="/manifest.webmanifest">

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
html, body {
  width: 100%;
  max-width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}
	:root{
  --bg:#0a0f14; --panel:#0e1520; --line:#13243a; --muted:#8aa6c3; --txt:#e8f2ff;
  --blue:#9fe5ff; --blue2:#39e3ff; --stroke:#1d415f; --glow:rgba(57,227,255,.18);
  --card:#0b131e; --thumb:#0a1018; --accent:#7fd9ff;
  --title-glow:0 0 3px rgba(180,240,255,1),0 0 8px rgba(110,220,255,.95),0 0 18px rgba(50,180,255,.85),0 0 36px rgba(0,120,255,.7);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Noto Sans KR, sans-serif}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
/* 앱 전체 레이아웃 쉘 */
#appShell,
#app {                /* 실제 쓰는 ID에 맞춰서 하나만 남겨도 됨 */
  width: 100%;
  max-width: 520px;   /* 갤럭시 폴드에서 너무 좁게 느껴지면 540~600까지 올려봐도 됨 */
  margin: 0 auto;     /* 화면 가운데 정렬 */
  min-height: 100vh;
  padding: 0 10px 12px;
}
	
/* Header */
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;background:linear-gradient(180deg,#0a1018,#0a0f14 60%);border-bottom:1px solid #0f1b2a}
.left-pack{display:flex;align-items:center;gap:10px}
.app-title{color:var(--blue);text-shadow:var(--title-glow);white-space:nowrap;font-weight:800;font-size:18px}
.center-tabs{position:absolute;left:calc(50% + 24px);transform:translateX(-50%);top:10px;display:flex;gap:8px}
.tab{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}
.tab.active{background:#0f2336}
.right-pack{display:flex;align-items:center;gap:8px;transform:translateX(-12px)}
#langBtn{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}

/* Hamburger */
.hamburger{width:21px;height:22px;position:relative;transform:translateY(2px)}
.hamburger span,.hamburger span:before,.hamburger span:after{
  position:absolute;left:0;right:0;height:2px;background:#8fe8ff;content:"";box-shadow:0 0 6px rgba(110,220,255,.95),0 0 14px rgba(50,180,255,.85)
}
.hamburger span{top:10px}
.hamburger span:before{top:-8px}
.hamburger span:after{top:8px}
.dropdown{position:absolute;top:42px;left:0;background:#0b1420;border:1px solid #16324f;min-width:260px;border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.45);display:none;max-height:70vh;overflow:auto}
.dropdown a{display:block;padding:11px 14px;border-bottom:1px solid #0f1b2a}
.dropdown a:last-child{border-bottom:0}
.dropdown a:hover{background:#0e1a2a}
.menu-container{position:relative}

/* Main */
main{padding:12px}
.hidden{display:none!important}

/* Library status */
.status{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin:6px 0 12px}
#statusThumb{width:120px;height:120px;border:1px solid #14253b;border-radius:18px;background:#0b1018;background-size:cover;background-position:center;flex-shrink: 0;}
.status-blank{
  background-image:radial-gradient(60% 40% at 50% 0%, rgba(90,210,255,.08), rgba(0,0,0,0)),
                   radial-gradient(70% 60% at 50% 100%, rgba(0,120,255,.06), rgba(0,0,0,0));
}
.status-meta{min-width:220px;max-width:min(560px,60vw)}
.status-title{font-weight:700;margin-bottom:2px;font-size: clamp(12px, 4vw, 18px);white-space; nowrap;overflow; hidden;text-overflow: ellipsis;max-width: 100%;}
.status-title.playing{
  background:linear-gradient(90deg,#b6ecff,#39e3ff,#7fffd4,#39e3ff,#b6ecff);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  animation:cycle 4.5s linear infinite
}
@keyframes cycle{0%{background-position:0%}100%{background-position:200%}}
.status-line{color:#9bbad6;opacity:.9;font-size:13px;line-height:1.4}

/* Player + nav */
.playerbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.playerbar .controls button{background:#0d1e2f;border:1px solid var(--stroke);color:var(--txt);padding:8px 10px;border-radius:10px;box-shadow:inset 0 0 10px var(--glow)}
.nav-row{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
.nav-row .nav-btn{width:48px;height:48px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;background:#0d1e2f;border:1px solid var(--stroke);box-shadow:inset 0 0 10px var(--glow);padding:0}
.nav-row .nav-btn svg{width:24px;height:24px;stroke:#8fe8ff;fill:none;filter:drop-shadow(0 0 4px rgba(110,220,255,.9)) drop-shadow(0 0 10px rgba(50,180,255,.7))}

/* Track Info Panel */
.track-info-panel{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:#0b131e;
  border:1px solid #102035;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.track-info-title{
  font-weight:800;
  margin-bottom:6px;
  color:#cfe9ff;
}
.track-info-body{
  font-size:13px;
  line-height:1.5;
  color:#9bbad6;
  max-height:21vh;
  overflow:auto;
  padding-right:4px;	
}


/* Search/Filter */
.filterbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:4px 0 10px}
.filterbar input, .filterbar select{background:#0f1a28;border:1px solid #13263c;color:#e9f4ff;border-radius:10px;padding:8px 10px}

/* Thumbs */
#favoritesWrap{margin:10px 0 2px 0; display:none;}
#favoritesTitle{color:#cfe9ff;font-weight:800;margin:4px 0 8px 2px}
#favoritesStrip{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory}
#favoritesStrip .card{flex:0 0 132px;scroll-snap-align:start}

.strip{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;scroll-snap-type:x mandatory}
.card{flex:0 0 132px;display:flex;flex-direction:column;background:var(--card);
  border:1px solid #102035;border-radius:14px;overflow:hidden;cursor:pointer;scroll-snap-align:start;position:relative}
.thumb{width:100%;height:132px;background:var(--thumb);background-size:cover;background-position:center}
.card .star{
  position:absolute; right:8px; bottom:8px; width:26px; height:26px;
  border-radius:9px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15);
  display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(2px);
}
.card .star svg{width:18px;height:18px; stroke:#8fe8ff; fill:none; filter: drop-shadow(0 0 4px rgba(110,220,255,.8))}
.card.fav .star svg{ fill:#9fe5ff; stroke:#9fe5ff; }

/* Generator */
.section{margin-top:14px;border-top:1px solid #0f1b2a;padding-top:12px}
.gen-grid{display:grid;gap:10px}
.gen-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.gen-toolbar .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--stroke);background:#0d1e2f;box-shadow:inset 0 0 10px var(--glow)}
.gen-row2{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
@media (max-width:640px){.gen-row2{grid-template-columns:1fr}}
.gen-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.gen-inline .gen-input{min-width:80px}
.gen-chip{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f;color:var(--txt);font-size:12px}
.gen-input, .gen-range, select{background:#0f1a28;border:1px solid #13263c;color:#e9f4ff;border-radius:10px}
.gen-range{height:32px}
label.gen-label{color:#cfe9ff;font-weight:700}
.gen-sub{font-size:12px;color:#cfe9ff}
.small-note{font-size:12px;color:#a7c4de}

/* Oscilloscope */
.osc-wrap{position:relative}
#osc{display:block;width:100%;height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#02070d}
@media (max-width:420px){ #osc{height:140px} }
.osc-toolbar{position:absolute;top:8px;right:8px;display:flex;align-items:center;gap:8px;z-index:6}
.osc-color-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:linear-gradient(135deg,#3be8ff,#1f7aff);box-shadow:0 2px 8px rgba(0,0,0,.25);cursor:pointer}
.osc-pop{position:absolute;top:40px;right:0;padding:10px;border-radius:12px;background:rgba(15,17,24,.96);border:1px solid rgba(255,255,255,.12);box-shadow:0 12px 28px rgba(0,0,0,.35);display:none}
.osc-pop.show{display:block}
.osc-swatches{display:grid;grid-template-columns:repeat(6,22px);gap:8px}
.osc-swatch{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,255,255,.25);cursor:pointer}

/* Modal */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:90}
.modal{position:fixed;inset:auto 10px 10px 10px;top:8%;max-width:760px;max-height:80vh;
  background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:none;z-index:101;padding:16px}
.mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#modalBody{white-space:pre-wrap;line-height:1.55;color:#d7e8ff;max-height:60vh;overflow:auto}

/* Playlist Panel */
#plPanel{display:none; position:fixed; inset:auto 10px 10px 10px; top:12%; max-width:760px; margin:auto;
  background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.45); z-index:120}
#plHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #15263f}
#plBody{padding:12px 14px; display:grid; gap:10px; max-height:56vh; overflow:auto}
.pl-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0b1420;border:1px solid #12253e;border-radius:10px;padding:8px 10px}
#plFoot{display:flex;justify-content:flex-end;gap:10px;padding:10px 14px;border-top:1px solid #15263f}
.btn{background:#0d1e2f;border:1px solid #1d415f;color:#e8f2ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{transform:translateY(-1px)}
.small{font-size:12px;padding:6px 8px}

/* Cleanup */
#verBadge{display:none}
</style>
</head>
<body>
	<div id="appShell">
<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener" data-i18n="menu.shop">Shop</a>
        <a href="#" class="menu-text" data-txt="faq" data-i18n="menu.faq">FAQ</a>
        <a href="#" class="menu-text" data-txt="manual" data-i18n="menu.manual">Manual</a>
        <a href="#" class="menu-text" data-txt="contact" data-i18n="menu.contact">Contact</a>
        <a href="#" class="menu-text" data-txt="about" data-i18n="menu.about">About</a>
      </div>
    </div>
    <div class="app-title">5DO</div>
  </div>

  <div class="center-tabs">
    <button id="tabLibrary" class="tab active" data-i18n="tab.library">Library</button>
    <button id="tabGenerator" class="tab" data-i18n="tab.generator">Generator</button>
  </div>

  <div class="right-pack">
    <button id="langBtn">KR/EN</button>
  </div>
</header>

<main>
  <!-- Library -->
  <section id="pageLibrary">
    <div class="nav-row">
      <button id="btnBack" class="nav-btn" title="Back" aria-label="Back">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M15 6l-6 6 6 6"/></svg>
      </button>
      <button id="btnHome" class="nav-btn" title="Home" aria-label="Home">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M3 12l9-8 9 8"/><path d="M9 21V9h6v12"/></svg>
      </button>
      <button id="btnRefresh" class="nav-btn" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M21 12a9 9 0 1 0-2.64 6.36"/><path d="M21 12v-6h-6"/></svg>
      </button>
    </div>

    <!-- 검색/필터 -->
    <div class="filterbar">
      <input id="searchInput" type="text" placeholder="검색어…" />
      <select id="searchMode">
        <option value="folder">폴더</option>
        <option value="track">곡명</option>
      </select>
      <button id="searchBtn" class="btn small">검색</button>
      <button id="searchClear" class="btn small">지우기</button>
    </div>

    <div id="favoritesWrap">
      <div id="favoritesTitle">★ Favorites</div>
      <div id="favoritesStrip"></div>
    </div>

    <div class="strip" id="strip"></div>

    <div class="status">
      <div id="statusThumb" class="status-blank"></div>
      <div class="status-meta">
        <div id="metaTitle" class="status-title"></div>
        <div id="metaDesc" class="status-line"></div>
        <div id="metaComposer" class="status-line"></div>
      </div>
    </div>

    <div class="playerbar">
      <div class="controls">
        <button id="btnPlay" data-i18n="player.play">Play</button>
        <button id="btnPause" data-i18n="player.pause">Pause</button>
        <button id="btnLoop" data-i18n="player.loop">Loop</button>
        <button id="btnTimer" data-i18n="player.timer">Timer</button>
        <button id="btnPlaylist" data-i18n="player.playlists" onclick="openPlPanel()">Playlists</button>
      </div>
      <audio id="player" controls playsinline style="width:min(520px, 100%);"></audio>
    </div>
    

    <!-- Track Info Panel (선곡 설명 영역) -->
    <section id="trackInfoPanel" class="track-info-panel">
      <div id="trackInfoTitle" class="track-info-title"></div>
      <div id="trackInfoBody" class="track-info-body"></div>
    </section>
 </section>
	<!-- Generator -->
  <section id="pageGenerator" class="hidden">
    <div class="osc-wrap">
      <canvas id="osc"></canvas>
      <div class="osc-toolbar" id="oscToolbar">
       
        <div class="osc-pop" id="oscPop">
          <div class="osc-swatches" id="oscSwatches"></div>
        </div>
      </div>
    </div>

    <div class="gen-toolbar" style="margin-top:6px">
      <button id="genPlay" class="btn" data-i18n="play">Play</button>
      <button id="genStop" class="btn" data-i18n="stop">Stop</button>
      <button id="presetSave" class="btn" data-i18n="preset_save">Save Preset</button>
      <select id="presetLoad" class="gen-input" style="min-width:160px">
        <option value="" data-i18n="preset_load">Load Preset…</option>
      </select>
      <select id="oscColor" class="gen-input" style="margin-left:auto;min-width:120px">
        <option value="#39e3ff" data-i18n="osc.color.neonBlue">Neon Blue</option>
        <option value="#00ffd5" data-i18n="osc.color.aqua">Aqua</option>
        <option value="#00ff7f" data-i18n="osc.color.green">Neon Green</option>
        <option value="#ffd166" data-i18n="osc.color.amber">Amber</option>
        <option value="#ff5ea0" data-i18n="osc.color.magenta">Magenta</option>
        <option value="#ffffff" data-i18n="osc.color.white">White</option>
      </select>
    </div>

    <div class="gen-grid" style="margin-top:8px">
      <div class="gen-row2">
        <label class="gen-label" data-i18n="gen.waveform">Waveform</label>
        <div class="gen-inline">
          <select id="wf" class="gen-input">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Saw</option>
          </select>
          <span class="gen-chip" data-i18n="gen.binaural">Binaural</span>
          <input type="checkbox" id="binEnable"/>
          <label class="gen-sub" data-i18n="gen.diff">Difference (Hz)</label>
          <input id="binDiff" class="gen-input" type="number" min="0" max="40" step="0.1" value="4"/>
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label" data-i18n="gen.frequency">Frequency (Hz)</label>
        <div class="gen-inline">
          <input id="freq" class="gen-input" type="number" min="0" max="20000" step="0.1" value="432"/>
          <input id="freqRange" class="gen-range" type="range" min="0" max="20000" step="1" value="432" style="flex:1">
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label" data-i18n="gen.duty">Duty Cycle</label>
        <div class="gen-inline">
          <input id="dutyNum" class="gen-input" type="number" min="1" max="100" step="1" value="50"/>
          <input id="duty" class="gen-range" type="range" min="1" max="100" step="1" value="50" style="flex:1">
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label" data-i18n="harmonics_label">Harmonics</label>
        <div class="gen-inline">
          <label class="gen-sub" data-i18n="harmonics_enable">Enable</label>
          <input id="harmEnable" type="checkbox">
          <label class="gen-sub" data-i18n="harmonics_base">Base</label>
          <select id="harmBase" class="gen-input">
            <option value="fund" data-i18n="harm_base_fund">Fundamental</option>
            <option value="mid"  data-i18n="harm_base_mid">Mid (x2)</option>
            <option value="high" data-i18n="harm_base_high">High (x4)</option>
          </select>
          <label class="gen-sub" data-i18n="harm_octaves"># of Octaves</label>
          <select id="harmOct" class="gen-input">
            <option value="0">0</option><option value="1">1</option>
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal (hamburger texts) -->
<div class="backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <div class="mhead">
    <div id="modalTitle" style="font-weight:800;color:#cfe9ff">Info</div>
    <button id="modalClose" class="btn small">Close</button>
  </div>
  <div id="modalBody"></div>
</div>

<!-- Playlist Panel -->
<div id="plPanel" role="dialog" aria-modal="true" aria-labelledby="plTitle">
  <div id="plHead">
    <div id="plTitle" style="color:#cfe9ff;font-weight:800">Playlists</div>
    <div>
      <button id="plNewBtn" class="btn small">+ New</button>
      <button id="plImportBtn" class="btn small">Import</button>
      <button id="plExportBtn" class="btn small">Export</button>
      <button id="plCloseBtn" class="btn small">Close</button>
    </div>
  </div>
  <div id="plBody"></div>
  <div id="plFoot">
    <button id="plSaveBtn" class="btn">Save</button>
  </div>
</div>

<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const MEDIA_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}`;
// ===== META.JSON LOAD =====
let TRACK_META = {};

// meta.json 한 번만 로딩
async function loadTrackMeta(){
  try{
    const url = `${MEDIA_BASE}/meta.json?t=${Date.now()}`;  // 캐시 방지
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) {
      console.warn("[meta] meta.json load failed", res.status);
      return;
    }
    TRACK_META = await res.json();
    console.log("[meta] meta.json loaded", TRACK_META);
  } catch (e) {
    console.warn("[meta] meta.json error", e);
  }
}

// lang 에 맞는 필드 가져오기 helper
function getLocalized(meta, base){
  if (!meta) return "";
  if (LANG === "ko") return meta[`${base}_ko`] || meta[`${base}_kr`] || meta[base] || "";
  return meta[`${base}_en`] || meta[base] || meta[`${base}_ko`] || "";
}

// 트랙에 해당되는 meta 레코드 찾기
function lookupTrackMeta(folder, fileName){
  if (!TRACK_META) return null;
  const s = stem(fileName);              // 예: Heart_Brain_Cohesion
  const key1 = `${folder}/${s}`;         // Quantum_Torus_X/Heart_Brain_Cohesion
  const key2 = `${folder}/${fileName}`;  // Quantum_Torus_X/Heart_Brain_Cohesion.mp3
  const key3 = s;                        // Heart_Brain_Cohesion

  return TRACK_META[key1] || TRACK_META[key2] || TRACK_META[key3] || null;
}

/* ===== i18n ===== */
let LANG = (document.documentElement.lang==='en'?'en':'ko');
const I18N = {
  'ko': {
    'tab.library':'라이브러리',
    'tab.generator':'주파수 생성기',
    'menu.shop':'Shop',
    'menu.faq':'FAQ',
    'menu.manual':'매뉴얼',
    'menu.contact':'연락처',
    'menu.about':'소개',

    'player.play':'재생',
    'player.pause':'일시정지',
    'player.loop':'루프',
    'player.timer':'타이머',
    'player.playlists':'플레이리스트',

    'gen.waveform':'파형',
    'gen.frequency':'주파수 (Hz)',

    'play':'재생',
    'stop':'정지',
    'preset_save':'프리셋 저장',
    'preset_load':'프리셋 불러오기…',

    'gen.binaural':'바이노럴',
    'gen.diff':'차이 (Hz)',
    'gen.duty':'듀티 사이클',

    'harmonics_label':'하모닉스',
    'harmonics_enable':'활성화',
    'harmonics_base':'기준',
    'harm_base_fund':'기본 주파수',
    'harm_base_mid':'중간 (x2)',
    'harm_base_high':'고역 (x4)',
    'harm_octaves':'옥타브 개수',

    'osc.color.neonBlue':'네온 블루',
    'osc.color.aqua':'아쿠아',
    'osc.color.green':'네온 그린',
    'osc.color.amber':'앰버',
    'osc.color.magenta':'마젠타',
    'osc.color.white':'화이트',

    'pl.no':'플레이리스트가 없습니다. 생성해 주세요.',
    'pl.new':'새 목록',
    'pl.delete':'삭제',
    'pl.save':'저장',
    'pl.import':'가져오기',
    'pl.export':'내보내기',
    'pl.close':'닫기'
  },
  'en': {
    'tab.library':'Library',
    'tab.generator':'Generator',
    'menu.shop':'Shop',
    'menu.faq':'FAQ',
    'menu.manual':'Manual',
    'menu.contact':'Contact',
    'menu.about':'About',

    'player.play':'Play',
    'player.pause':'Pause',
    'player.loop':'Loop',
    'player.timer':'Timer',
    'player.playlists':'Playlists',

    'gen.waveform':'Waveform',
    'gen.frequency':'Frequency (Hz)',

    'play':'Play',
    'stop':'Stop',
    'preset_save':'Save Preset',
    'preset_load':'Load Preset…',

    'gen.binaural':'Binaural',
    'gen.diff':'Difference (Hz)',
    'gen.duty':'Duty Cycle',

    'harmonics_label':'Harmonics',
    'harmonics_enable':'Enable',
    'harmonics_base':'Base',
    'harm_base_fund':'Fundamental',
    'harm_base_mid':'Mid (x2)',
    'harm_base_high':'High (x4)',
    'harm_octaves':'# of Octaves',

    'osc.color.neonBlue':'Neon Blue',
    'osc.color.aqua':'Aqua',
    'osc.color.green':'Neon Green',
    'osc.color.amber':'Amber',
    'osc.color.magenta':'Magenta',
    'osc.color.white':'White',

    'pl.no':'No playlists. Create one.',
    'pl.new':'New List',
    'pl.delete':'Delete',
    'pl.save':'Save',
    'pl.import':'Import',
    'pl.export':'Export',
    'pl.close':'Close'
  }
};
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(I18N[LANG] && I18N[LANG][key]) el.textContent = I18N[LANG][key];
  });
  // Playlist header buttons
  document.getElementById('plTitle').textContent = (LANG==='en'?'Playlists':'플레이리스트');
  document.getElementById('plNewBtn').textContent = (LANG==='en'?'+ New':'+ 새 목록');
  document.getElementById('plImportBtn').textContent = (LANG==='en'?'Import':'가져오기');
  document.getElementById('plExportBtn').textContent = (LANG==='en'?'Export':'내보내기');
  document.getElementById('plCloseBtn').textContent = (LANG==='en'?'Close':'닫기');
  document.getElementById('plSaveBtn').textContent = (LANG==='en'?'Save':'저장');
}

/* ===== Shorthands & State ===== */
const $ = (s,r=document)=>r.querySelector(s);
const strip = $('#strip');
const player = $('#player');
const statusThumb = $('#statusThumb');
const statusTitle = $('#metaTitle');
const infoTitle = document.getElementById('trackInfoTitle');
const infoBody  = document.getElementById('trackInfoBody');
const STATE = { path:'', stack:[], currentTrack:null, foldersCache:[], tracksCache:{} };
let RENDER_TICK = 0;
	
/* ===== Helpers ===== */

function stem(n){ return n.replace(/\.[^.]+$/, ''); }

function folderThumb(folder){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  // 언어별 폴더 썸네일 규칙:
  //  - 한국어 : folder.webp
  //  - 영어   : folder_e.webp
  const name = (LANG === 'en') ? 'folder_e.webp' : 'folder.webp';

  // Supabase 이미지 변환(썸네일 사이즈) 옵션 – 필요 없으면 ?뒤는 빼도 됨
  return `${base}${name}?width=320&quality=70&format=webp`;
}

function trackThumb(folder, file){
  const base = `${MEDIA_BASE}/${encodeURIComponent(folder)}/`;
  const s = stem(file);

  // 트랙 썸네일 규칙:
  //  - 한국어 : <stem>.webp
  //  - 영어   : <stem>_E.webp
  const fname = (LANG === 'en') ? `${s}_E.webp` : `${s}.webp`;

  return `${base}${fname}?width=320&quality=70&format=webp`;
}

async function listRoot(){
  let out=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list('', { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    const pageFolders = (data||[]).filter(it => !/\./.test(it.name)).map(it=>it.name);
    out.push(...pageFolders);
    more = (data||[]).length===100;
    page++;
  }
  return out.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
}
async function listTracks(folder){
  if(STATE.tracksCache[folder]) return STATE.tracksCache[folder];
  let list=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list(folder, { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    for(const it of (data||[])){
      if(/\.(mp3|m4a|aac|wav|flac|ogg)$/i.test(it.name)) list.push(it.name);
    }
    more = (data||[]).length===100; page++;
  }
  list = list.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
  STATE.tracksCache[folder] = list;
  return list;
}

function statusBlank(){
  statusThumb.classList.add('status-blank');
  statusThumb.style.backgroundImage='none';
  statusTitle.classList.remove('playing');
  statusTitle.textContent='';
  $('#metaDesc').textContent='';
  $('#metaComposer').textContent='';

  if(infoTitle) infoTitle.textContent = '';
  if(infoBody)  infoBody.textContent  = '';
}

/* ===== Favorites ===== */
const FAV_KEY='fiveDO_favs';
function loadFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||'[]')); }catch{ return new Set(); } }
function saveFavs(set){ localStorage.setItem(FAV_KEY, JSON.stringify([...set])); }
const FAVS = loadFavs();
function starSvg(){ return '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7"><path d="M12 3l3 6 6 .9-4.5 4.4 1 6.2-5.5-3-5.5 3 1-6.2L3 9.9 9 9z"/></svg>'; }
function trackId(folder, file){ return (folder? `${folder}/${file}` : file); }

async function renderFavoritesStrip(){
  const wrap   = $('#favoritesWrap');
  const fstrip = $('#favoritesStrip');
  const list   = [...FAVS];

  if(list.length===0){
    wrap.style.display='none';
    fstrip.innerHTML='';
    return;
  }

  wrap.style.display='';
  fstrip.innerHTML='';

  for(const id of list){
    const seg    = id.split('/');
    const folder = seg.length>1 ? seg.slice(0,-1).join('/') : '';
    const file   = seg[seg.length-1];

    const card = document.createElement('div');
    card.className='card fav';

    const th   = document.createElement('div');
    th.className='thumb';
    card.append(th);

    const star = document.createElement('div');
    star.className='star';
    star.innerHTML=starSvg();
    card.append(star);

    const u = folder ? trackThumb(folder, file) : null;
	if (u) th.style.backgroundImage = `url("${u}")`;
    // ★ 즐겨찾기 카드 클릭 시: 재생 + meta 반영
    card.addEventListener('click', async (e)=>{
      if(e.target.closest('.star')) return;  // 별 클릭이면 무시

      const url = `${MEDIA_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(file)}`;
      player.src = url;
      player.load?.();
      player.play().catch(()=>{});

      // 썸네일 업데이트
      const u2 = folder ? trackThumb(folder, file) : null;
	if (u2){
  	statusThumb.classList.remove('status-blank');
 	 setStatusThumb(statusThumb, `${u2}`);
	}

      // 기본 제목 (파일명 기반)
      const baseTitle = stem(file).replace(/[_\-]+/g,' ');

      // meta.json 조회
      const meta = lookupTrackMeta(folder, file);
      let title    = baseTitle;
      let desc     = "";
      let composer = "";

      if (meta){
        title    = getLocalized(meta, 'title') || baseTitle;
        desc     = getLocalized(meta, 'desc');
        composer = meta.composer || getLocalized(meta, 'composer') || "";
      }

      // 상단 상태 바
      statusTitle.textContent = title;
      statusTitle.classList.add('playing');
      if (typeof STATE !== 'undefined'){
        STATE.currentTrack = { name: title, url };
      }

      // info 패널 업데이트
      if (typeof infoTitle !== 'undefined' && infoTitle) infoTitle.textContent = title;
      if (typeof infoBody !== 'undefined' && infoBody){
        const parts = [];
        if (desc)     parts.push(desc);
        if (composer) parts.push(LANG==='ko' ? `작곡: ${composer}` : `Composer: ${composer}`);
        infoBody.textContent = parts.join(' · ');
      }
    });

    // ★ 별 클릭 시 즐겨찾기 토글
    star.addEventListener('click',(e)=>{
      e.stopPropagation();
      const isFav = FAVS.has(id);
      if(isFav){
        FAVS.delete(id);
        card.classList.remove('fav');
      } else {
        FAVS.add(id);
        card.classList.add('fav');
      }
      saveFavs(FAVS);
      renderFavoritesStrip();
    });

    fstrip.appendChild(card);
  }
}

/* ===== Render strip ===== */
async function renderStrip(){
  const myTick = ++RENDER_TICK;         // 이 렌더 전용 토큰
  strip.innerHTML='';

  if(!STATE.path){
    await renderFavoritesStrip();
    if(myTick !== RENDER_TICK) return;  // 중간에 다른 렌더가 시작되면 중단

    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();
    const folders = STATE.foldersCache;
    for(const name of folders){
      if(myTick !== RENDER_TICK) return;

      const card = document.createElement('div'); card.className='card folder';
      const th   = document.createElement('div'); th.className='thumb'; card.append(th);

     const u = folderThumb(name);
	if (u) th.style.backgroundImage = `url("${u}")`;

      const star = document.createElement('div'); star.className='star'; star.innerHTML=starSvg(); card.append(star);
      card.addEventListener('click',(e)=>{
        if(e.target.closest('.star')) return;
        STATE.stack.push(''); STATE.path=name; statusBlank(); renderStrip();
      });
      strip.appendChild(card);
    }
    } else {
    const files = await listTracks(STATE.path);
    for (const f of files) {
      if (myTick !== RENDER_TICK) return;

      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-file', f);

      const th = document.createElement('div');
      th.className = 'thumb';
      card.append(th);

      const u = trackThumb(STATE.path, f);
	if (u) th.style.backgroundImage = `url("${u}")`;

      const star = document.createElement('div');
      star.className = 'star';
      star.innerHTML = starSvg();
      card.append(star);

      // ── 트랙 클릭 핸들러 ─────────────────────────────
      card.addEventListener('click', async (e) => {
        if (e.target.closest('.star')) return;   // 즐겨찾기 별 클릭이면 무시

        const url = `${MEDIA_BASE}/${encodeURIComponent(STATE.path)}/${encodeURIComponent(f)}`;
        player.src = url;
        player.load?.();
        player.play().catch(() => {});

        // 로딩 썸네일 갱신
        const u2 = await trackThumb(STATE.path, f);
        if (u2) {
          statusThumb.classList.remove('status-blank');
          setStatusThumb(statusThumb, `${u2}`);
        }

        // 기본 제목
        const baseTitle = stem(f).replace(/[_\-]+/g, ' ');

        // meta lookup
        const meta = lookupTrackMeta(STATE.path, f);
        let title = baseTitle;
        let desc = "";
        let composer = "";

        if (meta) {
          // "Quantum_Torus_X/Heart_Brain_Cohesion": { title_ko, title_en, desc_ko, ... }
          title    = getLocalized(meta, 'title') || baseTitle;
          desc     = getLocalized(meta, 'desc');
          composer = meta.composer || getLocalized(meta, 'composer') || "";
        }

        // 상단 상태 텍스트
        statusTitle.textContent = title;
        statusTitle.classList.add('playing');
        STATE.currentTrack = { name: title, url };

        // info 패널 업데이트
        if (infoTitle) infoTitle.textContent = title;
        if (infoBody) {
          const parts = [];
          if (desc) parts.push(desc);
          if (composer) {
            parts.push(
              LANG === 'ko'
                ? `작곡: ${composer}`
                : `Composer: ${composer}`
            );
          }
          infoBody.textContent = parts.join(' · ');
        }
      });
      // ───────────────────────────────────────────────

      star.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = trackId(STATE.path, f);
        const isFav = FAVS.has(id);
        if (isFav) { FAVS.delete(id); card.classList.remove('fav'); }
        else       { FAVS.add(id);    card.classList.add('fav'); }
        saveFavs(FAVS);
        renderFavoritesStrip();
      });

      if (FAVS.has(trackId(STATE.path, f))) card.classList.add('fav');
      strip.appendChild(card);
    }
  }
}

/* ===== Search / Filter ===== */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = ($('#searchInput').value||'').trim().toLowerCase();
  const mode = $('#searchMode').value; // folder | track
  if(!q){ renderStrip(); return; }
  strip.innerHTML='';
  if(mode==='folder'){
    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();
    const list = STATE.foldersCache.filter(n=>n.toLowerCase().includes(q));
    for(const name of list){
      const card = document.createElement('div'); card.className='card folder';
      const th   = document.createElement('div'); th.className='thumb'; card.append(th);
      const u = await folderThumb(name);
      if(u) th.style.backgroundImage=`url("${u}")`;
      card.addEventListener('click',()=>{ STATE.stack.push(''); STATE.path=name; statusBlank(); renderStrip(); });
      strip.appendChild(card);
    }
  }else{
    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();
    for(const folder of STATE.foldersCache){
      const tracks = await listTracks(folder);
      for(const f of tracks){
        if(stem(f).toLowerCase().includes(q)){
          const card = document.createElement('div'); card.className='card';
          const th   = document.createElement('div'); th.className='thumb'; card.append(th);
          const u = await trackThumb(folder, f); if(u) th.style.backgroundImage=`url("${u}")`;
          card.addEventListener('click', async ()=>{
            STATE.path = folder;
            const url = `${MEDIA_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(f)}`;
            player.src = url; player.load?.(); player.play().catch(()=>{});
            const u2 = await trackThumb(folder, f);
            if(u2){ statusThumb.classList.remove('status-blank');
            setStatusThumb(statusThumb, `${u2}`); }
            statusTitle.textContent = stem(f).replace(/[_\-]+/g,' ');
            statusTitle.classList.add('playing');
            STATE.currentTrack = { name: stem(f), url };
          });
          strip.appendChild(card);
        }
      }
    }
  }
});
document.getElementById('searchClear').addEventListener('click', ()=>{
  $('#searchInput').value=''; renderStrip();
});

/* ===== Tabs / Language / Menu ===== */
function showPage(which){
  if(which==='lib'){ $('#pageLibrary').classList.remove('hidden'); $('#pageGenerator').classList.add('hidden');
    $('#tabLibrary').classList.add('active'); $('#tabGenerator').classList.remove('active');
  }else{
    $('#pageLibrary').classList.add('hidden'); $('#pageGenerator').classList.remove('hidden');
    $('#tabLibrary').classList.remove('active'); $('#tabGenerator').classList.add('active');
  }
}
$('#tabLibrary').addEventListener('click',()=>showPage('lib'));
$('#tabGenerator').addEventListener('click',()=>showPage('gen'));

$('#langBtn').addEventListener('click',()=>{
  LANG = (LANG==='en'?'ko':'en');
  applyLang();
  renderStrip();
  if(!STATE.currentTrack) statusBlank();
});

const menuBtn = $('#menuBtn'), menuDrop = $('#menuDrop'), backdrop=$('#backdrop'), modal=$('#modal');
menuBtn.addEventListener('click',()=>{
  const v = menuDrop.style.display==='block' ? 'none' : 'block';
  menuDrop.style.display=v;
});
backdrop.addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
$('#modalClose').addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
document.querySelectorAll('.menu-text').forEach(a=>{
  a.addEventListener('click', async (e)=>{
    e.preventDefault();
    menuDrop.style.display='none';
    const key = a.dataset.txt;
    const path = `texts/${key}.txt`;
    try{
      const res = await fetch(path+'?v='+Date.now());
      const txt = await res.text();
      $('#modalTitle').textContent = (a.textContent||'Info');
      $('#modalBody').textContent = txt;
      backdrop.style.display='block'; modal.style.display='block';
    }catch(err){
      $('#modalTitle').textContent = 'Error';
      $('#modalBody').textContent = 'Failed to load.';
      backdrop.style.display='block'; modal.style.display='block';
    }
  });
});

/* ===== Player controls & nav ===== */
$('#btnPlay').addEventListener('click',()=>{ player.play(); statusTitle.classList.add('playing'); });
$('#btnPause').addEventListener('click',()=>{ player.pause(); statusTitle.classList.remove('playing'); });
$('#btnLoop').addEventListener('click',()=>{ player.loop = !player.loop; alert(player.loop ? (LANG==='en'?'Loop On':'루프 켜짐') : (LANG==='en'?'Loop Off':'루프 꺼짐')); });
$('#btnTimer').addEventListener('click',()=>{
  const m = prompt(LANG==='en'?'Sleep timer (minutes)':'수면 타이머 (분)'); 
  const t = Number(m||0); if(!t) return;
  setTimeout(()=>{ player.pause(); statusTitle.classList.remove('playing'); }, t*60000);
});

$('#btnBack').addEventListener('click',()=>{ STATE.path=''; STATE.stack.pop(); renderStrip(); });
$('#btnHome').addEventListener('click',()=>{ STATE.path=''; STATE.stack.length=0; renderStrip(); });
$('#btnRefresh').addEventListener('click',()=>renderStrip());

/* ===== Playlist ===== */
const USER_ID_KEY='fiveDO_user_id';
function uid(){ return 'u'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function getUserId(){ let x=localStorage.getItem(USER_ID_KEY); if(!x){ x=uid(); localStorage.setItem(USER_ID_KEY,x); } return x; }
const USER_ID = getUserId();
const PL_KEY='fiveDO_playlists';
const PL_CLOUD_PATH = `playlists/${USER_ID}.json`;
function nowISO(){ return new Date().toISOString(); }
function newPLState(){ return {version:1,updatedAt:nowISO(),lists:[]}; }
function loadPLLocal(){ try{ return JSON.parse(localStorage.getItem(PL_KEY)||''); }catch{ return null; } }
function savePLLocal(obj){ try{ obj.updatedAt=nowISO(); localStorage.setItem(PL_KEY, JSON.stringify(obj)); }catch{} }
async function loadPLCloud(){
  const url = `${MEDIA_BASE}/${PL_CLOUD_PATH}`;
  try{ const res = await fetch(url+'?t='+Date.now(), {cache:'no-store'}); if(!res.ok) return null; return await res.json(); }
  catch{ return null; }
}
async function savePLCloud(obj){
  try{
    const { error } = await SB.storage.from(BUCKET)
      .upload(PL_CLOUD_PATH, new Blob([JSON.stringify(obj)], {type:'application/json'}), { upsert:true });
    if(error) throw error;
    return true;
  }catch(e){ console.warn('[playlist] cloud save failed', e); return false; }
}
async function syncPlaylists(){
  let local = loadPLLocal();
  let cloud = await loadPLCloud();
  if(!local && !cloud){
    local = newPLState(); savePLLocal(local); await savePLCloud(local); return local;
  }
  if(local && !cloud){ await savePLCloud(local); return local; }
  if(!local && cloud){ savePLLocal(cloud); return cloud; }
  const L = new Date(local.updatedAt||0).getTime();
  const C = new Date(cloud.updatedAt||0).getTime();
  const base = (C>L)? cloud : local;
  savePLLocal(base); if(C<L) await savePLCloud(base);
  return base;
}
let PL_STATE=null;
const plPanel = document.getElementById('plPanel'), plBody=document.getElementById('plBody');
function openPlPanel(){ plPanel.style.display='block'; renderPL(); }
function closePlPanel(){ plPanel.style.display='none'; }
function renderPL(){
  plBody.innerHTML='';
  const lists = (PL_STATE?.lists)||[];
  if(lists.length===0){
    const row=document.createElement('div'); row.className='pl-row';
    row.textContent=(LANG==='en'? I18N.en['pl.no'] : I18N.ko['pl.no']);
    plBody.appendChild(row);
    return;
  }
  lists.forEach((pl,i)=>{
    const row=document.createElement('div'); row.className='pl-row';
    const name=document.createElement('input'); name.className='gen-input'; name.value=pl.name||('List '+(i+1));
    const cnt=document.createElement('div'); cnt.style.opacity=.7; cnt.textContent=`${pl.items?.length||0} ${LANG==='en'?'tracks':'곡'}`;
    const left=document.createElement('div'); left.style.display='flex'; left.style.gap='10px'; left.append(name,cnt);
    const del=document.createElement('button'); del.className='btn small'; del.textContent=(LANG==='en'?I18N.en['pl.delete']:I18N.ko['pl.delete']);
    del.addEventListener('click',()=>{ PL_STATE.lists.splice(i,1); renderPL(); });
    row.append(left,del);
    name.addEventListener('input',()=>{ pl.name=name.value; });
    plBody.appendChild(row);
  });
}
document.getElementById('plNewBtn').addEventListener('click',()=>{ PL_STATE.lists.push({id:'pl_'+Date.now(),name:(LANG==='en'?I18N.en['pl.new']:I18N.ko['pl.new']),items:[]}); renderPL(); });
document.getElementById('plExportBtn').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(PL_STATE,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='playlists.json'; a.click();
});
document.getElementById('plImportBtn').addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; try{ const text=await f.text(); const json=JSON.parse(text); if(json?.lists){ PL_STATE=json; renderPL(); } }catch(e){ console.warn('import failed', e); } };
  inp.click();
});
document.getElementById('plSaveBtn').addEventListener('click', async ()=>{ savePLLocal(PL_STATE); await savePLCloud(PL_STATE); closePlPanel(); });
document.getElementById('plCloseBtn').addEventListener('click', closePlPanel);
window.openPlPanel = openPlPanel;

/* ===== Generator (WebAudio) ===== */
let aCtx=null, analyser=null;
let oscNodes=[];
let zoom = 1, gamma = 1, line = 1;   // ★ 기본값 추가
const cvs = document.getElementById('osc'), ctx2d = cvs.getContext('2d');
let rafId = 0;

function drawOsc(){
  const W=cvs.width= cvs.clientWidth; const H=cvs.height = cvs.clientHeight;
  ctx2d.clearRect(0,0,W,H);
  if(!analyser){ cancelAnimationFrame(rafId); return; }
  const color = document.getElementById('oscColor').value;
 
  const buf = new Uint8Array(1024); analyser.getByteTimeDomainData(buf);
  ctx2d.lineWidth=line; ctx2d.strokeStyle=color; ctx2d.beginPath();
  const step = Math.max(1, Math.floor(buf.length/(W/zoom))); let x=0;
  for(let i=0;i<buf.length;i+=step){
    const t = Math.pow(buf[i]/255, gamma);
    const y = t*H;
    if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    x += zoom; if(x>W) break;
  }
  ctx2d.stroke();
  rafId = requestAnimationFrame(drawOsc);
}
function clearOsc(){ cancelAnimationFrame(rafId); ctx2d.clearRect(0,0,cvs.width,cvs.height); }

function stopGen(){
  try{ oscNodes.forEach(n=>{ try{n.stop()}catch{} try{n.node?.stop?.()}catch{} }); }catch{}
  try{ oscNodes.forEach(n=> n.disconnect && n.disconnect()); }catch{}
  oscNodes=[];
  if(analyser){ try{ analyser.disconnect(); }catch{} analyser=null; }
  clearOsc();
}
function playGen(){
  if(!aCtx) aCtx = new (window.AudioContext||window.webkitAudioContext)();
  stopGen();

  const wf   = document.getElementById('wf').value;
  const f0   = parseFloat(document.getElementById('freq').value)||0;
  const bina = document.getElementById('binEnable').checked;
  const diff = parseFloat(document.getElementById('binDiff').value)||0;
  const duty = Math.max(1, Math.min(100, parseInt(document.getElementById('duty').value||'50',10)));
  const hEn  = document.getElementById('harmEnable').checked;
  const hBase= document.getElementById('harmBase').value;
  const hOct = parseInt(document.getElementById('harmOct').value||'0',10);

  const baseMul = (hBase==='mid'?2:(hBase==='high'?4:1));
  const baseFreq = f0 * baseMul;

  const merger = aCtx.createChannelMerger(2);
  analyser = aCtx.createAnalyser(); analyser.fftSize=2048;

  const mkOsc = (freq)=>{
    const o = aCtx.createOscillator();
    o.type = (wf==='square'?'square':(wf==='triangle'?'triangle':(wf==='sawtooth'?'sawtooth':'sine')));
    o.frequency.value = Math.max(0,freq);
    let node = o;
    if(wf==='square'){
      const shaper = aCtx.createWaveShaper();
      const curve = new Float32Array(256);
      const th = (duty/100)*2-1;
      for(let i=0;i<256;i++){ const x=i/128-1; curve[i] = (x<th)? -1 : 1; }
      shaper.curve = curve;
      o.connect(shaper);
      node = shaper;
    }
    const g = aCtx.createGain(); g.gain.value = 0.2;
    node.connect(g);
    return {osc:o, node:g};
  };

  const gens = [];
  const leftBase  = baseFreq;
  const rightBase = bina ? Math.max(0, baseFreq + diff) : baseFreq;

  const buildChannel = (base, chIndex)=>{
    gens.push(mkOsc(base));
    if(hEn){
      for(let k=1;k<=hOct;k++){
        gens.push(mkOsc(base*Math.pow(2,k)));
      }
    }
    gens.slice(- (hEn? (1+hOct) : 1)).forEach(g=> g.node.connect(merger,0,chIndex));
  };
  buildChannel(leftBase, 0);
  buildChannel(rightBase,1);

  merger.connect(analyser).connect(aCtx.destination);
  gens.forEach(g=>{ try{g.osc.start()}catch{} oscNodes.push(g.osc); });

  drawOsc();
}

document.getElementById('genPlay').addEventListener('click', async ()=>{
  try{ if(aCtx && aCtx.state==='suspended') await aCtx.resume(); }catch{}
  playGen();
});
document.getElementById('genStop').addEventListener('click', stopGen);

/* live param updates */
['freq','freqRange','wf','binEnable','binDiff','duty','dutyNum','harmEnable','harmBase','harmOct']
.forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  const evt = (el.tagName==='SELECT' || el.type==='checkbox') ? 'change' : 'input';
  el.addEventListener(evt, e=>{
    if(id==='freq'){ $('#freqRange').value = e.target.value; }
    if(id==='freqRange'){ $('#freq').value = e.target.value; }
    if(id==='duty'){ $('#dutyNum').value = e.target.value; }
    if(id==='dutyNum'){ $('#duty').value = e.target.value; }
    if(aCtx && aCtx.state==='running') playGen();
  });
});

['oscColor'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input', ()=>{});
  el.addEventListener('change', ()=>{});
});

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadTrackMeta();   // ★ meta.json 먼저 로딩
  applyLang();

  const unlock=()=>{ try{ player.play().then(()=>player.pause()).catch(()=>{}); }catch(_){} window.removeEventListener('touchend',unlock); window.removeEventListener('click',unlock); };
  window.addEventListener('touchend',unlock,{once:true}); window.addEventListener('click',unlock,{once:true});

  window.PL_STATE = await syncPlaylists();

  STATE.path=''; STATE.stack=[];
  await renderStrip();
  statusBlank();

  showPage('lib');
});
</script>

<!-- === WebP thumb loader (no JPG/PNG fallback) === -->
<script>
(function(){
  function buildThumbCandidates(src, lang){
    try{
      const u = new URL(src, location.href);
      const q = new URLSearchParams(u.search);
      const base = u.pathname.replace(/\.(webp|jpg|jpeg|png)$/i, '');
      const hasE  = /_e$/i.test(base);
      const suffixes = (lang === 'en')
        ? (hasE ? [""] : ["_e", ""])
        : (hasE ? ["", "_e"] : ["", "_e"]);
      const mk = (ext, suf) => {
        const p = base.replace(/_e$/i,'') + suf + '.' + ext;
        const uu = new URL(u.origin + p);
        const qq = new URLSearchParams(q.toString());
        if (!qq.get('format')) qq.set('format','webp');
        if (!qq.get('quality')) qq.set('quality','70');
        if (!qq.get('width')) qq.set('width','300');
        uu.search = '?' + qq.toString();
        return uu.toString();
      };
      const list = [];
      suffixes.forEach(s => list.push(mk('webp', s)));
      return [...new Set(list)];
    }catch(e){
      return [src];
    }
  }

  function setBGWithFallback(el, urls, i=0){
    if (!el || i>=urls.length){ if(el) el.setAttribute('data-loaded','fail'); return; }
    const test = new Image();
    test.onload = ()=>{ el.style.backgroundImage = `url("${urls[i]}")`; el.setAttribute('data-loaded','1'); };
    test.onerror= ()=> setBGWithFallback(el, urls, i+1);
    test.referrerPolicy = 'no-referrer';
    test.decoding = 'async';
    test.src = urls[i];
  }

  function lazyLoadThumbs(){
    const lang = (window.LANG || (document.documentElement.lang==='en'?'en':'ko')) || 'ko';
    document.querySelectorAll('.thumb[data-src]:not([data-loaded])').forEach(th => {
      const src = th.getAttribute('data-src');
      if (!src) return;
      const list = buildThumbCandidates(src, lang);
      setBGWithFallback(th, list, 0);
    });
  }

  window.addEventListener('DOMContentLoaded', lazyLoadThumbs, {once:true});
  window.addEventListener('load', lazyLoadThumbs);
  document.addEventListener('scroll', ()=>{
    if (window.__ll_t) return;
    window.__ll_t = setTimeout(()=>{ window.__ll_t=null; lazyLoadThumbs(); }, 120);
  }, {passive:true});

  window.setStatusThumb = function(div, src){
    const lang = (window.LANG || 'ko');
    const list = buildThumbCandidates(src, lang);
    setBGWithFallback(div, list, 0);
  };
  window.lazyLoadThumbs = lazyLoadThumbs;
})();
</script>

<!-- === 5DO Level-1 Memory Cache (folders/tracks/thumbs) === -->
<script>
(function(){
  const MC = window.__MEMCACHE__ = {
    root: null,
    folders: {},
    thumbs: new Map()
  };

  function deepClone(v){
    try { return structuredClone(v); } catch(e){
      return JSON.parse(JSON.stringify(v));
    }
  }

  function wrapRoot(fn){
    return async function(){
      if (MC.root) return deepClone(MC.root);
      const data = await fn.apply(this, arguments);
      MC.root = data;
      return deepClone(data);
    };
  }
  function wrapFolder(fn){
    return async function(path){
      const key = String(path || "");
      if (MC.folders[key]) return deepClone(MC.folders[key]);
      const data = await fn.apply(this, arguments);
      MC.folders[key] = data;
      return deepClone(data);
    };
  }

  if (typeof window.listRoot === 'function'){
    window.listRoot = wrapRoot(window.listRoot);
  }
  if (typeof window.listFolder === 'function'){
    window.listFolder = wrapFolder(window.listFolder);
  } else if (typeof window.loadFolder === 'function'){
    window.loadFolder = wrapFolder(window.loadFolder);
  }

  (function(){
    const orig = window.setBGWithFallback;
    if (!orig){
      window.setBGWithFallback = function(el, urls, i=0){
        if (!el || i>=urls.length){ if (el) el.setAttribute('data-loaded','fail'); return; }
        const u = urls[i];
        if (MC.thumbs.has(u)){
          el.style.backgroundImage = `url("${MC.thumbs.get(u)}")`;
          el.setAttribute('data-loaded','1');
          return;
        }
        const img = new Image();
        img.onload = function(){
          MC.thumbs.set(u, img.src);
          el.style.backgroundImage = `url("${img.src}")`;
          el.setAttribute('data-loaded','1');
        };
        img.onerror = function(){ window.setBGWithFallback(el, urls, i+1); };
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        img.src = u;
      };
      return;
    }

    window.setBGWithFallback = function(el, urls, i=0){
      if (!el || i>=urls.length){ if (el) el.setAttribute('data-loaded','fail'); return; }
      const u = urls[i];

      if (MC.thumbs.has(u)){
        el.style.backgroundImage = `url("${MC.thumbs.get(u)}")`;
        el.setAttribute('data-loaded','1');
        return;
      }

      const before = el.style.backgroundImage;
      const obs = new MutationObserver(()=>{
        const bi = el.style.backgroundImage;
        if (bi && bi !== before){
          const m = bi.match(/url\(["']?(.*?)["']?\)/i);
          if (m && m[1]) MC.thumbs.set(u, m[1]);
          obs.disconnect();
        }
      });
      try{ obs.observe(el, {attributes:true, attributeFilter:['style']}); }catch(e){}
      orig(el, urls, i);
    };
  })();

  window.clear5DOMemoryCaches = function(){
    MC.root = null;
    MC.folders = {};
    MC.thumbs.clear();
  };
})();
</script>
	
</body>
</html>

<script>
  // PWA용 서비스 워커 등록
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('5DO service worker registered:', reg.scope);
        })
        .catch(err => {
          console.warn('Service worker registration failed:', err);
        });
    });
  }
</script>
</div>
</body>
</html>
</body>
</html>
