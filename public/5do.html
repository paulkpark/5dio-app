<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>5DO Lite</title>
<link rel="preconnect" href="https://xdjgumqdwedgzwqturcx.supabase.co">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#0b0d13;--panel:#12141b;--border:#222738;--accent:#9cff8b;
  --card:#181b25;--ink:#e5e7eb;--muted:#9aa3b7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}

/* Header */
header{
  position:sticky;top:0;z-index:5;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)
}
.logo{font-weight:700;color:var(--accent);font-size:1.2rem}
.lang-toggle-wrap{display:flex;align-items:center;gap:8px}
#langToggle{
  font:600 12px/1.2 system-ui,-apple-system,'Noto Sans KR',Arial;
  padding:6px 10px;border-radius:8px;border:1px solid #2a3044;
  background:#141927;color:#e6f1ff;cursor:pointer
}

/* Hamburger */
.nav-toggle{display:none}
.hamburger{width:36px;height:32px;border-radius:8px;border:1px solid var(--border);
  background:#1c2130;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:8px}
.hamburger span,.hamburger span:before,.hamburger span:after{
  display:block;background:#cfd6e6;height:2px;width:18px;position:relative;border-radius:2px}
.hamburger span:before,.hamburger span:after{content:"";position:absolute;left:0}
.hamburger span:before{top:-6px}.hamburger span:after{top:6px}

/* Side menu (ê¸°ë³¸ ë‹«í˜, ì²´í¬ë˜ë©´ ì—´ë¦¼) */
.side-menu{position:fixed;top:0;left:0;width:33%;max-width:220px;height:100vh;background:#0f1320;
  border-right:1px solid var(--border);padding:14px;overflow-y:auto;transform:translateX(-100%);
  transition:.25s ease;display:flex;flex-direction:column;gap:8px;z-index:1001}
#navToggle:checked ~ nav.side-menu { transform:none; }
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
#navToggle:checked ~ .backdrop { display:block; }
.mbtn{padding:10px;border:1px solid var(--border);background:#171d2b;color:#dfe7f6;
  border-radius:10px;text-align:left;width:100%}

/* Oscilloscope */
#osc{width:100%;height:120px;background:#090b11;display:block;border-bottom:1px solid var(--border)}

/* Library */
#navBtns{display:flex;justify-content:center;gap:10px;padding:8px}
.icon-btn{
  font-size:18px;width:36px;height:36px;border-radius:10px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #2a3044;background:#121829;color:#e6f1ff;cursor:pointer
}
#library{display:flex;overflow-x:auto;gap:10px;padding:10px;scroll-behavior:smooth;scroll-snap-type:x mandatory}
.card{flex:0 0 auto;width:160px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;scroll-snap-align:start}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#0e1016;border-radius:8px}

/* Controls */
.controls{
  display:flex;flex-direction:column;gap:10px;padding:12px;background:#0f1320;border-top:1px solid var(--border)
}
.status{display:flex;align-items:center;justify-content:flex-start;gap:20px;margin-bottom:10px;}
/* Aì•ˆ: ì€ì€í•œ ë¸”ëŸ¬ ê¸€ë¡œìš° ë¡œë”© ì¸ë„¤ì¼ */
#statusThumb{
  width:124px;height:124px;border-radius:16px;position:relative;overflow:hidden;
  background: radial-gradient(circle at center, #1a1f2f 40%, #0d0f18 100%);
  border: 1px solid #2d334a;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 12px rgba(80,180,255,0.15);
  background-size:cover;background-position:center;
}
#statusThumb::before{
  content:'';position:absolute;inset:0;border-radius:50%;
  background: radial-gradient(circle, rgba(100,200,255,0.25), transparent 60%);
  animation:pulse 2s infinite ease-in-out;
}
@keyframes pulse{0%,100%{transform:scale(0.8);opacity:0.5;}50%{transform:scale(1.1);opacity:1;}}
.ctrl-stack{display:flex;flex-direction:column;justify-content:center;gap:8px;}
.ctrl-line{display:flex;align-items:center;gap:10px}
input[type="range"]{width:140px}
audio{width:92%;display:block;margin:10px auto}
</style>
</head>
<body>
<!-- ê¸°ë³¸ ë‹«í˜ -->
<input id="navToggle" class="nav-toggle" type="checkbox">

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <label for="navToggle" class="hamburger" aria-label="menu"><span></span></label>
    <div class="logo" data-i18n="title.app">5DO Lite</div>
  </div>
  <div class="lang-toggle-wrap">
    <button id="langToggle">EN</button>
  </div>
</header>

<nav class="side-menu">
  <a class="mbtn" href="https://5dshop.co.kr" target="_blank" data-i18n="menu.shop">Shop</a>
  <a class="mbtn" href="#" data-i18n="menu.faq">FAQ</a>
  <a class="mbtn" href="#" data-i18n="menu.manual">Manual</a>
  <a class="mbtn" href="#" data-i18n="menu.contact">Contact</a>
  <a class="mbtn" href="#" data-i18n="menu.about">About</a>
</nav>
<div class="backdrop" id="backdrop"></div>

<canvas id="osc"></canvas>
<div id="navBtns">
  <button id="navBack" class="icon-btn" title="Back" aria-label="Back">â¬…ï¸</button>
  <button id="navRefresh" class="icon-btn" title="Refresh" aria-label="Refresh">ğŸ”„</button>
</div>
<div id="library"></div>

<div class="controls">
  <div class="status">
    <div id="statusThumb" aria-label="status thumbnail"></div>
    <div class="ctrl-stack">
      <div class="ctrl-line"><label for="vol" data-i18n="controls.volume">Volume</label><input id="vol" type="range" min="0" max="1" step="0.01" value="1"></div>
      <div class="ctrl-line"><label><input type="checkbox" id="loop"> <span data-i18n="controls.loop">Loop</span></label></div>
      <div class="ctrl-line"><label for="timer" data-i18n="controls.timer">Timer</label>
        <select id="timer">
          <option value="0">Off</option><option value="5">5 min</option><option value="10">10 min</option>
          <option value="15">15 min</option><option value="20">20 min</option><option value="30">30 min</option>
          <option value="45">45 min</option><option value="60">60 min</option>
        </select>
      </div>
    </div>
  </div>
</div>

<audio id="player" controls preload="none" playsinline controlslist="nodownload noplaybackrate"></audio>

<script>
/* ===== Supabase ì ‘ì† ì„¤ì • ===== */
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const PUBLIC_BASE = SUPABASE_URL.replace(/\/+$/,'') + "/storage/v1/object/public/" + BUCKET + "/";

/* ===== ì—˜ë¦¬ë¨¼íŠ¸ ===== */
const lib = document.getElementById("library");
const btnBack = document.getElementById("navBack");
const btnRefresh = document.getElementById("navRefresh");
const statusThumb = document.getElementById("statusThumb");
const player = document.getElementById("player");
const loopChk = document.getElementById("loop");
const vol = document.getElementById("vol");
const timerSel = document.getElementById("timer");

/* ===== ì˜¤ë””ì˜¤ íŒŒì´í”„ë¼ì¸ ===== */
player.crossOrigin = "anonymous";
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const mediaNode = audioCtx.createMediaElementSource(player);
const gainNode = audioCtx.createGain();
const analyser = audioCtx.createAnalyser();
mediaNode.connect(gainNode);
gainNode.connect(analyser);
analyser.connect(audioCtx.destination);

/* ë³¼ë¥¨/ë®¤íŠ¸ ìƒíƒœ ì¼ì¹˜ */
let desiredGain = +vol.value || 1;
gainNode.gain.value = desiredGain;
player.muted = false;

vol.addEventListener("input", () => {
  desiredGain = +vol.value;
  if (!player.muted) gainNode.gain.value = desiredGain;
});
player.addEventListener("volumechange", () => {
  gainNode.gain.value = player.muted ? 0 : desiredGain;
});

/* ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ ì˜¤ë””ì˜¤ ì–¸ë½ */
function ensureAudioUnlocked(){
  if (audioCtx.state !== "running") audioCtx.resume();
}
document.addEventListener("pointerdown", ensureAudioUnlocked, { once:true });
player.addEventListener("play", ensureAudioUnlocked);

/* ë£¨í”„/íƒ€ì´ë¨¸ */
player.loop = loopChk.checked;
loopChk.onchange = () => (player.loop = loopChk.checked);

let timerId = null;
timerSel.onchange = () => {
  clearTimeout(timerId);
  const min = +timerSel.value;
  if (min > 0) timerId = setTimeout(() => { player.pause(); player.currentTime = 0; alert("Playback stopped after timer."); }, min*60000);
};

/* ===== ì˜¤ì‹¤ë¡œìŠ¤ì½”í”„ ===== */
analyser.fftSize = 2048;
const oscCanvas = document.getElementById("osc");
const ctx = oscCanvas.getContext("2d");
const buf = new Uint8Array(analyser.fftSize);
function resizeOsc(){ oscCanvas.width = oscCanvas.clientWidth; oscCanvas.height = 120; }
window.addEventListener("resize", resizeOsc);
resizeOsc();
(function draw(){
  requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(buf);
  ctx.fillStyle = "#090b11";
  ctx.fillRect(0,0,oscCanvas.width,oscCanvas.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#9cff8b";
  ctx.beginPath();
  const slice = oscCanvas.width / buf.length;
  for(let i=0,x=0;i<buf.length;i++,x+=slice){
    const y = (buf[i]/128)*(oscCanvas.height/2);
    i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
  }
  ctx.lineTo(oscCanvas.width, oscCanvas.height/2);
  ctx.stroke();
})();

/* ===== ë¼ì´ë¸ŒëŸ¬ë¦¬ ===== */
let cwd = "";
const enc = s => s.split("/").filter(Boolean).map(encodeURIComponent).join("/");
const abs = p => PUBLIC_BASE + enc(p);

/* Aì•ˆ setStatus: ì´ë¯¸ì§€ëŠ” ë°°ê²½ìœ¼ë¡œ, ì—†ìœ¼ë©´ ê¸€ë¡œìš° */
const setStatus = (img)=>{
  if(!img){
    statusThumb.style.background = "radial-gradient(circle at center, #1a1f2f 40%, #0d0f18 100%)";
    statusThumb.style.boxShadow = "0 0 12px rgba(80,180,255,0.15)";
    statusThumb.style.border = "1px solid #2d334a";
    statusThumb.style.backgroundImage = "";
  }else{
    statusThumb.style.background = "none";
    statusThumb.style.boxShadow = "none";
    statusThumb.style.border = "1px solid rgba(255,255,255,0.12)";
    statusThumb.style.backgroundImage = `url('${img}')`;
  }
};

/* Supabase list */
async function list(path=""){
  const { data, error } = await sb.storage.from(BUCKET).list(path, { limit:1000, sortBy:{ column:"name", order:"asc" } });
  if (error) { console.warn("[list:error]", error); return []; }
  return data || [];
}

/* í´ë”/íŒŒì¼ ë¡œë“œ (ì¸ë„¤ì¼ í´ë¦­ ì‹œ ìë™ì¬ìƒ ê¸ˆì§€: ì‚¬ìš©ìê°€ <audio> í”Œë ˆì´ ë²„íŠ¼ì„ ëˆ„ë¥´ê²Œ) */
async function load(path=""){
  cwd = path;
  lib.innerHTML = "";
  setStatus("");
  const rows = await list(path);

  for(const e of rows){
    const name = e.name;
    const full = (path? path + "/" : "") + name;

    if (!name.includes(".")){
      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = abs(full + "/folder.png");
      img.onerror = ()=> img.src = "https://placehold.co/300x300/111/aaa?text=Folder";
      card.onclick = ()=> { ensureAudioUnlocked(); load(full); };
      card.append(img); lib.append(card);
      continue;
    }

    if (/\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(name)){
      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.loading = "lazy";
      const thumb = full.replace(/\.[^.]+$/, ".png");
      img.src = abs(thumb);
      img.onerror = ()=> img.src = "https://placehold.co/300x300/222/888?text=Audio";
      card.onclick = ()=> {
        ensureAudioUnlocked();
        player.pause();
        player.currentTime = 0;
        player.src = abs(full);
        setStatus(abs(thumb));
        // ìë™ì¬ìƒ ê¸ˆì§€: í”Œë ˆì´ ë²„íŠ¼ì€ ì‚¬ìš©ìê°€ ëˆ„ë¦„
      };
      card.append(img); lib.append(card);
    }
  }
}

/* ë‚´ë¹„ê²Œì´ì…˜ */
btnBack.onclick = ()=>{
  if (!cwd) return;
  const seg = cwd.split("/"); seg.pop();
  load(seg.join("/"));
};
btnRefresh.onclick = ()=> load(cwd);

/* ì¸ë„¤ì¼ ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ */
let isDown=false, startX=0, startL=0;
lib.addEventListener("mousedown", e=>{ isDown=true; startX=e.pageX; startL=lib.scrollLeft; });
["mouseleave","mouseup"].forEach(ev=> lib.addEventListener(ev, ()=>{ isDown=false; }));
lib.addEventListener("mousemove", e=>{ if(!isDown) return; lib.scrollLeft = startL - (e.pageX - startX)*1.5; });

/* í–„ë²„ê±° ë‹«í˜ ì²˜ë¦¬ */
const navToggle = document.getElementById("navToggle");
const backdrop = document.getElementById("backdrop");
const sideMenu = document.querySelector("nav.side-menu");
backdrop?.addEventListener("click", ()=> navToggle.checked=false);
sideMenu?.addEventListener("click", e=>{ const a=e.target.closest("a"); if(a) navToggle.checked=false; });

/* EN/KO í† ê¸€ */
const I18N = {
  en:{'title.app':'5DO Lite','menu.shop':'Shop','menu.faq':'FAQ','menu.manual':'Manual','menu.contact':'Contact','menu.about':'About','controls.volume':'Volume','controls.loop':'Loop','controls.timer':'Timer'},
  ko:{'title.app':'5DO ë¼ì´íŠ¸','menu.shop':'ìƒµ','menu.faq':'FAQ','menu.manual':'ë§¤ë‰´ì–¼','menu.contact':'ë¬¸ì˜','menu.about':'ì†Œê°œ','controls.volume':'ë³¼ë¥¨','controls.loop':'ë°˜ë³µ','controls.timer':'íƒ€ì´ë¨¸'}
};
const LS_KEY='5do.lang';
const langToggle = document.getElementById('langToggle');
function currentLang(){ return localStorage.getItem(LS_KEY) || 'en'; }
function applyI18n(lang){
  const dict = I18N[lang] || I18N.en;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n'); if(dict[k]) el.textContent = dict[k];
  });
  if (langToggle) langToggle.textContent = (lang==='en'?'EN':'KO');
}
applyI18n(currentLang());
langToggle?.addEventListener('click', ()=>{
  const next = currentLang()==='en' ? 'ko' : 'en';
  localStorage.setItem(LS_KEY, next);
  applyI18n(next);
});

/* ìµœì´ˆ ë¡œë“œ */
load("");
</script>
</body>
</html>
