<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>5DO Lite</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#0b0d13;--panel:#12141b;--border:#222738;--accent:#9cff8b;
  --card:#181b25;--ink:#e5e7eb;--muted:#9aa3b7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}

/* Header */
header{
  position:sticky;top:0;z-index:5;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)
}
.logo{font-weight:700;color:var(--accent);font-size:1.2rem}
.lang-toggle-wrap{display:flex;align-items:center;gap:8px}
#langToggle{
  font:600 12px/1.2 system-ui,-apple-system,'Noto Sans KR',Arial;
  padding:6px 10px;border-radius:8px;border:1px solid #2a3044;
  background:#141927;color:#e6f1ff;cursor:pointer
}

/* Hamburger */
.nav-toggle{display:none}
.hamburger{width:36px;height:32px;border-radius:8px;border:1px solid var(--border);
  background:#1c2130;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:8px}
.hamburger span,.hamburger span:before,.hamburger span:after{
  display:block;background:#cfd6e6;height:2px;width:18px;position:relative;border-radius:2px}
.hamburger span:before,.hamburger span:after{content:"";position:absolute;left:0}
.hamburger span:before{top:-6px}.hamburger span:after{top:6px}

/* Side menu */
.side-menu{position:fixed;top:0;left:0;width:33%;max-width:220px;height:100vh;background:#0f1320;
border-right:1px solid var(--border);padding:14px;overflow-y:auto;transform:translateX(-100%);
transition:.25s ease;display:flex;flex-direction:column;gap:8px;z-index:1001}
#navToggle:checked ~ nav.side-menu {transform:none;}
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
#navToggle:checked ~ .backdrop {display:block;}
.mbtn{padding:10px;border:1px solid var(--border);background:#171d2b;color:#dfe7f6;
border-radius:10px;text-align:left;width:100%}

/* Oscilloscope */
#osc{width:100%;height:120px;background:#090b11;display:block;border-bottom:1px solid var(--border)}

/* Library */
#navBtns{display:flex;justify-content:center;gap:10px;padding:8px}
.icon-btn{
  font-size:18px;width:36px;height:36px;border-radius:10px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #2a3044;background:#121829;color:#e6f1ff;cursor:pointer
}
#library{display:flex;overflow-x:auto;gap:10px;padding:10px;scroll-behavior:smooth;scroll-snap-type:x mandatory}
.card{flex:0 0 auto;width:160px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;scroll-snap-align:start}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#0e1016;border-radius:8px}

/* Controls */
.controls{
  display:flex;flex-direction:column;gap:10px;padding:12px;background:#0f1320;border-top:1px solid var(--border)
}
.status{
  display:flex;align-items:center;justify-content:flex-start;gap:20px;margin-bottom:10px;
}
#statusThumb{
  width:124px;height:124px;object-fit:cover;border-radius:10px;background:#000;
  border:1px solid rgba(255,255,255,0.12);
}
.ctrl-stack{
  display:flex;flex-direction:column;justify-content:center;gap:8px;
}
.ctrl-line{display:flex;align-items:center;gap:10px}
input[type="range"]{width:140px}
audio{width:92%;display:block;margin:10px auto}
</style>
</head>
<body>
<input id="navToggle" class="nav-toggle" type="checkbox">
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <label for="navToggle" class="hamburger" aria-label="menu"><span></span></label>
    <div class="logo" data-i18n="title.app">5DO Lite</div>
  </div>
  <div class="lang-toggle-wrap">
    <button id="langToggle">EN</button>
  </div>
</header>

<nav class="side-menu">
  <a class="mbtn" href="https://5dshop.co.kr" target="_blank" data-i18n="menu.shop">Shop</a>
  <a class="mbtn" href="#" data-i18n="menu.faq">FAQ</a>
  <a class="mbtn" href="#" data-i18n="menu.manual">Manual</a>
  <a class="mbtn" href="#" data-i18n="menu.contact">Contact</a>
  <a class="mbtn" href="#" data-i18n="menu.about">About</a>
</nav>
<div class="backdrop" id="backdrop"></div>

<canvas id="osc"></canvas>
<div id="navBtns">
  <button id="navBack" class="icon-btn" title="Back">‚¨ÖÔ∏è</button>
  <button id="navRefresh" class="icon-btn" title="Refresh">üîÑ</button>
</div>
<div id="library"></div>

<div class="controls">
  <div class="status">
    <img id="statusThumb" alt="status">
    <div class="ctrl-stack">
      <div class="ctrl-line"><label for="vol" data-i18n="controls.volume">Volume</label><input id="vol" type="range" min="0" max="1" step="0.01" value="1"></div>
      <div class="ctrl-line"><label><input type="checkbox" id="loop"> <span data-i18n="controls.loop">Loop</span></label></div>
      <div class="ctrl-line"><label for="timer" data-i18n="controls.timer">Timer</label>
        <select id="timer">
          <option value="0">Off</option><option value="5">5 min</option><option value="10">10 min</option>
          <option value="15">15 min</option><option value="20">20 min</option><option value="30">30 min</option>
          <option value="45">45 min</option><option value="60">60 min</option>
        </select>
      </div>
    </div>
  </div>
</div>
<audio id="player" controls preload="none" playsinline controlslist="nodownload noplaybackrate"></audio>

<script>
const SUPABASE_URL="https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET="media";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const PUBLIC=SUPABASE_URL.replace(/\/+$/,'')+"/storage/v1/object/public/"+BUCKET+"/";

const lib=document.getElementById("library"),btnBack=document.getElementById("navBack"),btnRefresh=document.getElementById("navRefresh"),
loopChk=document.getElementById("loop"),vol=document.getElementById("vol"),timerSel=document.getElementById("timer"),
statusThumb=document.getElementById("statusThumb"),player=document.getElementById("player");

player.crossOrigin="anonymous";
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
const src=audioCtx.createMediaElementSource(player);
const gain=audioCtx.createGain();
const analyser=audioCtx.createAnalyser();
src.connect(gain).connect(analyser).connect(audioCtx.destination);

let desiredGain=+vol.value||1;
gain.gain.value=desiredGain;
vol.oninput=()=>{desiredGain=+vol.value;if(!player.muted)gain.gain.value=desiredGain;};
player.addEventListener("volumechange",()=>{gain.gain.value=player.muted?0:desiredGain;});
function ensureAudioUnlocked(){if(audioCtx.state!=="running"){audioCtx.resume();}}
document.addEventListener("pointerdown",ensureAudioUnlocked,{once:true});
player.addEventListener("play",ensureAudioUnlocked);
player.loop=loopChk.checked; loopChk.onchange=()=>player.loop=loopChk.checked;

let timerId=null;
timerSel.onchange=()=>{clearTimeout(timerId);const min=+timerSel.value;
if(min>0){timerId=setTimeout(()=>{player.pause();player.currentTime=0;alert("Playback stopped after timer.");},min*60000);}};

analyser.fftSize=2048;
const buf=new Uint8Array(analyser.fftSize);
const canvas=document.getElementById("osc");const ctx=canvas.getContext("2d");
function resize(){canvas.width=canvas.clientWidth;canvas.height=120;}
window.addEventListener("resize",resize);resize();
(function draw(){requestAnimationFrame(draw);analyser.getByteTimeDomainData(buf);
ctx.fillStyle="#090b11";ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.lineWidth=2;ctx.strokeStyle="#9cff8b";ctx.beginPath();
const slice=canvas.width/buf.length;for(let i=0,x=0;i<buf.length;i++,x+=slice){
const y=(buf[i]/128.0)*(canvas.height/2);i?ctx.lineTo(x,y):ctx.moveTo(x,y);}
ctx.lineTo(canvas.width,canvas.height/2);ctx.stroke();})();

let cwd="";
const enc=s=>s.split("/").filter(Boolean).map(encodeURIComponent).join("/");
async function list(p=""){const{data,error}=await sb.storage.from(BUCKET).list(p,{limit:1000,sortBy:{column:"name",order:"asc"}});if(error)return[];return data||[];}
function abs(p){return PUBLIC+enc(p);}
function setStatus(img){statusThumb.src=img||"";}

async function load(p=""){cwd=p;lib.innerHTML="";setStatus("");
  const d=await list(p);
  for(const e of d){
    const n=e.name;const full=(p?p+"/":"")+n;
    if(!n.includes(".")){
      const c=document.createElement("div");c.className="card";
      const img=document.createElement("img");img.src=abs(full+"/folder.png");
      img.onerror=()=>img.src="https://placehold.co/300x300/111/aaa?text=Folder";
      c.onclick=()=>{ensureAudioUnlocked();load(full);};c.append(img);lib.append(c);continue;
    }
    if(/\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(n)){
      const c=document.createElement("div");c.className="card";
      const img=document.createElement("img");const thumb=full.replace(/\.[^.]+$/,".png");
      img.src=abs(thumb);
      img.onerror=()=>img.src="https://placehold.co/300x300/222/888?text=Audio";
      c.onclick=()=>{ensureAudioUnlocked();player.src=abs(full);setStatus(abs(thumb));};
      c.append(img);lib.append(c);
    }
  }
}
btnBack.onclick=()=>{if(!cwd)return;const a=cwd.split("/");a.pop();load(a.join("/"));};
btnRefresh.onclick=()=>load(cwd);
let isDown=false,startX=0,startL=0;
lib.addEventListener('mousedown',e=>{isDown=true;startX=e.pageX;startL=lib.scrollLeft;});
['mouseleave','mouseup'].forEach(ev=>lib.addEventListener(ev,()=>{isDown=false;}));
lib.addEventListener('mousemove',e=>{if(!isDown)return;lib.scrollLeft=startL-(e.pageX-startX)*1.5;});

/* ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ Îã´Í∏∞ */
const navToggle=document.getElementById('navToggle');
const backdrop=document.getElementById('backdrop');
const sideMenu=document.querySelector('nav.side-menu');
backdrop?.addEventListener('click',()=>navToggle.checked=false);
sideMenu?.addEventListener('click',e=>{
  const a=e.target.closest('a'); if(a) navToggle.checked=false;
});

/* Ïñ∏Ïñ¥ ÌÜ†Í∏Ä */
const I18N={en:{'title.app':'5DO Lite','menu.shop':'Shop','menu.faq':'FAQ','menu.manual':'Manual','menu.contact':'Contact','menu.about':'About','controls.volume':'Volume','controls.loop':'Loop','controls.timer':'Timer'},
ko:{'title.app':'5DO ÎùºÏù¥Ìä∏','menu.shop':'ÏÉµ','menu.faq':'FAQ','menu.manual':'Îß§Îâ¥Ïñº','menu.contact':'Î¨∏Ïùò','menu.about':'ÏÜåÍ∞ú','controls.volume':'Î≥ºÎ•®','controls.loop':'Î∞òÎ≥µ','controls.timer':'ÌÉÄÏù¥Î®∏'}};
const LS_KEY='5do.lang';const langToggle=document.getElementById('langToggle');
function currentLang(){return localStorage.getItem(LS_KEY)||'en';}
function applyI18n(lang){const dict=I18N[lang]||I18N.en;
document.querySelectorAll('[data-i18n]').forEach(el=>{
const k=el.getAttribute('data-i18n');if(dict[k])el.textContent=dict[k];});
if(langToggle)langToggle.textContent=(lang==='en'?'EN':'KO');}
applyI18n(currentLang());
langToggle?.addEventListener('click',()=>{const next=currentLang()==='en'?'ko':'en';
localStorage.setItem(LS_KEY,next);applyI18n(next);});

load("");
</script>
</body>
</html>
