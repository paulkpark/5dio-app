<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>5DO Lite</title>
<link rel="preconnect" href="https://xdjgumqdwedgzwqturcx.supabase.co">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#0b0d13;--panel:#12141b;--border:#222738;--accent:#9cff8b;
  --card:#181b25;--ink:#e5e7eb;--muted:#9aa3b7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}

/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)
}
.logo{font-weight:700;color:var(--accent);font-size:1.2rem}

/* Hamburger */
.nav-toggle{display:none}
.hamburger{width:36px;height:32px;border-radius:8px;border:1px solid var(--border);
  background:#1c2130;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:8px; position:relative;}
.hamburger span,.hamburger span:before,.hamburger span:after{
  display:block;background:#cfd6e6;height:2px;width:18px;position:relative;border-radius:2px}
.hamburger span:before,.hamburger span:after{content:"";position:absolute;left:0}
.hamburger span:before{top:-6px}.hamburger span:after{top:6px}

/* Lang toggle */
.lang-toggle{
  background:#151b24;border:1px solid #2b3249;color:#e7effa;
  padding:4px 8px;border-radius:8px;cursor:pointer
}

/* Side menu */
.side-menu{position:fixed;top:0;left:0;width:33%;max-width:220px;height:100vh;background:#0f1320;
  border-right:1px solid var(--border);padding:14px;overflow-y:auto;transform:translateX(-100%);
  transition:.25s ease;display:flex;flex-direction:column;gap:8px;z-index:1001}
#navToggle:checked ~ nav.side-menu{transform:none;}
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
#navToggle:checked ~ .backdrop{display:block;}
.mbtn{padding:10px;border:1px solid var(--border);background:#171d2b;color:#dfe7f6;
  border-radius:10px;text-align:left;width:100%}

/* Library strip (horizontal scroll) */
#navBtns{display:flex;gap:10px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)}
.icon-btn{background:#141a22;border:1px solid #2b3249;color:#cfead1;border-radius:10px;padding:8px 10px;cursor:pointer}
#library{display:flex;gap:10px;padding:10px;overflow-x:auto;scroll-snap-type:x mandatory}
.card{
  flex:0 0 auto;width:150px;height:150px;border-radius:14px;scroll-snap-align:start;
  background:#0c111a;border:1px solid #2a3044;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;color:#8791a8;font-size:.85rem;
  background-size:cover;background-position:center;
}
.card::before{
  content:'';position:absolute;inset:0;border-radius:inherit;
  background: radial-gradient(circle, rgba(100,200,255,0.25), transparent 60%);
  animation:pulse 2s infinite ease-in-out;
}
.card.loaded::before{display:none;}
@keyframes pulse{0%,100%{transform:scale(0.8);opacity:0.5;}50%{transform:scale(1.1);opacity:1;}}

/* Controls */
.controls{display:flex;flex-direction:column;gap:10px;padding:12px;background:#0f1320;border-top:1px solid var(--border)}
.status{display:flex;align-items:center;gap:20px;margin-bottom:10px;}
#statusThumb{
  width:124px;height:124px;border-radius:16px;position:relative;overflow:hidden;
  background: radial-gradient(circle at center, #1a1f2f 40%, #0d0f18 100%);
  border: 1px solid #2d334a;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 12px rgba(80,180,255,0.15);
  background-size:cover;background-position:center;
}
#statusThumb::before{
  content:'';position:absolute;inset:0;border-radius:50%;
  background: radial-gradient(circle, rgba(100,200,255,0.25), transparent 60%);
  animation:pulse 2s infinite ease-in-out;
}
#statusThumb.loaded::before{display:none;}
.ctrl-stack{display:flex;flex-direction:column;gap:8px;}
.ctrl-line{display:flex;align-items:center;gap:10px}
input[type="range"]{width:160px}
audio{width:92%;display:block;margin:10px auto}

/* Bar Spectrum (always visible monitor under player) */
#barVizWrap{display:block;padding:8px 0;background:#0b0f17;border-top:1px solid #20263a}
#barViz{display:block;width:100%;height:100px}

/* Modal for texts */
#textModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:2000;align-items:center;justify-content:center;}
#textModal .inner{
  background:#0f1320;padding:20px;max-width:90%;max-height:80%;
  border-radius:12px;overflow:auto;color:#e7effa;position:relative;
}
#textModalClose{position:absolute;top:10px;right:12px;background:none;border:none;color:#9cff8b;font-size:18px;cursor:pointer}
</style>
</head>
<body>
<input id="navToggle" class="nav-toggle" type="checkbox">

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <label for="navToggle" class="hamburger" id="hambtn"><span></span></label>
    <div class="logo">5DO Lite</div>
  </div>
  <button id="langToggle" class="lang-toggle">EN</button>
</header>

<nav class="side-menu">
  <a class="mbtn" href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
  <a class="mbtn menu-text" href="texts/faq.txt">FAQ</a>
  <a class="mbtn menu-text" href="texts/manual.txt">Manual</a>
  <a class="mbtn menu-text" href="texts/contact.txt">Contact</a>
  <a class="mbtn menu-text" href="texts/about.txt">About</a>
</nav>
<div class="backdrop" id="backdrop"></div>

<div id="navBtns">
  <button id="navBack" class="icon-btn" title="Back">‚¨ÖÔ∏è</button>
  <button id="navRefresh" class="icon-btn" title="Refresh">üîÑ</button>
</div>

<div id="library"></div>

<div class="controls">
  <div class="status">
    <div id="statusThumb" aria-label="loading thumbnail"></div>
    <div class="ctrl-stack">
      <div class="ctrl-line">
        <label for="vol" id="lblVol">Volume</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="ctrl-line">
        <label><input type="checkbox" id="loop"> <span id="lblLoop">Loop</span></label>
      </div>
      <div class="ctrl-line">
        <label for="timer" id="lblTimer">Timer</label>
        <select id="timer">
          <option value="0">Off</option><option value="5">5 min</option>
          <option value="10">10 min</option><option value="15">15 min</option>
          <option value="20">20 min</option><option value="30">30 min</option>
          <option value="45">45 min</option><option value="60">60 min</option>
        </select>
      </div>
    </div>
  </div>
  <audio id="player" controls preload="none" playsinline controlslist="nodownload noplaybackrate"></audio>
</div>

<!-- Bar Spectrum monitor -->
<div id="barVizWrap"><canvas id="barViz"></canvas></div>

<!-- Modal (texts/*.txt) -->
<div id="textModal">
  <div class="inner">
    <button id="textModalClose">‚úï</button>
    <pre id="textModalContent" style="white-space:pre-wrap;font-family:inherit;margin-top:20px;"></pre>
  </div>
</div>

<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = 'https://xdjgumqdwedgzwqturcx.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU';
const BUCKET = 'media';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== UI refs ===== */
const library = document.getElementById('library');
const player = document.getElementById('player');
const vol = document.getElementById('vol');
const loop = document.getElementById('loop');
const timerSel = document.getElementById('timer');
const statusThumb = document.getElementById('statusThumb');
const langToggle = document.getElementById('langToggle');
const navBack = document.getElementById('navBack');
const navRefresh = document.getElementById('navRefresh');
const navT = document.getElementById('navToggle');
const backdrop = document.getElementById('backdrop');

/* ===== State ===== */
let currentPath = '';        // '' = root
let audioCtx, analyser, gainNode, srcNode;
let timerId = null;
let lang = 'KO';             // KO or EN

/* ===== Helpers ===== */
function imgx(path, qs='') {
  // Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò API (jpg Ïö∞ÏÑ† ‚Üí ÏóÜÏúºÎ©¥ png)
  // Ìò∏Ï∂úÎ∂ÄÏóêÏÑú ÌååÏùºÎ™ÖÎßå ÎÑòÍ∏∞Î©¥ Ïó¨Í∏∞ÏÑú jpg‚Üípng Ìè¥Î∞± ÏãúÎèÑ
  const url = new URL(`${SUPABASE_URL}/storage/v1/render/image/public/${BUCKET}/${path}`);
  if(qs) qs.split('&').forEach(p=>{ const [k,v]=p.split('='); url.searchParams.set(k,v); });
  return url.toString();
}
async function headExists(path){
  // Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨Ïó¨Î∂Ä ÌôïÏù∏Ïö© (Îπ†Î•∏ ÏöîÏ≤≠ÏùÑ ÏúÑÌï¥ fetch HEAD ÏÇ¨Ïö©)
  const url = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${path}`;
  try{
    const r = await fetch(url, {method:'HEAD', cache:'no-store'});
    return r.ok;
  }catch(e){ return false; }
}
async function chooseThumb(base, isFolder){
  // Ïñ∏Ïñ¥ Ï†ëÎØ∏ÏÇ¨ Í∑úÏπô: folder: _e (ÏÜåÎ¨∏Ïûê), audio: _E (ÎåÄÎ¨∏Ïûê)
  const suf = isFolder ? (lang==='EN' ? '_e' : '') : (lang==='EN' ? '_E' : '');
  // jpg Ïö∞ÏÑ† ‚Üí png Ìè¥Î∞±
  const jpg = `${base}${suf}.jpg`;
  const png = `${base}${suf}.png`;
  if (await headExists(jpg)) return jpg;
  if (await headExists(png)) return png;
  // ÏµúÌõÑ Ìè¥Î∞±: Ï†ëÎØ∏ÏÇ¨ ÏóÜÎäî Í∏∞Î≥∏ jpg/png
  const jpg0 = `${base}.jpg`, png0 = `${base}.png`;
  if (await headExists(jpg0)) return jpg0;
  if (await headExists(png0)) return png0;
  return null;
}

/* ===== Library listing ===== */
async function listFolder(path){
  const { data, error } = await supa.storage.from(BUCKET).list(path, { limit: 1000 });
  if (error){ console.error(error); return []; }
  // StorageÎäî ÎîîÎ†âÌÜ†Î¶¨ Í∞úÎÖê ÏóÜÏù¥ prefixÎ≥Ñ ÌååÏùº Î™©Î°ùÏùÑ Î∞òÌôò.
  // Í¥ÄÎ°Ä: Ïπ¥ÌÖåÍ≥†Î¶¨ Ìè¥ÎçîÎäî Í∞Å Ìè¥Îçî ÏïàÏóê folder.jpg|png Ï°¥Ïû¨.
  // Ïó¨Í∏∞ÏÑúÎäî ÌïòÏúÑ Ìï≠Î™©ÏùÑ "Ìè¥ÎçîÎ°ú Ï∑®Í∏â"ÌïòÍ∏∞ ÏúÑÌï¥ Ìè¥Îçî ÌõÑÎ≥¥Î•º Ï∂îÏ∂ú:
  //  - ÌòÑÏû¨ path Î∞ëÏùò ÌååÏùº Ï§ë "subdir/file" ÌòïÌÉúÎ•º Î∂ÑÎ¶¨Ìï¥ÏÑú unique Ìè¥ÎçîÎ™Ö ÏàòÏßë
  const folders = new Set();
  const files = [];
  // path=='' Ïù¥Î©¥ Î£®Ìä∏. Ïù¥ Í≤ΩÏö∞, Î£®Ìä∏ÏóêÎäî Î≥¥ÌÜµ ÌïòÏúÑÌè¥ÎçîÎì§Îßå ÏûàÎã§Í≥† Í∞ÄÏ†ïÌïòÍ≥†
  // _folderCandidatesÏóê from(list(''))Î°úÎäî Ìè¥ÎçîÎ•º Î™ª Î∞õÏúºÎãà, known rule: Ìè¥Îçî Ïç∏ÎÑ§Ïùº Ïú†Î¨¥Î°ú ÌåêÏ†ï
  // Í∞ÑÎã®ÌïòÍ≤å: Í∞ôÏùÄ prefixÎ°ú Îã§Ïãú list(sub)/folder.jpg Ï°¥Ïû¨ Ïó¨Î∂ÄÎ°ú Ìè¥Îçî Ï∑®Í∏â
  // Ïö∞ÏÑ† ÌòÑÏû¨ Í≤ΩÎ°úÏùò ÌååÏùºÎì§ push
  for (const it of data){
    if (it.name.includes('/')) {
      folders.add(it.name.split('/')[0]);
    } else {
      // ÌòÑÏû¨ Í≤ΩÎ°úÏóê ÏßÅÏ†ë Ïò¨ÎùºÏò® ÌååÏùºÏù¥Î©¥ Ïò§ÎîîÏò§ ÌååÏùºÎ°ú Ï∑®Í∏â
      files.push({ name: it.name, path: (path? path + '/' : '') + it.name });
    }
  }
  // supabase-js v2Ïùò listÎäî ÌòÑÏû¨ Í≤ΩÎ°úÏùò "ÏßÅÏ†ë ÌååÏùº"Îßå Ï§ÄÎã§Í≥† Î≥º Îïå,
  // Ïã§Ï†ú Ìè¥ÎçîÎäî Ï∂îÍ∞ÄÏ†ÅÏúºÎ°ú Ï∂îÏ∏°Ìï¥Ïïº ÌïúÎã§. Ìè¥Îçî Ïù¥Î¶Ñ Î™©Î°ùÏùÑ ÏñªÍ∏∞ ÏúÑÌï¥
  // ÌùîÌûà ÏÇ¨Ïö©ÎêòÎäî Ìè∞Ìä∏: Ìè¥Îçî Ïù¥Î¶Ñ Î¶¨Ïä§Ìä∏Î•º ÏÑúÎ≤ÑÏóêÏÑú Ï†úÍ≥µÌïòÎ©¥ Ïù¥ÏÉÅÏ†Å.
  // Ïó¨Í∏∞ÏÑúÎäî Í¥ÄÎ°ÄÏ†ÅÏúºÎ°ú Ìè¥Îçî ÌõÑÎ≥¥Î•º ÌååÏùºÎ™ÖÏóêÏÑú Ï∂îÏ∂úÌïòÍ∏∞Î≥¥Îã§Îäî
  // "Ìè¥Îçî Ïç∏ÎÑ§ÏùºÏù¥ Ï°¥Ïû¨ÌïòÎ©¥ Ìè¥Îçî"Î°ú ÌåêÏ†ïÌïòÎäî ÌÉêÏÉâÏùÑ ÏàòÌñâ (ÏÑ±Îä•ÏÉÅ Î¨¥Î¶¨ ÏóÜÏùÑ Ï†ïÎèÑÎ°ú)
  // Îã®, Î£®Ìä∏ÏóêÏÑúÎßå ÎåÄÌëú Ìè¥Îçî Î¶¨Ïä§Ìä∏Î•º ÎØ∏Î¶¨ Íµ¨ÏÑ±
  if (path===''){
    // ÎåÄÎûµÏ†ÅÏù∏ ÌõÑÎ≥¥Îì§: ÏûêÏ£º Ïì∞Îäî Ïπ¥ÌÖåÍ≥†Î¶¨Î™ÖÏùÑ ÌïòÎìú Ï∂îÏ†ïÌïòÏßÄ ÏïäÍ≥†,
    // media/ Ìè¥Îçî ÌïòÏúÑÏùò prefixÎì§ÏùÑ Ï∂îÏ†ïÌïòÍ∏∞ Ïñ¥Î†µÍ∏∞ ÎïåÎ¨∏Ïóê
    // ÎÑêÎ¶¨ Ïì∞Îäî Ìè¥ÎçîÎ™Ö Î™©Î°ùÏùÑ configÎ°ú Î∞õÏïÑÏò§Î©¥ Ï¢ãÏúºÎÇò,
    // Ïó¨Í∏∞ÏÑúÎäî ÏµúÍ∑º ÏÑ±Í≥µ ÏÇ¨Î°ÄÏóê ÎßûÏ∂∞ supabaseÏùò public Ìè¥Îçî Íµ¨Ï°∞Í∞Ä Ïù¥ÎØ∏ Ï†ïÌï¥Ï†∏ ÏûàÎã§Í≥† Í∞ÄÏ†ï.
    // Ìè¥ÎçîÎ•º ÏïåÏïÑÎÇ¥Í∏∞ ÏúÑÌï¥: list('')Î°ú ÏñªÏùÄ ÌååÏùº Ï§ë 'X/folder.jpg|png' ÌòïÏãùÏùÄ Ïò§ÏßÄ ÏïäÏùå.
    // Îî∞ÎùºÏÑú Í∞ÑÎã®Ìïú Î∞©Ïãù: Í¥ÄÎ¶¨Ïûê Ï∏°ÏóêÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ùÏùÑ ÎßåÎì§Ïñ¥ media/_index.txt Îì±ÏúºÎ°ú Ï†úÍ≥µÌïòÎäî Í≤å ÏµúÏÑ†.
    // ÏûÑÏãú Î∞©Ìé∏: Í∞ÄÏû• ÎßéÏù¥ Ïì∞Îäî Ìè¥ÎçîÎì§Îßå Îπ†Î•¥Í≤å Ï†êÍ≤Ä(Ï°¥Ïû¨ÌïòÎäî Í≤ÉÎßå ÎÖ∏Ï∂ú)
    const guess = [
      'Brainwave_States','Crystal_Frequencies','Moldavite','Rose_Quartz',
      'White_Noise','Torus_Harmonics','Scalar_Field_Sync'
    ];
    const exist = [];
    await Promise.all(guess.map(async g=>{
      if (await headExists(`${g}/folder.jpg`) || await headExists(`${g}/folder.png`) ||
          await headExists(`${g}/folder_e.jpg`) || await headExists(`${g}/folder_e.png`)) exist.push(g);
    }));
    return { folders: exist.map(n=>({ name:n, path:n })), files };
  }
  return { folders:[/* ÌïòÏúÑ Ìè¥Îçî ÏóÜÏùå(Í¥ÄÎ°Ä) */], files };
}

function makeCard(label){
  const el = document.createElement('div');
  el.className = 'card';
  el.textContent = label;
  return el;
}

async function renderFolder(path){
  library.innerHTML = '';
  currentPath = path;
  // Ìè¥Îçî/ÌååÏùº ÎÇòÎà†ÏÑú Î°úÎìú
  const { folders, files } = await listFolder(path);

  // Ìè¥Îçî Ïπ¥ÎìúÎì§
  for (const f of folders){
    const card = makeCard('Folder');
    library.appendChild(card);
    // Ïç∏ÎÑ§Ïùº ÏÑ†ÌÉù (Ïñ∏Ïñ¥ Ï†ëÎØ∏ÏÇ¨ + jpg‚Üípng Ìè¥Î∞±)
    const thumbKey = await chooseThumb(`${f.path}/folder`, true);
    if (thumbKey){
      card.style.backgroundImage = `url('${imgx(thumbKey,"width=360&quality=70&format=webp")}')`;
      card.classList.add('loaded');
    }
    card.onclick = ()=> {
      // ÌïòÏúÑÎ°ú ÏßÑÏûÖ
      renderFolder(f.path);
      // Î©îÎâ¥ ÏûêÎèô Îã´Í∏∞
      navT.checked = false;
    }
  }

  // Ïò§ÎîîÏò§ ÌååÏùº Ïπ¥ÎìúÎì§ (mp3Îßå ÎÖ∏Ï∂ú)
  for (const it of files){
    if (!/\.mp3$/i.test(it.name)) continue;
    const base = it.path.replace(/\.mp3$/i,''); // ÌôïÏû•Ïûê Ï†úÍ±∞
    const card = makeCard('Audio');
    library.appendChild(card);

    const thumbKey = await chooseThumb(base, false); // _E Ï≤òÎ¶¨ Ìè¨Ìï®
    if (thumbKey){
      card.style.backgroundImage = `url('${imgx(thumbKey,"width=360&quality=75&format=webp")}')`;
      card.classList.add('loaded');
    }

    card.onclick = async ()=>{
      // ÏûêÎèôÏû¨ÏÉù Í∏àÏßÄ: ÏÜåÏä§Îßå ÍµêÏ≤¥ + load()
      const { data: signed } = supa.storage.from(BUCKET)
        .getPublicUrl(it.path);
      // ÏÉÅÌÉú Ïç∏ÎÑ§ÏùºÎèÑ ÍµêÏ≤¥ (Ïò§ÎîîÏò§ Ïç∏ÎÑ§ÏùºÍ≥º ÎèôÏùº Í∑úÏπô)
      if (thumbKey){
        statusThumb.style.backgroundImage = `url('${imgx(thumbKey,"width=360&quality=75&format=webp")}')`;
        statusThumb.classList.add('loaded');
      } else {
        statusThumb.style.backgroundImage = '';
        statusThumb.classList.remove('loaded');
      }
      player.src = signed.publicUrl;
      player.load();
      // Î©îÎâ¥ Îã´Í∏∞
      navT.checked = false;
    };
  }

  // Îπà Ìè¥Îçî/ÌååÏùº Ï≤òÎ¶¨
  if (!library.children.length){
    const empty = document.createElement('div');
    empty.style.cssText = 'padding:12px;color:#9aa3b7';
    empty.textContent = lang==='EN' ? 'No items.' : 'Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.';
    library.appendChild(empty);
  }
}

/* ===== Back/Refresh ===== */
navBack.onclick = ()=> {
  if (!currentPath) return;
  const up = currentPath.split('/').slice(0,-1).join('/');
  renderFolder(up);
};
navRefresh.onclick = ()=> renderFolder(currentPath);

/* ===== Lang Toggle (EN/KO) ===== */
langToggle.onclick = ()=>{
  lang = (lang==='EN' ? 'KO' : 'EN');
  langToggle.textContent = (lang==='EN' ? 'EN' : 'KO');
  // ÎùºÎ≤® Î≤àÏó≠
  document.querySelector('#lblVol').textContent = (lang==='EN' ? 'Volume' : 'Î≥ºÎ•®');
  document.querySelector('#lblLoop').textContent = (lang==='EN' ? 'Loop' : 'Î∞òÎ≥µ');
  document.querySelector('#lblTimer').textContent = (lang==='EN' ? 'Timer' : 'ÌÉÄÏù¥Î®∏');
  const opts = timerSel.querySelectorAll('option');
  opts[0].textContent = (lang==='EN' ? 'Off' : 'ÎÅÑÍ∏∞');
  if(lang==='EN'){
    opts[1].textContent='5 min';opts[2].textContent='10 min';opts[3].textContent='15 min';
    opts[4].textContent='20 min';opts[5].textContent='30 min';opts[6].textContent='45 min';opts[7].textContent='60 min';
  }else{
    opts[1].textContent='5Î∂Ñ';opts[2].textContent='10Î∂Ñ';opts[3].textContent='15Î∂Ñ';
    opts[4].textContent='20Î∂Ñ';opts[5].textContent='30Î∂Ñ';opts[6].textContent='45Î∂Ñ';opts[7].textContent='60Î∂Ñ';
  }
  // Ïç∏ÎÑ§ÏùºÎèÑ Ïñ∏Ïñ¥ Î≤ÑÏ†ÑÏóê ÎßûÏ∂∞ Ïû¨Î°úÎî©
  renderFolder(currentPath);
};

/* ===== Side menu close on backdrop / icon ===== */
backdrop.addEventListener('click', ()=> navT.checked=false);
document.getElementById('hambtn').addEventListener('click', (e)=>{
  // Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏ÄÏùÄ labelÎ°ú Ï≤òÎ¶¨ÎêòÎØÄÎ°ú Î≥ÑÎèÑ Ï≤òÎ¶¨ Î∂àÌïÑÏöî
});

/* ===== Text Modal Loader (texts/*.txt) ===== */
const textModal = document.getElementById('textModal');
const textModalClose = document.getElementById('textModalClose');
const textModalContent = document.getElementById('textModalContent');
textModalClose.onclick = ()=> textModal.style.display='none';
document.querySelectorAll('nav.side-menu a.menu-text').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const url = a.getAttribute('href');
    textModalContent.textContent = 'Loading...';
    textModal.style.display = 'flex';
    fetch(url + (url.includes('?') ? '&' : '?') + 't=' + Date.now())
      .then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.text(); })
      .then(txt=> textModalContent.textContent = txt)
      .catch(err=> textModalContent.textContent = '‚ö†Ô∏è Failed to load: ' + err);
    navT.checked=false;
  });
});

/* ===== Audio wiring (iOS unlock safe) ===== */
function ensureAudioUnlocked(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    gainNode = audioCtx.createGain();
    gainNode.gain.value = parseFloat(vol.value||'1');
    // ÎØ∏Î¶¨ Ïó∞Í≤∞: Ïû¨ÏÉùÏãú ÏÜåÏä§Îßå ÎÅºÏõåÎÑ£Ïùå
    gainNode.connect(analyser).connect(audioCtx.destination);
  }
  if(audioCtx.state==='suspended') audioCtx.resume();
}
// ÏµúÏ¥à ÏÇ¨Ïö©Ïûê ÏÉÅÌò∏ÏûëÏö©ÏóêÏÑú Ïñ∏ÎùΩ
['touchstart','pointerdown','mousedown','keydown'].forEach(evt=>{
  window.addEventListener(evt, ensureAudioUnlocked, { once:true, passive:true });
});

/* Player controls */
player.addEventListener('play', ensureAudioUnlocked);
player.addEventListener('play', ()=>{
  if(!srcNode && audioCtx){
    const track = audioCtx.createMediaElementSource(player);
    // ÎÖ∏ÎìúÍ∞Ä Ï§ëÎ≥µÏúºÎ°ú Ïó∞Í≤∞ÎêòÏßÄ ÏïäÎèÑÎ°ù Î≥¥Í¥Ä
    srcNode = track;
    srcNode.connect(gainNode);
  }
});
player.addEventListener('ended', ()=>{ if(loop.checked) player.play(); });

vol.oninput = ()=>{
  ensureAudioUnlocked();
  if(gainNode) gainNode.gain.value = parseFloat(vol.value||'1');
};
loop.onchange = ()=>{ player.loop = loop.checked; };
timerSel.onchange = ()=>{
  if(timerId) { clearTimeout(timerId); timerId=null; }
  const mins = parseInt(timerSel.value||'0',10);
  if(mins>0){
    timerId = setTimeout(()=>{ player.pause(); }, mins*60*1000);
  }
};

/* ===== Bar Spectrum (always on) ===== */
const barCanvas = document.getElementById('barViz');
const bctx = barCanvas.getContext('2d');
function drawBars(){
  requestAnimationFrame(drawBars);
  if(!analyser) {
    // idle ÌôîÎ©¥
    bctx.fillStyle = '#0b0f17';
    bctx.fillRect(0,0,barCanvas.width,barCanvas.height);
    return;
  }
  const bufLen = 256;
  const data = new Uint8Array(bufLen);
  analyser.fftSize = 512;
  analyser.getByteFrequencyData(data);
  const w = barCanvas.width, h = barCanvas.height;
  bctx.clearRect(0,0,w,h);
  const n = data.length;
  const barW = Math.max(1, Math.floor(w/n*1.2));
  for(let i=0;i<n;i++){
    const v = data[i]/255;
    const bh = Math.max(2, Math.floor(v * (h-4)));
    const x = i*barW;
    // 5DO ÎÑ§Ïò® Í∑∏ÎùºÎç∞Ïù¥ÏÖò
    const g = bctx.createLinearGradient(0,h-bh,0,h);
    g.addColorStop(0,'#7ef1c0'); g.addColorStop(.5,'#55d0ff'); g.addColorStop(1,'#a38cff');
    bctx.fillStyle = g;
    bctx.fillRect(x, h-bh, barW-1, bh);
  }
}
function resizeBar(){ barCanvas.width = barCanvas.clientWidth; barCanvas.height = 100; }
window.addEventListener('resize', resizeBar);
resizeBar(); drawBars();

/* ===== Init ===== */
renderFolder(''); // root

</script>
</body>
</html>
