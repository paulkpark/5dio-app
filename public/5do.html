<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>5DO Lite</title>
<link rel="preconnect" href="https://xdjgumqdwedgzwqturcx.supabase.co">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#0b0d13;--panel:#12141b;--border:#222738;--accent:#9cff8b;
  --card:#181b25;--ink:#e5e7eb;--muted:#9aa3b7;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}

/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)
}
.logo{font-weight:700;color:var(--accent);font-size:1.2rem}

/* Hamburger */
.nav-toggle{display:none}
.hamburger{width:36px;height:32px;border-radius:8px;border:1px solid var(--border);
  background:#1c2130;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:8px}
.hamburger span,.hamburger span:before,.hamburger span:after{
  display:block;background:#cfd6e6;height:2px;width:18px;position:relative;border-radius:2px}
.hamburger span:before,.hamburger span:after{content:"";position:absolute;left:0}
.hamburger span:before{top:-6px}.hamburger span:after{top:6px}

/* Lang toggle */
.lang-toggle{
  background:#151b24;border:1px solid #2b3249;color:#e7effa;
  padding:4px 8px;border-radius:8px;cursor:pointer
}

/* Side menu */
.side-menu{position:fixed;top:0;left:0;width:33%;max-width:220px;height:100vh;background:#0f1320;
  border-right:1px solid var(--border);padding:14px;overflow-y:auto;transform:translateX(-100%);
  transition:.25s ease;display:flex;flex-direction:column;gap:8px;z-index:1001}
#navToggle:checked ~ nav.side-menu{transform:none;}
.backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
#navToggle:checked ~ .backdrop{display:block;}
.mbtn{padding:10px;border:1px solid var(--border);background:#171d2b;color:#dfe7f6;
  border-radius:10px;text-align:left;width:100%}

/* Library */
#navBtns{display:flex;justify-content:center;gap:10px;padding:8px}
.icon-btn{font-size:18px;width:36px;height:36px;border-radius:10px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #2a3044;background:#121829;color:#e6f1ff;cursor:pointer}
#library{display:flex;overflow-x:auto;gap:10px;padding:10px;scroll-behavior:smooth;scroll-snap-type:x mandatory}
.card{flex:0 0 auto;width:160px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:6px;scroll-snap-align:start}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#0e1016;border-radius:8px}

/* Controls */
.controls{display:flex;flex-direction:column;gap:10px;padding:12px;background:#0f1320;border-top:1px solid var(--border)}
.status{display:flex;align-items:center;gap:20px;margin-bottom:10px;}
#statusThumb{
  width:124px;height:124px;border-radius:16px;position:relative;overflow:hidden;
  background: radial-gradient(circle at center, #1a1f2f 40%, #0d0f18 100%);
  border: 1px solid #2d334a;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 12px rgba(80,180,255,0.15);
  background-size:cover;background-position:center;
}
#statusThumb::before{
  content:'';position:absolute;inset:0;border-radius:50%;
  background: radial-gradient(circle, rgba(100,200,255,0.25), transparent 60%);
  animation:pulse 2s infinite ease-in-out;
}
#statusThumb.loaded::before{display:none;}
@keyframes pulse{0%,100%{transform:scale(0.8);opacity:0.5;}50%{transform:scale(1.1);opacity:1;}}
.ctrl-stack{display:flex;flex-direction:column;gap:8px;}
.ctrl-line{display:flex;align-items:center;gap:10px}
input[type="range"]{width:140px}
audio{width:92%;display:block;margin:10px auto}

/* === Bar Spectrum (Ìï≠ÏÉÅ ÌëúÏãúÎêòÎäî Î™®ÎãàÌÑ∞ Ï†ÑÏö© Ï∞Ω) === */
#barVizWrap{
  display:block;
  padding:8px 0;
  background:#0b0f17;
  border-top:1px solid #20263a;
}
#barViz{
  display:block;
  width:100%;
  height:100px;
}
</style>
</head>
<body>
<input id="navToggle" class="nav-toggle" type="checkbox">

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <label for="navToggle" class="hamburger"><span></span></label>
    <div class="logo">5DO Lite</div>
  </div>
  <button id="langToggle" class="lang-toggle">EN</button>
</header>

<nav class="side-menu">
  <a class="mbtn" href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
  <a class="mbtn" href="#">FAQ</a>
  <a class="mbtn" href="#">Manual</a>
  <a class="mbtn" href="#">Contact</a>
  <a class="mbtn" href="#">About</a>
</nav>
<div class="backdrop" id="backdrop"></div>

<!-- Î∞î Ïä§ÌéôÌä∏Îüº Ï†ÑÏö© ÏòÅÏó≠ Í≥†Ï†ï ÌëúÏãú -->
<div id="barVizWrap"><canvas id="barViz"></canvas></div>

<div id="navBtns">
  <button id="navBack" class="icon-btn" title="Back">‚¨ÖÔ∏è</button>
  <button id="navRefresh" class="icon-btn" title="Refresh">üîÑ</button>
</div>
<div id="library"></div>

<div class="controls">
  <div class="status">
    <div id="statusThumb"></div>
    <div class="ctrl-stack">
      <div class="ctrl-line"><label id="lblVol" for="vol">Volume</label><input id="vol" type="range" min="0" max="1" step="0.01" value="1"></div>
      <div class="ctrl-line"><label><input type="checkbox" id="loop"> <span id="lblLoop">Loop</span></label></div>
      <div class="ctrl-line"><label id="lblTimer" for="timer">Timer</label>
        <select id="timer">
          <option value="0">Off</option><option value="5">5 min</option><option value="10">10 min</option>
          <option value="15">15 min</option><option value="20">20 min</option><option value="30">30 min</option>
          <option value="45">45 min</option><option value="60">60 min</option>
        </select>
      </div>
    </div>
  </div>
</div>

<audio id="player" controls preload="none" playsinline controlslist="nodownload noplaybackrate"></audio>

<script>
/* ==== Supabase ==== */
const SUPABASE_URL="https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET="media";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const PUBLIC_BASE=SUPABASE_URL+"/storage/v1/object/public/"+BUCKET+"/";

/* ==== DOM ==== */
const lib=document.getElementById("library");
const btnBack=document.getElementById("navBack");
const btnRefresh=document.getElementById("navRefresh");
const statusThumb=document.getElementById("statusThumb");
const player=document.getElementById("player");
const loopChk=document.getElementById("loop");
const vol=document.getElementById("vol");
const timerSel=document.getElementById("timer");

/* ==== Audio ==== */
player.crossOrigin="anonymous";
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
const mediaNode=audioCtx.createMediaElementSource(player);
const gainNode=audioCtx.createGain();
const analyser=audioCtx.createAnalyser();
mediaNode.connect(gainNode);
gainNode.connect(analyser);
analyser.connect(audioCtx.destination);
analyser.fftSize=1024;
analyser.smoothingTimeConstant=0.85;

gainNode.gain.value=+vol.value||1;
vol.addEventListener("input",()=>gainNode.gain.value=+vol.value||0);

/* Unlock */
function ensureAudioUnlocked(){ if(audioCtx.state!=="running") audioCtx.resume(); }
document.addEventListener("pointerdown",ensureAudioUnlocked,{once:true});

/* Loop/Timer */
loopChk.onchange=()=>player.loop=loopChk.checked;
let timerId=null;
timerSel.onchange=()=>{
  clearTimeout(timerId);
  const min=+timerSel.value;
  if(min>0) timerId=setTimeout(()=>{player.pause();player.currentTime=0;alert("Timer stopped playback.");},min*60000);
};

/* Status Thumb */
const setStatus=(img)=>{
  if(!img){
    statusThumb.classList.remove('loaded');
    statusThumb.style.background="radial-gradient(circle at center,#1a1f2f 40%,#0d0f18 100%)";
    statusThumb.style.boxShadow="0 0 12px rgba(80,180,255,0.15)";
    statusThumb.style.border="1px solid #2d334a";
    statusThumb.style.backgroundImage="";
  }else{
    statusThumb.classList.add('loaded');
    statusThumb.style.background="none";
    statusThumb.style.boxShadow="none";
    statusThumb.style.border="1px solid rgba(255,255,255,0.12)";
    statusThumb.style.backgroundImage=`url('${img}')`;
    statusThumb.style.backgroundSize="cover";
    statusThumb.style.backgroundPosition="center";
  }
};

/* Library */
let cwd="";
const enc=s=>s.split("/").filter(Boolean).map(encodeURIComponent).join("/");
const abs=p=>PUBLIC_BASE+enc(p);

async function list(path=""){
  const {data,error}=await sb.storage.from(BUCKET).list(path,{limit:1000,sortBy:{column:"name",order:"asc"}});
  if(error){console.warn(error);return [];}return data||[];
}
async function load(path=""){
  cwd=path;lib.innerHTML="";setStatus("");
  const rows=await list(path);
  for(const e of rows){
    const name=e.name; const full=(path?path+"/":"")+name;
    if(!name.includes(".")){
      const card=document.createElement("div");card.className="card";
      const img=document.createElement("img");
      img.src=abs(full+"/folder.png");
      img.onerror=()=>img.src="https://placehold.co/300x300/111/aaa?text=Folder";
      card.onclick=()=>load(full);
      card.append(img);lib.append(card);
      continue;
    }
    if(/\.(mp3|wav|ogg|m4a|flac|aac)$/i.test(name)){
      const card=document.createElement("div");card.className="card";
      const img=document.createElement("img");
      const thumb=full.replace(/\.[^.]+$/, ".png");
      img.src=abs(thumb);
      img.onerror=()=>img.src="https://placehold.co/300x300/222/888?text=Audio";
      card.onclick=()=>{
        ensureAudioUnlocked();
        player.pause();player.currentTime=0;
        player.src=abs(full);
        setStatus(abs(thumb));
        // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌîåÎ†àÏù¥ Î≤ÑÌäºÏúºÎ°ú Ïû¨ÏÉùÌïòÎèÑÎ°ù Ïú†ÏßÄ (ÏûêÎèôÏû¨ÏÉù Ï∞®Îã® ÌöåÌîº)
      };
      card.append(img);lib.append(card);
    }
  }
}
btnBack.onclick=()=>{
  if(!cwd)return;
  const seg=cwd.split("/");seg.pop();load(seg.join("/"));
};
btnRefresh.onclick=()=>load(cwd);

/* Drag scroll */
let isDown=false,startX=0,startL=0;
lib.addEventListener("mousedown",e=>{isDown=true;startX=e.pageX;startL=lib.scrollLeft;});
["mouseleave","mouseup"].forEach(ev=>lib.addEventListener(ev,()=>isDown=false));
lib.addEventListener("mousemove",e=>{if(!isDown)return;lib.scrollLeft=startL-(e.pageX-startX)*1.5;});

/* ÌñÑÎ≤ÑÍ±∞ Îã´Í∏∞ */
const navToggle=document.getElementById("navToggle");
const backdrop=document.getElementById("backdrop");
const sideMenu=document.querySelector("nav.side-menu");
backdrop.addEventListener("click",()=>navToggle.checked=false);
sideMenu.addEventListener("click",e=>{if(e.target.closest("a"))navToggle.checked=false;});

/* === Bar Spectrum Visualizer (Ìï≠ÏÉÅ ÌëúÏãú, Ïû¨ÏÉù Ï§ë draw) === */
(function(){
  const canvas=document.getElementById('barViz');
  const ctx=canvas.getContext('2d',{alpha:true});
  function resize(){
    const dpr=Math.min(window.devicePixelRatio||1,2);
    canvas.width=Math.floor(canvas.clientWidth*dpr);
    canvas.height=Math.floor(canvas.clientHeight*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resize).observe(canvas); resize();
  const data=new Uint8Array(512); let raf=0;
  function draw(){
    raf=requestAnimationFrame(draw);
    analyser.getByteFrequencyData(data);
    const W=canvas.clientWidth,H=canvas.clientHeight,n=data.length,barW=W/n;
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<n;i++){
      const v=data[i]/255, h=v*H, x=i*barW, y=H-h;
      const g=ctx.createLinearGradient(x,y,x,y+h);
      g.addColorStop(0,'#7ef1c0'); g.addColorStop(0.5,'#55d0ff'); g.addColorStop(1,'#a38cff');
      ctx.fillStyle=g;
      const wScale=1.0+(1-i/n)*0.4;
      ctx.fillRect(x,y,barW*wScale,h);
    }
  }
  function startViz(){ if(!raf) draw(); }
  function stopViz(){ if(raf){ cancelAnimationFrame(raf); raf=0; } ctx.clearRect(0,0,canvas.width,canvas.height); }
  player.addEventListener('play',  ()=>{ ensureAudioUnlocked(); startViz(); });
  player.addEventListener('pause', stopViz);
  player.addEventListener('ended', stopViz);
  player.addEventListener('emptied', stopViz);
})();

/* === Language Toggle === */
const langBtn=document.getElementById('langToggle');
let isKo=false;
function applyLang(){
  const L = {
    en:{ vol:'Volume', loop:'Loop', timer:'Timer', backTitle:'Back', refTitle:'Refresh' },
    ko:{ vol:'Î≥ºÎ•®',  loop:'Î∞òÎ≥µ', timer:'ÌÉÄÏù¥Î®∏', backTitle:'Îí§Î°ú', refTitle:'ÏÉàÎ°úÍ≥†Ïπ®' }
  }[isKo?'ko':'en'];
  document.getElementById('lblVol').textContent   = L.vol;
  document.getElementById('lblLoop').textContent  = L.loop;
  document.getElementById('lblTimer').textContent = L.timer;
  btnBack.title = L.backTitle;
  btnRefresh.title = L.refTitle;
}
langBtn.onclick=()=>{ isKo=!isKo; langBtn.textContent=isKo?'KO':'EN'; applyLang(); };
applyLang();

/* Init */
load("");
</script>
</body>
</html>
