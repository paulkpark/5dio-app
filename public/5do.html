<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>5DO Lite – Loop/Timer + Bar Spectrum</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#121826; --border:#2b3344; --text:#dbe7ff; --muted:#9fb0c6;
      --accent:#7ef1c0;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border)}
    .app-title{font-weight:700;color:var(--accent)}
    .wrap{max-width:900px;margin:18px auto;padding:0 14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .label{color:var(--muted);font-size:.95rem}
    audio{width:100%}

    /* 스펙트럼 캔버스 */
    #spectrumHost{margin-top:10px;width:100%;height:120px;display:block}
    #barSpectrum{width:100%;height:120px;display:block;border-radius:10px;background:#0b0f17}

    /* 루프/타이머 UI */
    #ltControls{display:flex;align-items:center;gap:12px;margin-top:10px;flex-wrap:wrap}
    #ltControls select{background:#111;border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);outline:none}
    #ltControls input[type="checkbox"]{transform:scale(1.1)}
  </style>
</head>
<body>
  <header>
    <div class="app-title">5DO Lite</div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <div class="label">Demo Player</div>
      </div>

      <!-- 실제 앱에서는 #player를 기존 오디오 요소로 매칭하세요 -->
      <audio id="player" controls preload="none" crossorigin="anonymous">
        <!-- 데모용: 원하는 mp3 URL을 직접 넣어 테스트하세요 -->
        <!-- <source src="https://example.com/test.mp3" type="audio/mpeg"> -->
      </audio>

      <!-- 상태/컨트롤을 붙일 자리 (기존 페이지에 이미 비슷한 래퍼가 있으면 id만 부여하세요) -->
      <div id="statusWrap" class="row" style="margin-top:8px"></div>

      <!-- 스펙트럼이 붙을 자리(없으면 스크립트가 자동 생성) -->
      <div id="spectrumHost">
        <canvas id="barSpectrum"></canvas>
      </div>
    </section>
  </main>

  <!-- ▼▼▼ 여기부터가 ‘실제 프로젝트에 붙이면 되는’ 최종 패치 스크립트입니다 ▼▼▼ -->
  <script>
  /* =========================================================
     5DO Lite — Loop + Sleep Timer + Bar Spectrum (final patch)
     - Library 전용: Loop 토글, Preset Timer(Off/5/10/15/20/30/45/60분)
     - 스펙트럼: 재생 중에만 렌더링, 일시정지/정지 시 즉시 OFF (freeze 없음)
     - 기존 UI/코드 불변, 안전하게 주입/바인딩
     ========================================================= */

  (function(){
    // ---------- 공용 유틸 ----------
    function $(sel){ return document.querySelector(sel); }
    function findPlayer(){
      // 프로젝트 내 다양한 id/class에 대응
      return $('#player') || $('#audio') || document.querySelector('audio#libPlayer') || document.querySelector('audio.player') || document.querySelector('audio');
    }
    function findStatusWrap(){
      return $('#statusWrap') ||
             document.querySelector('.status-wrap, .statusRow, .status, .player-row, .controlRow') ||
             findPlayer()?.parentElement || document.body;
    }

    // ---------- 오디오/컨테이너 준비 ----------
    const player = findPlayer();
    if(!player){ console.warn('[5DO] audio element not found — patch aborted'); return; }

    const statusWrap = findStatusWrap();
    if(!statusWrap){ console.warn('[5DO] status container not found — patch aborted'); return; }

    // ---------- 루프/타이머 UI (중복 방지) ----------
    if(!document.getElementById('ltControls')){
      const row = document.createElement('div');
      row.id = 'ltControls';
      row.innerHTML = `
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:0.95rem;user-select:none">
          <input id="loopToggle" type="checkbox"/>
          <span>Loop</span>
        </label>

        <label style="display:inline-flex;align-items:center;gap:6px;font-size:0.95rem;user-select:none">
          <span>Timer</span>
          <select id="timerSelect">
            <option value="">Off</option>
            <option value="5">5 min</option>
            <option value="10">10 min</option>
            <option value="15">15 min</option>
            <option value="20">20 min</option>
            <option value="30">30 min</option>
            <option value="45">45 min</option>
            <option value="60">60 min</option>
          </select>
        </label>
      `;
      statusWrap.appendChild(row);
    }

    // ---------- 루프/타이머 동작 ----------
    (function bindLoopTimer(){
      const loopToggle = $('#loopToggle');
      const timerSelect = $('#timerSelect');
      let sleepTimer = null;

      function clearSleepTimer(){
        if(sleepTimer){ clearTimeout(sleepTimer); sleepTimer = null; }
      }
      function scheduleSleepTimer(){
        clearSleepTimer();
        const mins = parseInt(timerSelect?.value||'', 10);
        if(!isFinite(mins) || mins<=0) return;
        sleepTimer = setTimeout(()=>{
          try { player.pause(); player.currentTime = 0; } catch(e){}
        }, mins*60*1000);
      }

      if(loopToggle){
        // 초기 동기화
        player.loop = !!loopToggle.checked;
        loopToggle.addEventListener('change', ()=>{ player.loop = !!loopToggle.checked; });
      }
      if(timerSelect){
        timerSelect.addEventListener('change', ()=>{
          if(!player.paused) scheduleSleepTimer();
        });
      }

      player.addEventListener('play',  scheduleSleepTimer);
      player.addEventListener('pause', clearSleepTimer);
      player.addEventListener('ended', clearSleepTimer);
    })();

    // ---------- 바 스펙트럼 (재생 중에만, 멈춤시 OFF) ----------
    (function barSpectrum(){
      // 호스트/캔버스 준비
      let host = document.querySelector('#spectrumHost, .spectrum-host, .visual-host');
      if(!host){
        host = document.createElement('div');
        host.id = 'spectrumHost';
        host.style.cssText = 'margin-top:10px;width:100%;height:120px;display:block;';
        (player.parentElement || document.body).appendChild(host);
      }

      let canvas = document.querySelector('#barSpectrum, #spectrumCanvas, canvas.bar-spectrum, canvas#barSpectrum');
      if(!canvas){
        canvas = document.createElement('canvas');
        canvas.id = 'barSpectrum';
        canvas.style.cssText = 'width:100%;height:120px;display:block;border-radius:10px;background:#0b0f17';
        host.appendChild(canvas);
      }
      const ctx = canvas.getContext('2d');

      // 오디오 분석 체인 (재사용 시도)
      let audioCtx = window.__libAudioCtx || null;
      let analyser = window.__libAnalyser || null;
      if(!audioCtx){
        try{
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();
          window.__libAudioCtx = audioCtx;
        }catch(e){ console.warn('[5DO] AudioContext create failed', e); return; }
      }
      if(!analyser){
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024;
        window.__libAnalyser = analyser;
        try{
          const src = audioCtx.createMediaElementSource(player);
          src.connect(analyser);
          analyser.connect(audioCtx.destination);
        }catch(_){} // 이미 연결되어 있으면 무시
      }

      function fit(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
      window.addEventListener('resize', fit, {passive:true}); fit();

      let rafId = null;
      function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

      function draw(){
        const bufLen = analyser.frequencyBinCount;
        const data = new Uint8Array(bufLen);
        analyser.getByteFrequencyData(data);

        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0,0,W,H);

        const bars = Math.min(80, bufLen);
        const step = Math.floor(bufLen / bars);
        const barW = Math.max(2, (W / bars) * 0.7);

        for(let i=0;i<bars;i++){
          const v = data[i*step] / 255;      // 0~1
          const h = v * (H*0.9);
          const g = ctx.createLinearGradient(0, H-h, 0, H);
          g.addColorStop(0.00, '#7ef1c0');   // 5DO 느낌 그라디언트
          g.addColorStop(0.60, '#55d0ff');
          g.addColorStop(1.00, '#a38cff');
          ctx.fillStyle = g;
          const x = (i * (W / bars)) + ((W / bars) - barW)/2;
          ctx.fillRect(x, H-h, barW, h);
        }
        rafId = requestAnimationFrame(draw);
      }

      function startViz(){
        if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
        cancelAnimationFrame(rafId); rafId = null;
        draw();
      }
      function stopViz(){
        cancelAnimationFrame(rafId); rafId = null;
        clearCanvas();
      }

      player.addEventListener('play',  startViz);
      player.addEventListener('pause', stopViz);
      player.addEventListener('ended', stopViz);
    })();

  })();
  </script>
  <!-- ▲▲▲ 위 스크립트 통째로 기존 페이지의 </body> 앞에 붙이면 끝 ▲▲▲ -->
</body>
</html>
