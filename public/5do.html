<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>5DO Pro</title>
<style>

:root{
  --bg:#060913;
  --panel:#0c1422;
  --ink:#eaf2ff;
  --muted:#9bb3cc;
  --stroke:#163050;
  --glow:rgba(160,92,255,.25); /* dark violet glow */
  --accent:#a05cff; /* dark violet neon */
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:920px;margin:0 auto;padding:14px 14px 28px}
header{display:flex;align-items:center;gap:10px}
.hamburger{width:30px;height:22px;position:relative;cursor:pointer}
.hamburger:before,.hamburger:after,.hamburger span{content:"";position:absolute;left:0;right:0;height:3px;background:#9ecfff;border-radius:2px;box-shadow:0 0 12px rgba(82,180,255,.55)}
.hamburger:before{top:0}.hamburger span{top:9px}.hamburger:after{bottom:0}
.title{font-weight:800;letter-spacing:.2px;font-size:20px;text-shadow:0 0 14px rgba(160,92,255,.55), 0 0 3px rgba(160,92,255,.9)}
.header-spacer{flex:1}
.tabs{display:flex;gap:10px}
.tab{padding:8px 12px;border:1px solid var(--stroke);border-radius:10px;background:var(--panel);color:var(--ink);opacity:.85}
.lang{margin-left:10px}
button,select,input{color:var(--ink)}
.btn{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;box-shadow:inset 0 0 14px var(--glow);cursor:pointer}
.btn:active{transform:translateY(1px)}
.gen-input,.gen-range,select{background:#0f1a28;border:1px solid #13263c;border-radius:10px}
.gen-input{padding:8px 10px;min-height:36px}
.gen-range{height:32px}
.gen-label{font-weight:800;color:#cfe0ff}
.gen-sub{color:#b5cce0}
.gen-chip{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f;color:#cfe0ff;font-size:12px}
.gen-grid{display:grid;gap:12px;margin-top:10px}
.gen-row2{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center}
.gen-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
@media (max-width:680px){.gen-row2{grid-template-columns:1fr}}
.panel{border:1px solid var(--stroke);border-radius:14px;background:linear-gradient(180deg,rgba(23,32,55,.55),rgba(8,14,26,.55));padding:12px}
.osc-wrap{position:relative;margin-top:12px}
#osc{display:block;width:100%;height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#02070d}
.osc-toolbar{position:absolute;top:8px;right:8px;display:flex;align-items:center;gap:8px;z-index:6}
.osc-color-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:linear-gradient(135deg,#b68cff,#6a3eff);box-shadow:0 2px 8px rgba(0,0,0,.25)}
.osc-pop{position:absolute;top:40px;right:0;padding:10px;border-radius:12px;background:rgba(15,17,24,.96);border:1px solid rgba(255,255,255,.12);box-shadow:0 12px 28px rgba(0,0,0,.35);display:none}
.osc-pop.show{display:block}
.osc-swatches{display:grid;grid-template-columns:repeat(6,22px);gap:8px}
.osc-swatch{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,255,255,.25)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
.toolbar .btn{padding:8px 12px}
select#presetLoad{min-width:164px}
/* compact for iPhone */
@media (max-width:420px){
  .btn{padding:8px 10px;font-size:12px}
  .gen-input{padding:8px 10px;font-size:12px;min-height:32px}
  .gen-range{height:26px}
  #osc{height:140px}
}
/* modal basic */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal .box{max-width:560px;width:92%;border:1px solid var(--stroke);background:var(--panel);border-radius:16px;padding:16px}
.modal.show{display:flex}

/* Tabs bar adjustments for center + lang right */
header{gap:12px}
.tabs{margin:0 auto}
.tab{cursor:pointer;user-select:none}
.tab[aria-selected="true"]{outline:1px solid #2a4e7d}

/* Library placeholder styles */
.lib-toolbar{display:flex;gap:8px;align-items:center;margin-top:12px}
.lib-btn{padding:8px 12px;border:1px solid var(--stroke);border-radius:10px;background:var(--panel)}
.lib-strip{display:grid;grid-auto-flow:column;grid-auto-columns:120px;gap:10px;overflow-x:auto;padding:10px;margin:10px 0;border:1px dashed #1b2f4d;border-radius:12px}
.lib-thumb{width:120px;height:120px;border-radius:12px;background:#0b1322;display:flex;align-items:center;justify-content:center;color:#7aa3d8}
.lib-meta{min-height:54px;color:#9bb3cc}

/* Generator scope row: label on left + slider right */
.scope-grid{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
@media (max-width:560px){.scope-grid{grid-template-columns:100px 1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="hamburger" id="menuBtn"><span></span></div>
    <div class="title">5DO Pro</div>
    <div class="header-spacer"></div>
    <div class="tabs">
      <div class="tab" id="tabLibrary" aria-selected="true">Library</div>
      <div class="tab" id="tabGenerator" aria-selected="false">Generator</div>
    </div>
    <button class="btn lang" id="langBtn">EN/KR</button>
  </header>

  <!-- Library Page -->
  <section id="pageLibrary">
    <div class="lib-toolbar">
      <button class="lib-btn" id="libBack">Back</button>
      <button class="lib-btn" id="libHome">Home</button>
      <button class="lib-btn" id="libRefresh">Refresh</button>
    </div>
    <div class="panel">
      <div class="gen-label" style="margin-bottom:6px">Media Thumbnails (placeholder)</div>
      <div class="lib-strip" id="libStrip">
        <div class="lib-thumb">Folder</div>
        <div class="lib-thumb">Folder</div>
        <div class="lib-thumb">Folder</div>
        <div class="lib-thumb">Folder</div>
      </div>
      <div class="lib-meta" id="libMeta">Select a track to see title/description here.</div>
    </div>
  </section>

  <!-- Generator Page (ported) -->
  <section id="pageGenerator" style="display:none">
    <div class="osc-wrap">
      <canvas id="osc" aria-label="waveform viewer"></canvas>
      <div class="osc-toolbar" id="oscToolbar">
        <button class="osc-color-btn" id="oscColorBtn" title="Waveform Color"></button>
        <div class="osc-pop" id="oscPop">
          <div class="osc-swatches" id="oscSwatches"></div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button id="genPlay" class="btn" data-i18n="gen.play">Play</button>
      <button id="genStop" class="btn" data-i18n="gen.stop">Stop</button>
      <button id="presetSave" class="btn" data-i18n="gen.preset_save">Save Preset</button>
      <select id="presetLoad" class="gen-input" data-i18n-select="gen.preset_load">
        <option value="">Load Preset…</option>
      </select>
      <select id="oscColor" class="gen-input" title="Color">
        <option value="#a05cff">Dark Violet</option>
        <option value="#39e3ff">Neon Blue</option>
        <option value="#00ffd5">Aqua</option>
        <option value="#00ff7f">Neon Green</option>
        <option value="#ffd166">Amber</option>
        <option value="#ffffff">White</option>
      </select>
    </div>

    <div class="panel gen-grid">
      <div class="gen-row2">
        <label class="gen-label"><span data-i18n="gen.waveform">Waveform Vibration</span></label>
        <div class="gen-inline">
          <select id="wf" class="gen-input">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Saw</option>
          </select>
          <span class="gen-chip" data-i18n="gen.binaural">Binaural (Left–Right Sync)</span>
          <input type="checkbox" id="binEnable">
          <label class="gen-sub" data-i18n="gen.diff_hz">Difference (Hz)</label>
          <input id="binDiff" class="gen-input" type="number" min="0" max="40" step="0.1" value="4">
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label"><span data-i18n="gen.frequency">Frequency (Hz)</span></label>
        <div class="gen-inline">
          <input id="freq" class="gen-input" type="number" min="0" max="20000" step="0.1" value="432">
          <input id="freqRange" class="gen-range" type="range" min="0" max="20000" step="1" value="432" style="flex:1">
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label"><span data-i18n="gen.duty">Wave Ratio</span></label>
        <div class="gen-inline">
          <input id="dutyNum" class="gen-input" type="number" min="1" max="100" step="1" value="50">
          <input id="duty" class="gen-range" type="range" min="1" max="100" step="1" value="50" style="flex:1">
        </div>
      </div>

      <div class="gen-row2">
        <label class="gen-label"><span data-i18n="gen.harmonics">Harmonics Activation</span></label>
        <div class="gen-inline">
          <label class="gen-sub" data-i18n="gen.enable">Enable</label>
          <input id="harmEnable" type="checkbox">
          <label class="gen-sub" data-i18n="gen.base">Base</label>
          <select id="harmBase" class="gen-input">
            <option value="fund" data-i18n="gen.base_fund">Fundamental</option>
            <option value="mid"  data-i18n="gen.base_mid">Mid (x2)</option>
            <option value="high" data-i18n="gen.base_high">High (x4)</option>
          </select>
          <label class="gen-sub" data-i18n="gen.octaves"># of Octaves</label>
          <select id="harmOct" class="gen-input">
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>
      </div>

      <!-- Scope with each label on left and slider on right -->
      <div>
        <label class="gen-label"><span data-i18n="gen.scope">Wave Viewer</span></label>
        <div class="scope-grid" style="margin-top:8px">
          <div class="gen-sub" data-i18n="gen.zoom">Zoom</div>
          <input id="oscZoom" type="range" class="gen-range" min="0.5" max="4" step="0.1" value="1">
          <div class="gen-sub" data-i18n="gen.gamma">Gamma</div>
          <input id="oscGamma" type="range" class="gen-range" min="0.6" max="2" step="0.05" value="1">
          <div class="gen-sub" data-i18n="gen.line">Line</div>
          <input id="oscLine" type="range" class="gen-range" min="1" max="4" step="0.5" value="2">
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Modal (for hamburger) -->
<div class="modal" id="menuModal" role="dialog" aria-modal="true">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800">Menu</div>
      <button class="btn" id="modalClose">Close</button>
    </div>
    <div style="max-height:60vh;overflow:auto">
      <p><strong>FAQ / Manual / Contact / About</strong> are shown here as scrollable content (placeholder).</p>
    </div>
  </div>
</div>

<script>

/** i18n (Style B: healing/5D tone) **/
const GEN_I18N = {
  en:{
    "gen.play":"Play",
    "gen.stop":"Stop",
    "gen.preset_save":"Save Preset",
    "gen.preset_load":"Load Preset…",
    "gen.waveform":"Waveform Vibration",
    "gen.binaural":"Binaural (Left–Right Sync)",
    "gen.diff_hz":"Difference (Hz)",
    "gen.frequency":"Frequency (Hz)",
    "gen.duty":"Wave Ratio",
    "gen.harmonics":"Harmonics Activation",
    "gen.enable":"Enable",
    "gen.base":"Base",
    "gen.base_fund":"Fundamental",
    "gen.base_mid":"Mid (x2)",
    "gen.base_high":"High (x4)",
    "gen.octaves":"# of Octaves",
    "gen.scope":"Wave Viewer",
    "gen.zoom":"Zoom",
    "gen.gamma":"Gamma",
    "gen.line":"Line",
    "gen.preset_name_prompt":"Preset name"
  },
  ko:{
    "gen.play":"재생",
    "gen.stop":"정지",
    "gen.preset_save":"프리셋 저장",
    "gen.preset_load":"프리셋 로드…",
    "gen.waveform":"파형 진동",
    "gen.binaural":"좌·우뇌 동기화",
    "gen.diff_hz":"차이(Hz)",
    "gen.frequency":"주파수(Hz)",
    "gen.duty":"파형 비율",
    "gen.harmonics":"하모닉스 활성화",
    "gen.enable":"사용",
    "gen.base":"베이스",
    "gen.base_fund":"기본",
    "gen.base_mid":"미드(x2)",
    "gen.base_high":"하이(x4)",
    "gen.octaves":"옥타브 수",
    "gen.scope":"파동 뷰어",
    "gen.zoom":"줌",
    "gen.gamma":"감마",
    "gen.line":"선 두께",
    "gen.preset_name_prompt":"프리셋 이름"
  }
};
let LANG = (document.documentElement.lang==='ko')?'ko':'en';
function t(key){ return (GEN_I18N[LANG]&&GEN_I18N[LANG][key])||key; }
function applyGenI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n'); const txt=t(k);
    if(el.firstElementChild && el.firstElementChild.tagName==='SPAN'){ el.firstElementChild.textContent=txt; }
    else el.textContent = txt;
  });
  document.querySelectorAll('[data-i18n-select]').forEach(sel=>{
    const k=sel.getAttribute('data-i18n-select'); const ph=t(k);
    const first=sel.querySelector('option[value=""]'); if(first) first.textContent = ph;
  });
}
document.getElementById('langBtn').addEventListener('click',()=>{
  LANG = (LANG==='en')?'ko':'en';
  document.documentElement.lang = (LANG==='ko')?'ko':'en';
  applyGenI18n();
});
applyGenI18n();

/** Modal (placeholder) **/
const modal = document.getElementById('menuModal');
document.getElementById('menuBtn').addEventListener('click',()=>{ modal.classList.add('show'); });
document.getElementById('modalClose').addEventListener('click',()=>{ modal.classList.remove('show'); });

/** WebAudio Graph **/
let aCtx=null, master=null, analyser=null;
let oscL=null, oscR=null, gainL=null, gainR=null, merger=null;
let rafId=0;

function ensureCtx(){
  if(!aCtx){
    aCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(!master){ master = aCtx.createGain(); master.connect(aCtx.destination); }
  if(!analyser){
    analyser = aCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.06;
    analyser.connect(master); // put analyser just before destination
  }
}

function connectBinauralGraph(){
  // Inputs
  const bin = document.getElementById('binEnable').checked;
  const diff = parseFloat(document.getElementById('binDiff').value)||0;
  const f = Math.max(0, parseFloat(document.getElementById('freq').value)||0);
  const wf = document.getElementById('wf').value;
  const duty = Math.min(100, Math.max(1, parseInt(document.getElementById('duty').value||'50',10))) / 100;

  // tear down
  [oscL,oscR,gainL,gainR,merger].forEach(n=>{ try{n&&n.disconnect();}catch(_){} });
  oscL=oscR=gainL=gainR=merger=null;

  oscL = aCtx.createOscillator();
  oscR = aCtx.createOscillator();
  oscL.type = wf; oscR.type = wf;
  oscL.frequency.value = f;
  oscR.frequency.value = bin ? Math.max(0, f + diff) : f;

  // duty for square only
  if(wf==='square'){
    try{
      const real = new Float32Array(2); const imag = new Float32Array(2);
      // simple PWM-esque approximation (duty): affects first harmonic
      const a0 = 0;
      const a1 = 4/Math.PI * Math.sin(Math.PI*duty);
      real[0]=a0; real[1]=a1; imag[0]=imag[1]=0;
      const wave = aCtx.createPeriodicWave(real, imag, {disableNormalization:true});
      oscL.setPeriodicWave(wave);
      oscR.setPeriodicWave(wave);
    }catch(_){}
  }

  gainL = aCtx.createGain(); gainR = aCtx.createGain();
  gainL.gain.value = 0.5; gainR.gain.value = 0.5;

  merger = aCtx.createChannelMerger(2);
  // L path
  oscL.connect(gainL); gainL.connect(merger,0,0);
  // R path
  oscR.connect(gainR); gainR.connect(merger,0,1);
  // To analyser → master
  merger.connect(analyser);
}

function playGen(){
  ensureCtx();
  if(aCtx.state==='suspended'){ aCtx.resume(); }
  connectBinauralGraph();

  try{ oscL.start(); oscR.start(); }catch(_){/* already started */}

  // Harmonics (octaves)
  const harmOscs=[]; const harmGain=[];
  if(document.getElementById('harmEnable').checked){
    const baseSel = document.getElementById('harmBase').value; // fund/mid/high
    const oct = parseInt(document.getElementById('harmOct').value||'0',10);
    const f0 = Math.max(0, parseFloat(document.getElementById('freq').value)||0);
    const scale = baseSel==='high'?4:(baseSel==='mid'?2:1);
    for(let i=1;i<=oct;i++){
      const o=aCtx.createOscillator(); o.type=document.getElementById('wf').value;
      o.frequency.value = f0*scale*(2**i);
      const g=aCtx.createGain(); g.gain.value = Math.max(0.05, 0.35/(i+0.5));
      o.connect(g); g.connect(analyser); o.start();
      harmOscs.push(o); harmGain.push(g);
    }
  }

  // Start drawing
  const colSel = document.getElementById('oscColor');
  const color = colSel ? colSel.value : getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#a05cff';
  drawOsc(color);

  // Live change handlers
  document.getElementById('freq').addEventListener('input', ()=>{ try{ oscL.frequency.value = parseFloat(freq.value)||0; oscR.frequency.value = (binEnable.checked?(parseFloat(freq.value)||0)+ (parseFloat(binDiff.value)||0) : parseFloat(freq.value)||0); }catch{} });
  document.getElementById('freqRange').addEventListener('input', (e)=>{ freq.value = e.target.value; freq.dispatchEvent(new Event('input')); });
  document.getElementById('binEnable').addEventListener('change', ()=>playGen()); // rebuild graph
  document.getElementById('binDiff').addEventListener('change', ()=>playGen());
  document.getElementById('wf').addEventListener('change', ()=>playGen());
  document.getElementById('duty').addEventListener('input', ()=>playGen());
  document.getElementById('dutyNum').addEventListener('input', (e)=>{ duty.value=e.target.value; duty.dispatchEvent(new Event('input')); });
  document.getElementById('harmEnable').addEventListener('change', ()=>playGen());
  document.getElementById('harmBase').addEventListener('change', ()=>playGen());
  document.getElementById('harmOct').addEventListener('change', ()=>playGen());

  // teardown hook
  playGen._teardown = ()=>{
    try{ oscL.stop(); oscR.stop(); }catch(_){}
    [...harmOscs].forEach(o=>{ try{o.stop();}catch(_){}});
    [oscL,oscR,gainL,gainR,merger].forEach(n=>{ try{n&&n.disconnect();}catch(_){}});
    harmOscs.forEach(n=>{ try{n&&n.disconnect();}catch(_){}});
    harmGain.forEach(n=>{ try{n&&n.disconnect();}catch(_){}});
  };
}

function stopGen(){
  if(typeof playGen._teardown==='function'){ playGen._teardown(); }
  cancelAnimationFrame(rafId);
  clearOsc();
}

document.getElementById('genPlay').addEventListener('click', async ()=>{
  try{
    ensureCtx();
    if(aCtx.state==='suspended') await aCtx.resume();
    playGen();
  }catch(e){ console.warn(e); }
});
document.getElementById('genStop').addEventListener('click', ()=>{ stopGen(); });

/** Oscilloscope **/
const cvs=document.getElementById('osc');
const ctx2d=cvs.getContext('2d');

function getCtl(id, def){ const el=document.getElementById(id); if(!el) return def; const v=parseFloat(el.value); return isNaN(v)?def:v; }

function drawOsc(color){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const W = cvs.clientWidth, H = cvs.clientHeight;
  cvs.width = Math.max(1, Math.floor(W*dpr));
  cvs.height = Math.max(1, Math.floor(H*dpr));
  ctx2d.setTransform(dpr,0,0,dpr,0,0);
  ctx2d.clearRect(0,0,W,H);

  const zoom = getCtl('oscZoom',1);
  const gamma = getCtl('oscGamma',1);
  const line = getCtl('oscLine',2);
  ctx2d.lineWidth = line;
  ctx2d.strokeStyle = color || '#a05cff';

  const buf = new Uint8Array(1024);
  if(!analyser){
    // idle baseline
    ctx2d.beginPath(); ctx2d.moveTo(0,H*0.5); ctx2d.lineTo(W,H*0.5); ctx2d.stroke();
    rafId = requestAnimationFrame(()=>drawOsc(color));
    return;
  }
  try{ analyser.getByteTimeDomainData(buf); }catch{}

  ctx2d.beginPath();
  const step = Math.max(1, Math.floor((buf.length)/ (W/zoom)));
  let x=0;
  for(let i=0;i<buf.length;i+=step){
    const t = buf[i]/255; // 0..1
    const g = Math.pow(t, gamma);
    const y = g*H;
    if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    x += zoom;
    if(x>W) break;
  }
  ctx2d.stroke();
  rafId = requestAnimationFrame(()=>drawOsc(color));
}

function clearOsc(){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const W = cvs.clientWidth, H = cvs.clientHeight;
  cvs.width = Math.max(1, Math.floor(W*dpr));
  cvs.height = Math.max(1, Math.floor(H*dpr));
  ctx2d.setTransform(dpr,0,0,dpr,0,0);
  ctx2d.clearRect(0,0,W,H);
}

/** Palette (icon + popover) **/
(function(){
  const btn = document.getElementById('oscColorBtn');
  const pop = document.getElementById('oscPop');
  const sw = document.getElementById('oscSwatches');
  const colorSel = document.getElementById('oscColor');
  const palette = ['#a05cff','#39e3ff','#00ffd5','#00ff7f','#ffd166','#ff5ea0','#ffffff','#d2d2d2','#8fbcff','#6a3eff','#b68cff','#d08bff'];
  palette.forEach(c=>{
    const b=document.createElement('button'); b.className='osc-swatch'; b.style.background=c;
    b.addEventListener('click',()=>{
      colorSel.value=c;
      btn.style.background = `linear-gradient(135deg, ${c}, ${c})`;
      drawOsc(c);
      pop.classList.remove('show');
    });
    sw.appendChild(b);
  });
  btn.style.background = `linear-gradient(135deg, ${colorSel.value}, ${colorSel.value})`;
  btn.addEventListener('click',(e)=>{ e.stopPropagation(); pop.classList.toggle('show'); });
  document.addEventListener('click',(e)=>{ if(!pop.contains(e.target) && e.target!==btn){ pop.classList.remove('show'); } });
  colorSel.addEventListener('input',()=> drawOsc(colorSel.value));
})();

/** Presets (localStorage) **/
(function(){
  const KEY='fiveDO_gen_presets_v1';
  const sel = document.getElementById('presetLoad');
  const saveBtn = document.getElementById('presetSave');
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
  function rebuild(){
    const arr = load();
    sel.innerHTML = `<option value="">${t('gen.preset_load')}</option>`;
    arr.forEach((p,i)=>{
      const opt=document.createElement('option'); opt.value=String(i); opt.textContent=p.name||('Preset '+(i+1)); sel.appendChild(opt);
    });
  }
  function snap(){
    return {
      name:'Preset '+new Date().toLocaleTimeString(),
      wf: wf.value,
      freq: parseFloat(freq.value)||432,
      bin: binEnable.checked,
      diff: parseFloat(binDiff.value)||4,
      duty: parseInt(duty.value||'50',10)||50,
      color: document.getElementById('oscColor').value,
      zoom: parseFloat(oscZoom.value)||1,
      gamma: parseFloat(oscGamma.value)||1,
      line: parseFloat(oscLine.value)||2,
      harm: harmEnable.checked,
      hbase: harmBase.value,
      hoct: parseInt(harmOct.value||'0',10)||0
    };
  }
  function apply(p){
    wf.value=p.wf; freq.value=p.freq; freqRange.value=p.freq;
    binEnable.checked=!!p.bin; binDiff.value=p.diff;
    duty.value=p.duty; dutyNum.value=p.duty;
    document.getElementById('oscColor').value=p.color;
    oscZoom.value=p.zoom; oscGamma.value=p.gamma; oscLine.value=p.line;
    harmEnable.checked=!!p.harm; harmBase.value=p.hbase; harmOct.value=p.hoct;
    drawOsc(p.color||document.getElementById('oscColor').value);
  }
  saveBtn.addEventListener('click', ()=>{
    const nm = prompt(t('gen.preset_name_prompt'));
    if(nm===null) return;
    const arr = load();
    const p = snap(); p.name = nm || ('Preset '+(arr.length+1));
    arr.push(p); save(arr); rebuild();
  });
  sel.addEventListener('change', (e)=>{
    const arr = load(); const idx = parseInt(e.target.value,10);
    if(!isNaN(idx) && arr[idx]) apply(arr[idx]);
  });
  rebuild();
})();

// Keep osc responsive on rotate/resize
addEventListener('resize', ()=>drawOsc(document.getElementById('oscColor').value));

// Tabs
const pageLib = document.getElementById('pageLibrary');
const pageGen = document.getElementById('pageGenerator');
const tabLib = document.getElementById('tabLibrary');
const tabGen = document.getElementById('tabGenerator');
function showLib(){ pageLib.style.display=''; pageGen.style.display='none'; tabLib.setAttribute('aria-selected','true'); tabGen.setAttribute('aria-selected','false'); }
function showGen(){ pageLib.style.display='none'; pageGen.style.display=''; tabLib.setAttribute('aria-selected','false'); tabGen.setAttribute('aria-selected','true'); }
tabLib.addEventListener('click', showLib);
tabGen.addEventListener('click', showGen);
// Align default to Library page
showLib();
</script>
</body>
</html>
