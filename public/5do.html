<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
<title>5DO</title>
<link rel="manifest" href="/manifest.webmanifest">

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
html, body {
  width: 100%;
  max-width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}
	:root{
  --bg:#0a0f14; --panel:#0e1520; --line:#13243a; --muted:#8aa6c3; --txt:#e8f2ff;
  --blue:#9fe5ff; --blue2:#39e3ff; --stroke:#1d415f; --glow:rgba(57,227,255,.18);
  --card:#0b131e; --thumb:#0a1018; --accent:#7fd9ff;
  --title-glow:0 0 3px rgba(180,240,255,1),0 0 8px rgba(110,220,255,.95),0 0 18px rgba(50,180,255,.85),0 0 36px rgba(0,120,255,.7);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Noto Sans KR, sans-serif}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
/* Ïï± Ï†ÑÏ≤¥ Î†àÏù¥ÏïÑÏõÉ Ïâò */
#appShell,
#app {                /* Ïã§Ï†ú Ïì∞Îäî IDÏóê ÎßûÏ∂∞ÏÑú ÌïòÎÇòÎßå ÎÇ®Í≤®ÎèÑ Îê® */
  width: 100%;
  max-width: 520px;   /* Í∞§Îü≠Ïãú Ìè¥ÎìúÏóêÏÑú ÎÑàÎ¨¥ Ï¢ÅÍ≤å ÎäêÍª¥ÏßÄÎ©¥ 540~600ÍπåÏßÄ Ïò¨Î†§Î¥êÎèÑ Îê® */
  margin: 0 auto;     /* ÌôîÎ©¥ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ */
  min-height: 100vh;
  padding: 0 10px 12px;
}
	
/* Header */
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;background:linear-gradient(180deg,#0a1018,#0a0f14 60%);border-bottom:1px solid #0f1b2a}
.left-pack{display:flex;align-items:center;gap:10px}
.app-title{color:var(--blue);text-shadow:var(--title-glow);white-space:nowrap;font-weight:800;font-size:18px}
.center-tabs{position:absolute;left:calc(50% + 24px);transform:translateX(-50%);top:10px;display:flex;gap:8px}
.tab{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}
.tab.active{background:#0f2336}
.right-pack{display:flex;align-items:center;gap:8px;transform:translateX(-12px)}
#langBtn{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f}

/* Hamburger */
.hamburger{width:21px;height:22px;position:relative;transform:translateY(0px)}
.hamburger span,.hamburger span:before,.hamburger span:after{
  position:absolute;left:0;right:0;height:2px;background:#8fe8ff;content:"";box-shadow:0 0 6px rgba(110,220,255,.95),0 0 14px rgba(50,180,255,.85)
}
.hamburger span{top:10px}
.hamburger span:before{top:-8px}
.hamburger span:after{top:8px}
.dropdown{position:absolute;top:42px;left:0;background:#0b1420;border:1px solid #16324f;min-width:260px;border-radius:12px;
  box-shadow:0 16px 40px rgba(0,0,0,.45);display:none;max-height:70vh;overflow:auto}
.dropdown a{display:block;padding:11px 14px;border-bottom:1px solid #0f1b2a}
.dropdown a:last-child{border-bottom:0}
.dropdown a:hover{background:#0e1a2a}
.menu-container{position:relative}

/* Main */
main{padding:12px}
.hidden{display:none!important}

/* Library status */
.status{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin:6px 0 12px}
#statusThumb{width:120px;height:120px;border:1px solid #14253b;border-radius:18px;background:#0b1018;background-size:cover;background-position:center;flex-shrink: 0;}
.status-blank{
  background-image:radial-gradient(60% 40% at 50% 0%, rgba(90,210,255,.08), rgba(0,0,0,0)),
                   radial-gradient(70% 60% at 50% 100%, rgba(0,120,255,.06), rgba(0,0,0,0));
}
.status-meta{min-width:220px;max-width:min(560px,60vw)}
.status-title{
  font-weight:700;
  margin-bottom:2px;             /* ÌÉÄÏù¥ÌãÄ ÏïÑÎûò ÏÇ¥ÏßùÎßå Í∞ÑÍ≤© */
  font-size: clamp(12px, 4vw, 18px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}

#statusThumb.status-blank{
  display:none;
}

.status-title.playing{
  background:linear-gradient(90deg,#b6ecff,#39e3ff,#7fffd4,#39e3ff,#b6ecff);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  animation:cycle 4.5s linear infinite
}
@keyframes cycle{0%{background-position:0%}100%{background-position:200%}}
.status-line{color:#9bbad6;opacity:.9;font-size:13px;line-height:1.4}

/* Player + nav */
.playerbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.playerbar .controls button{background:#0d1e2f;border:1px solid var(--stroke);color:var(--txt);padding:8px 10px;border-radius:10px;box-shadow:inset 0 0 10px var(--glow)}
.nav-row{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
.nav-row .nav-btn{width:48px;height:48px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;background:#0d1e2f;border:1px solid var(--stroke);box-shadow:inset 0 0 10px var(--glow);padding:0}
.nav-row .nav-btn svg{width:24px;height:24px;stroke:#8fe8ff;fill:none;filter:drop-shadow(0 0 4px rgba(110,220,255,.9)) drop-shadow(0 0 10px rgba(50,180,255,.7))}

/* Track Info Panel */
.track-info-panel{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  background:#0b131e;
  border:1px solid #102035;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.track-info-title{
  font-weight:800;
  margin-bottom:6px;
  color:#cfe9ff;
}
.track-info-body{
  font-size:13px;
  line-height:1.5;
  color:#9bbad6;
  max-height:21vh;
  overflow:auto;
  padding-right:4px;	
}

/* Generator main sliders are hidden (we use popup instead) */
#freqRange,
#duty {
  display: none;
}

/* Search/Filter */
.filterbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:4px 0 10px}
.filterbar input, .filterbar select{background:#0f1a28;border:1px solid #13263c;color:#e9f4ff;border-radius:10px;padding:8px 10px}
#favOnlyBtn.active {
  background:#39e3ff;
  color:#050910;
}

/* Thumbs */
#favoritesWrap{margin:10px 0 2px 0; display:none;}
#favoritesTitle{color:#cfe9ff;font-weight:800;margin:4px 0 8px 2px}
#favoritesStrip{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory}
#favoritesStrip .card{flex:0 0 132px;scroll-snap-align:start}

.strip{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;scroll-snap-type:x mandatory}
.card{flex:0 0 132px;display:flex;flex-direction:column;background:var(--card);
  border:1px solid #102035;border-radius:14px;overflow:hidden;cursor:pointer;scroll-snap-align:start;position:relative}
.thumb{width:100%;height:132px;background:var(--thumb);background-size:cover;background-position:center}
.card .star{
  position:absolute; right:8px; bottom:8px; width:26px; height:26px;
  border-radius:9px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.15);
  display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(2px);
}
.card .star svg{width:18px;height:18px; stroke:#8fe8ff; fill:none; filter: drop-shadow(0 0 4px rgba(110,220,255,.8))}
.card.fav .star svg{ fill:#9fe5ff; stroke:#9fe5ff; }




/* ===== Library Vertical List UI (folders/tracks) ===== */
#libBrowseView{display:block}
#libPlayerView{display:block}
#libPlayerView.hidden{display:none!important}

/* strip becomes vertical list in browse mode */
.strip.vstrip{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:visible;
  padding:6px 0;
}

/* Folder banner row */
.v-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:var(--card);
  border:1px solid #102035;
  cursor:pointer;
}
.v-item:hover{transform:translateY(-1px)}
.v-thumb{
  width:132px;
  height:132px;
  border-radius:12px;
  background:var(--thumb);
  background-size:cover;
  background-position:center;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,.06);
}
.v-meta{min-width:0; display:flex; flex-direction:column; gap:4px}
.v-title{
  font-weight:800;
  color:#cfe9ff;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.v-sub{
  color:#9bbad6;
  font-size:12.5px;
  line-height:1.35;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* Track row layout */
.v-item.track .v-thumb{ width:84px; height:84px; }
.v-item.track{ position:relative; padding-right:44px; }
.v-item.track .star{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:34px; height:34px; border-radius:12px;
}

/* Player view hero */
#libPlayerView .status{margin-top:6px}
#libPlayerView #statusThumb{
  width:min(320px, 86vw);
  height:min(320px, 86vw);
  border-radius:22px;
}
#libPlayerView .status{flex-direction:column; align-items:center; text-align:center}
#libPlayerView .status-meta{max-width:520px; width:100%}
#libPlayerView #metaDesc{display:none}
#libPlayerView .playerbar{justify-content:center}
#libPlayerView .controls{display:flex; flex-wrap:wrap; justify-content:center; gap:8px}

/* Library player oscilloscope */
.lib-osc-wrap{margin-top:10px}
#libOsc{
  display:block;
  width:100%;
  height:150px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  background:#02070d;
}

/* Generator */
.section{margin-top:14px;border-top:1px solid #0f1b2a;padding-top:12px}
.gen-grid{display:grid;gap:10px}
.gen-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.gen-toolbar .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--stroke);background:#0d1e2f;box-shadow:inset 0 0 10px var(--glow)}
.gen-row2{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
@media (max-width:640px){.gen-row2{grid-template-columns:1fr}}
.gen-row2.inline-h{grid-template-columns:90px 1fr}
.gen-inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
/* Îëê Í∞úÏùò gen-row2 Î∏îÎü≠ÏùÑ Ìïú Ï§ÑÏóê Î∞∞Ïπò (Frequency+Duty, ToneA+ToneB Ïö©) */
.gen-row2-pair{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

/* Î™®Î∞îÏùºÏóêÏÑúÎèÑ 2Ïª¨Îüº Ïú†ÏßÄ */
@media (max-width:640px){
  .gen-row2-pair{
    grid-template-columns:1fr 1fr;
  }
}
.gen-inline .gen-input{min-width:80px}
.gen-chip{padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0d1e2f;color:var(--txt);font-size:12px}
.gen-input, .gen-range, select{background:#0f1a28;border:1px solid #13263c;color:#e9f4ff;border-radius:10px}
.gen-range{height:32px}
label.gen-label{color:#cfe9ff;font-weight:700}
.gen-sub{font-size:12px;color:#cfe9ff}
.small-note{font-size:12px;color:#a7c4de}

/* Oscilloscope */
.osc-wrap{position:relative}
#osc{display:block;width:100%;height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#02070d}
@media (max-width:420px){ #osc{height:140px} }
.osc-toolbar{position:absolute;top:8px;right:8px;display:flex;align-items:center;gap:8px;z-index:6}
.osc-color-btn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:linear-gradient(135deg,#3be8ff,#1f7aff);box-shadow:0 2px 8px rgba(0,0,0,.25);cursor:pointer}
.osc-pop{position:absolute;top:40px;right:0;padding:10px;border-radius:12px;background:rgba(15,17,24,.96);border:1px solid rgba(255,255,255,.12);box-shadow:0 12px 28px rgba(0,0,0,.35);display:none}
.osc-pop.show{display:block}
.osc-swatches{display:grid;grid-template-columns:repeat(6,22px);gap:8px}
.osc-swatch{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,255,255,.25);cursor:pointer}

/* Modal */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:90}
.modal{position:fixed;inset:auto 10px 10px 10px;top:8%;max-width:760px;max-height:80vh;
  background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.4);display:none;z-index:101;padding:16px}
.mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#modalBody{white-space:pre-wrap;line-height:1.55;color:#d7e8ff;max-height:60vh;overflow:auto}

/* Playlist Panel */
#plPanel{display:none; position:fixed; inset:auto 10px 10px 10px; top:12%; max-width:760px; margin:auto;
  background:#0e1520;border:1px solid #18304c;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.45); z-index:120}
#plHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #15263f}
#plBody{padding:12px 14px; display:grid; gap:10px; max-height:56vh; overflow:auto}
.pl-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0b1420;border:1px solid #12253e;border-radius:10px;padding:8px 10px}
#plFoot{display:flex;justify-content:flex-end;gap:10px;padding:10px 14px;border-top:1px solid #15263f}
.btn{background:#0d1e2f;border:1px solid #1d415f;color:#e8f2ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn:hover{transform:translateY(-1px)}
.small{font-size:12px;padding:6px 8px}

/* ===== Playlist Controls (UX) ===== */
.pl-controls{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(6px);
}

.pl-spacer{ flex:1; }

.pl-icbtn{
  position:relative;
  width:38px;
  height:38px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

.pl-icbtn:hover{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.18);
}

.pl-icbtn:active{ transform: scale(.98); }
.pl-icbtn[disabled]{ opacity:.45; cursor:not-allowed; }

.pl-ic{
  width:20px; height:20px;
  fill: rgba(255,255,255,.85);
}

.pl-icbtn.is-on{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.30);
}

.pl-icbtn.is-on .pl-ic{ fill: rgba(255,255,255,1); }

.pl-badge{
  position:absolute;
  right:6px; top:6px;
  min-width:16px; height:16px;
  padding:0 4px;
  border-radius:999px;
  font-size:11px;
  line-height:16px;
  text-align:center;
  background: rgba(255,255,255,.85);
  color:#000;
  display:none;
}

/* ÌëúÏãúÎê† Îïå */
.pl-icbtn.is-loop-all .pl-badge{ display:inline-block; }
.pl-icbtn.is-loop-all .pl-badge{ content:"‚àû"; }

.pl-toast{
  position: fixed;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  padding:10px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.65);
  border: 1px solid rgba(255,255,255,.16);
  color: rgba(255,255,255,.92);
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  z-index: 99999;
}

.pl-toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(-4px);
}

/* ===== Playlist items highlight ===== */
.pl-item.is-playing{
  outline: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.06);
}

/* ===== Numeric Popup (Generator) ===== */
.num-popup-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.num-popup-backdrop.show{
  display:flex;
}

.num-popup-panel{
  width:min(360px, 90vw);
  padding:14px 16px 12px;
  border-radius:16px;
  background:#050a10;
  border:1px solid #15324a;
  box-shadow:0 18px 40px rgba(0,0,0,.7);
}

.num-popup-title{
  font-weight:700;
  margin-bottom:8px;
  color:#cfe9ff;
  text-shadow:0 0 8px rgba(110,220,255,.9);
}

.num-popup-body{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-bottom:10px;
}

#numPopupValue{
  width:100%;
}

#numPopupRange{
  width:100%;
}

.num-popup-footer{
  display:flex;
  justify-content:flex-end;
}

.num-popup-footer .btn.small{
  padding:6px 10px;
  font-size:13px;
}

/* ===== Generator ÌïòÎã® Í¥ëÍ≥† Î∞∞ÎÑà ===== */
#adBanner{
  margin-top:8px;
  padding-top:4px;
  border-top:1px solid #0f1b2a;
}

.ad-banner-wrap{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  border:1px solid #102035;
  background:#050a10;
}

.ad-banner-img{
  display:block;
  width:100%;
  height:auto;
}

/* ÏûëÏùÄ Ï†ê(Ïä¨ÎùºÏù¥Îìú Ïù∏ÎîîÏºÄÏù¥ÌÑ∞) */
.ad-banner-dots{
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:6px;
}

.ad-dot{
  width:7px;
  height:7px;
  border-radius:50%;
  background:#253447;
  cursor:pointer;
}

.ad-dot.active{
  background:#39e3ff;
}	

/* Cleanup */
#verBadge{display:none}

/* Visualizer removed */
#libOsc{display:none !important;}
</style>
</head>
<body>
	<div id="appShell">
<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener" data-i18n="menu.shop">Shop</a>
        <a href="#" class="menu-text" data-txt="faq" data-i18n="menu.faq">FAQ</a>
        <a href="#" class="menu-text" data-txt="manual" data-i18n="menu.manual">Manual</a>
        <a href="#" class="menu-text" data-txt="contact" data-i18n="menu.contact">Contact</a>
        <a href="#" class="menu-text" data-txt="about" data-i18n="menu.about">About</a>
      </div>
    </div>
    <div class="app-title">5DO</div>
  </div>

  <div class="center-tabs">
    <button id="tabLibrary" class="tab active" data-i18n="tab.library">Library</button>
    <button id="tabGenerator" class="tab" data-i18n="tab.generator">Generator</button>
  </div>

  <div class="right-pack">
    <button id="langBtn">KR/EN</button>
  </div>
</header>

<main>
  <!-- Library -->
  <section id="pageLibrary">
    <div class="nav-row">
      <button id="btnBack" class="nav-btn" title="Back" aria-label="Back">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M15 6l-6 6 6 6"/></svg>
      </button>
      <button id="btnHome" class="nav-btn" title="Home" aria-label="Home">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M3 12l9-8 9 8"/><path d="M9 21V9h6v12"/></svg>
      </button>
      <button id="btnRefresh" class="nav-btn" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7" fill="none"><path d="M21 12a9 9 0 1 0-2.64 6.36"/><path d="M21 12v-6h-6"/></svg>
      </button>
    </div>

   <!-- Í≤ÄÏÉâ/ÌïÑÌÑ∞ -->
<div class="filterbar">
  <input id="searchInput" type="text" data-i18n-placeholder="search.placeholder" placeholder="Í≤ÄÏÉâÏñ¥‚Ä¶" />

  <select id="searchMode">
    <option value="folder" data-i18n="search.mode.folder">Ìè¥Îçî</option>
    <option value="track"  data-i18n="search.mode.track">Í≥°Î™Ö</option>
  </select>

  <button id="searchBtn" class="btn small" data-i18n="search.btn.search">Í≤ÄÏÉâ</button>
  <button id="searchClear" class="btn small" data-i18n="search.btn.clear">ÏßÄÏö∞Í∏∞</button>

  <button id="favOnlyBtn" class="btn small" data-i18n="filter.favOnly">‚òÖ Ï¶êÍ≤®Ï∞æÍ∏∞Îßå</button>
</div>

    <div id="libBrowseView">
<div id="favoritesWrap">
      <div id="favoritesTitle">‚òÖ Favorites</div>
      <div id="favoritesStrip"></div>
    </div>

    <div class="strip vstrip" id="strip"></div>
</div>

<div id="libPlayerView" class="hidden">


    <div class="status">
      <div id="statusThumb" class="status-blank"></div>
      <div class="status-meta">
        <div id="metaTitle" class="status-title"></div>
        <div id="metaDesc" class="status-line"></div>
        <div id="metaComposer" class="status-line"></div>
      </div>
    </div>

    <div class="playerbar">
      <div class="controls">
        <button id="btnPlay" data-i18n="player.play">Play</button>
        <button id="btnPause" data-i18n="player.pause">Pause</button>
        <button id="btnLoop" data-i18n="player.loop">Loop</button>
        <button id="btnTimer" data-i18n="player.timer">Timer</button>
        <button id="btnPlaylist" data-i18n="player.playlists" onclick="openPlPanel()">Playlists</button>
      </div>
      <audio id="player" controls playsinline style="width:min(520px, 100%);"></audio>
    </div>
    
  
    <!-- Track Info Panel (ÏÑ†Í≥° ÏÑ§Î™Ö ÏòÅÏó≠) -->
    
    <!-- Library Player Oscilloscope -->
    <div class="lib-osc-wrap">
      <canvas id="libOsc"></canvas>
    </div>

<section id="trackInfoPanel" class="track-info-panel">
      <div id="trackInfoTitle" class="track-info-title"></div>
      <div id="trackInfoBody" class="track-info-body"></div>
    </section>
 

</div>

<!-- Playlist Panel -->
   <div id="plPanel" role="dialog" aria-modal="true" aria-labelledby="plTitle">
   <div id="plHead">
    <div id="plTitle" style="color:#cfe9ff;font-weight:800">Playlists</div>
    <div>
      <button id="plNewBtn" class="btn small">+ New</button>
      <button id="plAddCurrentBtn" class="btn small" data-i18n="pl.addCurrent">Add Current Track</button>
      <button id="plImportBtn" class="btn small">Import</button>
      <button id="plExportBtn" class="btn small">Export</button>
      <button id="plCloseBtn" class="btn small">Close</button>
    </div>
   </div>
 
 <div id="plBody"></div>
  <div id="plFoot">
    <button id="plSaveBtn" class="btn">Save</button>
  </div>
  <div class="pl-controls" id="plControls">
  <button id="plPlayAllBtn" class="pl-icbtn" title="Play playlist">
    <svg viewBox="0 0 24 24" class="pl-ic"><path d="M8 5v14l11-7z"/></svg>
  </button>

  <button id="plPrevBtn" class="pl-icbtn" title="Previous">
    <svg viewBox="0 0 24 24" class="pl-ic"><path d="M6 6h2v12H6zM20 6v12l-10-6z"/></svg>
  </button>

  <button id="plNextBtn" class="pl-icbtn" title="Next">
    <svg viewBox="0 0 24 24" class="pl-ic"><path d="M16 6h2v12h-2zM4 18V6l10 6z"/></svg>
  </button>

  <button id="plShuffleBtn" class="pl-icbtn" title="Shuffle">
    <svg viewBox="0 0 24 24" class="pl-ic">
      <path d="M16 3h5v5h-2V6.41l-3.59 3.59-1.41-1.41L17.59 5H16V3zM3 7h5.5c1.38 0 2.71.55 3.69 1.53l1.28 1.28-1.41 1.41-1.28-1.28A3.25 3.25 0 0 0 8.5 9H3V7zm0 10h5.5c.86 0 1.69-.34 2.3-.95l7.29-7.29 1.41 1.41-7.29 7.29A5.25 5.25 0 0 1 8.5 19H3v-2zm18-1v-2h-2v3h3v-2h-1zm-2.41-2.59L19 13.59V16h-2v-5h5v2h-2.41z"/>
    </svg>
  </button>

  <button id="plLoopBtn" class="pl-icbtn" title="Loop">
    <svg viewBox="0 0 24 24" class="pl-ic">
      <path d="M17 17h-2v-2h4v-4h2v6h-6v-0zM7 7h2v2H5v4H3V7h4zm0 10h10v2H7a4 4 0 0 1-4-4v-3h2v3a2 2 0 0 0 2 2zm10-10H7V5h10a4 4 0 0 1 4 4v3h-2V9a2 2 0 0 0-2-2z"/>
    </svg>
    <span class="pl-badge" id="plLoopBadge">1</span>
  </button>

  <span class="pl-spacer"></span>

  <!-- Í∏∞Ï°¥ Î≤ÑÌäºÎì§(ÏÉàÎ™©Î°ù/ÎÇ¥Î≥¥ÎÇ¥Í∏∞/Í∞ÄÏ†∏Ïò§Í∏∞/Ï†ÄÏû•/Îã´Í∏∞)ÏùÄ ÎÑà UIÏóê ÎßûÍ≤å ÏòÜÏóê ÎëêÎ©¥ Îê® -->
</div>

<div id="plToast" class="pl-toast" aria-live="polite">
</div>

   </section>
	


    <!-- Generator -->
    <section id="pageGenerator" class="hidden">
    <div class="osc-wrap">
    <canvas id="osc"></canvas>
    <div class="osc-toolbar" id="oscToolbar">
      <div class="osc-pop" id="oscPop">
        <div class="osc-swatches" id="oscSwatches"></div>
      </div>
    </div>
  </div>

  <div class="gen-toolbar" style="margin-top:6px">
    <button id="genPlay" class="btn" data-i18n="play"></button>
    <button id="genStop" class="btn" data-i18n="stop"></button>

    <button id="presetSave" class="btn" data-i18n="preset_save"></button>
    <button id="presetOverwrite" class="btn" data-i18n="preset_overwrite" title=""></button>
    <button id="presetRename" class="btn" data-i18n="preset_rename" title=""></button>
    <button id="presetDelete" class="btn" data-i18n="preset_delete" title=""></button>

    <select id="presetLoad" class="gen-input" style="min-width:200px">
      <option value="" disabled selected data-i18n="preset_load"></option>
    </select>

    <button id="presetExport" class="btn" data-i18n="preset_export"></button>
    <button id="presetImport" class="btn" data-i18n="preset_import"></button>
    <select id="oscColor" class="gen-input" style="margin-left:auto;min-width:120px">
      <option value="#39e3ff" data-i18n="osc.color.neonBlue">Neon Blue</option>
      <option value="#00ffd5" data-i18n="osc.color.aqua">Aqua</option>
      <option value="#00ff7f" data-i18n="osc.color.green">Neon Green</option>
      <option value="#ffd166" data-i18n="osc.color.amber">Amber</option>
      <option value="#ff5ea0" data-i18n="osc.color.magenta">Magenta</option>
      <option value="#ffffff" data-i18n="osc.color.white">White</option>
    </select>
  </div>

  <div class="gen-grid" style="margin-top:8px">
    <div class="gen-row2">
  <label class="gen-label" data-i18n="gen.waveform">Waveform</label>
  <div class="gen-inline">
    <select id="wf" class="gen-input">
      <!-- üîπ Ïó¨Í∏∞ ‚ÄúÍ∏∞Î≥∏ ÌÖçÏä§Ìä∏‚ÄùÎäî ÏòÅÏñ¥Î°ú ÎëêÎäî Í≤å ÏïàÏ†Ñ -->
      <option value="sine"     data-i18n="gen.wave.sine">Sine</option>
      <option value="square"   data-i18n="gen.wave.square">Square</option>
      <option value="triangle" data-i18n="gen.wave.triangle">Triangle</option>
      <option value="sawtooth" data-i18n="gen.wave.saw">Saw</option>
    </select>

    <span class="gen-chip" data-i18n="gen.binaural">Binaural</span>
    <input type="checkbox" id="binEnable"/>
    <label class="gen-sub" data-i18n="gen.diff">Difference (Hz)</label>
    <input id="binDiff" class="gen-input" type="number" min="0" max="40" step="0.1" value="4"/>
  </div>
</div>

 <div class="gen-row2-pair">
    <div class="gen-row2 inline-h">
      <label class="gen-label" data-i18n="gen.frequency">Frequency (Hz)</label>
      <div class="gen-inline">
        <input id="freq" class="gen-input num-popup-field"
               type="number" min="0" max="20000" step="0.1" value="432"/>
        <input id="freqRange" class="gen-range" type="range"
               min="0" max="20000" step="1" value="432" style="flex:1">
      </div>
    </div>

    <div class="gen-row2 inline-h">
      <label class="gen-label" data-i18n="gen.duty">Duty Cycle</label>
      <div class="gen-inline">
        <input id="dutyNum" class="gen-input num-popup-field"
               type="number" min="1" max="100" step="1" value="50"/>
        <input id="duty" class="gen-range" type="range"
               min="1" max="100" step="1" value="50" style="flex:1">
      </div>
    </div>
  </div>

    <div class="gen-row2">
      <label class="gen-label" data-i18n="harmonics_label">Harmonics</label>
      <div class="gen-inline">
        <label class="gen-sub" data-i18n="harmonics_enable">Enable</label>
        <input id="harmEnable" type="checkbox">
        <label class="gen-sub" data-i18n="harmonics_base">Base</label>
        <select id="harmBase" class="gen-input">
          <option value="fund" data-i18n="harm_base_fund">Fundamental</option>
          <option value="mid"  data-i18n="harm_base_mid">Mid (x2)</option>
          <option value="high" data-i18n="harm_base_high">High (x4)</option>
        </select>
        <label class="gen-sub" data-i18n="harm_octaves"># of Octaves</label>
        <select id="harmOct" class="gen-input">
          <option value="0">0</option><option value="1">1</option>
          <option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
      </div>
    </div>
  </div><!-- gen-grid ÎÅù -->

  <!-- üîª Ïó¨Í∏∞Î∂ÄÌÑ∞ Ï∂îÍ∞ÄÎêú Generator Ï†ÑÏö© ÌïòÎã®Î∂Ä üîª -->

  <!-- Quick Presets -->
<section class="section" id="quickPresets">
  <div class="gen-label" style="margin-bottom:6px;"
       data-i18n="gen.quick_presets">Quick Presets</div>
  <div class="gen-inline" style="flex-wrap:wrap; gap:8px;">
    <button class="gen-chip qp"
            data-freq="528" data-wf="sine"
            data-i18n="gen.qp_528">528 Hz</button>

    <button class="gen-chip qp"
            data-freq="432" data-wf="sine"
            data-i18n="gen.qp_432">432 Hz</button>

    <button class="gen-chip qp"
            data-freq="174" data-wf="sine"
            data-i18n="gen.qp_174">174 Solfeggio</button>

    <button class="gen-chip qp"
            data-freq="7.83" data-wf="sine"
            data-i18n="gen.qp_schumann">Schumann</button>

    <button class="gen-chip qp"
            data-freq="40" data-wf="sine"
            data-i18n="gen.qp_gamma40">Gamma 40</button>
  </div>
</section>

<section class="section" id="dualTone">
  <label class="gen-label" style="margin-bottom:6px;" data-i18n="dual.label">
    Dual-Tone Mixer
  </label>

  <div class="gen-row2-pair">
    <div class="gen-row2 inline-h">
      <label class="gen-sub" data-i18n="dual.toneA">ÌÜ§ A (Hz)</label>
      <div class="gen-inline">
        <input id="toneA"
               class="gen-input num-popup-field"
               type="number" min="0" max="20000" step="0.1"
               value="432">
      </div>
    </div>

    <div class="gen-row2 inline-h">
      <label class="gen-sub" data-i18n="dual.toneB">ÌÜ§ B (Hz)</label>
      <div class="gen-inline">
        <input id="toneB"
               class="gen-input num-popup-field"
               type="number" min="0" max="20000" step="0.1"
               value="528">
      </div>
    </div>
  </div>

  <!-- Numeric Popup for Generator -->
  <div id="numPopup" class="num-popup-backdrop">
    <div class="num-popup-panel">
      <div id="numPopupLabel" class="num-popup-title"></div>
      <div class="num-popup-body">
        <input id="numPopupValue" type="number" class="gen-input" />
        <input id="numPopupRange" type="range" class="gen-range" />
      </div>
      <div class="num-popup-footer">
        <button id="numPopupClose" class="btn small">‚úï Close</button>
      </div>
    </div>
  </div>

  <div class="gen-inline" style="margin-top:8px;">
    <button id="dualPlay" class="btn" data-i18n="dual.play">Play Dual</button>
    <button id="dualStop" class="btn" data-i18n="dual.stop">Stop</button>
  </div>
</section>

 <section class="section" id="adBanner">

  <a id="adBannerLink" class="ad-banner-wrap" href="#" target="_blank" rel="noopener noreferrer">
    <img id="adBannerImg"
         class="ad-banner-img"
         src=""
         alt="Banner">
  </a>

  <div class="ad-banner-dots" id="adBannerDots"></div>
</section>
  <!-- üî∫ Generator ÌïòÎã® Í¥ëÍ≥† Î∞∞ÎÑà ÎÅù üî∫ -->
	
<div class="backdrop" id="backdrop"></div>
<div class="modal" id="modal">
  <div class="mhead">
    <div id="modalTitle" style="font-weight:800;color:#cfe9ff">Info</div>
    <button id="modalClose" class="btn small">Close</button>
  </div>
  <div id="modalBody"></div>
</div>

</div>

<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const MEDIA_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}`;
// üîπ GitHub PagesÏóê Ïò¨Î†§Îëî Î∞∞ÎÑà/ÎÑ§ÎπÑ Ïù¥ÎØ∏ÏßÄ Î≤†Ïù¥Ïä§ Í≤ΩÎ°ú
const GITHUB_ASSET_BASE = 'https://paulkpark.github.io/5dio-app/assets';
	
// ===== META.JSON LOAD =====
let TRACK_META = {};

// meta.json Ìïú Î≤àÎßå Î°úÎî©
async function loadTrackMeta(){
  try{
    const url = `${MEDIA_BASE}/meta.json?t=${Date.now()}`;  // Ï∫êÏãú Î∞©ÏßÄ
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) {
      console.warn("[meta] meta.json load failed", res.status);
      return;
    }
    TRACK_META = await res.json();
    console.log("[meta] meta.json loaded", TRACK_META);
  } catch (e) {
    console.warn("[meta] meta.json error", e);
  }
}

// lang Ïóê ÎßûÎäî ÌïÑÎìú Í∞ÄÏ†∏Ïò§Í∏∞ helper
function getLocalized(meta, base){
  if (!meta) return "";
  if (LANG === "ko") return meta[`${base}_ko`] || meta[`${base}_kr`] || meta[base] || "";
  return meta[`${base}_en`] || meta[base] || meta[`${base}_ko`] || "";
}

// Ìä∏ÎûôÏóê Ìï¥ÎãπÎêòÎäî meta Î†àÏΩîÎìú Ï∞æÍ∏∞
function lookupTrackMeta(folder, fileName){
  if (!TRACK_META) return null;
  const s = stem(fileName);              // Ïòà: Heart_Brain_Cohesion
  const key1 = `${folder}/${s}`;         // Quantum_Torus_X/Heart_Brain_Cohesion
  const key2 = `${folder}/${fileName}`;  // Quantum_Torus_X/Heart_Brain_Cohesion.mp3
  const key3 = s;                        // Heart_Brain_Cohesion

  return TRACK_META[key1] || TRACK_META[key2] || TRACK_META[key3] || null;
}

/* ===== i18n ===== */
let LANG = (document.documentElement.lang==='en'?'en':'ko');

const I18N = {
  'ko': {
    'tab.library':'ÎùºÏù¥Î∏åÎü¨Î¶¨',
    'tab.generator':'Ï£ºÌååÏàò ÏÉùÏÑ±Í∏∞',
    'menu.shop':'Shop',
    'menu.faq':'FAQ',
    'menu.manual':'Îß§Îâ¥Ïñº',
    'menu.contact':'Ïó∞ÎùΩÏ≤ò',
    'menu.about':'ÏÜåÍ∞ú',

    'player.play':'Ïû¨ÏÉù',
    'player.pause':'ÏùºÏãúÏ†ïÏßÄ',
    'player.loop':'Î∞òÎ≥µ',
    'player.timer':'ÌÉÄÏù¥Î®∏',
    'player.playlists':'ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏',
    

    'play': 'Ïû¨ÏÉù',
    'stop': 'Ï†ïÏßÄ',
    'preset_save': 'ÌîÑÎ¶¨ÏÖã Ï†ÄÏû•',
    'preset_load': 'ÌîÑÎ¶¨ÏÖã Î∂àÎü¨Ïò§Í∏∞‚Ä¶',
    'preset_overwrite': 'ÎçÆÏñ¥Ïì∞Í∏∞',
    'preset_rename': 'Ïù¥Î¶ÑÎ≥ÄÍ≤Ω',
    'preset_delete': 'ÏÇ≠Ï†ú',
    'preset_export': 'ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
    'preset_import': 'Í∞ÄÏ†∏Ïò§Í∏∞',

    'gen.waveform':'ÌååÌòï',
    'gen.frequency':'Ï£ºÌååÏàò (Hz)',
    'gen.duty':'ÎèôÏûë ÎπÑÏú®',

	"gen.wave.sine":     "ÏÇ¨Ïù∏Ìåå",
    "gen.wave.square":   "ÏÇ¨Í∞ÅÌåå",
    "gen.wave.triangle": "ÏÇºÍ∞ÅÌåå",
    "gen.wave.saw":      "ÌÜ±ÎãàÌåå",

    // Binaural / Difference
    "gen.binaural": "Î∞îÏù¥ÎÖ∏Îü¥",
    "gen.diff":     "Ï∞®Ïù¥(Hz)",  

    // ‚ñº Quick Presets Í¥ÄÎ†®
    'gen.quick_presets':'ÌÄµ ÌîÑÎ¶¨ÏÖã',
    'qp.528':'528 Hz',
    'qp.432':'432 Hz',
    'qp.174':'174 ÏÜîÌéòÏßÄÏò§',
    'qp.schumann':'ÏäàÎßå Í≥µÎ™Ö',
    'qp.gamma40':'Í∞êÎßà 40',

    // ‚ñº Harmonics Í¥ÄÎ†®
    'harmonics_label':'ÌïòÎ™®ÎãâÏä§',
    'harmonics_enable':'ÌôúÏÑ±Ìôî',
    'harmonics_base':'Í∏∞Ï§Ä',
    'harm_base_fund':'Í∏∞Î≥∏ Ï£ºÌååÏàò',
    'harm_base_mid':'Ï§ëÍ∞Ñ (x2)',
    'harm_base_high':'Í≥†Ïó≠ (x4)',
    'harm_octaves':'Ïò•ÌÉÄÎ∏å Ïàò',

    // ‚ñº Dual-Tone Mixer Í¥ÄÎ†®
    'dual.label':'ÎìÄÏñº ÌÜ§ ÎØπÏÑú',
    'dual.toneA':'ÌÜ§ A (Hz)',
    'dual.toneB':'ÌÜ§ B (Hz)',
    'dual.play':'ÎìÄÏñº Ïû¨ÏÉù',
    'dual.stop':'Ï†ïÏßÄ',

    // ‚ñº Ïò§Ïã§Î°úÏä§ÏΩîÌîÑ ÏÉâÏÉÅ
    'osc.color.neonBlue':'ÎÑ§Ïò® Î∏îÎ£®',
    'osc.color.aqua':'ÏïÑÏø†ÏïÑ',
    'osc.color.green':'ÎÑ§Ïò® Í∑∏Î¶∞',
    'osc.color.amber':'Ïï∞Î≤Ñ',
    'osc.color.magenta':'ÎßàÏ††ÌÉÄ',
    'osc.color.white':'ÌôîÏù¥Ìä∏',

    // ‚ñº ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏
    'pl.no':'ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÉùÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî.',
    'pl.new':'ÏÉà Î™©Î°ù',
    'pl.delete':'ÏÇ≠Ï†ú',
    'pl.save':'Ï†ÄÏû•',
    'pl.import':'Í∞ÄÏ†∏Ïò§Í∏∞',
    'pl.export':'ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
    'pl.close':'Îã´Í∏∞',
    'pl.addCurrent':'ÌòÑÏû¨ Ìä∏Îûô Ï∂îÍ∞Ä',
    'pl.removeTrack':'ÏÇ≠Ï†ú',

    // ‚ñº Í≤ÄÏÉâ/ÌïÑÌÑ∞ UI (Ïù¥ÎØ∏ ÏÇ¨Ïö©Ï§ëÏùº Í∞ÄÎä•ÏÑ± ÏûàÏùå)
    'search.placeholder':'Í≤ÄÏÉâÏñ¥',
    'search.mode.folder':'Ìè¥Îçî',
    'search.mode.track':'Í≥°Î™Ö',
    'search.btn.search':'Í≤ÄÏÉâ',
    'search.btn.clear':'ÏßÄÏö∞Í∏∞',
    'filter.favOnly': '‚òÖ Ï¶êÍ≤®Ï∞æÍ∏∞Îßå'
  },
  'en': {
    'tab.library':'Library',
    'tab.generator':'Generator',
    'menu.shop':'Shop',
    'menu.faq':'FAQ',
    'menu.manual':'Manual',
    'menu.contact':'Contact',
    'menu.about':'About',

    'player.play':'Play',
    'player.pause':'Pause',
    'player.loop':'Loop',
    'player.timer':'Timer',
    'player.playlists':'Playlists',

    'play': 'Play',
    'stop': 'Stop',
    'preset_save': 'Save Preset',
    'preset_load': 'Load Preset‚Ä¶',
    'preset_overwrite': 'Overwrite',
    'preset_rename': 'Rename',
    'preset_delete': 'Delete',
    'preset_export': 'Export',
    'preset_import': 'Import',

    'gen.waveform':'Waveform',
    'gen.frequency':'Freq.(Hz)',
    'gen.duty':'Duty Cycle',

	 "gen.wave.sine":     "Sine",
    "gen.wave.square":   "Square",
    "gen.wave.triangle": "Triangle",
    "gen.wave.saw":      "Saw",

    // Binaural / Difference
    "gen.binaural": "Binaural",
    "gen.diff":     "Gap(Hz)",

    // ‚ñº Quick Presets
    'gen.quick_presets':'Quick Presets',
    'qp.528':'528 Hz',
    'qp.432':'432 Hz',
    'qp.174':'174 Solfeggio',
    'qp.schumann':'Schumann',
    'qp.gamma40':'Gamma 40',

    // ‚ñº Harmonics
    'harmonics_label':'Harmonics',
    'harmonics_enable':'Enable',
    'harmonics_base':'Base',
    'harm_base_fund':'Fundamental',
    'harm_base_mid':'Mid (x2)',
    'harm_base_high':'High (x4)',
    'harm_octaves':'Octaves',

    // ‚ñº Dual-Tone Mixer
    'dual.label':'Dual-Tone Mixer',
    'dual.toneA':'Tone A (Hz)',
    'dual.toneB':'Tone B (Hz)',
    'dual.play':'Play Dual',
    'dual.stop':'Stop',

    // ‚ñº Osc colors
    'osc.color.neonBlue':'Neon Blue',
    'osc.color.aqua':'Aqua',
    'osc.color.green':'Neon Green',
    'osc.color.amber':'Amber',
    'osc.color.magenta':'Magenta',
    'osc.color.white':'White',

    // ‚ñº Playlists
    'pl.no':'No playlists. Create one.',
    'pl.new':'New List',
    'pl.delete':'Delete',
    'pl.save':'Save',
    'pl.import':'Import',
    'pl.export':'Export',
    'pl.close':'Close',
    'pl.addCurrent':'Add Current Track',
    'pl.removeTrack':'Remove',

    // ‚ñº Search/filter
    'search.placeholder':'Search',
    'search.mode.folder':'Folder',
    'search.mode.track':'Track',
    'search.btn.search':'Search',
    'search.btn.clear':'Clear',
    'filter.favOnly': '‚òÖ Favorites Only'
  }
};

// ================================
// Loading thumb + i18n applyLang (fixed full block)
// ================================

// Ïñ∏Ïñ¥Ïóê Îî∞Îùº Î°úÎî© Ïç∏ÎÑ§Ïùº Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°úÎ•º ÎèåÎ†§Ï£ºÎäî Ìï®Ïàò
function getLoadingThumbUrl() {
  // ko: loading.webp, en: loading_E.webp
  return (LANG === 'en')
    ? MEDIA_BASE + '/_system/loading_E.webp'
    : MEDIA_BASE + '/_system/loading.webp';
}

// statusThumb ÏóòÎ¶¨Î®ºÌä∏Ïóê Ïç∏ÎÑ§ÏùºÏùÑ Ï†ÅÏö©ÌïòÎäî helper
function setStatusThumb(el, url){
  if(!el) return;

  el.style.backgroundImage = `url("${url}")`;
  el.style.backgroundSize = 'cover';
  el.style.backgroundPosition = 'center';
  el.style.backgroundRepeat = 'no-repeat';
}

/**
 * Î°úÎî© Ïç∏ÎÑ§ÏùºÏùÑ ÌòÑÏû¨ LANGÏóê ÎßûÍ≤å Îã§Ïãú ÏÑ∏ÌåÖ
 * - force=true: Ï∫êÏãú Î≤ÑÏä§Ìä∏Î°ú Î¨¥Ï°∞Í±¥ Í∞±Ïã†
 * - ONLY_WHEN_BLANK=trueÎ©¥ status-blank ÏÉÅÌÉúÏóêÏÑúÎßå Ï†ÅÏö© (ÏõêÌïòÎ©¥ trueÎ°ú Î≥ÄÍ≤Ω)
 */
const ONLY_WHEN_BLANK = true;

function refreshLoadingThumbForLang(force=true) {
  const el = document.getElementById('statusThumb');
  if (!el) return;

  if (ONLY_WHEN_BLANK && !el.classList.contains('status-blank')) {
    // Î°úÎî© ÏÉÅÌÉúÍ∞Ä ÏïÑÎãê ÎïåÎäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
    return;
  }

  let url = getLoadingThumbUrl();

  // Ï∫êÏãú Î¨∏Ï†ú Î∞©ÏßÄ: ÌÜ†Í∏Ä ÎïåÎßàÎã§ URLÏù¥ Îã¨ÎùºÏßÄÍ≤å
  if (force) {
    const sep = url.includes('?') ? '&' : '?';
    url = url + sep + 'lang=' + encodeURIComponent(LANG) + '&v=' + Date.now();
  }

  console.log('[refreshLoadingThumbForLang]', LANG, url);

  // ÌòπÏãú ÎèôÏùºÍ∞í Ïä§ÌÇµ/Î†åÎçî ÏßÄÏó∞ Î∞©ÏßÄ
  el.style.backgroundImage = 'none';
  requestAnimationFrame(() => setStatusThumb(el, url));
}

function applyLang(){
  // 1) data-i18n ÌÖçÏä§Ìä∏ ÎùºÎ≤®
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = I18N[LANG] && I18N[LANG][key];
    if(!val) return;

    const tag = el.tagName;
    if(tag === 'INPUT' || tag === 'TEXTAREA') el.value = val;
    else el.textContent = val;  // BUTTON, OPTION, DIV, SPAN...
  });

  // 2) placeholderÏö©
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.getAttribute('data-i18n-placeholder');
    const val = I18N[LANG] && I18N[LANG][key];
    if(val) el.placeholder = val;
  });

  // 3) ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ìó§Îçî Î≤ÑÌäºÎì§ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
  const plTitle   = document.getElementById('plTitle');
  const plNewBtn  = document.getElementById('plNewBtn');
  const plImport  = document.getElementById('plImportBtn');
  const plExport  = document.getElementById('plExportBtn');
  const plClose   = document.getElementById('plCloseBtn');
  const plSave    = document.getElementById('plSaveBtn');

  if (plTitle)  plTitle.textContent  = (LANG==='en'?'Playlists':'ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏');
  if (plNewBtn) plNewBtn.textContent = (LANG==='en'?'+ New':'+ ÏÉà Î™©Î°ù');
  if (plImport) plImport.textContent = (LANG==='en'?'Import':'Í∞ÄÏ†∏Ïò§Í∏∞');
  if (plExport) plExport.textContent = (LANG==='en'?'Export':'ÎÇ¥Î≥¥ÎÇ¥Í∏∞');
  if (plClose)  plClose.textContent  = (LANG==='en'?'Close':'Îã´Í∏∞');
  if (plSave)   plSave.textContent   = (LANG==='en'?'Save':'Ï†ÄÏû•');

  // 4) Ïù¥ÎØ∏ Ïû¨ÏÉù Ï§ëÏù∏ Ìä∏ÎûôÏùò Ïç∏ÎÑ§Ïùº¬∑Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ïñ∏Ïñ¥ Î∞òÏòÅ
  try{
    const playerEl      = document.getElementById('player');
    const statusThumbEl = document.getElementById('statusThumb');

    // player/srcÍ∞Ä ÏóÜÏúºÎ©¥ Î°úÎî© Ïç∏ÎÑ§Ïùº Ï™ΩÏóêÏÑú Ï≤òÎ¶¨ÌïòÎ©¥ ÎêòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Ï¢ÖÎ£å
    if (!playerEl || !playerEl.src || !statusThumbEl) {
      // nothing
    } else {
      const base = MEDIA_BASE + '/';

      // srcÍ∞Ä Ïö∞Î¶¨ ÎØ∏ÎîîÏñ¥ Í≤ΩÎ°úÍ∞Ä ÏïÑÎãàÎ©¥ Î°úÎî©Ï≤òÎüº Ï∑®Í∏â (Î°úÎî© Ïç∏ÎÑ§ÏùºÏóêÏÑú Ï≤òÎ¶¨)
      if (playerEl.src.startsWith(base)) {
        // Ïó¨Í∏∞Î∂ÄÌÑ∞Îäî Ïã§Ï†ú Ìä∏Îûô Ïç∏ÎÑ§Ïùº
        const rel   = decodeURIComponent(playerEl.src.slice(base.length));
        const parts = rel.split('/');
        const file  = parts.pop();
        const folder= parts.join('/');

        // Ìä∏Îûô Ïç∏ÎÑ§Ïùº Ï†ÅÏö© (ÎπÑÎ°úÎî© ÏÉÅÌÉú)
        const thumbUrl = trackThumb(folder, file);
        if(thumbUrl){
          statusThumbEl.classList.remove('status-blank');
          setStatusThumb(statusThumbEl, thumbUrl);
        }

        // meta
        const baseTitle = stem(file).replace(/[_\-]+/g,' ');
        const meta      = lookupTrackMeta(folder, file);

        let title    = baseTitle;
        let desc     = "";
        let composer = "";

        if(meta){
          title    = getLocalized(meta, 'title') || baseTitle;
          desc     = getLocalized(meta, 'desc');
          composer = meta.composer || getLocalized(meta, 'composer') || "";
        }

        // ÏÉÅÎã® ÏÉÅÌÉú ÌÖçÏä§Ìä∏
        if (typeof statusTitle !== 'undefined' && statusTitle) {
          statusTitle.textContent = title;
          statusTitle.classList.add('playing');
        }

        // info Ìå®ÎÑê ÏóÖÎç∞Ïù¥Ìä∏
        if (typeof infoTitle !== 'undefined' && infoTitle) infoTitle.textContent = title;
        if (typeof infoBody !== 'undefined' && infoBody) {
          const partsTxt = [];
          if(desc) partsTxt.push(desc);
          if(composer) partsTxt.push(LANG==='ko' ? `ÏûëÍ≥°: ${composer}` : `Composer: ${composer}`);
          infoBody.textContent = partsTxt.join(' ¬∑ ');
        }
      }
    }
  }catch(e){
    console.warn('[applyLang] refresh current track failed', e);
  }

  // ‚úÖ (ÌïµÏã¨) Ïñ∏Ïñ¥ ÌÜ†Í∏Ä Ïãú Î°úÎî© Ïç∏ÎÑ§ÏùºÎèÑ Ìï≠ÏÉÅ Í∞±Ïã† ÏãúÎèÑ
  // - Î°úÎî© ÏÉÅÌÉúÏóêÏÑúÎßå Î∞îÍæ∏Í≥† Ïã∂ÏúºÎ©¥ ONLY_WHEN_BLANK=trueÎ°ú Î∞îÍæ∏Î©¥ Îê®
  refreshLoadingThumbForLang(true);

  // ‚úÖ 5) ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ìå®ÎÑêÏù¥ Ïó¥Î†§ ÏûàÏúºÎ©¥ ‚Üí Î¶¨Ïä§Ìä∏/Í≥° ÏÇ≠Ï†ú Î≤ÑÌäº Ìè¨Ìï® Ï†ÑÏ≤¥ Ïû¨Î†åÎçî
  if (typeof renderPL === 'function') {
    const plPanelEl = document.getElementById('plPanel');
    if (plPanelEl && plPanelEl.style.display !== 'none') {
      renderPL();
    }
  }
}
/* ===== Shorthands & State ===== */
const $ = (s,r=document)=>r.querySelector(s);
const strip = $('#strip');
const player = $('#player');
// allow WebAudio analyser to read Supabase-hosted audio
player.crossOrigin = 'anonymous';
const statusThumb = $('#statusThumb');
const statusTitle = $('#metaTitle');
const infoTitle = document.getElementById('trackInfoTitle');
const infoBody  = document.getElementById('trackInfoBody');
const STATE = { path:'', stack:[], currentTrack:null, foldersCache:[], tracksCache:{} };
let RENDER_TICK = 0;
let THUMB_VER = Date.now();
	
/* ===== Helpers ===== */

function stem(n){ return n.replace(/\.[^.]+$/, ''); }


function encFolderPath(folder){
  if(!folder) return '';
  return folder.split('/').filter(Boolean).map(encodeURIComponent).join('/');
}
function mediaObjectUrl(folder, file){
  const f = encFolderPath(folder);
  return f ? `${MEDIA_BASE}/${f}/${encodeURIComponent(file)}` : `${MEDIA_BASE}/${encodeURIComponent(file)}`;
}
function mediaFolderBase(folder){
  const f = encFolderPath(folder);
  return f ? `${MEDIA_BASE}/${f}/` : `${MEDIA_BASE}/`;
}


function folderThumb(folder){
  const base = mediaFolderBase(folder);
  const name = (LANG === 'en') ? 'folder_e.webp' : 'folder.webp';

  // üîπ THUMB_VER ÏùÑ Î∂ôÏó¨ÏÑú Í∞ïÏ†ú Ï∫êÏãú Î¨¥Ìö®Ìôî
  return `${base}${name}?width=320&quality=70&format=webp&v=${THUMB_VER}`;
}

function trackThumb(folder, file){
  const base = mediaFolderBase(folder);
  const s = stem(file);
  const fname = (LANG === 'en') ? `${s}_E.webp` : `${s}.webp`;

  // üîπ Ïó¨Í∏∞ÏóêÎèÑ ÎèôÏùºÌïòÍ≤å Î≤ÑÏ†Ñ ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä
  return `${base}${fname}?width=320&quality=70&format=webp&v=${THUMB_VER}`;
}

async function listRoot(){
  let out=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list('', { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    const pageFolders = (data||[]).filter(it => !/\./.test(it.name)).map(it=>it.name);
    out.push(...pageFolders);
    more = (data||[]).length===100;
    page++;
  }
  return out.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
}
async function listTracks(folder){
  if(STATE.tracksCache[folder]) return STATE.tracksCache[folder];
  let list=[], page=0, more=true;
  while(more){
    const { data, error } = await SB.storage.from(BUCKET).list(folder, { limit:100, offset:page*100 });
    if(error){ console.warn(error); break; }
    for(const it of (data||[])){
      if(/\.(mp3|m4a|aac|wav|flac|ogg)$/i.test(it.name)) list.push(it.name);
    }
    more = (data||[]).length===100; page++;
  }
  list = list.sort((a,b)=>a.localeCompare(b,'en',{numeric:true,sensitivity:'base'}));
  STATE.tracksCache[folder] = list;
  return list;
}

function statusBlank(){
  statusThumb.classList.add('status-blank');
  statusThumb.style.backgroundImage='none';
  statusTitle.classList.remove('playing');
  statusTitle.textContent='';
  $('#metaDesc').textContent='';
  $('#metaComposer').textContent='';

  if(infoTitle) infoTitle.textContent = '';
  if(infoBody)  infoBody.textContent  = '';
}

/* ===== Favorites ===== */
const FAV_KEY='fiveDO_favs';
function loadFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||'[]')); }catch{ return new Set(); } }
function saveFavs(set){ localStorage.setItem(FAV_KEY, JSON.stringify([...set])); }
const FAVS = loadFavs();
let FAVORITES_ONLY = false;
function starSvg(){ return '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.7"><path d="M12 3l3 6 6 .9-4.5 4.4 1 6.2-5.5-3-5.5 3 1-6.2L3 9.9 9 9z"/></svg>'; }
function trackId(folder, file){ return (folder? `${folder}/${file}` : file); }

async function renderFavoritesStrip(){
  const wrap   = $('#favoritesWrap');
  const fstrip = $('#favoritesStrip');
  const list   = [...FAVS];

  if(list.length===0){
    wrap.style.display='none';
    fstrip.innerHTML='';
    return;
  }

  wrap.style.display='';
  fstrip.innerHTML='';

  for(const id of list){
    const seg    = id.split('/');
    const folder = seg.length>1 ? seg.slice(0,-1).join('/') : '';
    const file   = seg[seg.length-1];

    const card = document.createElement('div');
    card.className='card fav';

    const th   = document.createElement('div');
    th.className='thumb';
    card.append(th);

    const star = document.createElement('div');
    star.className='star';
    star.innerHTML=starSvg();
    card.append(star);

    const u = folder ? trackThumb(folder, file) : null;
	if (u) th.style.backgroundImage = `url("${u}")`;
    // ‚òÖ Ï¶êÍ≤®Ï∞æÍ∏∞ Ïπ¥Îìú ÌÅ¥Î¶≠ Ïãú: Ïû¨ÏÉù + meta Î∞òÏòÅ
    card.addEventListener('click', async (e)=>{
      if(e.target.closest('.star')) return;  // Î≥Ñ ÌÅ¥Î¶≠Ïù¥Î©¥ Î¨¥Ïãú

      const url = mediaObjectUrl(folder, file);

function setCurrentTrack(track) {
  CURRENT_TRACK = track;
  // ÏõêÌïòÎ©¥ ÏÉÅÌÉúÏòÅÏó≠ÏóêÎèÑ Ï†úÎ™© ÌëúÏãúÎ•º ÌÜµÏùº
  // statusTitle.textContent = track.title || track.name || '';
}
      player.src = url;
      player.load?.();
      setLibMode('player');
      stopLibViz();

      // Ïç∏ÎÑ§Ïùº ÏóÖÎç∞Ïù¥Ìä∏
      const u2 = folder ? trackThumb(folder, file) : null;
	if (u2){
  	statusThumb.classList.remove('status-blank');
 	 setStatusThumb(statusThumb, `${u2}`);
	}

      // Í∏∞Î≥∏ Ï†úÎ™© (ÌååÏùºÎ™Ö Í∏∞Î∞ò)
      const baseTitle = stem(file).replace(/[_\-]+/g,' ');

      // meta.json Ï°∞Ìöå
      const meta = lookupTrackMeta(folder, file);
      let title    = baseTitle;
      let desc     = "";
      let composer = "";

      if (meta){
        title    = getLocalized(meta, 'title') || baseTitle;
        desc     = getLocalized(meta, 'desc');
        composer = meta.composer || getLocalized(meta, 'composer') || "";
      }

      // ÏÉÅÎã® ÏÉÅÌÉú Î∞î
      statusTitle.textContent = title;
      statusTitle.classList.add('playing');
      if (typeof STATE !== 'undefined'){
        STATE.currentTrack = { name: title, url };
      }

      // info Ìå®ÎÑê ÏóÖÎç∞Ïù¥Ìä∏
      if (typeof infoTitle !== 'undefined' && infoTitle) infoTitle.textContent = title;
      if (typeof infoBody !== 'undefined' && infoBody){
        const parts = [];
        if (desc)     parts.push(desc);
        if (composer) parts.push(LANG==='ko' ? `ÏûëÍ≥°: ${composer}` : `Composer: ${composer}`);
        infoBody.textContent = parts.join(' ¬∑ ');
      }
    });

    // ‚òÖ Î≥Ñ ÌÅ¥Î¶≠ Ïãú Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä
    star.addEventListener('click',(e)=>{
      e.stopPropagation();
      const isFav = FAVS.has(id);
      if(isFav){
        FAVS.delete(id);
        card.classList.remove('fav');
      } else {
        FAVS.add(id);
        card.classList.add('fav');
      }
      saveFavs(FAVS);
      renderFavoritesStrip();
    });

    fstrip.appendChild(card);
  }
}

// ===== Track selection & play =====
function setCurrentTrack(track) {
  CURRENT_TRACK = track;
}

function loadAndPlayTrack(track) {
  setCurrentTrack(track);

  const url = track.url || track.src || track.path;
  if (!url) {
    console.warn('No playable url in track', track);
    return;
  }

  player.src = url;
  player.load?.();

  statusTitle.classList.add('playing');
  const mv = document.getElementById('miniViz');
  if (mv) mv.style.display = 'block';
}

/* ===== Render strip ===== */

// ===== Library UI mode (folders / tracks / player) =====
const libBrowseView = document.getElementById('libBrowseView');
const libPlayerView = document.getElementById('libPlayerView');

function setLibMode(mode){
  STATE.uiMode = mode; // 'folders' | 'tracks' | 'player'
  if(!libBrowseView || !libPlayerView) return;

  if(mode === 'player'){
    libBrowseView.classList.add('hidden');
    libPlayerView.classList.remove('hidden');
  }else{
    libBrowseView.classList.remove('hidden');
    libPlayerView.classList.add('hidden');
  }

  // Back Î≤ÑÌäº UX: playerÏóêÏÑú Îí§Î°ú=Ìä∏ÎûôÎ™©Î°ù, tracksÏóêÏÑú Îí§Î°ú=Ìè¥ÎçîÎ™©Î°ù
  const backBtn = document.getElementById('btnBack');
  if(backBtn){
    backBtn.title = (mode==='player') ? 'Back to list' : 'Back';
  }
}

function prettyName(name){
  return (name||'').replace(/[_\-]+/g,' ').trim();
}

// ===== Library Audio Visualizer (for MP3 player) =====
let libCtx=null, libAnalyser=null, libSrc=null, libRaf=0, libData=null;

function ensureLibAnalyser(){
  // Visualizer removed for background-play stability.
  return false;
}


function drawLibSpectrum(){
  // no-op (visualizer removed)
  return;
}



function startLibViz(){
  // no-op (visualizer removed)
  return;
}

function stopLibViz(){
  // no-op (visualizer removed)
  return;
}

// ===== Track selection (browse -> player) =====
function playSelectedTrack(folder, file){
  const url = mediaObjectUrl(folder, file);
  player.src = url;
  player.load?.();

  // UI: player viewÎ°ú Ï†ÑÌôò
  setLibMode('player');

  // thumb
  const u2 = trackThumb(folder, file);
  if(u2){
    statusThumb.classList.remove('status-blank');
    setStatusThumb(statusThumb, u2);
  }

  // meta
  const baseTitle = prettyName(stem(file));
  const meta = lookupTrackMeta(folder, file);

  let title = baseTitle;
  let desc = "";
  let composer = "";

  if(meta){
    title    = getLocalized(meta, 'title') || baseTitle;
    desc     = getLocalized(meta, 'desc');
    composer = meta.composer || getLocalized(meta, 'composer') || "";
  }

  statusTitle.textContent = title;
  statusTitle.classList.add('playing');
  document.getElementById('metaDesc').textContent = desc || '';
  document.getElementById('metaComposer').textContent = composer ? (LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`) : '';

  if(infoTitle) infoTitle.textContent = title;
  if(infoBody){
    const parts = [];
    if(desc) parts.push(desc);
    if(composer) parts.push(LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`);
    infoBody.textContent = parts.join(' ¬∑ ');
  }

  STATE.currentTrack = { name: title, url, folder, file };

  // NOTE: do NOT autoplay; wait for user to press Play
  stopLibViz();
}

async function renderStrip(){
  const myTick = ++RENDER_TICK;
  strip.innerHTML='';

  // Ìè¥Îçî Î£®Ìä∏
  if(!STATE.path){
    setLibMode('folders');

    await renderFavoritesStrip();
    if(myTick !== RENDER_TICK) return;

    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();

    for(const name of STATE.foldersCache){
      if(myTick !== RENDER_TICK) return;

      const row = document.createElement('div');
      row.className = 'v-item folder';

      const th = document.createElement('div');
      th.className = 'v-thumb';
      th.style.backgroundImage = `url("${folderThumb(name)}")`;

      const meta = document.createElement('div');
      meta.className = 'v-meta';

      const title = document.createElement('div');
      title.className = 'v-title';
      title.textContent = prettyName(name);

      const sub = document.createElement('div');
      sub.className = 'v-sub';
      sub.textContent = (LANG==='ko') ? 'Ïπ¥ÌÖåÍ≥†Î¶¨ Ïó¥Í∏∞' : 'Open category';

      meta.append(title, sub);
      row.append(th, meta);

      row.addEventListener('click', ()=>{
        STATE.path = name;
        statusBlank();
        renderStrip();
      });

      strip.appendChild(row);
    }
    return;
  }

  // Ìè¥Îçî ÎÇ¥Î∂Ä(Ìä∏Îûô Î¶¨Ïä§Ìä∏)
  setLibMode('tracks');

  const files = await listTracks(STATE.path);
  for(const f of files){
    if(myTick !== RENDER_TICK) return;

    if (FAVORITES_ONLY) {
      const id = trackId(STATE.path, f);
      if (!FAVS.has(id)) continue;
    }

    const row = document.createElement('div');
    row.className = 'v-item track' + (FAVS.has(trackId(STATE.path, f)) ? ' fav' : '');

    const th = document.createElement('div');
    th.className = 'v-thumb';
    th.style.backgroundImage = `url("${trackThumb(STATE.path, f)}")`;

    const metaBox = document.createElement('div');
    metaBox.className = 'v-meta';

    const baseTitle = prettyName(stem(f));
    const meta = lookupTrackMeta(STATE.path, f);

    const title = document.createElement('div');
    title.className = 'v-title';
    title.textContent = (meta ? (getLocalized(meta,'title') || baseTitle) : baseTitle);

    const sub = document.createElement('div');
    sub.className = 'v-sub';
    const desc = meta ? (getLocalized(meta,'desc') || '') : '';
    const composer = meta ? (meta.composer || getLocalized(meta,'composer') || '') : '';
    const composerTxt = composer ? (LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`) : '';
    sub.textContent = [desc, composerTxt].filter(Boolean).join(' ¬∑ ');

    metaBox.append(title, sub);

    const star = document.createElement('div');
    star.className = 'star';
    star.innerHTML = starSvg();

    // row click = play
    row.addEventListener('click', (e)=>{
      if(e.target.closest('.star')) return;
      playSelectedTrack(STATE.path, f);
    });

    // star click = fav toggle
    star.addEventListener('click',(e)=>{
      e.stopPropagation();
      const id = trackId(STATE.path, f);
      const isFav = FAVS.has(id);
      if(isFav){ FAVS.delete(id); row.classList.remove('fav'); }
      else { FAVS.add(id); row.classList.add('fav'); }
      saveFavs(FAVS);
      renderFavoritesStrip();
    });

    row.append(th, metaBox, star);
    strip.appendChild(row);
  }
}


/* ===== Search / Filter ===== */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const q = ($('#searchInput').value||'').trim().toLowerCase();
  const mode = $('#searchMode').value; // folder | track
  if(!q){ renderStrip(); return; }
  strip.innerHTML='';
  if(mode==='folder'){
    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();
    const list = STATE.foldersCache.filter(n=>n.toLowerCase().includes(q));
    for(const name of list){
      const card = document.createElement('div'); card.className='card folder';
      const th   = document.createElement('div'); th.className='thumb'; card.append(th);
      const u = await folderThumb(name);
      if(u) th.style.backgroundImage=`url("${u}")`;
      card.addEventListener('click',()=>{ STATE.stack.push(''); STATE.path=name; statusBlank(); renderStrip(); });
      strip.appendChild(card);
    }
  }else{
    if(!STATE.foldersCache.length) STATE.foldersCache = await listRoot();
    for(const folder of STATE.foldersCache){
      const tracks = await listTracks(folder);
      for(const f of tracks){
        if(stem(f).toLowerCase().includes(q)){
          const card = document.createElement('div'); card.className='card';
          const th   = document.createElement('div'); th.className='thumb'; card.append(th);
          const u = await trackThumb(folder, f); if(u) th.style.backgroundImage=`url("${u}")`;
          card.addEventListener('click', async ()=>{
            STATE.path = folder;
            const url = `${MEDIA_BASE}/${encodeURIComponent(folder)}/${encodeURIComponent(f)}`;
            player.src = url; player.load?.();
            const u2 = await trackThumb(folder, f);
            if(u2){ statusThumb.classList.remove('status-blank');
            setStatusThumb(statusThumb, `${u2}`); }
            statusTitle.textContent = stem(f).replace(/[_\-]+/g,' ');
            statusTitle.classList.add('playing');
            STATE.currentTrack = { name: stem(f), url };
          });
          strip.appendChild(card);
        }
      }
    }
  }
});
document.getElementById('searchClear').addEventListener('click', ()=>{
  $('#searchInput').value=''; renderStrip();
});

// üîπ "FavoritesÎßå Î≥¥Í∏∞" ÌïÑÌÑ∞ Î≤ÑÌäº
const favOnlyBtn = document.getElementById('favOnlyBtn');
if (favOnlyBtn) {
  favOnlyBtn.addEventListener('click', () => {
    FAVORITES_ONLY = !FAVORITES_ONLY;

    // Î≤ÑÌäº ÌôúÏÑ±Ìôî Ïä§ÌÉÄÏùº ÌÜ†Í∏Ä
    favOnlyBtn.classList.toggle('active', FAVORITES_ONLY);

    // Î™©Î°ù Îã§Ïãú Í∑∏Î¶¨Í∏∞
    renderStrip();
  });
}

/* ===== Tabs / Language / Menu ===== */
function showPage(which){
  if(which==='lib'){ $('#pageLibrary').classList.remove('hidden'); $('#pageGenerator').classList.add('hidden');
    $('#tabLibrary').classList.add('active'); $('#tabGenerator').classList.remove('active');
  }else{
    $('#pageLibrary').classList.add('hidden'); $('#pageGenerator').classList.remove('hidden');
    $('#tabLibrary').classList.remove('active'); $('#tabGenerator').classList.add('active');
  }
}
$('#tabLibrary').addEventListener('click',()=>showPage('lib'));
$('#tabGenerator').addEventListener('click',()=>showPage('gen'));

$('#langBtn').addEventListener('click',()=>{
  LANG = (LANG==='en'?'ko':'en');
  applyLang();

  // ‚úÖ Ïñ∏Ïñ¥ ÌÜ†Í∏ÄÏùÄ ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ Ïú†ÏßÄÌïúÎã§.
  // - ÌîåÎ†àÏù¥Ïñ¥ ÌôîÎ©¥ÏóêÏÑúÎäî ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïä§Ìä∏Î¶ΩÏùÑ Ïû¨Î†åÎçîÌïòÎ©¥ Î™®ÎìúÍ∞Ä folders/tracksÎ°ú Î∞îÎÄåÏñ¥Î≤ÑÎ¶¨ÎØÄÎ°ú Í∏àÏßÄ.
  // - Ìè¥Îçî/Ìä∏Îûô Î¶¨Ïä§Ìä∏ ÌôîÎ©¥ÏóêÏÑúÎßå Ïû¨Î†åÎçî.
  if(STATE.uiMode !== 'player'){
    renderStrip();
    if(!STATE.currentTrack) statusBlank();
  }else{
    // ÌîåÎ†àÏù¥Ïñ¥ ÌôîÎ©¥ÏóêÏÑúÎäî ÌòÑÏû¨ Ìä∏Îûô Î©îÌÉÄ ÌÖçÏä§Ìä∏Îßå Í∞±Ïã† (applyLangÏù¥ ÎåÄÎ∂ÄÎ∂Ñ Ï≤òÎ¶¨)
    // ÌïÑÏöî Ïãú: infoPanel / metaTitle Í∞ôÏùÄ ÌÖçÏä§Ìä∏Í∞Ä ÎπÑÏñ¥ÏûàÎã§Î©¥ Î≥¥Í∞ï
    try{
      if(STATE.currentTrack && STATE.currentTrack.folder && STATE.currentTrack.file){
        const meta = lookupTrackMeta(STATE.currentTrack.folder, STATE.currentTrack.file);
        const baseTitle = (STATE.currentTrack.file||'').replace(/\.[^/.]+$/,'');
        const title = meta ? (getLocalized(meta,'title') || baseTitle) : (STATE.currentTrack.name || baseTitle);
        const desc  = meta ? (getLocalized(meta,'desc')  || '') : '';
        const composer = meta ? (meta.composer || getLocalized(meta,'composer') || '') : '';
        const titleEl = document.getElementById('metaTitle');
        const compEl  = document.getElementById('metaComposer');
        if(titleEl) titleEl.textContent = title;
        if(compEl)  compEl.textContent  = composer ? (LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`) : '';
        if(infoTitle) infoTitle.textContent = title;
        if(infoBody){
          const parts = [];
          if(desc) parts.push(desc);
          if(composer) parts.push(LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`);
          infoBody.textContent = parts.join(' ¬∑ ');
      // ‚úÖ ÌîåÎ†àÏù¥Ïñ¥ ÌôîÎ©¥: ÏÑ†ÌÉùÎêú Ìä∏Îûô Ïç∏ÎÑ§ÏùºÎèÑ ÌòÑÏû¨ LANGÏóê ÎßûÍ≤å Ï¶âÏãú ÍµêÏ≤¥ (name_E.webp)
      if (STATE.currentTrack && STATE.currentTrack.folder && STATE.currentTrack.file){
        const f = STATE.currentTrack.file;
        const folder = STATE.currentTrack.folder;
        const el = document.getElementById('statusThumb');
        if (el){
          const primary = trackThumb(folder, f); // uses LANG
          const alt = (LANG === 'en')
            ? primary.replace(/_E\.webp/i, '.webp')
            : primary.replace(/\.webp/i, '_E.webp');
          const img = new Image();
          img.onload = ()=>{ el.classList.remove('status-blank'); setStatusThumb(el, primary); };
          img.onerror = ()=>{
            const img2 = new Image();
            img2.onload = ()=>{ el.classList.remove('status-blank'); setStatusThumb(el, alt); };
            img2.onerror = ()=>{};
            img2.src = alt;
          };
          img.src = primary;
        }
      }

        }
      }
    }catch(e){}
  }
});

const menuBtn = $('#menuBtn'), menuDrop = $('#menuDrop'), backdrop=$('#backdrop'), modal=$('#modal');
menuBtn.addEventListener('click',()=>{
  const v = menuDrop.style.display==='block' ? 'none' : 'block';
  menuDrop.style.display=v;
});
backdrop.addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
$('#modalClose').addEventListener('click',()=>{ backdrop.style.display='none'; modal.style.display='none'; });
document.querySelectorAll('.menu-text').forEach(a=>{
  a.addEventListener('click', async (e)=>{
    e.preventDefault();
    menuDrop.style.display='none';
    const key = a.dataset.txt;
    const path = `texts/${key}.txt`;
    try{
      const res = await fetch(path+'?v='+Date.now());
      const txt = await res.text();
      $('#modalTitle').textContent = (a.textContent||'Info');
      $('#modalBody').textContent = txt;
      backdrop.style.display='block'; modal.style.display='block';
    }catch(err){
      $('#modalTitle').textContent = 'Error';
      $('#modalBody').textContent = 'Failed to load.';
      backdrop.style.display='block'; modal.style.display='block';
    }
  });
});

/* ===== Player controls & nav ===== */
/* ===== Playback helpers (single source of truth) ===== */
async function ensurePlaybackReady(){
  // Make sure analyser graph exists and AudioContext is running
  ensureLibAnalyser();
  try{ if(libCtx && libCtx.state==='suspended') await libCtx && libCtx.resume(); }catch(e){}
}

async function requestPlay(){
  await ensurePlaybackReady();
  try{
    await player.play();
  }catch(e){
    console.warn('[play] failed', e);
  }
}

function onPlaybackStarted(){
  statusTitle.classList.add('playing');
  startLibViz();
  const mv = document.getElementById('miniViz');
  if(mv) mv.style.display = 'block';
}

function onPlaybackStopped(){
  statusTitle.classList.remove('playing');
  stopLibViz();
  const mv = document.getElementById('miniViz');
  if(mv) mv.style.display = 'none';
}

// Any play action (UI button, native controls, strip play, etc.) should drive viz.
player.addEventListener('play', async ()=>{
  // Some browsers start <audio> before AudioContext is resumed; ensure it here too.
  try{ await ensurePlaybackReady(); }catch(e){}
  onPlaybackStarted();
});
player.addEventListener('pause', ()=>{ onPlaybackStopped(); });
player.addEventListener('ended', ()=>{ onPlaybackStopped(); });

$('#btnPlay').addEventListener('click', async ()=>{
  // Manual start: only play when user taps Play
  if(player.paused){
    await requestPlay();
    // 'play' event will start viz
  }else{
    player.pause();
    // 'pause' event will stop viz
  }
});

$('#btnPause').addEventListener('click',()=>{
  player.pause();
  stopLibViz();
  statusTitle.classList.remove('playing');
  const mv = document.getElementById('miniViz');
  if(mv) mv.style.display = 'none';
});
$('#btnLoop').addEventListener('click',()=>{ player.loop = !player.loop; alert(player.loop ? (LANG==='en'?'Loop On':'Î£®ÌîÑ ÏºúÏßê') : (LANG==='en'?'Loop Off':'Î£®ÌîÑ Í∫ºÏßê')); });
$('#btnTimer').addEventListener('click',()=>{
  const m = prompt(LANG==='en'?'Sleep timer (minutes)':'ÏàòÎ©¥ ÌÉÄÏù¥Î®∏ (Î∂Ñ)'); 
  const t = Number(m||0); if(!t) return;
  setTimeout(()=>{ player.pause(); statusTitle.classList.remove('playing'); }, t*60000);
});

$('#btnBack').addEventListener('click',()=>{
  if(STATE.uiMode==='player'){
    setLibMode('tracks');
    // ÌîåÎ†àÏù¥Ïñ¥Îäî Ïú†ÏßÄÌïòÎêò, Î¶¨Ïä§Ìä∏Î°ú ÎèåÏïÑÍ∞ÄÎ©¥ ÏãúÍ∞ÅÌôîÎäî Í∫ºÎèÑ Îê®(ÏõêÌïòÎ©¥ Ïú†ÏßÄ)
    stopLibViz();
    return;
  }
  if(STATE.path){
    STATE.path='';
    renderStrip();
    return;
  }
});
$('#btnHome').addEventListener('click',()=>{
  STATE.path='';
  setLibMode('folders');
  stopLibViz();
  renderStrip();
});
$('#btnRefresh').addEventListener('click', async ()=>{
  // 1) Ïï± ÎÇ¥Î∂Ä Î©îÎ™®Î¶¨ Ï∫êÏãú ÎπÑÏö∞Í∏∞ (Ìè¥Îçî/Ìä∏Îûô Ï∫êÏãú)
  if (window.clear5DOMemoryCaches) {
    window.clear5DOMemoryCaches();  // ÎÑàÍ∞Ä ÏòàÏ†ÑÏóê Ï∂îÍ∞ÄÌï¥ Îëî helper
  }
  STATE.tracksCache  = {};
  STATE.foldersCache = [];

  // 2) Ïç∏ÎÑ§Ïùº Ï∫êÏãú Î≤ÑÏ†Ñ Í∞±Ïã† ‚Üí Î™®Îì† Ïç∏ÎÑ§Ïùº URLÏù¥ ÏÉàÎ°úÏõåÏßê
  THUMB_VER = Date.now();

  // 3) meta.json ÎèÑ Îã§Ïãú Î°úÎî© (Ìä∏Îûô ÏÑ§Î™Ö/ÌÉÄÏù¥ÌãÄ Í∞±Ïã†Ïö©)
  await loadTrackMeta();

  // 4) PWA ÏÑúÎπÑÏä§ÏõåÏª§ Ï∫êÏãúÎèÑ Ïãπ ÎπÑÏö∞Í∏∞ (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
  if ('caches' in window) {
    try {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
      console.log('[refresh] caches cleared', keys);
    } catch(e) {
      console.warn('[refresh] cache clear failed', e);
    }
  }

  // 5) Î¶¨Ïä§Ìä∏/Ïç∏ÎÑ§Ïùº Îã§Ïãú Î†åÎçîÎßÅ
  if (STATE.uiMode === 'player' && STATE.currentTrack && STATE.currentTrack.folder && STATE.currentTrack.file){
    // ÌîåÎ†àÏù¥Ïñ¥ ÌôîÎ©¥ Ïú†ÏßÄ: ÌòÑÏû¨ Ìä∏Îûô Î©îÌÉÄ/Ïç∏ÎÑ§ÏùºÎßå Í∞±Ïã†
    const folder = STATE.currentTrack.folder;
    const file   = STATE.currentTrack.file;
    const meta = lookupTrackMeta(folder, file);

    // thumb
    const el = document.getElementById('statusThumb');
    if (el){
      const primary = trackThumb(folder, file);
      const alt = (LANG === 'en')
        ? primary.replace(/_E\.webp/i, '.webp')
        : primary.replace(/\.webp/i, '_E.webp');
      const img = new Image();
      img.onload = ()=>{ el.classList.remove('status-blank'); setStatusThumb(el, primary); };
      img.onerror = ()=>{
        const img2 = new Image();
        img2.onload = ()=>{ el.classList.remove('status-blank'); setStatusThumb(el, alt); };
        img2.onerror = ()=>{};
        img2.src = alt;
      };
      img.src = primary;
    }

    // meta text
    const baseTitle = prettyName(stem(file));
    const title = (meta ? (getLocalized(meta,'title') || baseTitle) : baseTitle);
    const desc  = meta ? (getLocalized(meta,'desc') || '') : '';
    const composer = meta ? (meta.composer || getLocalized(meta,'composer') || '') : '';

    statusTitle.textContent = title;
    statusTitle.classList.add('playing');
    document.getElementById('metaDesc').textContent = desc || '';
    document.getElementById('metaComposer').textContent = composer ? (LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`) : '';

    if(infoTitle) infoTitle.textContent = title;
    if(infoBody){
      const parts = [];
      if(desc) parts.push(desc);
      if(composer) parts.push(LANG==='ko'?`ÏûëÍ≥°: ${composer}`:`Composer: ${composer}`);
      infoBody.textContent = parts.join(' ¬∑ ');
    }
  } else {
    // ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôîÎ©¥: ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî + Ïû¨Î†åÎçî
    statusBlank();     // ÏÉÅÌÉú ÏòÅÏó≠ÎèÑ Ï¥àÍ∏∞ÌôîÌïòÍ≥† Ïã∂ÏúºÎ©¥ Ï∂îÍ∞Ä
    renderStrip();
  }
});

/* ===== Playlist ===== */
const USER_ID_KEY='fiveDO_user_id';
function uid(){ return 'u'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
function getUserId(){ let x=localStorage.getItem(USER_ID_KEY); if(!x){ x=uid(); localStorage.setItem(USER_ID_KEY,x); } return x; }
const USER_ID = getUserId();

const PL_KEY='fiveDO_playlists';
const PL_CLOUD_PATH = `playlists/${USER_ID}.json`;

function nowISO(){ return new Date().toISOString(); }
function newPLState(){ return {version:1,updatedAt:nowISO(),lists:[]}; }

function loadPLLocal(){
  try{
    const raw = localStorage.getItem(PL_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function savePLLocal(obj){
  try{
    obj.updatedAt = nowISO();
    localStorage.setItem(PL_KEY, JSON.stringify(obj));
  }catch{}
}

async function loadPLCloud(){
  const url = `${MEDIA_BASE}/${PL_CLOUD_PATH}`;
  try{
    const res = await fetch(url+'?t='+Date.now(), {cache:'no-store'});
    if(!res.ok) return null;
    return await res.json();
  }catch{ return null; }
}
async function savePLCloud(obj){
  try{
    const { error } = await SB.storage.from(BUCKET)
      .upload(PL_CLOUD_PATH, new Blob([JSON.stringify(obj)], {type:'application/json'}), { upsert:true });
    if(error) throw error;
    return true;
  }catch(e){
    console.warn('[playlist] cloud save failed', e);
    return false;
  }
}

async function syncPlaylists(){
  let local = loadPLLocal();
  let cloud = await loadPLCloud();

  if(!local && !cloud){
    local = newPLState();
    savePLLocal(local);
    await savePLCloud(local);
    return local;
  }
  if(local && !cloud){
    await savePLCloud(local);
    return local;
  }
  if(!local && cloud){
    savePLLocal(cloud);
    return cloud;
  }

  const L = new Date(local.updatedAt||0).getTime();
  const C = new Date(cloud.updatedAt||0).getTime();
  const base = (C > L) ? cloud : local;

  savePLLocal(base);
  if(C < L) await savePLCloud(base);
  return base;
}

let PL_STATE = null;
let CURRENT_TRACK = null;

function ensurePLState(){
  if(!PL_STATE || typeof PL_STATE !== 'object') PL_STATE = newPLState();
  if(!Array.isArray(PL_STATE.lists)) PL_STATE.lists = [];
  if(!PL_STATE.updatedAt) PL_STATE.updatedAt = nowISO();
  if(!PL_STATE.version) PL_STATE.version = 1;
  return PL_STATE;
}

// ÏµúÏÜå Í∏∞Î≥∏Í∞í
ensurePLState();

const plPanel = document.getElementById('plPanel'),
      plBody  = document.getElementById('plBody');

/* ===== Queue / Mode / Loop (3Î≤à) ===== */
let PL_MODE = 'order';      // 'order' | 'shuffle'
let PL_LOOP = 'off';        // 'off' | 'all'
let PL_QUEUE = [];          // [{title,url,path,file}]
let PL_INDEX = -1;
let PL_ACTIVE_LIST_ID = null;

function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function plToast(msg){
  const el = document.getElementById('plToast');
  if(!el) return;
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(plToast._t);
  plToast._t = setTimeout(()=> el.classList.remove('show'), 900);
}

function updatePLControlsUI(){
  const sh = document.getElementById('plShuffleBtn');
  const lp = document.getElementById('plLoopBtn');
  const bd = document.getElementById('plLoopBadge');
  const prev = document.getElementById('plPrevBtn');
  const next = document.getElementById('plNextBtn');

  if(sh){
    sh.classList.toggle('is-on', PL_MODE === 'shuffle');
  }
  if(lp){
    lp.classList.toggle('is-on', PL_LOOP === 'all');
    lp.classList.toggle('is-loop-all', PL_LOOP === 'all');
    if(bd){
      bd.style.display = (PL_LOOP === 'all') ? 'inline-block' : 'none';
      bd.textContent = (PL_LOOP === 'all') ? '‚àû' : '1';
    }
  }
  const hasQ = PL_QUEUE.length > 0;
  if(prev) prev.disabled = !hasQ;
  if(next) next.disabled = !hasQ;
}

function highlightPlayingItem(){
  const curUrl = PL_QUEUE[PL_INDEX]?.url || CURRENT_TRACK?.url || '';
  document.querySelectorAll('#plBody .pl-item').forEach(el=>{
    const u = el.getAttribute('data-url');
    el.classList.toggle('is-playing', !!curUrl && u === curUrl);
  });
}

function setQueueFromListId(listId, startIndex=0){
  ensurePLState();
  const list = PL_STATE.lists.find(x => x.id === listId);
  if(!list || !Array.isArray(list.items) || list.items.length===0) return false;

  PL_ACTIVE_LIST_ID = listId;

  let base = list.items.map(it => ({
    title: it.title || it.file || it.url || 'Untitled',
    url: it.url,
    path: it.path || '',
    file: it.file || ''
  })).filter(x => !!x.url);

  if(base.length===0) return false;

  if(PL_MODE === 'shuffle'){
    const cur = base[startIndex] || base[0];
    base = shuffleArray(base);
    PL_QUEUE = base;
    PL_INDEX = PL_QUEUE.findIndex(x => x.url === cur.url);
    if(PL_INDEX < 0) PL_INDEX = 0;
  }else{
    PL_QUEUE = base;
    PL_INDEX = Math.max(0, Math.min(startIndex, PL_QUEUE.length-1));
  }

  updatePLControlsUI();
  highlightPlayingItem();
  return true;
}

function playFromQueue(index){
  if(!PL_QUEUE.length) return;
  const idx = Math.max(0, Math.min(index, PL_QUEUE.length-1));
  const t = PL_QUEUE[idx];
  if(!t?.url) return;

  PL_INDEX = idx;

  player.src = t.url;
  player.load?.();
  player.play().catch(()=>{});

  statusTitle.textContent = t.title || 'Untitled';
  statusTitle.classList.add('playing');

  STATE.currentTrack = { name: t.title, url: t.url };
  CURRENT_TRACK = { title: t.title, url: t.url, path: t.path, file: t.file };

  // Ïç∏ÎÑ§Ïùº Í∞±Ïã†(Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
  (async()=>{
    try{
      if(t.path && t.file){
        const u2 = await trackThumb(t.path, t.file);
        if(u2){
          statusThumb.classList.remove('status-blank');
          setStatusThumb(statusThumb, `${u2}`);
        }
      }
    }catch(err){
      console.warn('playlist thumb update failed', err);
    }
  })();

  updatePLControlsUI();
  highlightPlayingItem();
}

function nextInQueue(){
  if(!PL_QUEUE.length) return;
  let next = PL_INDEX + 1;
  if(next >= PL_QUEUE.length){
    if(PL_LOOP === 'all') next = 0;
    else return;
  }
  playFromQueue(next);
}

function prevInQueue(){
  if(!PL_QUEUE.length) return;
  let prev = PL_INDEX - 1;
  if(prev < 0){
    if(PL_LOOP === 'all') prev = PL_QUEUE.length - 1;
    else prev = 0;
  }
  playFromQueue(prev);
}

// ÏûêÎèô Îã§ÏùåÍ≥° (3Î≤à)
player.addEventListener('ended', () => {
  if(!PL_QUEUE.length) return;
  nextInQueue();
});

function openPlPanel(){
  if (typeof applyLang === 'function') applyLang();
  // ‚úÖ Ìï≠ÏÉÅ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌÉ≠ÏùÑ Î∞∞Í≤ΩÏúºÎ°ú ÏÇ¨Ïö©
  if (typeof showPage === 'function') showPage('lib');

  plPanel.style.display = 'block';
  ensurePLState();
  renderPL();

  // (ÏÑ†ÌÉù) Î∞±Í∑∏ÎùºÏö¥Îìú ÎèôÍ∏∞Ìôî: Îä¶Í≤å ÎèÑÏ∞©Ìï¥ÎèÑ UI Í∞±Ïã†
  syncPlaylists().then((state)=>{
    PL_STATE = state;
    ensurePLState();
    renderPL();
  }).catch(()=>{});
}

function closePlPanel(){
  plPanel.style.display = 'none';
}

/* ===== Render playlists + items ===== */
function renderPL(){
  ensurePLState();
  plBody.innerHTML = '';

  const lists = PL_STATE.lists || [];
  if(lists.length === 0){
    const row = document.createElement('div');
    row.className = 'pl-row';
    row.textContent = (LANG === 'en' ? I18N.en['pl.no'] : I18N.ko['pl.no']);
    plBody.appendChild(row);
    return;
  }

  lists.forEach((pl, i) => {
    // ---- Playlist header row ----
    const row = document.createElement('div');
    row.className = 'pl-row';

    const name = document.createElement('input');
    name.className = 'gen-input';
    name.value = pl.name || ('List ' + (i + 1));
    name.addEventListener('input', () => { pl.name = name.value; });

    const cnt = document.createElement('div');
    cnt.style.opacity = .7;
    cnt.textContent = `${(pl.items?.length || 0)} ${LANG === 'en' ? 'tracks' : 'Í≥°'}`;

    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.gap = '10px';
    left.append(name, cnt);

    const del = document.createElement('button');
    del.className = 'btn small';
    del.setAttribute('data-i18n', 'pl.delete');
    del.textContent = I18N[LANG]['pl.delete'] || (LANG==='en'?'Delete':'ÏÇ≠Ï†ú');
    del.addEventListener('click', (e) => {
      e.stopPropagation();
      PL_STATE.lists.splice(i, 1);
      // Î¶¨Ïä§Ìä∏ ÏÇ≠Ï†úÎêòÎ©¥ ÌÅêÍ∞Ä Í∑∏ Î¶¨Ïä§Ìä∏ÏòÄÏùÑ ÏàòÎèÑ ÏûàÏùå
      if(PL_ACTIVE_LIST_ID && pl.id === PL_ACTIVE_LIST_ID){
        PL_QUEUE = []; PL_INDEX = -1; PL_ACTIVE_LIST_ID = null;
        updatePLControlsUI();
      }
      renderPL();
    });

    row.append(left, del);
    plBody.appendChild(row);

    // ---- Items section ----
    if(!Array.isArray(pl.items)) pl.items = [];

    if(pl.items.length === 0){
      const empty = document.createElement('div');
      empty.className = 'pl-item pl-item-empty';
      empty.style.opacity = .6;
      empty.style.padding = '8px 10px';
      empty.textContent = (LANG === 'en' ? 'No tracks' : 'Í≥° ÏóÜÏùå');
      plBody.appendChild(empty);
      return;
    }

    pl.items.forEach((it, j) => {
      const item = document.createElement('div');
      item.className = 'pl-item';
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.justifyContent = 'space-between';
      item.style.gap = '10px';
      item.style.padding = '8px 10px';
      item.style.cursor = 'pointer';

      // ÌÅ¥Î¶≠ Ïû¨ÏÉùÏö© Îç∞Ïù¥ÌÑ∞
      item.setAttribute('data-url', it.url || '');
      item.setAttribute('data-title', it.title || '');
      item.setAttribute('data-path', it.path || '');
      item.setAttribute('data-file', it.file || '');

      // (4Î≤à) ÏÜåÏÜç Ïû¨ÏÉùÎ™©Î°ù id + Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
      item.setAttribute('data-plid', pl.id || '');
      item.setAttribute('data-idx', String(j));

      const label = document.createElement('div');
      label.className = 'pl-item-label';
      label.style.flex = '1';
      label.style.minWidth = '0';
      label.style.overflow = 'hidden';
      label.style.textOverflow = 'ellipsis';
      label.style.whiteSpace = 'nowrap';
      label.textContent = it.title || it.file || it.url || 'Untitled';

      const delBtn = document.createElement('button');
delBtn.className = 'btn small pl-item-del';

// ‚úÖ 2Î≤àÏïà ÌïµÏã¨: data-i18n ÌÇ§ Î∂ÄÏó¨ (applyLangÏù¥ ÌÜ†Í∏Ä Îïå ÏûêÎèô Í∞±Ïã†)
delBtn.setAttribute('data-i18n', 'pl.removeTrack');

// ‚úÖ Ï¥àÍ∏∞ Î†åÎçî ÏãúÏ†ê ÌÖçÏä§Ìä∏(ÌÜ†Í∏ÄÏùÄ applyLangÏù¥ Ï≤òÎ¶¨)
delBtn.textContent = (I18N[LANG] && I18N[LANG]['pl.removeTrack'])
  ? I18N[LANG]['pl.removeTrack']
  : (LANG === 'en' ? 'Remove' : 'ÏÇ≠Ï†ú');

delBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  pl.items.splice(j, 1);

  // ÌÅêÍ∞Ä Ïù¥ Î¶¨Ïä§Ìä∏ÎùºÎ©¥, URL Í∏∞Ï§ÄÏúºÎ°ú ÌÅêÎèÑ Ïû¨Íµ¨ÏÑ±(ÏïàÏ†Ñ)
  if(PL_ACTIVE_LIST_ID && (pl.id === PL_ACTIVE_LIST_ID)){
    const curUrl = PL_QUEUE[PL_INDEX]?.url;
    setQueueFromListId(PL_ACTIVE_LIST_ID, 0);
    if(curUrl){
      const ni = PL_QUEUE.findIndex(x=>x.url===curUrl);
      PL_INDEX = (ni>=0)? ni : Math.min(PL_INDEX, PL_QUEUE.length-1);
    }
    updatePLControlsUI();
  }

  renderPL();
});

item.append(label, delBtn);
plBody.appendChild(item);
    });
  });

  // Î†åÎçî ÌõÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Í∞±Ïã†
  highlightPlayingItem();
  updatePLControlsUI();
}

/* ===== Playlist events (stable with dynamic DOM) =====
   - Î≤ÑÌäº/ÏïÑÏù¥ÌÖúÏù¥ innerHTMLÎ°ú Î∞îÎÄåÏñ¥ÎèÑ Ìï≠ÏÉÅ ÎèôÏûëÌïòÎèÑÎ°ù "Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ" ÏÇ¨Ïö©
*/
plPanel.addEventListener('click', async (e) => {
  // ---- New list ----
  if (e.target.closest('#plNewBtn')) {
    ensurePLState();
    PL_STATE.lists.push({
      id: 'pl_' + Date.now(),
      name: (LANG==='en' ? I18N.en['pl.new'] : I18N.ko['pl.new']),
      items: []
    });
    renderPL();
    return;
  }

  // ---- Close ----
  if (e.target.closest('#plCloseBtn')) {
    closePlPanel();
    return;
  }

  // ---- Save ----
  if (e.target.closest('#plSaveBtn')) {
    ensurePLState();
    savePLLocal(PL_STATE);
    await savePLCloud(PL_STATE);
    closePlPanel();
    return;
  }

  // ---- Export ----
  if (e.target.closest('#plExportBtn')) {
    ensurePLState();
    const blob = new Blob([JSON.stringify(PL_STATE, null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'playlists.json';
    a.click();
    return;
  }

  // ---- Import ----
  if (e.target.closest('#plImportBtn')) {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.onchange = async () => {
      const f = inp.files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const json = JSON.parse(text);

        ensurePLState();
        if (json && Array.isArray(json.lists)) {
          // ‚úÖ Ïû¨Ìï†Îãπ(PL_STATE=json) Í∏àÏßÄ: listsÎßå ÍµêÏ≤¥
          PL_STATE.lists = json.lists;
          PL_STATE.updatedAt = nowISO();
          renderPL();
        }
      }catch(err){
        console.warn('import failed', err);
      }
    };
    inp.click();
    return;
  }

  // ---- Add current track ----
  if (e.target.closest('#plAddCurrentBtn')) {
    if (!CURRENT_TRACK) {
      alert(LANG === 'en'
        ? 'Please select or play a track first.'
        : 'Î®ºÏ†Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ÏóêÏÑú Í≥°ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïû¨ÏÉùÌïòÏÑ∏Ïöî.'
      );
      return;
    }

    ensurePLState();
    if (!PL_STATE.lists.length) {
      alert(LANG === 'en'
        ? 'No playlist found. Please create one first.'
        : 'Ïû¨ÏÉùÎ™©Î°ùÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÉà Ïû¨ÏÉùÎ™©Î°ùÏùÑ ÎßåÎìúÏÑ∏Ïöî.'
      );
      return;
    }

    const msg = PL_STATE.lists.map((pl, i) => `${i+1}. ${pl.name}`).join('\n');
    const n = prompt((LANG==='en' ? 'Add to which playlist?\n' : 'Ïñ¥Îäê Ïû¨ÏÉùÎ™©Î°ùÏóê Ï∂îÍ∞ÄÌï†ÍπåÏöî?\n') + msg);
    const idx = parseInt(n, 10) - 1;
    if (isNaN(idx) || idx < 0 || idx >= PL_STATE.lists.length) return;

    const pl = PL_STATE.lists[idx];
    if(!Array.isArray(pl.items)) pl.items = [];

    const ref = {
      id: 't_' + (CURRENT_TRACK.path || '') + '_' + (CURRENT_TRACK.file || Date.now()),
      title: CURRENT_TRACK.title || 'Untitled',
      url: CURRENT_TRACK.url,
      path: CURRENT_TRACK.path || '',
      file: CURRENT_TRACK.file || ''
    };

    if (pl.items.some(it => it.url === ref.url)) return;
    pl.items.push(ref);
    renderPL();
    return;
  }

  // ===== (5Î≤à) Ïª®Ìä∏Î°§ Î≤ÑÌäº Ìï∏Îì§ÎßÅ: Ï°¥Ïû¨Ìï† ÎïåÎßå ÎèôÏûë =====
  if (e.target.closest('#plShuffleBtn')) {
    PL_MODE = (PL_MODE === 'order') ? 'shuffle' : 'order';
    updatePLControlsUI();
    plToast(PL_MODE === 'shuffle'
      ? (LANG==='en'?'Shuffle On':'ÎûúÎç§ Ïû¨ÏÉù ÏºúÏßê')
      : (LANG==='en'?'Shuffle Off':'ÎûúÎç§ Ïû¨ÏÉù Í∫ºÏßê')
    );

    // ÌÅêÍ∞Ä Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ ÌòÑÏû¨Í≥° Ïú†ÏßÄÌïòÎ©¥ÏÑú Ïû¨Íµ¨ÏÑ±
    if (PL_ACTIVE_LIST_ID && PL_QUEUE.length) {
      const curUrl = PL_QUEUE[PL_INDEX]?.url;
      const list = PL_STATE.lists.find(x=>x.id===PL_ACTIVE_LIST_ID);
      const startIndex = list?.items?.findIndex(it=>it.url===curUrl) ?? 0;
      setQueueFromListId(PL_ACTIVE_LIST_ID, Math.max(0,startIndex));
      playFromQueue(PL_INDEX);
    }
    return;
  }

  if (e.target.closest('#plLoopBtn')) {
    PL_LOOP = (PL_LOOP === 'off') ? 'all' : 'off';
    updatePLControlsUI();
    plToast(PL_LOOP === 'all'
      ? (LANG==='en'?'Loop All':'Ï†ÑÏ≤¥ Î∞òÎ≥µ')
      : (LANG==='en'?'Loop Off':'Î∞òÎ≥µ Ìï¥Ï†ú')
    );
    return;
  }

  if (e.target.closest('#plPrevBtn')) { prevInQueue(); return; }
  if (e.target.closest('#plNextBtn')) { nextInQueue(); return; }

  if (e.target.closest('#plPlayAllBtn')) {
    ensurePLState();
    const targetId = PL_ACTIVE_LIST_ID || PL_STATE.lists?.[0]?.id;
    if(!targetId){
      plToast(LANG==='en'?'No playlist':'Ïû¨ÏÉùÎ™©Î°ù ÏóÜÏùå');
      return;
    }
    const ok = setQueueFromListId(targetId, 0);
    if(!ok){ plToast(LANG==='en'?'No tracks':'Í≥° ÏóÜÏùå'); return; }
    playFromQueue(PL_INDEX);
    return;
  }

  // ---- Click playlist item -> play (ÌÅê Í∏∞Î∞ò) ----
  const itemEl = e.target.closest('.pl-item');
  if (itemEl) {
    // ÏÇ≠Ï†ú Î≤ÑÌäºÏù¥Î©¥ Ïû¨ÏÉù Í∏àÏßÄ
    if (e.target.closest('.pl-item-del')) return;

    const listId = itemEl.getAttribute('data-plid') || '';
    const idx = parseInt(itemEl.getAttribute('data-idx') || '0', 10) || 0;

    const ok = setQueueFromListId(listId, idx);
    if(!ok) return;

    playFromQueue(PL_INDEX);
    return;
  }
});
/* ===== Generator (WebAudio) ===== */
let aCtx=null, analyser=null;
let oscNodes=[];
let zoom = 1, gamma = 1, line = 1;   // ‚òÖ Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
const cvs = document.getElementById('osc'), ctx2d = cvs.getContext('2d');
let rafId = 0;

function drawOsc(){
  const W=cvs.width= cvs.clientWidth; const H=cvs.height = cvs.clientHeight;
  ctx2d.clearRect(0,0,W,H);
  if(!analyser){ cancelAnimationFrame(rafId); return; }
  const color = document.getElementById('oscColor').value;
 
  const buf = new Uint8Array(1024); analyser.getByteTimeDomainData(buf);
  ctx2d.lineWidth=line; ctx2d.strokeStyle=color; ctx2d.beginPath();
  const step = Math.max(1, Math.floor(buf.length/(W/zoom))); let x=0;
  for(let i=0;i<buf.length;i+=step){
    const t = Math.pow(buf[i]/255, gamma);
    const y = t*H;
    if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    x += zoom; if(x>W) break;
  }
  ctx2d.stroke();
  rafId = requestAnimationFrame(drawOsc);
}
function clearOsc(){ cancelAnimationFrame(rafId); ctx2d.clearRect(0,0,cvs.width,cvs.height); }

function stopGen(){
  try{ oscNodes.forEach(n=>{ try{n.stop()}catch{} try{n.node?.stop?.()}catch{} }); }catch{}
  try{ oscNodes.forEach(n=> n.disconnect && n.disconnect()); }catch{}
  oscNodes=[];
  if(analyser){ try{ analyser.disconnect(); }catch{} analyser=null; }
  clearOsc();
}
function playGen(){
  if(!aCtx) aCtx = new (window.AudioContext||window.webkitAudioContext)();
  stopGen();

  const wf   = document.getElementById('wf').value;
  const f0   = parseFloat(document.getElementById('freq').value)||0;
  const bina = document.getElementById('binEnable').checked;
  const diff = parseFloat(document.getElementById('binDiff').value)||0;
  const duty = Math.max(1, Math.min(100, parseInt(document.getElementById('duty').value||'50',10)));
  const hEn  = document.getElementById('harmEnable').checked;
  const hBase= document.getElementById('harmBase').value;
  const hOct = parseInt(document.getElementById('harmOct').value||'0',10);

  const baseMul  = (hBase==='mid'?2:(hBase==='high'?4:1));
  const baseFreq = f0 * baseMul;

  const merger = aCtx.createChannelMerger(2);
  analyser = aCtx.createAnalyser();
  analyser.fftSize = 2048;

  const mkOsc = (freq)=>{
    const o = aCtx.createOscillator();
    o.type = (wf==='square'?'square':(wf==='triangle'?'triangle':(wf==='sawtooth'?'sawtooth':'sine')));
    o.frequency.value = Math.max(0,freq);
    let node = o;

    // Ïª§Ïä§ÌÖÄ ÎìÄÌã∞ ÏÇ¨Í∞ÅÌåå
    if(wf==='square'){
      const shaper = aCtx.createWaveShaper();
      const curve = new Float32Array(256);
      const th = (duty/100)*2-1;
      for(let i=0;i<256;i++){
        const x=i/128-1;
        curve[i] = (x<th)? -1 : 1;
      }
      shaper.curve = curve;
      o.connect(shaper);
      node = shaper;
    }

    const g = aCtx.createGain();
    g.gain.value = 0.2;
    node.connect(g);
    return { osc:o, node:g };
  };

  const gens = [];
  const mixerMode = (window.__dualMode__ === true);

  /* =========================
     1) Dual-Tone Ï†ÑÏö© Î™®Îìú
     ========================= */
  if (mixerMode){
    const toneAEl = document.getElementById('toneA');
    const toneBEl = document.getElementById('toneB');
    const fA = parseFloat(toneAEl?.value || '0') || 0;
    const fB = parseFloat(toneBEl?.value || '0') || 0;

    // Îëò Îã§ 0Ïù¥Î©¥ Í∑∏ÎÉ• ÏïÑÎ¨¥Í≤ÉÎèÑ Ïû¨ÏÉùÌïòÏßÄ ÏïäÏùå
    if (!fA && !fB) return;

    // Ïôº/Ïò§Î•∏ Ï±ÑÎÑêÏóê A/B Î∞∞Ïπò (ÌïúÏ™ΩÏù¥ 0Ïù¥Î©¥ Îã§Î•∏ Ï™ΩÏùÑ ÏñëÏ™ΩÏóê ÏÇ¨Ïö©)
    const leftFreq  = fA || fB;
    const rightFreq = fB || fA || leftFreq;

    const oA = mkOsc(leftFreq);
    const oB = mkOsc(rightFreq);

    // L/R Ï±ÑÎÑêÎ°ú Î≥¥ÎÉÑ
    oA.node.connect(merger,0,0);
    oB.node.connect(merger,0,1);

    gens.push(oA, oB);

    merger.connect(analyser).connect(aCtx.destination);
    gens.forEach(g=>{
      try{ g.osc.start(); }catch(e){}
      oscNodes.push(g.osc);
    });

    drawOsc();
    return;  // ‚òÖ Ïó¨Í∏∞ÏÑú Ï¢ÖÎ£å ‚Üí Î©îÏù∏ f0/ÌïòÎ™®Îãâ/Î∞îÏù¥ÎÖ∏Îü¥ÏùÄ Ï†ÑÌòÄ ÏïàÏîÄ
  }

  /* =========================
     2) Í∏∞Ï°¥ Îã®ÏùºÌÜ§ + Î∞îÏù¥ÎÖ∏Îü¥ + ÌïòÎ™®Îãâ Î™®Îìú
     ========================= */
  const leftBase  = baseFreq;
  const rightBase = bina ? Math.max(0, baseFreq + diff) : baseFreq;

  const buildChannel = (base, chIndex)=>{
    const baseGen = mkOsc(base);
    gens.push(baseGen);

    if(hEn){
      for(let k=1;k<=hOct;k++){
        gens.push(mkOsc(base*Math.pow(2,k)));
      }
    }

    const sliceCount = (hEn ? (1+hOct) : 1);
    gens.slice(-sliceCount).forEach(g=> g.node.connect(merger,0,chIndex));
  };

  buildChannel(leftBase, 0);
  buildChannel(rightBase,1);

  merger.connect(analyser).connect(aCtx.destination);
  gens.forEach(g=>{
    try{ g.osc.start(); }catch(e){}
    oscNodes.push(g.osc);
  });

  drawOsc();
}
document.getElementById('genPlay').addEventListener('click', async ()=>{
  try{ if(aCtx && aCtx.state==='suspended') await aCtx.resume(); }catch{}
  playGen();
});
document.getElementById('genStop').addEventListener('click', stopGen);

/* ===== Generator Presets (SAVE/LOAD/MANAGE) ===== */
const GEN_PRESET_KEY = 'fiveDO_gen_presets_v1';

function loadGenPresets(){
  try{
    const raw = localStorage.getItem(GEN_PRESET_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    console.warn('[gen preset] load failed', e);
    return [];
  }
}
function saveGenPresets(arr){
  try{
    localStorage.setItem(GEN_PRESET_KEY, JSON.stringify(arr));
  }catch(e){
    console.warn('[gen preset] save failed', e);
  }
}

function captureGenParams(){
  const num = (id, fb=0) => {
    const el = document.getElementById(id);
    const v = el ? parseFloat(el.value) : fb;
    return Number.isFinite(v) ? v : fb;
  };
  const str = (id, fb='') => {
    const el = document.getElementById(id);
    return el ? (el.value ?? fb) : fb;
  };
  const bool = (id) => {
    const el = document.getElementById(id);
    return !!(el && el.checked);
  };

  return {
    wf: str('wf','sine'),
    freq: num('freq', 432),
    duty: num('dutyNum', 50),
    binaural: bool('binEnable'),
    diff: num('binDiff', 4),
    harmEnable: bool('harmEnable'),
    harmBase: str('harmBase','fund'),
    harmOct: num('harmOct', 1),
    oscColor: str('oscColor', '#39e3ff')
  };
}

function applyGenParams(p){
  if(!p) return;

  const setVal = (id, v) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.value = v;
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  };
  const setCheck = (id, v) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.checked = !!v;
    el.dispatchEvent(new Event('change', {bubbles:true}));
  };

  setVal('wf', p.wf ?? 'sine');

  // freq / range sync
  setVal('freq', p.freq ?? 432);
  setVal('freqRange', p.freq ?? 432);

  // duty / num sync
  setVal('dutyNum', p.duty ?? 50);
  setVal('duty', p.duty ?? 50);

  setCheck('binEnable', !!p.binaural);
  setVal('binDiff', p.diff ?? 4);

  setCheck('harmEnable', !!p.harmEnable);
  setVal('harmBase', p.harmBase ?? 'fund');
  setVal('harmOct', p.harmOct ?? 1);

  if(p.oscColor) setVal('oscColor', p.oscColor);

  // playing? reflect immediately
  try{
    if(typeof aCtx !== 'undefined' && aCtx && aCtx.state === 'running'){
      playGen();
    }
  }catch(e){}
}

function refreshPresetSelect(keepSelected=true){
  const sel = document.getElementById('presetLoad');
  if(!sel) return;

  const cur = keepSelected ? sel.value : '';
  const presets = loadGenPresets();

  sel.innerHTML = '';

  // placeholder
  const ph = document.createElement('option');
  ph.value = '';
  ph.disabled = true;
  ph.selected = !cur;
  ph.setAttribute('data-i18n', 'preset_load');
  ph.textContent = (I18N?.[LANG]?.['preset_load']) || (LANG==='en' ? 'Load Preset‚Ä¶' : 'ÌîÑÎ¶¨ÏÖã Î∂àÎü¨Ïò§Í∏∞‚Ä¶');
  sel.appendChild(ph);

  presets.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name || p.id;
    sel.appendChild(opt);
  });

  // restore selection if possible
  if(cur && presets.some(x=>x.id===cur)) sel.value = cur;
}

function getSelectedPresetId(){
  const sel = document.getElementById('presetLoad');
  if(!sel) return '';
  const v = sel.value || '';
  // if placeholder selected, v will be ''
  return v;
}

function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

function pickJsonFile(onLoad){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = async () => {
    const f = inp.files && inp.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const json = JSON.parse(txt);
      onLoad && onLoad(json);
    }catch(e){
      console.warn('[gen preset] import failed', e);
      alert(LANG==='en' ? 'Import failed.' : 'Í∞ÄÏ†∏Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };
  inp.click();
}

// Ï¥àÍ∏∞ Íµ¨ÏÑ±
refreshPresetSelect(false);

// Ï†ÄÏû•(ÏÉà ÌîÑÎ¶¨ÏÖã)
const presetSaveBtn = document.getElementById('presetSave');
if(presetSaveBtn){
  presetSaveBtn.addEventListener('click', ()=>{
    const presets = loadGenPresets();
    const name = prompt(LANG==='en' ? 'Preset name?' : 'ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    if(!name) return;

    const params = captureGenParams();
    const id = 'gp_' + Date.now();

    presets.push({ id, name, params, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
    saveGenPresets(presets);
    refreshPresetSelect(true);

    const sel = document.getElementById('presetLoad');
    if(sel) sel.value = id;

    alert(LANG==='en' ? 'Preset saved.' : 'ÌîÑÎ¶¨ÏÖãÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
  });
}else{
  console.warn('[gen preset] #presetSave not found');
}

// Î∂àÎü¨Ïò§Í∏∞(ÏÑ†ÌÉù)
const presetLoadSel = document.getElementById('presetLoad');
if(presetLoadSel){
  presetLoadSel.addEventListener('change', ()=>{
    const id = getSelectedPresetId();
    if(!id) return;

    const presets = loadGenPresets();
    const hit = presets.find(x=>x.id===id);
    if(!hit) return;

    applyGenParams(hit.params);
  });
}else{
  console.warn('[gen preset] #presetLoad not found');
}

// ÎçÆÏñ¥Ïì∞Í∏∞
const presetOverwriteBtn = document.getElementById('presetOverwrite');
if(presetOverwriteBtn){
  presetOverwriteBtn.addEventListener('click', ()=>{
    const id = getSelectedPresetId();
    if(!id){
      alert(LANG==='en' ? 'Select a preset to overwrite.' : 'ÎçÆÏñ¥Ïì∏ ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
      return;
    }
    const presets = loadGenPresets();
    const idx = presets.findIndex(x=>x.id===id);
    if(idx<0) return;

    const ok = confirm(LANG==='en'
      ? `Overwrite "${presets[idx].name}" with current settings?`
      : `"${presets[idx].name}" ÌîÑÎ¶¨ÏÖãÏùÑ ÌòÑÏû¨ ÏÑ§Ï†ïÏúºÎ°ú ÎçÆÏñ¥Ïì∏ÍπåÏöî?`
    );
    if(!ok) return;

    presets[idx].params = captureGenParams();
    presets[idx].updatedAt = new Date().toISOString();
    saveGenPresets(presets);
    refreshPresetSelect(true);

    alert(LANG==='en' ? 'Preset updated.' : 'ÌîÑÎ¶¨ÏÖãÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.');
  });
}

// Ïù¥Î¶ÑÎ≥ÄÍ≤Ω
const presetRenameBtn = document.getElementById('presetRename');
if(presetRenameBtn){
  presetRenameBtn.addEventListener('click', ()=>{
    const id = getSelectedPresetId();
    if(!id){
      alert(LANG==='en' ? 'Select a preset to rename.' : 'Ïù¥Î¶ÑÏùÑ Î∞îÍøÄ ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
      return;
    }
    const presets = loadGenPresets();
    const idx = presets.findIndex(x=>x.id===id);
    if(idx<0) return;

    const next = prompt(
      LANG==='en' ? 'New preset name?' : 'ÏÉà ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏùÄ?',
      presets[idx].name || ''
    );
    if(!next) return;

    presets[idx].name = next;
    presets[idx].updatedAt = new Date().toISOString();
    saveGenPresets(presets);
    refreshPresetSelect(true);
  });
}

// ÏÇ≠Ï†ú
const presetDeleteBtn = document.getElementById('presetDelete');
if(presetDeleteBtn){
  presetDeleteBtn.addEventListener('click', ()=>{
    const id = getSelectedPresetId();
    if(!id){
      alert(LANG==='en' ? 'Select a preset to delete.' : 'ÏÇ≠Ï†úÌï† ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
      return;
    }
    const presets = loadGenPresets();
    const idx = presets.findIndex(x=>x.id===id);
    if(idx<0) return;

    const ok = confirm(LANG==='en'
      ? `Delete "${presets[idx].name}"?`
      : `"${presets[idx].name}" ÌîÑÎ¶¨ÏÖãÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?`
    );
    if(!ok) return;

    presets.splice(idx,1);
    saveGenPresets(presets);
    refreshPresetSelect(false);
  });
}

// ÎÇ¥Î≥¥ÎÇ¥Í∏∞
const presetExportBtn = document.getElementById('presetExport');
if(presetExportBtn){
  presetExportBtn.addEventListener('click', ()=>{
    const presets = loadGenPresets();
    downloadJson('gen_presets.json', {version:1, exportedAt:new Date().toISOString(), presets});
  });
}

// Í∞ÄÏ†∏Ïò§Í∏∞
const presetImportBtn = document.getElementById('presetImport');
if(presetImportBtn){
  presetImportBtn.addEventListener('click', ()=>{
    pickJsonFile((json)=>{
      const incoming = Array.isArray(json?.presets) ? json.presets : (Array.isArray(json) ? json : null);
      if(!incoming){
        alert(LANG==='en' ? 'No presets found in file.' : 'ÌååÏùºÏóêÏÑú ÌîÑÎ¶¨ÏÖãÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
        return;
      }

      const modeReplace = confirm(
        LANG==='en'
          ? 'Replace existing presets?\nOK = Replace, Cancel = Merge'
          : 'Í∏∞Ï°¥ ÌîÑÎ¶¨ÏÖãÏùÑ ÎçÆÏñ¥Ïì∏ÍπåÏöî?\nÌôïÏù∏ = ÎçÆÏñ¥Ïì∞Í∏∞, Ï∑®ÏÜå = Î≥ëÌï©'
      );

      let presets = loadGenPresets();

      if(modeReplace){
        // replace
        presets = incoming.map(p=>{
          const id = p.id || ('gp_' + Date.now() + '_' + Math.random().toString(36).slice(2));
          return { ...p, id, updatedAt: p.updatedAt || new Date().toISOString() };
        });
      }else{
        // merge by id, if conflict create new id
        const exists = new Set(presets.map(p=>p.id));
        incoming.forEach(p=>{
          let id = p.id || ('gp_' + Date.now() + '_' + Math.random().toString(36).slice(2));
          if(exists.has(id)){
            id = 'gp_' + Date.now() + '_' + Math.random().toString(36).slice(2);
          }
          exists.add(id);
          presets.push({ ...p, id, updatedAt: p.updatedAt || new Date().toISOString() });
        });
      }

      saveGenPresets(presets);
      refreshPresetSelect(false);
      alert(LANG==='en' ? 'Presets imported.' : 'ÌîÑÎ¶¨ÏÖãÏùÑ Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.');
    });
  });
}

/* Ïñ∏Ïñ¥ ÌÜ†Í∏Ä Ïãú presetLoad placeholderÎèÑ Í∞±Ïã† */
(function(){
  const _applyLang = window.applyLang;
  window.applyLang = function(){
    try{ _applyLang && _applyLang(); }catch(e){}
    try{ refreshPresetSelect(true); }catch(e){}
  };
})();

/* live param updates */
['freq','freqRange','wf','binEnable','binDiff','duty','dutyNum','harmEnable','harmBase','harmOct']
.forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  const evt = (el.tagName==='SELECT' || el.type==='checkbox') ? 'change' : 'input';
  el.addEventListener(evt, e=>{
    if(id==='freq'){ $('#freqRange').value = e.target.value; }
    if(id==='freqRange'){ $('#freq').value = e.target.value; }
    if(id==='duty'){ $('#dutyNum').value = e.target.value; }
    if(id==='dutyNum'){ $('#duty').value = e.target.value; }
    if(aCtx && aCtx.state==='running') playGen();
  });
});

['oscColor'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input', ()=>{});
  el.addEventListener('change', ()=>{});
});

// ===== Quick Presets =====
document.querySelectorAll('.qp').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const hz = btn.dataset.freq;
    const wf = btn.dataset.wf || 'sine';

    // Î©îÏù∏ ÌååÎùºÎØ∏ÌÑ∞ ÏÑ∏ÌåÖ
    document.getElementById('freq').value      = hz;
    document.getElementById('freqRange').value = hz;
    document.getElementById('wf').value        = wf;

    // ÌîÑÎ¶¨ÏÖã ÏÑ†ÌÉù Ïãú Dual-Tone Î™®ÎìúÎäî ÎÅî
    window.__dualMode__ = false;

    if(aCtx && aCtx.state==='running'){
      playGen();
    }else{
      document.getElementById('genPlay').click();
    }
  });
});

// ===== Dual Tone Buttons =====
window.__dualMode__ = false;

const dualPlayBtn = document.getElementById('dualPlay');
const dualStopBtn = document.getElementById('dualStop');

if (dualPlayBtn && dualStopBtn) {
  dualPlayBtn.addEventListener('click', () => {
    const toneAEl   = document.getElementById('toneA');
    const toneBEl   = document.getElementById('toneB');
    const freqEl    = document.getElementById('freq');
    const binEnable = document.getElementById('binEnable');
    const binDiffEl = document.getElementById('binDiff');

    const a = toneAEl ? parseFloat(toneAEl.value) || 0 : 0;
    const b = toneBEl ? parseFloat(toneBEl.value) || 0 : 0;

    // Î©îÏù∏ Ï£ºÌååÏàòÎ•º Tone AÎ°ú ÏÑ§Ï†ï
    if (freqEl) freqEl.value = a.toString();

    // Binaural diff = Tone B - Tone A
    if (binDiffEl) binDiffEl.value = (b - a).toFixed(3);

    // Î∞îÏù¥ÎÖ∏Îü¥ ON
    if (binEnable) binEnable.checked = true;

    window.__dualMode__ = true;

    // Ïã§Ï†ú Ïû¨ÏÉùÏùÄ Í∏∞Ï°¥ genPlay Î≤ÑÌäºÏóê ÏúÑÏûÑ
    const genPlayBtn = document.getElementById('genPlay');
    if (genPlayBtn) genPlayBtn.click();
  });

  dualStopBtn.addEventListener('click', () => {
    window.__dualMode__ = false;
    // Í∏∞Ï°¥ stopGen() ÎòêÎäî genStop Î°úÏßÅÏù¥ ÏûàÏúºÎ©¥ Ìò∏Ï∂ú
    if (typeof stopGen === 'function') stopGen();
    else {
      // fallback: Ïò§Ïã§Î†àÏù¥ÌÑ∞ Ï†ïÏßÄ + ÏÉÅÌÉú ÌëúÏãúÎßåÏù¥ÎùºÎèÑ
      const playerTitle = document.getElementById('metaTitle');
      if (playerTitle) playerTitle.classList.remove('playing');
    }
  });
}
	


/* ===== Generator ÌïòÎã® Í¥ëÍ≥† Î∞∞ÎÑà (GitHub Pages Ïù¥ÎØ∏ÏßÄ) ===== */
(function initAdBanner(){
  const imgEl   = document.getElementById('adBannerImg');
  const linkEl  = document.getElementById('adBannerLink');
  const dotsBox = document.getElementById('adBannerDots');
  if (!imgEl || !linkEl || !dotsBox) return;

  // üîπ Î∞∞ÎÑà ÏÑ§Ï†ï: Ïù¥ÎØ∏ÏßÄ src Îäî GitHub Pages, ÎßÅÌÅ¨Îäî Í∞Å ÏÇ¨Ïù¥Ìä∏
  const BANNERS = [
    {
      // Î∞∞ÎÑà 1: Quantum Torus X
      src:  GITHUB_ASSET_BASE + '/banners/qtx-banner.webp',
      href: 'https://5dshop.co.kr/?idx=483', // Ïã§Ï†ú Ïπ¥ÌÖåÍ≥†Î¶¨ URLÎ°ú ÍµêÏ≤¥
      alt:  'Quantum Torus X'
    },
    {
      // Î∞∞ÎÑà 2: Quantum Torus Pendant ‚Üí ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌéòÏù¥ÏßÄÎ°ú
      src:  GITHUB_ASSET_BASE + '/banners/qtp-banner.webp',
      href: 'https://paulkpark.github.io/5dio-app/assets/nav/qtp-nav.html',        // ÎÑ§Í∞Ä ÎßåÎì† ÎÇ¥ÎπÑ ÌéòÏù¥ÏßÄ Í≤ΩÎ°ú
      alt:  'Quantum Torus Pendant'
    },
    {
      // Î∞∞ÎÑà 3: 5D Healing Center
      src:  GITHUB_ASSET_BASE + '/banners/5dhc-banner.webp',
      href: 'https://5dhealingcenter.co.kr',
      alt:  '5D Healing Center'
    }
  ];

  let current = 0;
  let timerId = null;

  // Ï†ê(Ïä¨ÎùºÏù¥Îìú Ïù∏ÎîîÏºÄÏù¥ÌÑ∞) ÎßåÎì§Í∏∞
  dotsBox.innerHTML = '';
  BANNERS.forEach((_, idx)=>{
    const dot = document.createElement('div');
    dot.className = 'ad-dot' + (idx===0 ? ' active' : '');
    dot.dataset.idx = idx;
    dot.addEventListener('click', ()=>{
      setBanner(idx);
      restartTimer();
    });
    dotsBox.appendChild(dot);
  });

  function setBanner(idx){
    const b = BANNERS[idx];
    if (!b) return;
    current = idx;
    imgEl.src = b.src;
    imgEl.alt = b.alt || '';
    linkEl.href = b.href;

    // active Ï†ê Í∞±Ïã†
    dotsBox.querySelectorAll('.ad-dot').forEach((d, i)=>{
      d.classList.toggle('active', i === idx);
    });
  }

  function nextBanner(){
    const next = (current + 1) % BANNERS.length;
    setBanner(next);
  }

  function restartTimer(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(nextBanner, 7000);  // 7Ï¥àÎßàÎã§ ÍµêÏ≤¥
  }

  // Ï¥àÍ∏∞ ÌëúÍ∏∞ + ÌÉÄÏù¥Î®∏ ÏãúÏûë
  setBanner(0);
  restartTimer();
})();	
	
/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadTrackMeta();   // ‚òÖ meta.json Î®ºÏ†Ä Î°úÎî©
  applyLang();

  const unlock=()=>{ try{ player.play().then(()=>player.pause()).catch(()=>{}); }catch(_){} window.removeEventListener('touchend',unlock); window.removeEventListener('click',unlock); };
  window.addEventListener('touchend',unlock,{once:true}); window.addEventListener('click',unlock,{once:true});

  window.PL_STATE = await syncPlaylists();

  STATE.path=''; STATE.stack=[];
  await renderStrip();
  statusBlank();

  showPage('lib');
});
</script>

<script>
(function(){
  const popup      = document.getElementById('numPopup');
  if (!popup) return;

  const labelEl    = document.getElementById('numPopupLabel');
  const valEl      = document.getElementById('numPopupValue');
  const rangeEl    = document.getElementById('numPopupRange');
  const closeBtn   = document.getElementById('numPopupClose');

  let boundInput = null;
  let cfg        = null;

 // ÌåùÏóÖ ÏÑ§Ï†ï: Ï£ºÌååÏàò / ÎìÄÌã∞ / ÎìÄÏñº ÌÜ§
const configs = {
  freq: {
    min: 0,
    max: 20000,
    step: 0.1,
    labelKey: 'gen.frequency'
  },
  dutyNum: {
    min: 1,
    max: 100,
    step: 1,
    labelKey: 'gen.duty'
  },
  toneA: {
    min: 0,
    max: 20000,
    step: 0.1,
    labelKey: 'dual.toneA'
  },
  toneB: {
    min: 0,
    max: 20000,
    step: 0.1,
    labelKey: 'dual.toneB'
  }
};

  function getLabelText(input, config){
    // i18n Ïö∞ÏÑ†
    if (config && config.labelKey && I18N && I18N[LANG] && I18N[LANG][config.labelKey]){
      return I18N[LANG][config.labelKey];
    }
    // Í∑∏Îã§Ïùå fallback
    if (input.dataset.label) return input.dataset.label;
    if (input.placeholder)  return input.placeholder;
    return input.id;
  }

  function openPopup(input){
    const id = input.id;
    const c  = configs[id];
    if (!c) return;
    boundInput = input;
    cfg = c;

    labelEl.textContent = getLabelText(input, c);

    valEl.min   = c.min;
    valEl.max   = c.max;
    valEl.step  = c.step;
    rangeEl.min = c.min;
    rangeEl.max = c.max;
    rangeEl.step= c.step;

    const current = parseFloat(input.value || c.min);
    valEl.value   = isNaN(current) ? c.min : current;
    rangeEl.value = valEl.value;

    popup.classList.add('show');
  }

  function applyValue(v){
    if (!boundInput) return;
    boundInput.value = v;
    // Í∏∞Ï°¥ Ï†úÎÑàÎ†àÏù¥ÌÑ∞ Î°úÏßÅÏóê Ï¶âÏãú Î∞òÏòÅÎêòÎèÑÎ°ù input/change Ïù¥Î≤§Ìä∏ Îëò Îã§ Ïè¥Ï§å
    boundInput.dispatchEvent(new Event('input', { bubbles:true }));
    boundInput.dispatchEvent(new Event('change', { bubbles:true }));
  }

  // Ïä¨ÎùºÏù¥Îçî/Ïà´Ïûê ÏûÖÎ†• Ïãú Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ
  valEl.addEventListener('input', ()=>{
    const v = valEl.value;
    rangeEl.value = v;
    applyValue(v);
  });

  rangeEl.addEventListener('input', ()=>{
    const v = rangeEl.value;
    valEl.value = v;
    applyValue(v);
  });

  // Îã´Í∏∞ Î≤ÑÌäº & Î∞∞Í≤Ω ÌÅ¥Î¶≠ÏúºÎ°ú Î™®Îã¨ Îã´Í∏∞
  function closePopup(){
    popup.classList.remove('show');
    boundInput = null;
    cfg        = null;
  }

  closeBtn.addEventListener('click', closePopup);
  popup.addEventListener('click', (e)=>{
    if (e.target === popup) closePopup();
  });

  // ÎåÄÏÉÅ ÌïÑÎìúÏóê ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ Í±∏Í∏∞ (freq / dutyNum)
  document.querySelectorAll('.num-popup-field').forEach(input =>{
    input.readOnly = true;  // ÏßÅÏ†ë ÌÇ§Î≥¥Îìú ÏûÖÎ†• ÎåÄÏã† ÌåùÏóÖ ÏÇ¨Ïö©
    input.addEventListener('click', (e)=>{
      e.preventDefault();
      openPopup(input);
    });
  });
})();
</script>

<!-- === WebP thumb loader (no JPG/PNG fallback) === -->
<script>
(function(){
  function buildThumbCandidates(src, lang){
    try{
      const u = new URL(src, location.href);
      const q = new URLSearchParams(u.search);
      const base = u.pathname.replace(/\.(webp|jpg|jpeg|png)$/i, '');
      const hasE  = /_e$/i.test(base);
      const suffixes = (lang === 'en')
        ? (hasE ? [""] : ["_e", ""])
        : (hasE ? ["", "_e"] : ["", "_e"]);
      const mk = (ext, suf) => {
        const p = base.replace(/_e$/i,'') + suf + '.' + ext;
        const uu = new URL(u.origin + p);
        const qq = new URLSearchParams(q.toString());
        if (!qq.get('format')) qq.set('format','webp');
        if (!qq.get('quality')) qq.set('quality','70');
        if (!qq.get('width')) qq.set('width','300');
        uu.search = '?' + qq.toString();
        return uu.toString();
      };
      const list = [];
      suffixes.forEach(s => list.push(mk('webp', s)));
      return [...new Set(list)];
    }catch(e){
      return [src];
    }
  }

  function setBGWithFallback(el, urls, i=0){
    if (!el || i>=urls.length){ if(el) el.setAttribute('data-loaded','fail'); return; }
    const test = new Image();
    test.onload = ()=>{ el.style.backgroundImage = `url("${urls[i]}")`; el.setAttribute('data-loaded','1'); };
    test.onerror= ()=> setBGWithFallback(el, urls, i+1);
    test.referrerPolicy = 'no-referrer';
    test.decoding = 'async';
    test.src = urls[i];
  }

  function lazyLoadThumbs(){
    const lang = (window.LANG || (document.documentElement.lang==='en'?'en':'ko')) || 'ko';
    document.querySelectorAll('.thumb[data-src]:not([data-loaded])').forEach(th => {
      const src = th.getAttribute('data-src');
      if (!src) return;
      const list = buildThumbCandidates(src, lang);
      setBGWithFallback(th, list, 0);
    });
  }

  window.addEventListener('DOMContentLoaded', lazyLoadThumbs, {once:true});
  window.addEventListener('load', lazyLoadThumbs);
  document.addEventListener('scroll', ()=>{
    if (window.__ll_t) return;
    window.__ll_t = setTimeout(()=>{ window.__ll_t=null; lazyLoadThumbs(); }, 120);
  }, {passive:true});

  window.setStatusThumb = function(div, src){
    const lang = (window.LANG || 'ko');
    const list = buildThumbCandidates(src, lang);
    setBGWithFallback(div, list, 0);
  };
  window.lazyLoadThumbs = lazyLoadThumbs;
})();
</script>

<!-- === 5DO Level-1 Memory Cache (folders/tracks/thumbs) === -->
<script>
(function(){
  const MC = window.__MEMCACHE__ = {
    root: null,
    folders: {},
    thumbs: new Map()
  };

  function deepClone(v){
    try { return structuredClone(v); } catch(e){
      return JSON.parse(JSON.stringify(v));
    }
  }

  function wrapRoot(fn){
    return async function(){
      if (MC.root) return deepClone(MC.root);
      const data = await fn.apply(this, arguments);
      MC.root = data;
      return deepClone(data);
    };
  }
  function wrapFolder(fn){
    return async function(path){
      const key = String(path || "");
      if (MC.folders[key]) return deepClone(MC.folders[key]);
      const data = await fn.apply(this, arguments);
      MC.folders[key] = data;
      return deepClone(data);
    };
  }

  if (typeof window.listRoot === 'function'){
    window.listRoot = wrapRoot(window.listRoot);
  }
  if (typeof window.listFolder === 'function'){
    window.listFolder = wrapFolder(window.listFolder);
  } else if (typeof window.loadFolder === 'function'){
    window.loadFolder = wrapFolder(window.loadFolder);
  }

  (function(){
    const orig = window.setBGWithFallback;
    if (!orig){
      window.setBGWithFallback = function(el, urls, i=0){
        if (!el || i>=urls.length){ if (el) el.setAttribute('data-loaded','fail'); return; }
        const u = urls[i];
        if (MC.thumbs.has(u)){
          el.style.backgroundImage = `url("${MC.thumbs.get(u)}")`;
          el.setAttribute('data-loaded','1');
          return;
        }
        const img = new Image();
        img.onload = function(){
          MC.thumbs.set(u, img.src);
          el.style.backgroundImage = `url("${img.src}")`;
          el.setAttribute('data-loaded','1');
        };
        img.onerror = function(){ window.setBGWithFallback(el, urls, i+1); };
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        img.src = u;
      };
      return;
    }

    window.setBGWithFallback = function(el, urls, i=0){
      if (!el || i>=urls.length){ if (el) el.setAttribute('data-loaded','fail'); return; }
      const u = urls[i];

      if (MC.thumbs.has(u)){
        el.style.backgroundImage = `url("${MC.thumbs.get(u)}")`;
        el.setAttribute('data-loaded','1');
        return;
      }

      const before = el.style.backgroundImage;
      const obs = new MutationObserver(()=>{
        const bi = el.style.backgroundImage;
        if (bi && bi !== before){
          const m = bi.match(/url\(["']?(.*?)["']?\)/i);
          if (m && m[1]) MC.thumbs.set(u, m[1]);
          obs.disconnect();
        }
      });
      try{ obs.observe(el, {attributes:true, attributeFilter:['style']}); }catch(e){}
      orig(el, urls, i);
    };
  })();

  window.clear5DOMemoryCaches = function(){
    MC.root = null;
    MC.folders = {};
    MC.thumbs.clear();
  };
})();
</script>
	
</body>
</html>

<script>
  // PWAÏö© ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => {
          console.log('5DO service worker registered:', reg.scope);
        })
        .catch(err => {
          console.warn('Service worker registration failed:', err);
        });
    });
  }
</script>
</div>
</body>
</html>
</body>
</html>
