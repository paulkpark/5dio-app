<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>5DO Lite</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#0b0f17; --panel:#101623; --accent:#73e6c3; --fg:#dfe7ef; --muted:#8ea0b4; --border:#1f2734;
  --chip:#172132; --chip2:#1a2234;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Helvetica,Arial}
a{color:inherit;text-decoration:none}
button{cursor:pointer}

header{
  display:flex;align-items:center;gap:10px;justify-content:space-between;
  padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10
}
.left-pack{display:flex;align-items:center;gap:10px}
.app-title{font-weight:700;color:var(--accent);font-size:1.1rem;letter-spacing:.2px}

/* hamburger with frame */
.menu-container{position:relative}
.hamburger{width:38px;height:28px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;background:#0e1420}
.hamburger span,.hamburger span::before,.hamburger span::after{
  display:block;position:relative;width:18px;height:2px;background:#cfead1;border-radius:2px;content:"";
}
.hamburger span::before{position:absolute;top:-6px;content:"";width:18px;height:2px;background:#cfead1}
.hamburger span::after {position:absolute;top: 6px;content:"";width:18px;height:2px;background:#cfead1}
.dropdown{position:absolute;top:36px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:12px;min-width:220px;display:none;flex-direction:column;overflow:hidden}
.dropdown a{padding:10px 12px;border-bottom:1px solid var(--border)}
.dropdown a:last-child{border-bottom:none}
.backdrop{position:fixed;inset:0;background:#0008;display:none}

.main{padding:16px;display:grid;gap:16px}

/* library strip */
.nav-row{display:flex;align-items:center;gap:10px}
.nav-btn{width:34px;height:34px;border:1px solid var(--border);background:var(--chip);border-radius:10px;display:grid;place-items:center}
.nav-btn:hover{background:var(--chip2)}
.nav-emoji{font-size:16px}

.scroller{
  display:flex;gap:12px;overflow-x:auto;padding:10px;border:1px solid var(--border);
  background:#0e1522;border-radius:14px;scroll-snap-type:x mandatory
}
.card{min-width:120px;max-width:120px;scroll-snap-align:start;background:#0f1726;border:1px solid var(--border);border-radius:14px;overflow:hidden}
.thumb{width:100%;height:100px;display:block;background:#05070c;background-position:center;background-size:cover}
.caption{padding:8px 9px;color:var(--muted);font-size:.86rem}

/* player/status row */
.player-row{display:flex;align-items:flex-start;gap:12px}
.statusThumb{
  width:124px;height:124px;border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative;background:#070a10;
}
.statusThumb .glow{
  position:absolute;inset:0;background:
  radial-gradient(120px 120px at 30% 30%, #14384a 0,#0e1624 60%, transparent 70%),
  radial-gradient(160px 160px at 70% 60%, #1a3a2f 0,#0e1624 60%, transparent 70%);
  animation:float 6s ease-in-out infinite alternate;
}
@keyframes float{
  0%{transform:translate3d(0,0,0);opacity:.8}
  100%{transform:translate3d(0,-6px,0);opacity:.95}
}
.statusThumb.ready .glow{display:none}
.statusThumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
.statusThumb.ready img{display:block}

.controls{
  flex:1;display:grid;gap:10px;grid-template-columns:1fr 110px 140px;align-items:center
}
.controls .vol{display:flex;align-items:center;gap:10px}
.controls input[type="range"]{width:100%}
.loopBtn{height:36px;border:1px solid var(--border);background:var(--chip);color:#cfead1;border-radius:10px}
.timerSel{height:36px;border:1px solid var(--border);background:var(--chip);color:#cfead1;border-radius:10px;padding:0 8px}

/* audio controls (native) */
audio{width:100%;height:36px}

/* visualizer panel (bar) */
.viz-wrap{
  border:1px solid var(--border);border-radius:14px;background:#0d1422;padding:10px;height:140px;display:flex;align-items:center;justify-content:center
}
#viz{width:100%;height:120px;display:block}

/* footer spacing */
.spacer{height:6px}

/* responsive */
@media (max-width:720px){
  .controls{grid-template-columns:1fr;gap:8px}
  .player-row{align-items:center}
}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger" style="margin-top:-2px"><span></span></div>
      <nav id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
        <a href="texts/faq.txt"     class="menu-text" target="_blank">FAQ</a>
        <a href="texts/manual.txt"  class="menu-text" target="_blank">Manual</a>
        <a href="texts/contact.txt" class="menu-text" target="_blank">Contact</a>
        <a href="texts/about.txt"   class="menu-text" target="_blank">About</a>
      </nav>
      <div id="backdrop" class="backdrop"></div>
    </div>
    <div class="app-title">5DO Lite</div>
  </div>
</header>

<main class="main">

  <!-- Library nav -->
  <div class="nav-row">
    <button class="nav-btn" id="navBack"    title="Back"><span class="nav-emoji">‚óÄÔ∏è</span></button>
    <button class="nav-btn" id="navRefresh" title="Refresh"><span class="nav-emoji">üîÑ</span></button>
  </div>

  <!-- Thumbnails scroller -->
  <div id="thumbs" class="scroller" aria-label="media thumbnails"></div>

  <!-- Player + status/controls -->
  <div class="player-row">
    <div id="statusThumb" class="statusThumb" aria-label="loading status thumbnail">
      <div class="glow"></div>
      <img id="statusImg" alt="thumbnail">
    </div>

    <div class="controls">
      <div class="vol">
        <label style="min-width:52px;color:var(--muted)">Volume</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9">
      </div>

      <button id="loopBtn" class="loopBtn" aria-pressed="false" title="Loop current track">Loop: Off</button>

      <select id="timerSel" class="timerSel" title="Stop after preset">
        <option value="">Timer: Off</option>
        <option value="5">5 min</option>
        <option value="10">10 min</option>
        <option value="15">15 min</option>
        <option value="20">20 min</option>
        <option value="30">30 min</option>
        <option value="45">45 min</option>
        <option value="60">60 min</option>
      </select>
    </div>
  </div>

  <audio id="player" controls preload="none" crossorigin="anonymous"></audio>

  <!-- Visualizer (bars) -->
  <div class="viz-wrap">
    <canvas id="viz"></canvas>
  </div>

  <div class="spacer"></div>
</main>

<script>
/* -------------------- MENU -------------------- */
(()=>{
  const btn = document.getElementById('menuBtn');
  const drop= document.getElementById('menuDrop');
  const bd  = document.getElementById('backdrop');
  const open = ()=>{ drop.style.display='flex'; bd.style.display='block'; };
  const close= ()=>{ drop.style.display='none'; bd.style.display='none'; };
  btn.addEventListener('click', (e)=>{ e.stopPropagation();
    (drop.style.display==='flex') ? close() : open();
  });
  bd.addEventListener('click', close);
})();

/* -------------------- SUPABASE -------------------- */
const SB_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";
const sb = supabase.createClient(SB_URL, SB_KEY);

// image (imgproxy) & file URLs
const imgx = (path, params="width=360&quality=70&format=webp") =>
  `${SB_URL}/storage/v1/render/image/public/${BUCKET}/${encodeURI(path)}?${params}`;

const fileUrl = (path) =>
  `${SB_URL}/storage/v1/object/public/${BUCKET}/${encodeURI(path)}`;

/* -------------------- STATE -------------------- */
const thumbsEl   = document.getElementById('thumbs');
const player     = document.getElementById('player');
const volEl      = document.getElementById('vol');
const loopBtn    = document.getElementById('loopBtn');
const timerSel   = document.getElementById('timerSel');
const statusBox  = document.getElementById('statusThumb');
const statusImg  = document.getElementById('statusImg');
const navBack    = document.getElementById('navBack');
const navRefresh = document.getElementById('navRefresh');

let cwd = "";         // current path inside 'media'
let stack = [];       // path stack for Back
let timerId = null;   // stop timer

/* -------------------- AUDIO + VIS -------------------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const analyser = audioCtx.createAnalyser();
analyser.fftSize = 1024;
const srcNode  = audioCtx.createMediaElementSource(player);
srcNode.connect(analyser);
analyser.connect(audioCtx.destination);

let rafId = null;
const viz = document.getElementById('viz');
const vctx= viz.getContext('2d');

function fitCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = viz.clientWidth, h = viz.clientHeight;
  viz.width = Math.floor(w*dpr); viz.height = Math.floor(h*dpr);
  vctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', fitCanvas); fitCanvas();

function clearViz(){
  vctx.clearRect(0,0,viz.width, viz.height);
}

function drawBars(){
  const W = viz.clientWidth, H = viz.clientHeight;
  const bins = new Uint8Array(analyser.frequencyBinCount);
  function loop(){
    rafId = requestAnimationFrame(loop);
    analyser.getByteFrequencyData(bins);
    vctx.clearRect(0,0,W,H);
    const n = 64;                // bars to draw
    const step = Math.floor(bins.length/n);
    const barW = (W - 20) / n;
    for(let i=0;i<n;i++){
      const v = bins[i*step]/255;                      // 0..1
      const h = Math.max(2, v * (H-10));
      const x = 10 + i*barW;
      const y = H - h;
      // gradient color (5DO ÎäêÎÇå)
      const grd = vctx.createLinearGradient(x, y, x, y+h);
      grd.addColorStop(0, "#73e6c3");
      grd.addColorStop(.6, "#55d0ff");
      grd.addColorStop(1, "#a38cff");
      vctx.fillStyle = grd;
      vctx.fillRect(x, y, barW*0.8, h);
      // slight glow
      vctx.globalAlpha = 0.12;
      vctx.fillRect(x, y-6, barW*0.8, 6);
      vctx.globalAlpha = 1;
    }
  }
  loop();
}

function startViz(){
  if(rafId) cancelAnimationFrame(rafId);
  drawBars();
}
function stopViz(){
  if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
  clearViz(); // freeze Í∏àÏßÄ ‚Üí Ï¶âÏãú Í∫ºÏßê
}

/* -------------------- HELPERS -------------------- */
function setStatusThumb(src){ // show image & stop glow
  if(src){
    statusImg.src = src;
    statusBox.classList.add('ready');
  }else{
    statusImg.removeAttribute('src');
    statusBox.classList.remove('ready'); // dreamy glow shows
  }
}

function cancelTimer(){
  if(timerId){ clearTimeout(timerId); timerId=null; }
  timerSel.value="";
}

/* -------------------- LIBRARY -------------------- */
async function list(path){
  const { data, error } = await sb.storage.from(BUCKET).list(path||"", {limit:1000, sortBy:{column:'name', order:'asc'}});
  if(error){ console.warn(error); return []; }
  return data || [];
}

function isAudio(name){
  return /\.mp3$/i.test(name);
}
function isImage(name){
  return /\.(png|jpg|jpeg|webp)$/i.test(name);
}

async function loadRoot(){
  cwd="";
  stack.length=0;
  await renderFolder("");
}

async function renderFolder(path){
  thumbsEl.innerHTML = "";
  const rows = await list(path);
  // Folders first
  const folders = rows.filter(r=>r.metadata && r.metadata.name===undefined && r.id===undefined && r.name && r.name.indexOf('.')===-1 || r.type==="folder");
  const files   = rows.filter(r=>r.name && r.name.indexOf('.')>0);

  // Category folders
  for(const f of rows.filter(r=>r.id===undefined && r.name && !r.name.includes('.'))){
    const card = document.createElement('div'); card.className='card';
    const t = document.createElement('div'); t.className='thumb';
    const cap = document.createElement('div'); cap.className='caption'; cap.textContent = f.name;
    // folder thumb: prefer jpg then png
    const thumbUrlJpg = imgx(`${path?path+'/':''}${f.name}/folder.jpg`);
    const thumbUrlPng = imgx(`${path?path+'/':''}${f.name}/folder.png`);
    // try jpg then fallback to png
    try{
      const ok = await fetch(thumbUrlJpg, {method:'HEAD'});
      t.style.backgroundImage = `url('${ok.ok?thumbUrlJpg:thumbUrlPng}')`;
    }catch{
      t.style.backgroundImage = `url('${thumbUrlPng}')`;
    }
    card.appendChild(t); card.appendChild(cap);
    card.addEventListener('click', ()=>{
      stack.push(cwd);
      cwd = (path?path+'/':'') + f.name;
      renderFolder(cwd);
    });
    thumbsEl.appendChild(card);
  }

  // Audio files inside folder
  for(const f of files.filter(r=>isAudio(r.name))){
    const base = f.name.replace(/\.(mp3)$/i,'');
    const imgJ = imgx(`${path?path+'/':''}${base}.jpg`, "width=360&quality=78&format=webp");
    const imgP = imgx(`${path?path+'/':''}${base}.png`, "width=360&quality=78&format=webp");
    const src  = fileUrl(`${path?path+'/':''}${f.name}`);

    const card = document.createElement('div'); card.className='card';
    const t = document.createElement('div'); t.className='thumb';
    const cap = document.createElement('div'); cap.className='caption'; cap.textContent = base;
    // image try jpg‚Üípng
    (async()=>{
      try{
        const ok = await fetch(imgJ,{method:'HEAD'}); 
        t.style.backgroundImage = `url('${ok.ok?imgJ:imgP}')`;
      }catch{
        t.style.backgroundImage = `url('${imgP}')`;
      }
    })();

    card.appendChild(t); card.appendChild(cap);
    card.addEventListener('click', ()=>{
      // load only (no autoplay)
      player.src = src;
      // set status preview
      (async()=>{
        try{
          const ok = await fetch(imgJ,{method:'HEAD'});
          setStatusThumb(ok.ok?imgJ:imgP);
        }catch{
          setStatusThumb(imgP);
        }
      })();
      // ensure context resume happens on user play
    });
    thumbsEl.appendChild(card);
  }
}

/* -------------------- NAV -------------------- */
navBack.addEventListener('click', ()=>{
  if(stack.length){
    cwd = stack.pop();
    renderFolder(cwd);
  }
});
navRefresh.addEventListener('click', ()=>{
  renderFolder(cwd);
});

/* -------------------- PLAYER WIRES -------------------- */
volEl.addEventListener('input', ()=>{
  player.volume = parseFloat(volEl.value);
});

loopBtn.addEventListener('click', ()=>{
  const on = loopBtn.getAttribute('aria-pressed') === 'true';
  const next = !on;
  loopBtn.setAttribute('aria-pressed', String(next));
  loopBtn.textContent = `Loop: ${next? 'On':'Off'}`;
  // L1: single-track repeat
  player.loop = next;
});

timerSel.addEventListener('change', ()=>{
  if(timerId){ clearTimeout(timerId); timerId=null; }
  const mins = parseInt(timerSel.value||"",10);
  if(!mins) return; // off
  timerId = setTimeout(()=>{
    player.pause();
    stopViz();
    cancelTimer();
  }, mins*60*1000);
});

/* Audio unlock + visualize */
function ensureUnlocked(){
  if(audioCtx.state !== 'running'){
    audioCtx.resume?.();
  }
}
player.addEventListener('play', ()=>{
  ensureUnlocked();
  startViz();                 // start bars
});
player.addEventListener('pause', stopViz);
player.addEventListener('ended', ()=>{
  stopViz();                  // ended ‚Üí off
  if(!player.loop){ /* do nothing */ }
});

/* -------------------- INIT -------------------- */
(async function init(){
  // defaults
  player.volume = parseFloat(volEl.value);
  setStatusThumb(null); // dreamy glow (default)

  await loadRoot();
})();
</script>
</body>
</html>
