<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5DIO Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
body{margin:0;background:#0b0d13;color:#e5e7eb;font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',Roboto,Arial}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#12141b;border-bottom:1px solid #222738}
.logo{font-weight:700;color:#9cff8b;font-size:1.2rem}

.nav-toggle{display:none}
.hamburger{width:36px;height:32px;border-radius:8px;border:1px solid #222738;
  background:#1c2130;display:flex;align-items:center;justify-content:center;cursor:pointer}
.hamburger span,.hamburger span:before,.hamburger span:after{
  display:block;background:#cfd6e6;height:2px;width:18px;position:relative;border-radius:2px}
.hamburger span:before,.hamburger span:after{content:"";position:absolute;left:0}
.hamburger span:before{top:-6px}.hamburger span:after{top:6px}

.side-menu{
  position:fixed;top:0;left:0;width:78%;max-width:340px;height:100vh;
  background:#0f1320;border-right:1px solid #222738;box-shadow:6px 0 20px rgba(0,0,0,.35);
  transform:translateX(-100%);transition:.25s ease;padding:14px;overflow-y:auto
}
.nav-toggle:checked~.side-menu{transform:translateX(-100%)!important}
.nav-toggle:not(:checked)~.side-menu{transform:none}

.menu-title{margin:4px 0 10px;font-weight:800;color:#cfead1}
.mbtn{padding:9px 10px;border-radius:10px;border:1px solid #222738;background:#171d2b;color:#dfe7f6;text-align:left;width:100%;margin:5px 0}
.mrow{display:flex;align-items:center;gap:10px;margin:6px 0}
.mrow input[type="range"]{flex:1}

canvas{width:100%;height:120px;background:#090b11;display:block;border-bottom:1px solid #222738}
#library{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}
.card{background:#181b25;border:1px solid #222738;border-radius:12px;padding:6px;cursor:pointer}
.card img{width:100%;aspect-ratio:1/1;object-fit:contain;background:#0e1016;border-radius:8px}
.card span{display:block;margin-top:6px;font-size:.92rem}
#nav{display:flex;justify-content:center;gap:8px;margin:6px 0 10px}
.btn{background:#1e2232;border:1px solid #2c3147;color:#eee;border-radius:8px;padding:6px 12px}
audio{width:92%;display:block;margin:6px auto 12px}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <input id="navToggle" class="nav-toggle" type="checkbox" checked>
    <label for="navToggle" class="hamburger" aria-label="menu"><span></span></label>
    <div class="logo">5DIO</div>
  </div>
</header>

<nav class="side-menu">
  <div class="menu-title">Menu</div>
  <button id="mRoot" class="mbtn">Root</button>
  <button id="mBack" class="mbtn">Back</button>
  <button id="mRefresh" class="mbtn">Refresh</button>
  <div class="mrow"><label>Volume</label><input id="vol" type="range" min="0" max="1" step="0.01" value="1"></div>
  <div class="mrow"><label>Balance</label><input id="bal" type="range" min="-1" max="1" step="0.01" value="0"></div>
</nav>

<canvas id="osc"></canvas>
<div id="library"></div>
<div id="nav">
  <button id="btnBack" class="btn">Back</button>
  <button id="btnRefresh" class="btn">Refresh</button>
</div>
<audio id="player" controls preload="none"></audio>

<script>
const SUPABASE_URL="https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_KEY="YOUR_ANON_KEY";
const BUCKET="media";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const PUBLIC=SUPABASE_URL+"/storage/v1/object/public/"+BUCKET+"/";

const navToggle=document.getElementById("navToggle");
const player=document.getElementById("player");
const vol=document.getElementById("vol");
const bal=document.getElementById("bal");

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
const src=audioCtx.createMediaElementSource(player);
const gain=audioCtx.createGain();
const pan=audioCtx.createStereoPanner();
const analyser=audioCtx.createAnalyser();
src.connect(pan).connect(gain).connect(analyser).connect(audioCtx.destination);
gain.gain.value=parseFloat(vol.value);
pan.pan.value=parseFloat(bal.value);

vol.oninput=()=>{gain.gain.value=parseFloat(vol.value);}
bal.oninput=()=>{pan.pan.value=parseFloat(bal.value);}

window.ensureAudioUnlocked=function(){
  if(audioCtx.state!=="running")audioCtx.resume().catch(()=>{});
};
document.addEventListener("pointerdown",ensureAudioUnlocked,{once:true});
player.addEventListener("play",ensureAudioUnlocked);

/* ===== Oscilloscope ===== */
analyser.fftSize=2048;
const buf=new Uint8Array(analyser.fftSize);
const canvas=document.getElementById("osc");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=canvas.clientWidth;canvas.height=120;}
window.addEventListener("resize",resize);resize();
function draw(){
  requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(buf);
  ctx.fillStyle="#090b11";ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth=2;ctx.strokeStyle="#9cff8b";ctx.beginPath();
  const slice=canvas.width/buf.length;
  for(let i=0,x=0;i<buf.length;i++,x+=slice){
    const y=(buf[i]/128.0)*canvas.height/2;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.lineTo(canvas.width,canvas.height/2);ctx.stroke();
}
draw();

/* ===== Supabase Library ===== */
const lib=document.getElementById("library");
let cwd="";
const enc=s=>s.split("/").map(encodeURIComponent).join("/");
async function list(p=""){
  const {data,error}=await sb.storage.from(BUCKET).list(p,{limit:1000,sortBy:{column:"name",order:"asc"}});
  if(error){console.warn(error);return [];}return data||[];
}
function abs(p){return PUBLIC+enc(p);}
async function load(p=""){
  cwd=p;lib.innerHTML="<p style='opacity:.6'>Loading...</p>";
  const d=await list(p);lib.innerHTML="";
  for(const e of d){
    const name=e.name;const full=(p?p+"/":"")+name;
    if(!name.includes(".")){
      const c=document.createElement("div");c.className="card";
      const img=document.createElement("img");
      img.src=abs(full+"/folder.png");img.onerror=()=>img.src="https://placehold.co/300x300/111/aaa?text=Folder";
      const s=document.createElement("span");s.textContent=name;
      c.onclick=()=>{ensureAudioUnlocked();load(full);navToggle.checked=true;};
      c.append(img,s);lib.append(c);continue;
    }
    if(/\.(mp3|wav|ogg|m4a)$/i.test(name)){
      const c=document.createElement("div");c.className="card";
      const img=document.createElement("img");
      img.src=abs(full.replace(/\.[^.]+$/,".png"));
      img.onerror=()=>img.src="https://placehold.co/300x300/222/888?text=Audio";
      const s=document.createElement("span");s.textContent=name;
      c.onclick=()=>{ensureAudioUnlocked();player.src=abs(full);player.play();navToggle.checked=true;};
      c.append(img,s);lib.append(c);
    }
  }
}

document.getElementById("btnBack").onclick=()=>{
  if(!cwd)return;const parts=cwd.split("/");parts.pop();load(parts.join("/"));
};
document.getElementById("btnRefresh").onclick=()=>load(cwd);
document.getElementById("mRoot").onclick=()=>{load("");navToggle.checked=true;};
document.getElementById("mBack").onclick=()=>{
  if(!cwd)return;const parts=cwd.split("/");parts.pop();load(parts.join("/"));navToggle.checked=true;
};
document.getElementById("mRefresh").onclick=()=>{load(cwd);navToggle.checked=true;};
load("");
</script>
</body>
</html>