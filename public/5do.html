<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>5DO Lite</title>
<!-- supabase-js v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0b0f17; --panel:#111726; --border:#1e2637; --accent:#8ff0cc; --text:#e6f5ee; --muted:#93a1b2;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}

  /* Header */
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  .left-pack{display:flex;align-items:center;gap:12px}
  .app-title{font-weight:700;color:var(--accent);font-size:1.1rem}

  /* Hamburger (framed like Lite style) */
  .menu-container{position:relative}
  .hamburger{width:34px;height:28px;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .hamburger span,.hamburger span:before,.hamburger span:after{content:"";display:block;width:16px;height:2px;background:#cfead1;border-radius:2px;position:relative}
  .hamburger span:before{position:absolute;top:-6px}
  .hamburger span:after{position:absolute;top:6px}
  .dropdown{position:absolute;top:36px;left:0;background:#121a2a;border:1px solid var(--border);border-radius:12px;min-width:240px;display:none;flex-direction:column;overflow:hidden}
  .dropdown a,.dropdown button{padding:12px 14px;color:#cfead1;border:none;background:transparent;text-align:left;cursor:pointer;width:100%}
  .dropdown a:hover,.dropdown button:hover{background:#182035}
  .backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);}

  /* Language toggle */
  .lang-toggle{display:flex;align-items:center;gap:6px}
  .lang-toggle button{padding:6px 10px;border:1px solid var(--border);background:#151d2c;color:#cfead1;border-radius:10px;cursor:pointer}
  .lang-toggle button.active{background:#1f2739;border-color:#334;color:#aefad9}

  /* Library bar */
  .libbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border)}
  .lib-left{display:flex;align-items:center;gap:10px}
  .ibtn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;background:#151d2c;cursor:pointer}
  .ibtn:hover{background:#182035}
  .lib-path{color:var(--muted);font-size:.9rem}

  /* Thumbs horizontal scroller (iTunes style) */
  .row-wrap{padding:10px 14px}
  .thumb-row{display:flex;gap:10px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:8px}
  .thumb-row::-webkit-scrollbar{height:6px}
  .thumb-row::-webkit-scrollbar-thumb{background:#24304a;border-radius:20px}
  .thumb{flex:0 0 auto;width:140px;height:140px;border-radius:16px;border:1px solid var(--border);background:#0e1523;position:relative;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
  .thumb .label{position:absolute;bottom:8px;left:8px;right:8px;background:rgba(0,0,0,.35);color:#cfead1;padding:4px 6px;border-radius:8px;font-size:.75rem;text-align:center;display:none}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity .25s ease}

  /* Loading placeholder ‚Äì dreamy gradient + subtle glow */
  .placeholder{
    position:absolute;inset:0;border-radius:16px;background:
      radial-gradient(120px 80px at 35% 30%, rgba(126,241,192,.35), transparent 60%),
      radial-gradient(160px 100px at 70% 70%, rgba(85,208,255,.28), transparent 62%),
      radial-gradient(140px 120px at 60% 20%, rgba(163,140,255,.22), transparent 58%),
      linear-gradient(135deg, #0e1725, #0b101b 60%);
    filter: drop-shadow(0 0 18px rgba(143,240,204,.12));
    animation: floatGlow 4s ease-in-out infinite;
  }
  @keyframes floatGlow{
    0% { filter: drop-shadow(0 0 14px rgba(143,240,204,.10)); transform: translateY(0); }
    50%{ filter: drop-shadow(0 0 24px rgba(143,240,204,.20)); transform: translateY(-1px); }
    100%{ filter: drop-shadow(0 0 14px rgba(143,240,204,.10)); transform: translateY(0); }
  }

  /* Player strip */
  .player-strip{padding:10px 14px;border-top:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap}
  .status-thumb{width:124px;height:124px;border-radius:16px;border:1px solid var(--border);background:#0e1523;position:relative;overflow:hidden;flex:0 0 auto}
  .status-thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .status-thumb .placeholder{border-radius:16px}

  .ctrls{display:flex;flex-direction:column;gap:10px;min-width:220px;flex:1}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .row label{font-size:.85rem;color:#a9b8c8}
  .row input[type=range]{width:200px}
  .row select{padding:6px 10px;border:1px solid var(--border);background:#151d2c;color:#cfead1;border-radius:10px}
  .row .chk{display:flex;align-items:center;gap:8px}
  audio{width:100%;background:#0e1523;border-radius:12px;border:1px solid var(--border);padding:6px}

  /* Modal for texts */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
  .modal .shade{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .card{position:relative;z-index:2;background:#0f1522;border:1px solid var(--border);border-radius:16px;max-width:720px;width:92%;max-height:80vh;overflow:auto;padding:18px}
  .modal .close{position:absolute;right:10px;top:10px;border:1px solid var(--border);border-radius:8px;background:#141c2b;color:#cfead1;padding:6px 10px;cursor:pointer}

  /* Bar Spectrum Canvas box */
  .spectrum-wrap{width:100%;height:120px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:#0a1220}
  #barSpectrum{width:100%;height:100%}

  @media (max-width:600px){
    .thumb{width:120px;height:120px}
    .row input[type=range]{width:160px}
    .dropdown{min-width:200px}
  }
</style>
</head>
<body>

<header>
  <div class="left-pack">
    <div class="menu-container">
      <div id="menuBtn" class="hamburger" style="position:relative; top:-3px;"><span></span></div>
      <div id="menuDrop" class="dropdown">
        <a href="https://5dshop.co.kr" target="_blank" rel="noopener">Shop</a>
        <button data-text="faq">FAQ</button>
        <button data-text="manual">Manual</button>
        <button data-text="contact">Contact</button>
        <button data-text="about">About</button>
      </div>
      <div id="backdrop" class="backdrop"></div>
    </div>
    <div class="app-title">5DO Lite</div>
  </div>
  <div class="lang-toggle">
    <button id="btnKO" class="active">KO</button>
    <button id="btnEN">EN</button>
  </div>
</header>

<!-- Library bar -->
<div class="libbar">
  <div class="lib-left">
    <div id="btnBack" class="ibtn" title="Back">‚¨ÖÔ∏è</div>
    <div id="btnRefresh" class="ibtn" title="Refresh">üîÑ</div>
    <div class="lib-path" id="libPath">/</div>
  </div>
</div>

<!-- Thumbnails: folders then files -->
<div class="row-wrap">
  <div class="thumb-row" id="foldersRow"></div>
</div>
<div class="row-wrap">
  <div class="thumb-row" id="filesRow"></div>
</div>

<!-- Spectrum monitor (always visible box under the player) -->
<div class="spectrum-wrap">
  <canvas id="barSpectrum"></canvas>
</div>

<!-- Player strip -->
<div class="player-strip">
  <div class="status-thumb" id="statusBox"><div class="placeholder"></div></div>
  <div class="ctrls">
    <div class="row">
      <label id="lblVol">Volume</label>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
      <label class="chk"><input id="loop" type="checkbox"> <span id="lblLoop">Loop</span></label>
      <label id="lblTimer">Timer</label>
      <select id="timer">
        <option value="0">Off</option>
        <option value="5">5m</option>
        <option value="10">10m</option>
        <option value="15">15m</option>
        <option value="20">20m</option>
        <option value="30">30m</option>
        <option value="45">45m</option>
        <option value="60">60m</option>
      </select>
    </div>
    <audio id="player" controls preload="none" playsinline></audio>
  </div>
</div>

<!-- Modal for texts -->
<div id="modal" class="modal">
  <div class="shade"></div>
  <div class="card">
    <button class="close">Close</button>
    <div id="modalBody" style="white-space:pre-wrap; line-height:1.5;"></div>
  </div>
</div>

<script>
/* ===========================
   5DO Media Engine v1 (Lite/Pro Í≥µÏö©)
   =========================== */
const FIVE_DO_MEDIA_CONFIG = {
  projectId: "xdjgumqdwedgzwqturcx",
  bucket   : "media",
  anonKey  : "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU",
  defaultLang: "ko",
};
const SB_HOST = `https://${FIVE_DO_MEDIA_CONFIG.projectId}.supabase.co`;
const SB_BASE = `${SB_HOST}/storage/v1`;
const SB_REND = `${SB_BASE}/render/image/public/${FIVE_DO_MEDIA_CONFIG.bucket}`;
const SB_PUB  = `${SB_BASE}/object/public/${FIVE_DO_MEDIA_CONFIG.bucket}`;
const enc = (p)=>p.split('/').map(encodeURIComponent).join('/');

const FiveDOMedia = (() => {
  let client=null, lang=FIVE_DO_MEDIA_CONFIG.defaultLang;
  const waitClient = async()=>{
    if(client) return client;
    await new Promise(r=>{
      const t=setInterval(()=>{ if(window.supabase){ clearInterval(t); r(); }}, 20);
    });
    client = window.supabase.createClient(SB_HOST, FIVE_DO_MEDIA_CONFIG.anonKey, {auth:{persistSession:false}});
    return client;
  };
  const imgx=(key,params="width=360&quality=70&format=webp")=>`${SB_REND}/${enc(key)}?${params}`;
  const fileURL=(key)=>`${SB_PUB}/${enc(key)}`;
  const preloadImg=(url,timeout=8000)=>new Promise(res=>{
    const im=new Image(); let done=false;
    const to=setTimeout(()=>{ if(!done){done=true;res(false);} }, timeout);
    im.onload =()=>{ if(!done){done=true;clearTimeout(to);res(true);} };
    im.onerror=()=>{ if(!done){done=true;clearTimeout(to);res(false);} };
    im.src=url;
  });
  const firstAvailableImage=async(cands,params)=>{ for(const k of cands){ const u=imgx(k,params); if(await preloadImg(u)) return u; } return null; };
  const J=['jpg','jpeg','JPG','JPEG']; // JPG Í≥ÑÏó¥Îßå Ïö∞ÏÑ†
  const sansExt = (fn)=>fn.replace(/\.[^/.]+$/,'');
  const chooseFolderThumb=async(folderName)=>{
    const base=`${folderName}/`; const keys=[];
    if(lang==='en'){ for(const ext of J) keys.push(`${base}folder_e.${ext}`); }
    for(const ext of J) keys.push(`${base}folder.${ext}`);
    return await firstAvailableImage(keys);
  };
  const chooseAudioThumb=async(folderName,fileBase)=>{
    const base=`${folderName}/`; const keys=[];
    if(lang==='en'){ for(const ext of J) keys.push(`${base}${fileBase}_E.${ext}`); }
    for(const ext of J) keys.push(`${base}${fileBase}.${ext}`);
    return await firstAvailableImage(keys);
  };
  const list = async(path="")=>{
    const cli = await waitClient();
    const { data, error } = await cli.storage.from(FIVE_DO_MEDIA_CONFIG.bucket)
      .list(path, {limit:1000,offset:0,sortBy:{column:"name",order:"asc"}});
    if(error) throw error;
    const folders=[], files=[];
    for(const it of data){
      if(it.name.startsWith('.')) continue;
      if(it.metadata && it.metadata.mimetype === 'application/x-directory'){
        folders.push({ name: it.name, path: path ? `${path}/${it.name}` : it.name });
      }else{
        files.push({ name: it.name, path: path ? `${path}/${it.name}` : it.name });
      }
    }
    return {folders, files};
  };
  const setLang = (code)=>{ lang=(code==='en')?'en':'ko'; return lang; };
  const getLang = ()=>lang;
  return {
    init: waitClient, setLang, getLang, list,
    imgForFolder: chooseFolderThumb,
    imgForAudio : chooseAudioThumb,
    urlForAudio : (folder,filename)=>fileURL(`${folder}/${filename}`),
    _priv:{imgx,fileURL,preloadImg,firstAvailableImage,sansExt}
  };
})();
</script>

<script>
/* ===========================
   5DO Lite App Logic
   =========================== */
const foldersRow = document.getElementById('foldersRow');
const filesRow   = document.getElementById('filesRow');
const libPathEl  = document.getElementById('libPath');
const player     = document.getElementById('player');
const vol        = document.getElementById('vol');
const loop       = document.getElementById('loop');
const timerSel   = document.getElementById('timer');
const statusBox  = document.getElementById('statusBox');

let pathStack = [];     // for Back
let currentPath = "";   // e.g. "Brainwave_States"
let pendingSrc = null;  // chosen track URL (awaiting user play)
let timerId    = null;

/* Hamburger toggle + modal texts */
const menuBtn   = document.getElementById('menuBtn');
const menuDrop  = document.getElementById('menuDrop');
const backdrop  = document.getElementById('backdrop');
function closeMenu(){ menuDrop.style.display='none'; backdrop.style.display='none'; }
menuBtn.addEventListener('click', ()=>{
  const show = menuDrop.style.display!=='flex';
  menuDrop.style.display = show ? 'flex' : 'none';
  backdrop.style.display = show ? 'block' : 'none';
});
backdrop.addEventListener('click', closeMenu);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu(); });
document.querySelectorAll('#menuDrop [data-text]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const key = btn.getAttribute('data-text'); closeMenu();
    showTextModal(`/texts/${key}.txt`);
  });
});
async function showTextModal(url){
  const modal=document.getElementById('modal');
  const body =document.getElementById('modalBody');
  body.textContent=''; modal.style.display='flex';
  try{
    const r = await fetch(url); body.textContent = r.ok ? await r.text() : `Failed to load: ${url}`;
  }catch(e){ body.textContent=`Error: ${e}`; }
}
document.querySelector('.modal .close').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });
document.querySelector('.modal .shade').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });

/* Language toggle */
const btnKO=document.getElementById('btnKO'), btnEN=document.getElementById('btnEN');
function setLangButtons(lc){
  btnKO.classList.toggle('active', lc==='ko');
  btnEN.classList.toggle('active', lc==='en');
}
btnKO.addEventListener('click', async ()=>{
  FiveDOMedia.setLang('ko'); setLangButtons('ko'); await refresh();
});
btnEN.addEventListener('click', async ()=>{
  FiveDOMedia.setLang('en'); setLangButtons('en'); await refresh();
});

/* Back / Refresh */
document.getElementById('btnBack').addEventListener('click', async ()=>{
  if(pathStack.length>0){ currentPath = pathStack.pop(); await renderCurrent(); }
});
document.getElementById('btnRefresh').addEventListener('click', async ()=>{ await refresh(true); });
async function refresh(isHard=false){
  // isHard=false: Í∑∏ÎÉ• Ïû¨Î†åÎçî, true: Ïû¨Î™©Î°ù
  await renderCurrent();
}

/* Placeholder helpers (status + thumb) */
function applyPlaceholder(el){
  // ensure one placeholder child exists
  const p=document.createElement('div'); p.className='placeholder'; el.appendChild(p);
}
function clearPlaceholder(el){
  const p=el.querySelector('.placeholder'); if(p) p.remove();
}

/* Renderers */
async function renderCurrent(){
  libPathEl.textContent = currentPath ? `/${currentPath}` : '/';
  // Î™©Î°ù
  await FiveDOMedia.init();
  const {folders, files} = await FiveDOMedia.list(currentPath);

  // Ìè¥Îçî Î†åÎçî
  foldersRow.innerHTML='';
  for(const f of folders){
    const card=document.createElement('div'); card.className='thumb folder';
    const ph = document.createElement('div'); ph.className='placeholder'; card.appendChild(ph);
    const img=document.createElement('img'); card.appendChild(img);

    // Ïç∏ÎÑ§Ïùº ÎπÑÎèôÍ∏∞
    FiveDOMedia.imgForFolder(f.path).then(url=>{
      if(url){ img.src=url; img.onload=()=>{ img.style.opacity='1'; ph.remove(); }; }
      else { ph.remove(); /* ÎÇ®Í∏∏ ÏàòÎèÑ */ }
    });

    card.addEventListener('click', async ()=>{
      pathStack.push(currentPath);
      currentPath = f.path;
      await renderCurrent();
    });

    foldersRow.appendChild(card);
  }

  // ÌååÏùº Î†åÎçî (mp3Îßå ÌïÑÌÑ∞)
  filesRow.innerHTML='';
  for(const file of files){
    if(!/\.mp3$/i.test(file.name)) continue;
    const card=document.createElement('div'); card.className='thumb audio';
    const ph = document.createElement('div'); ph.className='placeholder'; card.appendChild(ph);
    const img=document.createElement('img'); card.appendChild(img);

    const base = FiveDOMedia._priv.sansExt(file.name);
    FiveDOMedia.imgForAudio(currentPath, base).then(url=>{
      if(url){ img.src=url; img.onload=()=>{ img.style.opacity='1'; ph.remove(); }; }
      else { ph.remove(); }
    });

    // ÌÅ¥Î¶≠: Î°úÎî©Îßå, ÏûêÎèôÏû¨ÏÉù Í∏àÏßÄ
    card.addEventListener('click', async ()=>{
      const src = FiveDOMedia.urlForAudio(currentPath, file.name);
      pendingSrc = src;
      // ÏÉÅÌÉú Ïç∏ÎÑ§Ïùº ÍµêÏ≤¥
      setStatusThumb(currentPath, base);
      // ÌîåÎ†àÏù¥Ïñ¥ÏóêÎäî src ÏÑ∏ÌåÖ(ÎØ∏Î¶¨ Î°úÎìú), ÏûêÎèôÏû¨ÏÉù X
      player.src = pendingSrc;
      player.load();
      // Î©îÎâ¥ Îã´Ìûò Îì±ÏùÄ ÏóÜÏùå
    });

    filesRow.appendChild(card);
  }
}

/* Status thumb updater */
async function setStatusThumb(folder, base){
  const box = statusBox;
  box.innerHTML=''; // reset
  const ph = document.createElement('div'); ph.className='placeholder'; box.appendChild(ph);
  const img=document.createElement('img'); box.appendChild(img);
  const url = await FiveDOMedia.imgForAudio(folder, base);
  if(url){ img.src=url; img.onload=()=>{ ph.remove(); }; }
  else { /* keep placeholder */ }
}

/* Player controls */
player.volume = parseFloat(vol.value||'0.85');
vol.addEventListener('input', ()=>{ player.volume = parseFloat(vol.value||'0.85'); });
loop.addEventListener('change', ()=>{ player.loop = loop.checked; });
timerSel.addEventListener('change', ()=>{
  if(timerId){ clearTimeout(timerId); timerId=null; }
  const m = parseInt(timerSel.value,10);
  if(m>0){
    timerId = setTimeout(()=>{ player.pause(); }, m*60*1000);
  }
});

/* Bar Spectrum (from player) */
let audioCtx=null, analyser=null, srcNode=null;
const specCanvas = document.getElementById('barSpectrum');
const sctx = specCanvas.getContext('2d');
function resizeSpectrum(){ specCanvas.width = specCanvas.clientWidth; specCanvas.height = specCanvas.clientHeight; }
window.addEventListener('resize', resizeSpectrum); resizeSpectrum();

function ensureAudioGraph(){
  if(audioCtx) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  audioCtx = new AC();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  // MediaElementSourceÎäî Ìïú Î≤àÎßå Ïó∞Í≤∞ Í∞ÄÎä•
  srcNode = audioCtx.createMediaElementSource(player);
  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}
function drawBars(){
  requestAnimationFrame(drawBars);
  if(!analyser) { sctx.clearRect(0,0,specCanvas.width,specCanvas.height); return; }
  const {width,height}=specCanvas;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  analyser.getByteFrequencyData(dataArray);
  sctx.clearRect(0,0,width,height);
  const bars = Math.min(64, bufferLength);
  const barW = (width / bars)*0.9;
  for(let i=0;i<bars;i++){
    const v = dataArray[i]/255;
    const h = v * (height*0.9);
    const x = i*(width/bars) + (width/bars - barW)/2;
    const y = height - h;
    // gradient-ish color
    const g = sctx.createLinearGradient(x,y,x,y+h);
    g.addColorStop(0, '#7ef1c0');
    g.addColorStop(0.5, '#55d0ff');
    g.addColorStop(1, '#a38cff');
    sctx.fillStyle = g;
    sctx.fillRect(x,y,barW,Math.max(1.5,h));
  }
}

/* iOS unlock on play */
player.addEventListener('play', async ()=>{
  try{
    ensureAudioGraph();
    if(audioCtx.state === 'suspended') await audioCtx.resume();
  }catch(e){}
});

/* Init */
(async ()=>{
  await FiveDOMedia.init();
  await renderCurrent();
  drawBars();
})();

/* EN/KR labels (optional: keep English UI text if you prefer) */
function applyLangLabels(){
  const lc = FiveDOMedia.getLang();
  const ko = (lc==='ko');
  document.getElementById('lblVol').textContent   = ko?'Î≥ºÎ•®':'Volume';
  document.getElementById('lblLoop').textContent  = ko?'Î∞òÎ≥µ':'Loop';
  document.getElementById('lblTimer').textContent = ko?'ÌÉÄÏù¥Î®∏':'Timer';
}
applyLangLabels();
btnKO.addEventListener('click', applyLangLabels);
btnEN.addEventListener('click', applyLangLabels);
</script>
</body>
</html>
