<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>5DO Backdrop Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0;}
    input,button,select,textarea{padding:8px 10px;font-size:14px;}
    input[type="text"], input[type="password"]{min-width:260px;}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;}
    .thumb{width:100%;aspect-ratio:16/9;border-radius:10px;background:#111;background-size:cover;background-position:center;}
    .muted{opacity:.7}
    .danger{background:#b91c1c;color:#fff;border:none;border-radius:8px;}
    .primary{background:#2563eb;color:#fff;border:none;border-radius:8px;}
    .ok{color:#16a34a}
    .warn{color:#b45309}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px;}
  </style>
</head>
<body>
  <h2>5DO Backdrop Admin</h2>
  <div class="muted">Uploads images to <code>/_system/backdrops/</code> and upserts metadata into <code>public.backdrops</code>.</div>

  <div class="card">
    <h3>Login</h3>
    <div class="row">
      <input id="email" type="text" placeholder="email" value="paul@5dshop.co.kr"/>
      <input id="pw" type="password" placeholder="password"/>
      <button id="loginBtn" class="primary">Login</button>
      <button id="logoutBtn">Logout</button>
      <span id="authState" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>Upload + Register</h3>
    <div class="row">
      <input id="file" type="file" accept="image/webp,image/png,image/jpeg"/>
      <input id="id" type="text" placeholder="id (e.g. nebula_purple)"/>
      <input id="nameKo" type="text" placeholder="name_ko"/>
      <input id="nameEn" type="text" placeholder="name_en"/>
      <input id="tags" type="text" placeholder="tags (comma)"/>
      <input id="sort" type="text" placeholder="sort" value="1000"/>
      <label class="row" style="gap:6px"><input id="enabled" type="checkbox" checked/> enabled</label>
      <button id="uploadBtn" class="primary">Upload + Upsert</button>
    </div>
    <div class="muted">Recommended: WebP 2560×1440, file name auto-generated as <code>bg_&lt;id&gt;.webp</code>.</div>
    <div id="uploadMsg" class="muted"></div>
  </div>

  <div class="card">
    <h3>Existing Backdrops</h3>
    <div class="row">
      <button id="refreshBtn">Refresh List</button>
      <span id="listMsg" class="muted"></span>
    </div>
    <div id="list" class="grid"></div>
  </div>

<script>
const SUPABASE_URL = "https://xdjgumqdwedgzwqturcx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhkamd1bXFkd2VkZ3p3cXR1cmN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDQzNDUsImV4cCI6MjA3NjA4MDM0NX0.pZcnU1xMaaBBdvytSTVrLPsLU9r_3FPzCPSUeBFUsaU";
const BUCKET = "media";

const SB = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const MEDIA_BASE = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}`;

function $(id){ return document.getElementById(id); }

function setMsg(el, msg, cls='muted') {
  el.className = cls;
  el.textContent = msg || '';
}

async function refreshAuthState(){
  const { data } = await SB.auth.getSession();
  const user = data?.session?.user;
  $('authState').textContent = user ? `Logged in: ${user.email}` : 'Not logged in';
}

$('loginBtn').onclick = async ()=>{
  const email = $('email').value.trim();
  const password = $('pw').value;
  const { error } = await SB.auth.signInWithPassword({ email, password });
  if(error) return alert(error.message);
  $('pw').value = '';
  await refreshAuthState();
  await loadList();
};

$('logoutBtn').onclick = async ()=>{
  await SB.auth.signOut();
  await refreshAuthState();
};

$('uploadBtn').onclick = async ()=>{
  setMsg($('uploadMsg'), '');
  const f = $('file').files?.[0];
  if(!f) return alert('Choose an image file.');
  const id = $('id').value.trim();
  if(!id) return alert('ID is required (e.g. nebula_purple).');

  // Force webp naming convention (you can upload png/jpg but name becomes .webp; recommended to upload actual webp)
  const fileName = `bg_${id}.webp`;
  const path = `_system/backdrops/${fileName}`;

  setMsg($('uploadMsg'), 'Uploading image…');
  const up = await SB.storage.from(BUCKET).upload(path, f, { upsert: true });
  if(up.error) {
    console.warn(up.error);
    return setMsg($('uploadMsg'), 'Upload failed: ' + up.error.message, 'warn');
  }

  const payload = {
    id,
    file: fileName,
    name_ko: $('nameKo').value.trim() || id,
    name_en: $('nameEn').value.trim() || id,
    tags: ($('tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    sort: parseInt(($('sort').value||'1000'),10) || 1000,
    enabled: !!$('enabled').checked
  };

  setMsg($('uploadMsg'), 'Updating DB…');
  const { error } = await SB.from('backdrops').upsert(payload);
  if(error) {
    console.warn(error);
    return setMsg($('uploadMsg'), 'DB upsert failed: ' + error.message, 'warn');
  }

  setMsg($('uploadMsg'), 'Done ✅', 'ok');
  await loadList();
};

$('refreshBtn').onclick = loadList;

async function loadList(){
  setMsg($('listMsg'), 'Loading…');
  $('list').innerHTML = '';
  const { data, error } = await SB.from('backdrops')
    .select('id,file,name_ko,name_en,tags,enabled,sort,updated_at')
    .order('sort', { ascending:true })
    .order('updated_at', { ascending:false });
  if(error) {
    console.warn(error);
    return setMsg($('listMsg'), 'Load failed: ' + error.message, 'warn');
  }
  setMsg($('listMsg'), `Loaded ${(data||[]).length} item(s).`);

  (data||[]).forEach(item=>{
    const card = document.createElement('div');
    card.className = 'card';

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    thumb.style.backgroundImage = `url("${MEDIA_BASE}/_system/backdrops/${item.file}?v=${encodeURIComponent(item.updated_at||'')}")`;

    const title = document.createElement('div');
    title.innerHTML = `<b>${item.id}</b> <span class="muted">(sort ${item.sort})</span>`;

    const meta = document.createElement('div');
    meta.className = 'muted';
    meta.textContent = `${item.name_ko} / ${item.name_en}`;

    const row = document.createElement('div');
    row.className = 'row';

    const enabled = document.createElement('input');
    enabled.type = 'checkbox';
    enabled.checked = !!item.enabled;

    const sort = document.createElement('input');
    sort.type = 'text';
    sort.value = String(item.sort ?? 1000);
    sort.style.width = '90px';

    const nameKo = document.createElement('input');
    nameKo.type = 'text';
    nameKo.value = item.name_ko || item.id;

    const nameEn = document.createElement('input');
    nameEn.type = 'text';
    nameEn.value = item.name_en || item.id;

    const tags = document.createElement('input');
    tags.type = 'text';
    tags.value = (item.tags||[]).join(', ');

    const saveBtn = document.createElement('button');
    saveBtn.className = 'primary';
    saveBtn.textContent = 'Save';

    const disableBtn = document.createElement('button');
    disableBtn.className = 'danger';
    disableBtn.textContent = 'Disable';

    const msg = document.createElement('span');
    msg.className = 'muted';

    saveBtn.onclick = async ()=>{
      msg.textContent = 'Saving…';
      const payload = {
        id: item.id,
        file: item.file,
        enabled: !!enabled.checked,
        sort: parseInt(sort.value||'1000',10) || 1000,
        name_ko: nameKo.value.trim() || item.id,
        name_en: nameEn.value.trim() || item.id,
        tags: tags.value.split(',').map(s=>s.trim()).filter(Boolean)
      };
      const { error } = await SB.from('backdrops').upsert(payload);
      if(error) {
        console.warn(error);
        msg.textContent = 'Save failed: ' + error.message;
        msg.className = 'warn';
      } else {
        msg.textContent = 'Saved ✅';
        msg.className = 'ok';
      }
    };

    disableBtn.onclick = async ()=>{
      if(!confirm('Disable this backdrop (hide from app)?')) return;
      msg.textContent = 'Disabling…';
      const { error } = await SB.from('backdrops')
        .update({ enabled:false })
        .eq('id', item.id);
      if(error) {
        console.warn(error);
        msg.textContent = 'Disable failed: ' + error.message;
        msg.className = 'warn';
      } else {
        msg.textContent = 'Disabled ✅';
        msg.className = 'ok';
        enabled.checked = false;
      }
    };

    row.append(
      document.createTextNode('enabled '), enabled,
      document.createTextNode(' sort '), sort,
      nameKo, nameEn, tags,
      saveBtn, disableBtn, msg
    );

    card.append(thumb, title, meta, row);
    $('list').appendChild(card);
  });
}

(async function init(){
  await refreshAuthState();
  // Try load list (will work only after login if RLS blocks select-all; otherwise will show)
  try{ await loadList(); }catch(e){}
})();
</script>
</body>
</html>
